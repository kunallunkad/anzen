import{c as $,d as A,r as x,s as h,j as e,e as T}from"./index-05MON0zc.js";import{C as k}from"./chevron-up-TszMf-vQ.js";import{C as F}from"./chevron-down-C44n7mhs.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const M=$("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);function P(){const{t:s}=A(),[n,_]=x.useState([]),[y,m]=x.useState(!0),[u,v]=x.useState(new Date().toISOString().split("T")[0]),[g,b]=x.useState(new Set);x.useEffect(()=>{j()},[u]);const j=async()=>{try{m(!0);const{data:t,error:d}=await h.from("sales_invoices").select("*, customers(company_name)").in("payment_status",["pending","partial"]).order("due_date");if(d)throw d;const l=await Promise.all((t||[]).map(async a=>{var p;const{data:o}=await h.rpc("get_invoice_paid_amount",{p_invoice_id:a.id}),i=o||0,O=a.total_amount-i,L=new Date(a.due_date),R=new Date(u),E=Math.floor((R.getTime()-L.getTime())/(1e3*60*60*24));return{id:a.id,customer_id:a.customer_id,customer_name:((p=a.customers)==null?void 0:p.company_name)||"Unknown",invoice_number:a.invoice_number,invoice_date:a.invoice_date,due_date:a.due_date,total_amount:a.total_amount,paid_amount:i,balance:O,days_overdue:E}})),r=new Map;l.forEach(a=>{const o=a.customer_id;r.has(o)||r.set(o,{customer_id:o,customer_name:a.customer_name,total_outstanding:0,invoice_count:0,oldest_overdue_days:-999,invoices:[]});const i=r.get(o);i.total_outstanding+=a.balance,i.invoice_count+=1,i.oldest_overdue_days=Math.max(i.oldest_overdue_days,a.days_overdue),i.invoices.push(a)});const c=Array.from(r.values()).sort((a,o)=>a.oldest_overdue_days!==o.oldest_overdue_days?o.oldest_overdue_days-a.oldest_overdue_days:o.total_outstanding-a.total_outstanding);_(c)}catch(t){console.error("Error loading ageing data:",t),alert("Failed to load ageing report")}finally{m(!1)}},f=t=>{const d=new Set(g);d.has(t)?d.delete(t):d.add(t),b(d)},N=()=>{const t=[];t.push(["Customer","Total Outstanding","Invoices","Oldest Overdue (Days)","Status"]),n.forEach(a=>{t.push([a.customer_name,a.total_outstanding.toString(),a.invoice_count.toString(),a.oldest_overdue_days.toString(),a.oldest_overdue_days>90?"CRITICAL":a.oldest_overdue_days>0?"OVERDUE":"CURRENT"]),t.push(["","Invoice #","Invoice Date","Due Date","Amount","Paid","Balance","Days Overdue"]),a.invoices.forEach(o=>{t.push(["",o.invoice_number,o.invoice_date,o.due_date,o.total_amount.toString(),o.paid_amount.toString(),o.balance.toString(),o.days_overdue.toString()])}),t.push([""])});const d=t.map(a=>a.join(",")).join(`
`),l=new Blob([d],{type:"text/csv"}),r=URL.createObjectURL(l),c=document.createElement("a");c.href=r,c.download=`ageing_report_${u}.csv`,c.click(),URL.revokeObjectURL(r)},w=t=>t<0?"text-green-600":t===0?"text-gray-600":t<=30?"text-yellow-600":t<=60?"text-orange-600":t<=90?"text-red-600":"text-red-900 font-bold",D=t=>t<0?{text:s("not_due","Not Due"),color:"bg-green-100 text-green-800"}:t===0?{text:s("due_today","Due Today"),color:"bg-gray-100 text-gray-800"}:t<=30?{text:`${t}d ${s("overdue","Overdue")}`,color:"bg-yellow-100 text-yellow-800"}:t<=60?{text:`${t}d ${s("overdue","Overdue")}`,color:"bg-orange-100 text-orange-800"}:t<=90?{text:`${t}d ${s("overdue","Overdue")}`,color:"bg-red-100 text-red-800"}:{text:`${t}d ${s("critical","CRITICAL")}`,color:"bg-red-200 text-red-900 font-bold"},S=n.reduce((t,d)=>t+d.total_outstanding,0),C=n.reduce((t,d)=>t+d.invoice_count,0),I=n.filter(t=>t.oldest_overdue_days>90).length;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-white rounded-lg shadow-sm border border-gray-200 p-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-xs font-medium text-gray-700",children:[s("as_of_date","As of Date"),":"]}),e.jsx("input",{type:"date",value:u,onChange:t=>v(t.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("button",{onClick:N,disabled:n.length===0,className:"flex items-center gap-1.5 bg-green-600 text-white px-2.5 py-1.5 rounded text-xs hover:bg-green-700 transition disabled:opacity-50",children:[e.jsx(M,{className:"w-3.5 h-3.5"}),s("export_csv","Export CSV")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-blue-500",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:s("total_outstanding","Total Outstanding")}),e.jsxs("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:["Rp ",S.toLocaleString("id-ID",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-gray-400",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:s("total_invoices","Total Invoices")}),e.jsx("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:C})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-orange-500",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:s("customers","Customers")}),e.jsx("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:n.length})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-red-600",children:[e.jsxs("p",{className:"text-[10px] text-gray-600 flex items-center gap-1",children:[e.jsx(T,{className:"w-3 h-3 text-red-600"}),s("critical_90_days","Critical (90+ days)")]}),e.jsx("p",{className:"text-base font-bold text-red-900 mt-0.5",children:I})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:y?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),e.jsxs("p",{className:"mt-2 text-sm text-gray-500",children:[s("loading","Loading ageing data"),"..."]})]}):n.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx("p",{className:"text-sm font-medium",children:s("no_outstanding","No Outstanding Invoices")}),e.jsx("p",{className:"text-xs mt-1",children:s("all_paid","All invoices are fully paid!")})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:n.map(t=>{const d=g.has(t.customer_id),l=D(t.oldest_overdue_days);return e.jsxs("div",{children:[e.jsxs("div",{onClick:()=>f(t.customer_id),className:"p-2.5 hover:bg-gray-50 cursor-pointer flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[e.jsx("button",{className:"text-gray-400 hover:text-gray-600",children:d?e.jsx(k,{className:"w-4 h-4"}):e.jsx(F,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:t.customer_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[t.invoice_count," ",s("invoices","invoice(s)")]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-sm text-gray-900",children:["Rp ",t.total_outstanding.toLocaleString("id-ID",{minimumFractionDigits:2})]})}),e.jsx("div",{className:"w-28",children:e.jsx("span",{className:`inline-block px-2 py-0.5 rounded-full text-[10px] ${l.color}`,children:l.text})})]})]}),d&&e.jsx("div",{className:"bg-gray-50 px-3 pb-3",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{className:"border-b border-gray-300",children:e.jsxs("tr",{className:"text-[10px] text-gray-600",children:[e.jsx("th",{className:"text-left py-1.5 px-2",children:s("invoice_number","Invoice #")}),e.jsx("th",{className:"text-left py-1.5 px-2",children:s("invoice_date","Invoice Date")}),e.jsx("th",{className:"text-left py-1.5 px-2",children:s("due_date","Due Date")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:s("amount","Amount")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:s("paid","Paid")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:s("balance","Balance")}),e.jsx("th",{className:"text-center py-1.5 px-2",children:s("days_overdue","Days Overdue")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:t.invoices.map(r=>e.jsxs("tr",{className:"hover:bg-gray-100",children:[e.jsx("td",{className:"py-1.5 px-2 font-mono text-blue-600",children:r.invoice_number}),e.jsx("td",{className:"py-1.5 px-2",children:new Date(r.invoice_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"py-1.5 px-2",children:new Date(r.due_date).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"py-1.5 px-2 text-right",children:["Rp ",r.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-1.5 px-2 text-right text-green-600",children:["Rp ",r.paid_amount.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-1.5 px-2 text-right font-medium",children:["Rp ",r.balance.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsx("td",{className:"py-1.5 px-2 text-center",children:e.jsx("span",{className:`font-medium ${w(r.days_overdue)}`,children:r.days_overdue<0?`${s("due_in","Due in")} ${Math.abs(r.days_overdue)}d`:r.days_overdue===0?s("today","Today"):`${r.days_overdue}d`})})]},r.id))})]})})]},t.customer_id)})})})]})}export{P as AgeingReport};
