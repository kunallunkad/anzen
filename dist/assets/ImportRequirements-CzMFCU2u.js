import{r as p,j as e,s as S,u as E,f as T,e as P,C as I}from"./index-B8TvHX1I.js";import{L as q,P as $,T as L}from"./Layout-CTEhjuO5.js";import{f as B}from"./dateFormat-E6B5rKFz.js";function F({requirements:C,onRefresh:h,canEdit:u}){const[s,_]=p.useState(null),[x,n]=p.useState(""),o=p.useRef(null),N=[{value:"high",label:"High",color:"text-red-600",bgColor:"bg-red-50"},{value:"medium",label:"Medium",color:"text-orange-600",bgColor:"bg-orange-50"},{value:"low",label:"Low",color:"text-green-600",bgColor:"bg-green-50"}],y=[{value:"pending",label:"Pending",color:"text-gray-600",bgColor:"bg-gray-50"},{value:"ordered",label:"Ordered",color:"text-blue-600",bgColor:"bg-blue-50"},{value:"partially_received",label:"Partially Received",color:"text-yellow-600",bgColor:"bg-yellow-50"},{value:"received",label:"Received",color:"text-green-600",bgColor:"bg-green-50"},{value:"cancelled",label:"Cancelled",color:"text-red-600",bgColor:"bg-red-50"}];p.useEffect(()=>{s&&o.current&&o.current.focus()},[s]);const g=(t,r,l)=>{if(console.log("startEditing called:",{id:t,field:r,currentValue:l,canEdit:u}),!u){console.log("Cannot edit - canEdit is false");return}_({id:t,field:r}),n(l||""),console.log("Editing cell set:",{id:t,field:r})},k=()=>{_(null),n("")},m=async(t,r)=>{try{const l={};r==="required_quantity"||r==="shortage_quantity"||r==="lead_time_days"?l[r]=Number(x):l[r]=x;const{error:d}=await S.from("import_requirements").update(l).eq("id",t);if(d)throw d;h(),k()}catch(l){console.error("Error updating import requirement:",l),alert("Failed to update")}},w=(t,r,l)=>{t.key==="Enter"?m(r,l):t.key==="Escape"&&k()},D=t=>N.find(l=>l.value===t)||N[1],f=t=>y.find(l=>l.value===t)||y[0],i=t=>{const r=new Date,d=new Date(t).getTime()-r.getTime();return Math.ceil(d/(1e3*60*60*24))},c=t=>t<0?"text-red-700 font-bold":t<=7?"text-red-600 font-semibold":t<=30?"text-orange-600":"text-gray-600";return e.jsxs("div",{className:"overflow-x-auto border border-gray-200 rounded-lg",children:[e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Product"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Sales Order"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Required Qty"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Shortage Qty"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Delivery Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Priority"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Lead Time"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider",children:"Notes"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:C.map(t=>{var b,v,j,R;const r=i(t.required_delivery_date),l=D(t.priority),d=f(t.status);return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:(b=t.products)==null?void 0:b.product_name}),e.jsx("div",{className:"text-xs text-gray-500",children:(v=t.products)==null?void 0:v.product_code})]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:(j=t.sales_orders)==null?void 0:j.so_number}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:(R=t.customers)==null?void 0:R.company_name}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="required_quantity"?e.jsx("input",{ref:o,type:"number",value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"required_quantity"),onKeyDown:a=>w(a,t.id,"required_quantity"),className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"}):e.jsx("div",{onClick:()=>g(t.id,"required_quantity",t.required_quantity),className:`text-sm ${u?"cursor-pointer hover:bg-gray-100 px-2 py-1 rounded":""}`,children:t.required_quantity.toLocaleString()})}),e.jsx("td",{className:"px-4 py-3 text-sm text-red-600 font-semibold",children:t.shortage_quantity.toLocaleString()}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="required_delivery_date"?e.jsx("input",{ref:o,type:"date",value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"required_delivery_date"),onKeyDown:a=>w(a,t.id,"required_delivery_date"),className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"}):e.jsxs("div",{onClick:()=>g(t.id,"required_delivery_date",t.required_delivery_date),className:`${u?"cursor-pointer hover:bg-gray-100 px-2 py-1 rounded":""}`,children:[e.jsx("div",{className:"text-sm",children:B(t.required_delivery_date)}),e.jsx("div",{className:`text-xs ${c(r)}`,children:r<0?`${Math.abs(r)} days overdue`:`${r} days`})]})}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="priority"?e.jsx("select",{ref:o,value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"priority"),className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",children:N.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}):e.jsx("div",{onClick:()=>g(t.id,"priority",t.priority),className:`inline-flex px-3 py-1 text-xs font-semibold rounded-full ${l.color} ${l.bgColor} ${u?"cursor-pointer hover:opacity-80":""}`,children:l.label})}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="status"?e.jsx("select",{ref:o,value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"status"),className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500",children:y.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}):e.jsx("div",{onClick:()=>g(t.id,"status",t.status),className:`inline-flex px-3 py-1 text-xs font-semibold rounded-full ${d.color} ${d.bgColor} ${u?"cursor-pointer hover:opacity-80":""}`,children:d.label})}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="lead_time_days"?e.jsx("input",{ref:o,type:"number",value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"lead_time_days"),onKeyDown:a=>w(a,t.id,"lead_time_days"),className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"}):e.jsxs("div",{onClick:()=>g(t.id,"lead_time_days",t.lead_time_days),className:`text-sm ${u?"cursor-pointer hover:bg-gray-100 px-2 py-1 rounded":""}`,children:[t.lead_time_days," days"]})}),e.jsx("td",{className:"px-4 py-3",children:(s==null?void 0:s.id)===t.id&&s.field==="notes"?e.jsx("textarea",{ref:o,value:x,onChange:a=>n(a.target.value),onBlur:()=>m(t.id,"notes"),rows:2,className:"w-full px-2 py-1 border border-blue-400 rounded focus:outline-none focus:ring-2 focus:ring-blue-500"}):e.jsx("div",{onClick:()=>g(t.id,"notes",t.notes),className:`text-sm text-gray-600 max-w-xs truncate ${u?"cursor-pointer hover:bg-gray-100 px-2 py-1 rounded":""}`,title:t.notes||"Click to add notes",children:t.notes||"-"})})]},t.id)})})]}),C.length===0&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No import requirements found"})]})}function K(){const{profile:C}=E(),[h,u]=p.useState([]),[s,_]=p.useState({}),[x,n]=p.useState(!0),[o,N]=p.useState("pending"),[y,g]=p.useState("all"),k=!0;p.useEffect(()=>{m()},[o]);const m=async()=>{try{n(!0);let i=S.from("import_requirements").select(`
          *,
          products (product_name, product_code),
          sales_orders (so_number),
          customers (company_name)
        `).order("priority",{ascending:!0}).order("required_delivery_date",{ascending:!0});o!=="all"&&(i=i.eq("status",o));const{data:c,error:t}=await i;if(t)throw t;u(c||[]);const r=[...new Set(c==null?void 0:c.map(l=>l.product_id))];r.length>0&&await w(r)}catch(i){console.error("Error fetching import requirements:",i.message),T({type:"error",title:"Error",message:"Failed to load import requirements"})}finally{n(!1)}},w=async i=>{try{const c={};for(const t of i){const{data:r}=await S.from("batches").select("current_stock").eq("product_id",t),l=(r==null?void 0:r.reduce((v,j)=>v+Number(j.current_stock),0))||0,{data:d}=await S.from("stock_reservations").select("reserved_quantity").eq("product_id",t).eq("status","active"),b=(d==null?void 0:d.reduce((v,j)=>v+Number(j.reserved_quantity),0))||0;c[t]={product_id:t,total_stock:l,reserved_stock:b,free_stock:l-b}}_(c)}catch(c){console.error("Error fetching stock info:",c.message)}},D=h.filter(i=>y==="all"?!0:i.priority===y),f={total:h.length,high_priority:h.filter(i=>i.priority==="high"&&i.status==="pending").length,pending:h.filter(i=>i.status==="pending").length,ordered:h.filter(i=>i.status==="ordered").length};return e.jsx(q,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Import Requirements"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Track and manage product import needs based on stock shortages"})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4 mb-6",children:[e.jsx("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx($,{className:"w-5 h-5 md:w-6 md:h-6 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Total Requirements"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-gray-900",children:f.total})]})]})}),e.jsx("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx(P,{className:"w-5 h-5 md:w-6 md:h-6 text-red-600 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"High Priority"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-red-600",children:f.high_priority})]})]})}),e.jsx("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx(I,{className:"w-5 h-5 md:w-6 md:h-6 text-yellow-600 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Pending"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-yellow-600",children:f.pending})]})]})}),e.jsx("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:e.jsxs("div",{className:"flex items-center gap-2 md:gap-3",children:[e.jsx(L,{className:"w-5 h-5 md:w-6 md:h-6 text-green-600 flex-shrink-0"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Ordered"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-green-600",children:f.ordered})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow mb-6",children:[e.jsxs("div",{className:"p-4 border-b flex gap-4",children:[e.jsxs("select",{value:o,onChange:i=>N(i.target.value),className:"border rounded-lg px-4 py-2",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"ordered",children:"Ordered"}),e.jsx("option",{value:"partially_received",children:"Partially Received"}),e.jsx("option",{value:"received",children:"Received"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]}),e.jsxs("select",{value:y,onChange:i=>g(i.target.value),className:"border rounded-lg px-4 py-2",children:[e.jsx("option",{value:"all",children:"All Priorities"}),e.jsx("option",{value:"high",children:"High Priority"}),e.jsx("option",{value:"medium",children:"Medium Priority"}),e.jsx("option",{value:"low",children:"Low Priority"})]}),e.jsxs("div",{className:"ml-auto text-sm text-gray-600 flex items-center gap-2",children:[e.jsx($,{className:"w-4 h-4"}),"Click any cell to edit"]})]}),x?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Loading..."}):e.jsx(F,{requirements:D,onRefresh:m,canEdit:k})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(P,{className:"w-5 h-5 text-blue-600 mt-0.5"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-blue-900",children:"About Import Requirements"}),e.jsx("p",{className:"text-sm text-blue-700 mt-1",children:"Import requirements are automatically generated when sales orders are approved but stock is insufficient. The system tracks shortages and helps procurement plan imports based on customer delivery dates and priorities."})]})]})})]})})}export{K as default};
