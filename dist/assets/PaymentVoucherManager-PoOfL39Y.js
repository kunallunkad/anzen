import{r as n,s as c,j as e}from"./index-D377iWu2.js";import{M as U}from"./Modal-XL444I2e.js";import{S as W}from"./SearchableSelect-B1o4KxTG.js";import{S as z}from"./search-C8aJjCFC.js";import{A as Y}from"./arrow-up-circle-K6XcFrXA.js";import"./chevron-down-D_LZ1jaB.js";function de({canManage:N}){n.useRef(null);const[w,S]=n.useState([]),[D,k]=n.useState([]),[C,P]=n.useState([]),[p,x]=n.useState([]),[h,F]=n.useState([]),[A,I]=n.useState(!0),[L,d]=n.useState(!1),[H,J]=n.useState(!1),[K,Q]=n.useState(null),[X,Z]=n.useState([]),[g,V]=n.useState(""),[y,m]=n.useState([]),[ee,te]=n.useState(""),[ae,se]=n.useState(""),[a,i]=n.useState({voucher_date:new Date().toISOString().split("T")[0],supplier_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,pph_code_id:"",pph_amount:0,description:""});n.useEffect(()=>{b(),R(),M(),E()},[]),n.useEffect(()=>{a.supplier_id?O(a.supplier_id):(x([]),m([]))},[a.supplier_id]),n.useEffect(()=>{if(a.pph_code_id&&a.amount>0){const t=h.find(s=>s.id===a.pph_code_id);if(t){const s=a.amount*(t.rate/100);i(r=>({...r,pph_amount:Math.round(s)}))}}else i(t=>({...t,pph_amount:0}))},[a.pph_code_id,a.amount,h]);const b=async()=>{try{const{data:t,error:s}=await c.from("payment_vouchers").select("*, suppliers(company_name), bank_accounts(account_name, bank_name)").order("voucher_date",{ascending:!1});if(s)throw s;S(t||[])}catch(t){console.error("Error loading vouchers:",t)}finally{I(!1)}},R=async()=>{const{data:t}=await c.from("suppliers").select("id, company_name").order("company_name");k(t||[])},M=async()=>{const{data:t}=await c.from("bank_accounts").select("id, account_name, bank_name").eq("is_active",!0);P(t||[])},E=async()=>{const{data:t}=await c.from("tax_codes").select("id, code, name, rate").eq("is_withholding",!0);F(t||[])},O=async t=>{const{data:s}=await c.from("purchase_invoices").select("id, invoice_number, invoice_date, total_amount, paid_amount, balance_amount").eq("supplier_id",t).gt("balance_amount",0).order("invoice_date");x(s||[]),m([])},T=async()=>{const t=new Date().getFullYear().toString().slice(-2),s=(new Date().getMonth()+1).toString().padStart(2,"0"),{count:r}=await c.from("payment_vouchers").select("*",{count:"exact",head:!0}).like("voucher_number",`PV${t}${s}%`);return`PV${t}${s}-${String((r||0)+1).padStart(4,"0")}`},q=(t,s)=>{m(r=>r.find(o=>o.invoiceId===t)?s<=0?r.filter(o=>o.invoiceId!==t):r.map(o=>o.invoiceId===t?{...o,amount:s}:o):s>0?[...r,{invoiceId:t,amount:s}]:r)};y.reduce((t,s)=>t+s.amount,0);const B=a.amount-a.pph_amount,$=async t=>{t.preventDefault();try{const{data:{user:s}}=await c.auth.getUser();if(!s)throw new Error("Not authenticated");const r=await T(),{data:v,error:o}=await c.from("payment_vouchers").insert([{voucher_number:r,voucher_date:a.voucher_date,supplier_id:a.supplier_id,payment_method:a.payment_method,bank_account_id:a.bank_account_id||null,reference_number:a.reference_number||null,amount:a.amount,pph_amount:a.pph_amount,pph_code_id:a.pph_code_id||null,description:a.description||null,created_by:s.id}]).select().single();if(o)throw o;for(const l of y){await c.from("voucher_allocations").insert({voucher_type:"payment",payment_voucher_id:v.id,purchase_invoice_id:l.invoiceId,allocated_amount:l.amount});const _=p.find(u=>u.id===l.invoiceId);if(_){const u=(_.paid_amount||0)+l.amount,G=_.total_amount-u;await c.from("purchase_invoices").update({paid_amount:u,status:G<=0?"paid":"partial"}).eq("id",l.invoiceId)}}d(!1),f(),b()}catch(s){console.error("Error saving voucher:",s),alert("Failed to save: "+s.message)}},f=()=>{i({voucher_date:new Date().toISOString().split("T")[0],supplier_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,pph_code_id:"",pph_amount:0,description:""}),m([]),x([])},j=w.filter(t=>{var s,r;return t.voucher_number.toLowerCase().includes(g.toLowerCase())||((r=(s=t.suppliers)==null?void 0:s.company_name)==null?void 0:r.toLowerCase().includes(g.toLowerCase()))});return A?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(z,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search payments...",value:g,onChange:t=>V(t.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),N&&e.jsxs("button",{onClick:()=>{f(),d(!0)},className:"flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700",children:[e.jsx(Y,{className:"w-5 h-5"}),"New Payment"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Supplier"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Method"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Gross"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"PPh"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Net Paid"})]})}),e.jsxs("tbody",{className:"divide-y",children:[j.map(t=>{var s;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:t.voucher_number}),e.jsx("td",{className:"px-4 py-3",children:new Date(t.voucher_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-4 py-3",children:(s=t.suppliers)==null?void 0:s.company_name}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs capitalize",children:t.payment_method.replace("_"," ")})}),e.jsxs("td",{className:"px-4 py-3 text-right",children:["Rp ",t.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-4 py-3 text-right text-orange-600",children:t.pph_amount>0?`Rp ${t.pph_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-red-600",children:["Rp ",t.net_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},t.id)}),j.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No payment vouchers found"})})]})]})}),e.jsx(U,{isOpen:L,onClose:()=>d(!1),title:"New Payment Voucher",children:e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date *"}),e.jsx("input",{type:"date",required:!0,value:a.voucher_date,onChange:t=>i({...a,voucher_date:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier *"}),e.jsx(W,{value:a.supplier_id,onChange:t=>i({...a,supplier_id:t}),options:D.map(t=>({value:t.id,label:t.company_name})),placeholder:"Select supplier"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{required:!0,value:a.payment_method,onChange:t=>i({...a,payment_method:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"giro",children:"Giro"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Gross Amount (Rp) *"}),e.jsx("input",{type:"number",required:!0,value:a.amount,onChange:t=>i({...a,amount:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),a.payment_method!=="cash"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:a.bank_account_id,onChange:t=>i({...a,bank_account_id:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Select account"}),C.map(t=>e.jsxs("option",{value:t.id,children:[t.bank_name," - ",t.account_name]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference No."}),e.jsx("input",{type:"text",value:a.reference_number,onChange:t=>i({...a,reference_number:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"PPh Withholding (Potong Pajak)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"PPh Type"}),e.jsxs("select",{value:a.pph_code_id,onChange:t=>i({...a,pph_code_id:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"No withholding"}),h.map(t=>e.jsxs("option",{value:t.id,children:[t.code," - ",t.name," (",t.rate,"%)"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"PPh Amount"}),e.jsx("input",{type:"number",value:a.pph_amount,onChange:t=>i({...a,pph_amount:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-orange-50"})]})]}),e.jsxs("div",{className:"mt-2 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Gross Amount:"}),e.jsxs("span",{children:["Rp ",a.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-orange-600",children:[e.jsx("span",{children:"Less: PPh Withholding:"}),e.jsxs("span",{children:["-Rp ",a.pph_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between font-medium text-lg border-t mt-2 pt-2",children:[e.jsx("span",{children:"Net Payment:"}),e.jsxs("span",{className:"text-red-600",children:["Rp ",B.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:a.description,onChange:t=>i({...a,description:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:2})]}),p.length>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"Allocate to Purchase Invoices"}),e.jsx("div",{className:"max-h-48 overflow-y-auto border rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Invoice"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Balance"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Allocate"})]})}),e.jsx("tbody",{className:"divide-y",children:p.map(t=>{var s;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-mono",children:t.invoice_number}),e.jsx("div",{className:"text-gray-500 text-xs",children:new Date(t.invoice_date).toLocaleDateString("id-ID")})]}),e.jsxs("td",{className:"px-3 py-2 text-right text-red-600",children:["Rp ",t.balance_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",min:0,max:t.balance_amount,value:((s=y.find(r=>r.invoiceId===t.id))==null?void 0:s.amount)||"",onChange:r=>q(t.id,parseFloat(r.target.value)||0),className:"w-24 px-2 py-1 border rounded text-right",placeholder:"0"})})]},t.id)})})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>d(!1),className:"px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Save Payment"})]})]})})]})}export{de as PaymentVoucherManager};
