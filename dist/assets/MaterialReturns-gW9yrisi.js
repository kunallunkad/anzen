import{c as oe,r as h,j as e,X as de,u as ce,d as pe,s as m,e as ue,i as me,T as he,f as g,h as $}from"./index-CKfpb48H.js";import{P as xe,M as be}from"./Modal-5mKOe-a5.js";import{S as ge}from"./SearchableSelect--rmycQNW.js";import{D as ye}from"./DataTable-BA7PtZyw.js";import{P as je,h as fe,E as _e}from"./html2canvas.esm-orZ44ulK.js";import{D as ve}from"./download-BHGVBkDb.js";import{f as J}from"./dateFormat-E6B5rKFz.js";import{E as Ne}from"./eye-BxGXgDrB.js";import{S as we}from"./square-pen-qhCVKoGC.js";import{X as ke}from"./x-circle-CfqbOicI.js";import"./chevron-down-DyIIW3M8.js";import"./search-Doi2Y3_1.js";import"./chevron-up-SDMS78hZ.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const V=oe("PackageX",[["path",{d:"M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l2-1.14",key:"e7tb2h"}],["path",{d:"m7.5 4.27 9 5.15",key:"1c824w"}],["polyline",{points:"3.29 7 12 12 20.71 7",key:"ousv84"}],["line",{x1:"12",x2:"12",y1:"22",y2:"12",key:"a4e8g8"}],["path",{d:"m17 13 5 5m-5 0 5-5",key:"im3w4b"}]]);function Ce({materialReturn:i,items:d,onClose:L}){const k=h.useRef(null),I=l=>{const x=new Date(l),b=x.getDate(),y=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][x.getMonth()],f=x.getFullYear();return`${b} ${y} ${f}`},E=l=>l==null?"Rp 0,00":`Rp ${l.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,T=()=>{window.print()},O=async()=>{if(k.current)try{const l=await fe(k.current,{scale:2,useCORS:!0,allowTaint:!0,logging:!1,backgroundColor:"#ffffff",windowWidth:k.current.scrollWidth,windowHeight:k.current.scrollHeight,onclone:C=>{const v=C.getElementById("return-print-content");v&&(v.style.width="210mm")}}),x=l.toDataURL("image/png",1),b=new _e("p","mm","a4"),y=b.internal.pageSize.getWidth(),f=b.internal.pageSize.getHeight(),M=l.width,D=l.height,P=y/M,_=D*P;if(_>f){let C=0,v=_;for(;v>0;)b.addImage(x,"PNG",0,C,y,_),v-=f,C-=f,v>0&&b.addPage()}else b.addImage(x,"PNG",0,0,y,_);b.save(`MaterialReturn-${i.return_number}.pdf`)}catch(l){console.error("Error generating PDF:",l),alert("Failed to generate PDF. Please try again.")}},u=i.customers;return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 print:static print:bg-white print:overflow-visible",children:[e.jsx("div",{className:"flex min-h-screen items-start justify-center p-4 pt-10 print:p-0 print:min-h-0 print:block",children:e.jsxs("div",{className:"relative w-full max-w-5xl bg-white shadow-xl print:shadow-none print:max-w-full",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b bg-white px-6 py-4 print:hidden",children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:["Material Return ",i.return_number]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:T,className:"flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[e.jsx(je,{className:"h-4 w-4"}),"Print"]}),e.jsxs("button",{onClick:O,className:"flex items-center gap-2 rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700",children:[e.jsx(ve,{className:"h-4 w-4"}),"PDF"]}),e.jsx("button",{onClick:L,className:"rounded-lg bg-gray-100 p-2 text-gray-600 hover:bg-gray-200",children:e.jsx(de,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{id:"return-print-content",ref:k,className:"p-8",children:[e.jsxs("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:[e.jsxs("div",{className:"mb-2 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-16 w-16 flex items-center justify-center print:h-12 print:w-12",style:{backgroundColor:"#fff"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",width:"100%",height:"100%",viewBox:"0 0 15686.55 15480.24",style:{shapeRendering:"geometricPrecision",fillRule:"evenodd",clipRule:"evenodd"},children:e.jsxs("g",{children:[e.jsx("path",{fill:"#FDB763",d:"M69.94 10438.12l10353.39 0 0 -1798.67 1665.92 0 0 1868.6 0 320.44 0 4552.28c0,38.48 -31.45,69.94 -69.94,69.94l-11949.38 0c-38.48,0 -69.94,-31.45 -69.94,-69.94l0 -4872.72c0,-38.48 31.45,-69.94 69.94,-69.94zm1605.9 1710.15l8737.57 0c13.58,0 24.68,11.11 24.68,24.68l0 1719.84c0,13.58 -11.11,24.68 -24.68,24.68l-8737.57 0c-13.58,0 -24.68,-11.11 -24.68,-24.68l0 -1719.84c0,-13.58 11.11,-24.68 24.68,-24.68z"}),e.jsx("path",{fill:"#FDB763",d:"M15587.15 5136.67l-10353.49 0 0 1822.07 -1665.92 0 0 -1892.9 0 -324.61 0 -4611.43c0,-39 31.45,-70.87 69.94,-70.87l11949.47 0c38.48,0 69.94,31.87 69.94,70.87l0 4936.04c0,39 -31.45,70.83 -69.94,70.83zm-1605.9 -1732.36l-8737.67 0c-13.58,0 -24.68,-11.27 -24.68,-25l0 -1742.21c0,-13.74 11.11,-25 24.68,-25l8737.67 0c13.58,0 24.68,11.27 24.68,25l0 1742.21c0,13.74 -11.11,25 -24.68,25z"}),e.jsx("polygon",{fill:"#FD6D26",points:"-0,0 1651.16,0 1651.16,6929.27 15657.09,6929.27 15657.09,6958.74 15686.55,6958.74 15686.55,15480.24 14022.85,15480.24 14022.85,8639.45 1651.16,8639.45 -0,8639.45 -0,6929.27"})]})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-base font-bold print:text-sm",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Komplek Ruko Metro Sunter Blok A1 NO.15, Jl. Metro Indah Raya,"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Kelurahan Papanggo, Kec. Tanjung Priok, Jakarta Utara - 14340"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Telp: (+62 21) 65832426"})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("h2",{className:"text-3xl font-bold text-orange-600 print:text-2xl",children:"MATERIAL RETURN"})})]}),e.jsxs("div",{className:"text-xs space-y-0.5 print:text-[10px] print:space-y-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No izin PBF"}),e.jsx("span",{className:"ml-16",children:": 27092400534390007"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No Sertifikasi CDOB"}),e.jsx("span",{className:"ml-4",children:": 270924005343900070001"})]})]})]}),e.jsx("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 flex-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Customer:"}),e.jsxs("span",{className:"font-semibold",children:[" ",(u==null?void 0:u.company_name)||""]})]}),e.jsxs("div",{className:"pt-1 flex",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Address:"}),e.jsxs("div",{children:[e.jsx("p",{children:(u==null?void 0:u.address)||""}),e.jsx("p",{children:(u==null?void 0:u.city)||""})]})]}),e.jsxs("div",{className:"flex pt-1",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Phone:"}),e.jsx("span",{children:(u==null?void 0:u.phone)||""})]})]}),e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 text-right",style:{minWidth:"220px"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Return No:"}),e.jsx("span",{className:"ml-2",children:i.return_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Return Date:"}),e.jsx("span",{className:"ml-2",children:I(i.return_date)})]}),i.delivery_challans&&e.jsxs("div",{className:"pt-1",children:[e.jsx("span",{className:"font-bold",children:"Original DC:"}),e.jsx("span",{className:"ml-2",children:i.delivery_challans.challan_number})]}),e.jsxs("div",{className:"pt-1",children:[e.jsx("span",{className:"font-bold",children:"Return Type:"}),e.jsx("span",{className:"ml-2",children:i.return_type.replace("_"," ").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Status:"}),e.jsx("span",{className:`ml-2 px-2 py-0.5 rounded text-xs font-semibold ${i.status==="approved"?"bg-green-100 text-green-800":i.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:i.status.replace("_"," ").toUpperCase()})]})]})]})}),e.jsx("div",{children:e.jsxs("table",{className:"w-full border-2 border-black text-xs print:text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-black bg-white",children:[e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"No."}),e.jsx("th",{className:"border-r border-black p-1.5 text-left font-bold print:p-1",children:"Product Name"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Batch No."}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Original Qty"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Return Qty"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Condition"}),e.jsx("th",{className:"border-r border-black p-1.5 text-right font-bold print:p-1",children:"Unit Price"}),e.jsx("th",{className:"p-1.5 text-right font-bold print:p-1",children:"Total"})]})}),e.jsxs("tbody",{children:[d.map((l,x)=>{var y,f;const b=l.quantity_returned*l.unit_price;return e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:x+1}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:((y=l.products)==null?void 0:y.product_name)||"Unknown Product"}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:((f=l.batches)==null?void 0:f.batch_number)||"N/A"}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:l.original_quantity.toLocaleString()}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:l.quantity_returned.toLocaleString()}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:l.condition.toUpperCase()}),e.jsx("td",{className:"border-r border-black p-1.5 text-right print:p-1",children:E(l.unit_price)}),e.jsx("td",{className:"p-1.5 text-right print:p-1",children:E(b)})]},l.id||x)}),d.length<2&&Array.from({length:2-d.length}).map((l,x)=>e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"p-1.5 print:p-1",children:" "})]},`empty-${x}`))]})]})}),e.jsxs("div",{className:"border-2 border-black border-t-0",children:[e.jsxs("div",{className:"flex items-stretch border-b-2 border-black",children:[e.jsxs("div",{className:"flex-1 p-2 border-r-2 border-black print:p-1.5",children:[e.jsx("p",{className:"text-xs font-bold print:text-[10px]",children:"Return Reason:"}),e.jsx("p",{className:"text-xs mt-0.5 print:text-[10px] print:mt-0",children:i.return_reason})]}),e.jsx("div",{className:"w-64 text-xs p-2 print:text-[10px] print:p-1.5",children:e.jsxs("div",{className:"flex justify-between border-t-2 border-black py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"Total Value"}),e.jsx("span",{className:"font-bold text-sm text-orange-600 print:text-xs",children:E(i.financial_impact||0)})]})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-0 text-xs print:text-[10px]",children:[e.jsxs("div",{className:"p-3 border-r-2 border-black print:p-2 text-center",children:[e.jsx("p",{className:"font-semibold mb-12 print:mb-10",children:"Prepared By"}),e.jsx("div",{className:"border-t border-black pt-1 mx-4",children:"Name & Signature"})]}),e.jsxs("div",{className:"p-3 border-r-2 border-black print:p-2 text-center",children:[e.jsx("p",{className:"font-semibold mb-12 print:mb-10",children:"Checked By"}),e.jsx("div",{className:"border-t border-black pt-1 mx-4",children:"QC / Manager"})]}),e.jsxs("div",{className:"p-3 print:p-2 text-center",children:[e.jsx("p",{className:"font-semibold mb-1",children:"Approved By"}),e.jsx("p",{className:"font-semibold mb-9 print:mb-7",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("div",{className:"border-t border-black pt-1 mx-4",children:"Pharmacist"})]})]})]}),i.notes&&e.jsx("div",{className:"mt-3 border-2 border-black p-2 print:mt-2 print:p-1.5",children:e.jsxs("p",{className:"text-xs print:text-[10px]",children:[e.jsx("span",{className:"font-bold",children:"Additional Notes: "}),e.jsx("span",{children:i.notes})]})})]})]})}),e.jsx("style",{children:`
        @media print {
          @page {
            size: A4 portrait;
            margin: 8mm;
          }

          .sticky {
            display: none !important;
          }

          body {
            margin: 0;
            padding: 0;
          }

          body * {
            visibility: hidden;
          }

          #return-print-content,
          #return-print-content * {
            visibility: visible;
          }

          #return-print-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            page-break-inside: avoid;
            page-break-after: auto;
          }

          #return-print-content > div {
            page-break-inside: avoid;
          }

          table {
            page-break-inside: auto;
          }

          tr {
            page-break-inside: avoid;
            page-break-after: auto;
          }

          thead {
            display: table-header-group;
          }

          tfoot {
            display: table-footer-group;
          }
        }
      `})]})}function He(){const{user:i,profile:d}=ce(),{t:L}=pe(),[k,I]=h.useState([]),[E,T]=h.useState(!0),[O,u]=h.useState(!1),[l,x]=h.useState(!1),[b,y]=h.useState(null),[f,M]=h.useState([]),[D,P]=h.useState(!1),[_,C]=h.useState(null),[v,X]=h.useState([]),[W,B]=h.useState([]),[H,R]=h.useState([]),[U,q]=h.useState([]),[a,N]=h.useState({customer_id:"",original_dc_id:"",return_date:new Date().toISOString().split("T")[0],return_type:"quality_issue",return_reason:"",notes:""});h.useEffect(()=>{S(),G()},[]);const S=async()=>{try{const{data:r,error:t}=await m.from("material_returns").select(`
          *,
          customers(company_name, address, city, phone),
          delivery_challans(challan_number)
        `).order("created_at",{ascending:!1});if(t)throw t;I(r||[])}catch(r){console.error("Error loading returns:",r)}finally{T(!1)}},G=async()=>{try{const{data:r,error:t}=await m.from("customers").select("id, company_name").eq("is_active",!0).order("company_name");if(t)throw t;X(r||[])}catch(r){console.error("Error loading customers:",r)}},Q=async r=>{try{const{data:t,error:s}=await m.from("sales_invoices").select("linked_challan_ids").not("linked_challan_ids","is",null);if(s)throw s;const n=new Set;(t||[]).forEach(j=>{j.linked_challan_ids&&Array.isArray(j.linked_challan_ids)&&j.linked_challan_ids.forEach(p=>n.add(p))});const{data:o,error:c}=await m.from("delivery_challans").select("id, challan_number, challan_date, customer_id").eq("customer_id",r).order("challan_date",{ascending:!1});if(c)throw c;const w=(o||[]).filter(j=>!n.has(j.id));B(w)}catch(t){console.error("Error loading delivery challans:",t)}},K=async r=>{try{const{data:t,error:s}=await m.from("delivery_challan_items").select(`
          product_id,
          batch_id,
          quantity,
          products(product_name, product_code),
          batches(batch_number, import_price, duty_charges, freight_charges, other_charges, import_quantity)
        `).eq("challan_id",r);if(s)throw s;R(t||[]);const n=(t||[]).map(o=>{const c=o.batches;let w=0;return c&&c.import_quantity>0&&(w=Math.round((c.import_price+c.duty_charges+c.freight_charges+c.other_charges)/c.import_quantity*1.25)),{product_id:o.product_id,batch_id:o.batch_id,quantity_returned:0,original_quantity:o.quantity,unit_price:w,condition:"good",disposition:"pending",notes:""}});q(n)}catch(t){console.error("Error loading challan items:",t)}},Y=r=>{N({...a,customer_id:r,original_dc_id:""}),R([]),q([]),r?Q(r):B([])},Z=r=>{N({...a,original_dc_id:r}),r?K(r):(R([]),q([]))},A=(r,t,s)=>{const n=[...U];n[r]={...n[r],[t]:s},q(n)},ee=async r=>{if(r.preventDefault(),!a.customer_id||!a.original_dc_id||!a.return_reason){g({type:"error",title:"Error",message:"Please complete all required fields"});return}const t=U.filter(n=>n.quantity_returned>0);if(t.length===0){g({type:"error",title:"Error",message:"Please enter at least one item with return quantity"});return}if(t.some(n=>n.quantity_returned>n.original_quantity)){g({type:"error",title:"Error",message:"Return quantity cannot exceed original quantity"});return}try{const n=t.reduce((o,c)=>o+c.quantity_returned*c.unit_price,0);if(D&&_){const{error:o}=await m.from("material_returns").update({customer_id:a.customer_id,original_dc_id:a.original_dc_id,return_date:a.return_date,return_type:a.return_type,return_reason:a.return_reason,notes:a.notes,financial_impact:n}).eq("id",_).eq("status","pending_approval");if(o)throw o;const{error:c}=await m.from("material_return_items").delete().eq("return_id",_);if(c)throw c;const w=t.map(p=>({return_id:_,product_id:p.product_id,batch_id:p.batch_id,quantity_returned:p.quantity_returned,original_quantity:p.original_quantity,unit_price:p.unit_price,condition:p.condition,disposition:p.disposition,notes:p.notes})),{error:j}=await m.from("material_return_items").insert(w);if(j)throw j;g({type:"success",title:"Success",message:"Material return updated successfully."})}else{const{data:o,error:c}=await m.from("material_returns").insert({customer_id:a.customer_id,original_dc_id:a.original_dc_id,return_date:a.return_date,return_type:a.return_type,return_reason:a.return_reason,notes:a.notes,financial_impact:n,status:"pending_approval",created_by:i==null?void 0:i.id}).select().single();if(c)throw c;const w=t.map(p=>({return_id:o.id,product_id:p.product_id,batch_id:p.batch_id,quantity_returned:p.quantity_returned,original_quantity:p.original_quantity,unit_price:p.unit_price,condition:p.condition,disposition:p.disposition,notes:p.notes})),{error:j}=await m.from("material_return_items").insert(w);if(j)throw j;g({type:"success",title:"Success",message:"Material return created successfully. Pending approval."})}u(!1),F(),S()}catch(n){console.error("Error saving return:",n),g({type:"error",title:"Error",message:n.message||"Failed to save material return"})}},re=async r=>{try{const{data:t,error:s}=await m.from("material_return_items").select(`
          *,
          products(product_name, product_code),
          batches(batch_number)
        `).eq("return_id",r.id);if(s)throw s;y(r),M(t||[]),x(!0)}catch(t){console.error("Error loading return items:",t),g({type:"error",title:"Error",message:"Failed to load return details"})}},te=async r=>{try{const{data:t,error:s}=await m.from("material_return_items").select(`
          *,
          products(product_name, product_code),
          batches(batch_number, import_price, duty_charges, freight_charges, other_charges, import_quantity)
        `).eq("return_id",r.id);if(s)throw s;N({customer_id:r.customer_id,original_dc_id:r.original_dc_id,return_date:r.return_date,return_type:r.return_type,return_reason:r.return_reason,notes:r.notes||""}),await Q(r.customer_id),await K(r.original_dc_id);const n=(t||[]).map(o=>({product_id:o.product_id,batch_id:o.batch_id,quantity_returned:o.quantity_returned,original_quantity:o.original_quantity,unit_price:o.unit_price,condition:o.condition,disposition:o.disposition,notes:o.notes||""}));q(n),P(!0),C(r.id),u(!0)}catch(t){console.error("Error loading return for edit:",t),g({type:"error",title:"Error",message:"Failed to load return for editing"})}},se=async r=>{if(await $({title:"Confirm",message:"Approve this material return? Stock will be added back to inventory based on disposition.",variant:"warning"}))try{const{error:t}=await m.from("material_returns").update({status:"approved",approved_by:i==null?void 0:i.id,restocked:!0}).eq("id",r);if(t)throw t;g({type:"success",title:"Success",message:"Material return approved successfully"}),S()}catch(t){console.error("Error approving return:",t),g({type:"error",title:"Error",message:t.message||"Failed to approve material return"})}},ae=async r=>{const t=prompt("Enter reason for rejection:");if(t)try{const{error:s}=await m.from("material_returns").update({status:"rejected",approved_by:i==null?void 0:i.id,notes:t}).eq("id",r);if(s)throw s;g({type:"success",title:"Success",message:"Material return rejected"}),S()}catch(s){console.error("Error rejecting return:",s),g({type:"error",title:"Error",message:s.message||"Failed to reject material return"})}},ne=async r=>{if(await $({title:"Confirm",message:"Are you sure you want to delete this material return?",variant:"danger",confirmLabel:"Delete"}))try{const{error:t}=await m.from("material_returns").delete().eq("id",r);if(t)throw t;S()}catch(t){console.error("Error deleting return:",t),g({type:"error",title:"Error",message:"Failed to delete material return"})}},F=()=>{N({customer_id:"",original_dc_id:"",return_date:new Date().toISOString().split("T")[0],return_type:"quality_issue",return_reason:"",notes:""}),R([]),q([]),B([]),P(!1),C(null)},z=(d==null?void 0:d.role)==="admin"||(d==null?void 0:d.role)==="sales"||(d==null?void 0:d.role)==="manager",ie=(d==null?void 0:d.role)==="admin"||(d==null?void 0:d.role)==="manager",le=[{key:"return_number",label:"Return #",render:(r,t)=>t.return_number||"Pending"},{key:"return_date",label:"Date",render:(r,t)=>J(t.return_date)},{key:"customer",label:"Customer",render:(r,t)=>{var s;return((s=t.customers)==null?void 0:s.company_name)||"N/A"}},{key:"dc_number",label:"Original DC",render:(r,t)=>{var s;return((s=t.delivery_challans)==null?void 0:s.challan_number)||"N/A"}},{key:"return_type",label:"Type",render:(r,t)=>t.return_type.replace("_"," ")},{key:"status",label:"Status",render:(r,t)=>e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${t.status==="approved"?"bg-green-100 text-green-800":t.status==="rejected"?"bg-red-100 text-red-800":t.status==="completed"?"bg-blue-100 text-blue-800":"bg-yellow-100 text-yellow-800"}`,children:t.status.replace("_"," ")})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Material Returns"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage physical returns before invoicing"})]}),z&&e.jsxs("button",{onClick:()=>{F(),u(!0)},className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition",children:[e.jsx(xe,{className:"w-5 h-5"}),"Create Material Return"]})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex gap-3",children:[e.jsx(ue,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"Material Returns vs Credit Notes:"}),e.jsx("p",{className:"mt-1",children:"Use Material Returns for physical goods returned BEFORE invoice is made (e.g., DC 100kg → return 20kg). For returns AFTER invoice filing, use Credit Notes."})]})]}),e.jsx(ye,{columns:le,data:k,loading:E,actions:r=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>re(r),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"View Return",children:e.jsx(Ne,{className:"w-4 h-4"})}),z&&r.status==="pending_approval"&&e.jsx("button",{onClick:()=>te(r),className:"p-1 text-yellow-600 hover:bg-yellow-50 rounded",title:"Edit Return",children:e.jsx(we,{className:"w-4 h-4"})}),ie&&r.status==="pending_approval"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>se(r.id),className:"p-1 text-green-600 hover:bg-green-50 rounded",title:"Approve Return",children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ae(r.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Reject Return",children:e.jsx(ke,{className:"w-4 h-4"})})]}),z&&r.status==="pending_approval"&&e.jsx("button",{onClick:()=>ne(r.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete Return",children:e.jsx(he,{className:"w-4 h-4"})})]})}),e.jsx(be,{isOpen:O,onClose:()=>{u(!1),F()},title:D?"Edit Material Return":"Create Material Return",size:"xl",children:e.jsxs("form",{onSubmit:ee,className:"space-y-6",children:[e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(V,{className:"w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-blue-800",children:[e.jsx("p",{className:"font-medium",children:"How Material Returns Work:"}),e.jsxs("ol",{className:"mt-1 list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Select the customer who is returning goods"}),e.jsx("li",{children:"Choose the Delivery Challan that was originally dispatched"}),e.jsx("li",{children:"The system will show all products, batches, quantities, and prices from that DC"}),e.jsx("li",{children:"Enter the quantity being returned for each item"}),e.jsx("li",{children:"After approval, stock will be added back to inventory"})]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer *"}),e.jsx(ge,{value:a.customer_id,onChange:r=>Y(r),options:v.map(r=>({value:r.id,label:r.company_name})),placeholder:"Select Customer"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Original Delivery Challan *"}),e.jsxs("select",{value:a.original_dc_id,onChange:r=>Z(r.target.value),required:!0,disabled:!a.customer_id,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select Delivery Challan"}),W.map(r=>e.jsxs("option",{value:r.id,children:[r.challan_number," - ",J(r.challan_date)]},r.id))]}),a.customer_id&&W.length===0&&e.jsx("p",{className:"text-xs text-orange-600 mt-1",children:"No uninvoiced delivery challans found. All DCs are already invoiced - use Credit Notes for returns after invoicing."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Return Date *"}),e.jsx("input",{type:"date",value:a.return_date,onChange:r=>N({...a,return_date:r.target.value}),required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Return Type *"}),e.jsxs("select",{value:a.return_type,onChange:r=>N({...a,return_type:r.target.value}),required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent",children:[e.jsx("option",{value:"quality_issue",children:"Quality Issue"}),e.jsx("option",{value:"wrong_product",children:"Wrong Product"}),e.jsx("option",{value:"excess_quantity",children:"Excess Quantity"}),e.jsx("option",{value:"damaged",children:"Damaged"}),e.jsx("option",{value:"expired",children:"Expired"}),e.jsx("option",{value:"other",children:"Other"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Return Reason *"}),e.jsx("textarea",{value:a.return_reason,onChange:r=>N({...a,return_reason:r.target.value}),required:!0,rows:3,placeholder:"Explain why the goods are being returned...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),H.length>0&&e.jsxs("div",{className:"border-t pt-6",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-4",children:"Items from Delivery Challan"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"Enter the quantity being returned for each item. Leave as 0 if not returning that item."}),e.jsx("div",{className:"space-y-3",children:H.map((r,t)=>{const s=U[t];return s?e.jsxs("div",{className:"p-4 bg-gray-50 rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"grid grid-cols-12 gap-4",children:[e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Product"}),e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.products.product_name}),e.jsxs("div",{className:"text-xs text-gray-500",children:["Code: ",r.products.product_code]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Batch"}),e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.batches.batch_number})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Dispatched Qty (Kg)"}),e.jsxs("div",{className:"text-sm font-medium text-blue-600",children:[r.quantity," Kg"]})]}),e.jsxs("div",{className:"col-span-1",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Unit Price (per Kg)"}),e.jsx("div",{className:"text-sm font-medium text-gray-900",children:s.unit_price.toLocaleString()})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Return Qty (Kg) *"}),e.jsx("input",{type:"number",step:"0.01",value:s.quantity_returned||"",onChange:n=>A(t,"quantity_returned",parseFloat(n.target.value)||0),max:r.quantity,min:"0",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500",placeholder:"Enter Kg"}),s.quantity_returned>r.quantity&&e.jsxs("p",{className:"text-xs text-red-600 mt-1",children:["Cannot exceed ",r.quantity]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Condition"}),e.jsxs("select",{value:s.condition,onChange:n=>A(t,"condition",n.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"good",children:"Good"}),e.jsx("option",{value:"damaged",children:"Damaged"}),e.jsx("option",{value:"expired",children:"Expired"}),e.jsx("option",{value:"unusable",children:"Unusable"})]})]})]}),s.quantity_returned>0&&e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Disposition"}),e.jsxs("select",{value:s.disposition,onChange:n=>A(t,"disposition",n.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500",children:[e.jsx("option",{value:"pending",children:"Pending Decision"}),e.jsx("option",{value:"restock",children:"Restock"}),e.jsx("option",{value:"scrap",children:"Scrap"}),e.jsx("option",{value:"return_to_supplier",children:"Return to Supplier"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Notes (optional)"}),e.jsx("input",{type:"text",value:s.notes||"",onChange:n=>A(t,"notes",n.target.value),placeholder:"Any additional notes...",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-green-500"})]})]})]},t):null})})]}),H.length===0&&a.original_dc_id&&e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(V,{className:"w-12 h-12 mx-auto mb-2 text-gray-400"}),e.jsx("p",{children:"No items found in the selected delivery challan"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional Notes"}),e.jsx("textarea",{value:a.notes,onChange:r=>N({...a,notes:r.target.value}),rows:2,placeholder:"Any additional information...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-6 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{u(!1),F()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition",children:D?"Update Material Return":"Create Material Return"})]})]})}),l&&b&&e.jsx(Ce,{materialReturn:b,items:f,onClose:()=>{x(!1),y(null),M([])}})]})}export{He as default};
