import{d as ae,u as oe,r as p,s as i,j as e,T as A,X as B,f as x,h as w}from"./index-05MON0zc.js";import{L as ie}from"./Layout-9pjiZa2A.js";import{D as le}from"./DataTable-DghMVdqP.js";import{M}from"./Modal-DojL8f5j.js";import{P as T}from"./plus-C8ciBmA_.js";import{S as ce}from"./square-pen-pND7Nsfd.js";import{U as ne}from"./upload-BdstOxEa.js";import"./dateFormat-E6B5rKFz.js";import"./search-CGgsAlNq.js";import"./chevron-up-TszMf-vQ.js";import"./chevron-down-C44n7mhs.js";function je(){var U,F,O;const{t:d}=ae(),{profile:g}=oe(),[G,R]=p.useState([]),[$,k]=p.useState(!0),[z,b]=p.useState(!1),[V,P]=p.useState(!1),[u,C]=p.useState(null),[S,v]=p.useState([]),[y,D]=p.useState(null),[o,m]=p.useState({product_name:"",hsn_code:"",category:"api",unit:"kg",packaging_type:"",default_supplier:"",description:"",min_stock_level:"",duty_a1:""}),[h,f]=p.useState([{source_name:"",grade:"BP",files:[]}]);p.useEffect(()=>{N()},[]);const N=async()=>{try{k(!0);const{data:t,error:s}=await i.from("products").select("*").eq("is_active",!0).order("product_name");if(s)throw s;R(t||[])}catch(t){console.error("Error loading products:",t)}finally{k(!1)}},E=async t=>{try{const{data:s,error:r}=await i.from("product_sources").select(`
          id,
          supplier_name,
          grade,
          country,
          remarks,
          created_at
        `).eq("product_id",t).order("created_at",{ascending:!1});if(r)throw r;const c=await Promise.all((s||[]).map(async l=>{const{data:n}=await i.from("product_source_documents").select("*").eq("source_id",l.id);return{...l,documents:n||[]}})),{data:a}=await i.from("product_documents").select("*").eq("product_id",t);if(a&&a.length>0){const l={id:"default",supplier_name:"Product Documents",grade:"-",country:null,remarks:"General product documents",created_at:new Date().toISOString(),documents:a.map(n=>({id:n.id,doc_type:n.document_type,original_filename:n.file_name,file_url:n.file_url,file_size:n.file_size}))};v([l,...c])}else v(c)}catch(s){console.error("Error loading sources:",s)}},W=async t=>{C(t),await E(t.id),P(!0)},K=()=>{f([...h,{source_name:"",grade:"BP",files:[]}])},H=t=>{h.length>1&&f(h.filter((s,r)=>r!==t))},q=(t,s,r)=>{const c=[...h];c[t]={...c[t],[s]:r},f(c)},J=(t,s)=>{if(!s)return;const r=[...h];r[t].files=[...r[t].files,...Array.from(s)],f(r)},X=(t,s)=>{const r=[...h];r[t].files=r[t].files.filter((c,a)=>a!==s),f(r)},Q=async t=>{var r;D(t),m({product_name:t.product_name,hsn_code:t.hsn_code,category:t.category,unit:t.unit,packaging_type:t.packaging_type||"",default_supplier:t.default_supplier||"",description:t.description||"",min_stock_level:((r=t.min_stock_level)==null?void 0:r.toString())||"",duty_a1:t.duty_a1||""});const{data:s}=await i.from("product_sources").select(`
        id,
        supplier_name,
        grade
      `).eq("product_id",t.id);if(s&&s.length>0){const c=await Promise.all(s.map(async a=>{const{data:l}=await i.from("product_source_documents").select("*").eq("source_id",a.id);return{id:a.id,source_name:a.supplier_name||"",grade:a.grade||"BP",files:[],existing_docs:l||[]}}));f(c)}else f([{source_name:"",grade:"BP",files:[]}]);b(!0)},Y=async t=>{try{const{data:s}=await i.from("sales_invoice_items").select("id").eq("product_id",t.id).limit(1);if(s&&s.length>0){x({type:"error",title:"Error",message:'Cannot delete this product. It has been used in sales invoices. Please use the "Deactivate" option instead or contact your administrator.'});return}const{data:r}=await i.from("sales_order_items").select("id").eq("product_id",t.id).limit(1);if(r&&r.length>0){x({type:"error",title:"Error",message:"Cannot delete this product. It has been used in sales orders. Please deactivate it instead."});return}const{data:c}=await i.from("delivery_challan_items").select("id").eq("product_id",t.id).limit(1);if(c&&c.length>0){x({type:"error",title:"Error",message:'Cannot delete this product. It has been used in delivery challans. Please use the "Deactivate" option instead.'});return}const{data:a}=await i.from("batches").select("id, batch_number").eq("product_id",t.id);if(a&&a.length>0){if(!await w({title:"Confirm",message:`This product has ${a.length} batch(es). Deleting this product will permanently remove:
- ${a.length} batches
- All related inventory transactions
- All related documents

Are you absolutely sure you want to continue?`,variant:"danger",confirmLabel:"Delete"}))return}else if(!await w({title:"Confirm",message:"Are you sure you want to delete this product?",variant:"danger",confirmLabel:"Delete"}))return;if(a&&a.length>0){for(const n of a)await i.from("batch_documents").delete().eq("batch_id",n.id),await i.from("inventory_transactions").delete().eq("batch_id",n.id),await i.from("finance_expenses").delete().eq("batch_id",n.id);await i.from("batches").delete().eq("product_id",t.id)}await i.from("inventory_transactions").delete().eq("product_id",t.id),await i.from("product_files").delete().eq("product_id",t.id);const{error:l}=await i.from("products").delete().eq("id",t.id);if(l)throw l;x({type:"success",title:"Success",message:"Product deleted successfully"}),await N()}catch(s){console.error("Error deleting product:",s);const r=(s==null?void 0:s.message)||"Unknown error occurred";x({type:"error",title:"Error",message:`Failed to delete product: ${r}

If this product is in use, consider deactivating it instead.`})}},_=()=>{D(null),m({product_name:"",hsn_code:"",category:"api",unit:"kg",packaging_type:"",default_supplier:"",description:"",min_stock_level:"",duty_a1:""}),f([{source_name:"",grade:"BP",files:[]}])},Z=async t=>{t.preventDefault();try{const s=parseFloat(o.min_stock_level)||null,r={product_name:o.product_name,product_code:null,hsn_code:o.hsn_code,category:o.category,unit:o.unit,packaging_type:o.packaging_type,default_supplier:o.default_supplier,description:o.description,min_stock_level:s,duty_a1:o.duty_a1||null};let c;if(y){const{error:a}=await i.from("products").update(r).eq("id",y.id);if(a)throw a;c=y.id}else{const{data:a,error:l}=await i.from("products").insert([{...r,created_by:g==null?void 0:g.id}]).select().single();if(l)throw l;c=a.id}for(const a of h){if(!a.source_name.trim())continue;let l;if(a.id){const{error:n}=await i.from("product_sources").update({supplier_name:a.source_name,grade:a.grade}).eq("id",a.id);if(n)throw n;l=a.id}else{const{data:n,error:j}=await i.from("product_sources").insert([{product_id:c,supplier_name:a.source_name,grade:a.grade,created_by:g==null?void 0:g.id}]).select().single();if(j)throw j;l=n.id}for(const n of a.files){const j=n.name.split(".").pop(),I=`${c}/${l}/${Date.now()}.${j}`,{error:L}=await i.storage.from("product-source-documents").upload(I,n);if(L){console.error("Upload error:",L);continue}const{data:re}=i.storage.from("product-source-documents").getPublicUrl(I);await i.from("product_source_documents").insert([{source_id:l,doc_type:"Other",file_url:re.publicUrl,original_filename:n.name,file_size:n.size,uploaded_by:g==null?void 0:g.id}])}}x({type:"success",title:"Success",message:y?"Product updated successfully":"Product added successfully"}),b(!1),_(),await N()}catch(s){console.error("Error saving product:",s),x({type:"error",title:"Error",message:"Failed to save product: "+s.message})}},ee=async(t,s)=>{try{const c=await(await fetch(t)).blob(),a=window.URL.createObjectURL(c),l=document.createElement("a");l.href=a,l.download=s,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(a),document.body.removeChild(l)}catch(r){console.error("Error downloading:",r),x({type:"error",title:"Error",message:"Failed to download file"})}},te=async(t,s)=>{if(await w({title:"Confirm",message:"Delete this document?",variant:"danger",confirmLabel:"Delete"}))try{const{error:r}=await i.from("product_source_documents").delete().eq("id",t);if(r)throw r;x({type:"success",title:"Success",message:"Document deleted"}),u&&await E(u.id)}catch(r){console.error("Error deleting document:",r),x({type:"error",title:"Error",message:"Failed to delete: "+r.message})}},se=[{key:"product_name",label:d("products.productName"),render:(t,s)=>e.jsx("button",{onClick:()=>W(s),className:"text-blue-600 hover:text-blue-800 font-medium text-left",children:t||"-"})},{key:"hsn_code",label:d("products.hsnCode")},{key:"category",label:d("products.category"),render:t=>t&&typeof t=="string"?t.toUpperCase():"-"},{key:"unit",label:d("products.unit"),render:t=>t&&typeof t=="string"?t.toUpperCase():"-"},{key:"current_stock",label:d("products.currentStock"),render:t=>t!=null&&typeof t=="number"?t.toFixed(2):"-"},{key:"duty_a1",label:d("products.dutyA1")}];return e.jsxs(ie,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:d("products.title")}),e.jsx("p",{className:"text-gray-600",children:"Manage your product catalog with packaging details"})]}),e.jsxs("button",{onClick:()=>{_(),b(!0)},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:[e.jsx(T,{className:"w-4 h-4"}),d("products.addProduct")]})]}),e.jsx(le,{data:G,columns:se,loading:$,actions:t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>Q(t),className:"p-1 text-blue-600 hover:bg-blue-50 rounded transition",children:e.jsx(ce,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Y(t),className:"p-1 text-red-600 hover:bg-red-50 rounded transition",children:e.jsx(A,{className:"w-4 h-4"})})]})})]}),e.jsx(M,{isOpen:z,onClose:()=>{b(!1),_()},title:d(y?"products.editProduct":"products.addProduct"),maxWidth:"max-w-4xl",children:e.jsxs("form",{onSubmit:Z,className:"space-y-6",children:[e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg space-y-4",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Product Details"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[d("products.productName")," *"]}),e.jsx("input",{type:"text",required:!0,value:o.product_name,onChange:t=>m({...o,product_name:t.target.value}),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[d("products.hsnCode")," *"]}),e.jsx("input",{type:"text",required:!0,value:o.hsn_code,onChange:t=>m({...o,hsn_code:t.target.value}),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[d("products.category")," *"]}),e.jsxs("select",{required:!0,value:o.category,onChange:t=>m({...o,category:t.target.value}),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"api",children:"API"}),e.jsx("option",{value:"excipients",children:"Excipients"}),e.jsx("option",{value:"packaging",children:"Packaging"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[d("products.unit")," *"]}),e.jsxs("select",{required:!0,value:o.unit,onChange:t=>m({...o,unit:t.target.value}),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"kg",children:"KG"}),e.jsx("option",{value:"liter",children:"Liter"}),e.jsx("option",{value:"pieces",children:"Pieces"}),e.jsx("option",{value:"box",children:"Box"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:d("products.minStockLevel")}),e.jsx("input",{type:"number",step:"0.01",value:o.min_stock_level,onChange:t=>m({...o,min_stock_level:t.target.value}),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:d("products.packagingType")}),e.jsx("input",{type:"text",value:o.packaging_type,onChange:t=>m({...o,packaging_type:t.target.value}),placeholder:"e.g., 25kg drum",className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[d("products.dutyA1")," (%)"]}),e.jsx("input",{type:"text",value:o.duty_a1,onChange:t=>m({...o,duty_a1:t.target.value}),placeholder:"e.g., 5.0",className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:o.description,onChange:t=>m({...o,description:t.target.value}),rows:2,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-lg space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:"Sources"}),e.jsxs("button",{type:"button",onClick:K,className:"flex items-center gap-1 px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:[e.jsx(T,{className:"w-3 h-3"}),"Add Source"]})]}),h.map((t,s)=>e.jsxs("div",{className:"bg-white p-4 rounded-lg border border-blue-200 space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1 grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Source Name"}),e.jsx("input",{type:"text",value:t.source_name,onChange:r=>q(s,"source_name",r.target.value),placeholder:"e.g., Everest Organics",className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Grade"}),e.jsxs("select",{value:t.grade,onChange:r=>q(s,"grade",r.target.value),className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"BP",children:"BP (British Pharmacopoeia)"}),e.jsx("option",{value:"USP",children:"USP (United States Pharmacopeia)"}),e.jsx("option",{value:"EP",children:"EP (European Pharmacopoeia)"}),e.jsx("option",{value:"IP",children:"IP (Indian Pharmacopoeia)"}),e.jsx("option",{value:"Tech",children:"Tech Grade"}),e.jsx("option",{value:"Food Grade",children:"Food Grade"}),e.jsx("option",{value:"Industrial",children:"Industrial"}),e.jsx("option",{value:"Other",children:"Other"})]})]})]}),h.length>1&&e.jsx("button",{type:"button",onClick:()=>H(s),className:"ml-2 p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx(B,{className:"w-4 h-4"})})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Upload Documents"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("label",{className:"flex items-center gap-2 px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg cursor-pointer hover:bg-gray-100",children:[e.jsx(ne,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm text-gray-600",children:"Choose Files"}),e.jsx("input",{type:"file",multiple:!0,onChange:r=>J(s,r.target.files),className:"hidden",accept:".pdf,.doc,.docx,.jpg,.jpeg,.png"})]}),e.jsx("span",{className:"text-xs text-gray-500",children:"PDF, DOC, JPG (Max 10MB each)"})]}),t.files.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:t.files.map((r,c)=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-gray-50 rounded text-sm",children:[e.jsx("span",{className:"text-gray-700",children:r.name}),e.jsx("button",{type:"button",onClick:()=>X(s,c),className:"text-red-600 hover:text-red-800",children:e.jsx(B,{className:"w-4 h-4"})})]},c))}),t.existing_docs&&t.existing_docs.length>0&&e.jsxs("div",{className:"mt-2 space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600",children:"Existing Documents:"}),t.existing_docs.map(r=>e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 bg-green-50 rounded text-sm",children:[e.jsx("span",{className:"text-gray-700",children:r.original_filename}),e.jsxs("span",{className:"text-xs text-gray-500",children:[(r.file_size/1024).toFixed(1)," KB"]})]},r.id))]})]})]},s))]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{b(!1),_()},className:"px-4 py-2 text-gray-700 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:y?"Update Product":"Add Product"})]})]})}),e.jsx(M,{isOpen:V,onClose:()=>{P(!1),C(null),v([])},title:(u==null?void 0:u.product_name)||"Product Details",maxWidth:"max-w-5xl",children:u&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-4 gap-4 p-4 bg-gray-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"HSN Code"}),e.jsx("p",{className:"font-medium",children:u.hsn_code})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Category"}),e.jsx("p",{className:"font-medium",children:(U=u.category)==null?void 0:U.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Unit"}),e.jsx("p",{className:"font-medium",children:(F=u.unit)==null?void 0:F.toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Current Stock"}),e.jsx("p",{className:"font-medium",children:((O=u.current_stock)==null?void 0:O.toFixed(2))||"0.00"})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"Sources & Documents"}),S.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No sources added yet. Edit the product to add sources."}):e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Source Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Grade"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Documents"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:S.map(t=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-medium",children:t.supplier_name}),e.jsx("td",{className:"px-4 py-3",children:t.grade}),e.jsx("td",{className:"px-4 py-3",children:t.documents.length===0?e.jsx("span",{className:"text-gray-400 text-sm",children:"No documents"}):e.jsx("div",{className:"space-y-1",children:t.documents.map(s=>e.jsxs("div",{className:"flex items-center justify-between gap-2 text-sm",children:[e.jsx("button",{onClick:()=>ee(s.file_url,s.original_filename),className:"text-blue-600 hover:text-blue-800 flex-1 text-left",children:s.original_filename}),e.jsx("button",{onClick:()=>te(s.id,t.id),className:"text-red-600 hover:text-red-800 p-1",children:e.jsx(A,{className:"w-3 h-3"})})]},s.id))})})]},t.id))})]})})]})]})})]})}export{je as Products};
