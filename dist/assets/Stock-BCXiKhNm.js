import{d as z,a as V,r as i,s as u,j as e,e as f,C as G}from"./index-C6UjJy9t.js";import{L as H,P as g,T as J}from"./Layout-cYEGBOjJ.js";import{D as j}from"./DataTable-CFQM2mrx.js";import"./search-CWB-ZnVC.js";import"./chevron-up-BctZjBOj.js";import"./chevron-down-OscdQjjm.js";function ee(){const{t:a}=z(),{setCurrentPage:v}=V(),[o,k]=i.useState([]),[p,N]=i.useState(!0),[n,_]=i.useState(null),[w,S]=i.useState([]);i.useEffect(()=>{q()},[]);const q=async()=>{try{const{data:s,error:t}=await u.from("product_stock_summary").select("*").order("product_name");if(t)throw t;const{data:c}=await u.from("import_requirements").select("product_id, shortage_quantity").in("status",["pending","ordered"]),l=new Map;c==null||c.forEach(r=>{const d=l.get(r.product_id)||0;l.set(r.product_id,d+Number(r.shortage_quantity))});const A=(await Promise.all((s||[]).map(async r=>{const{data:d}=await u.from("stock_reservations").select("reserved_quantity").eq("product_id",r.product_id).eq("status","active"),b=(d==null?void 0:d.reduce((M,U)=>M+Number(U.reserved_quantity),0))||0,y=l.get(r.product_id)||0,F=y>0?-y:b,I=r.total_current_stock-b;return{...r,reserved_stock:F,available_quantity:I}}))).filter(r=>r.total_current_stock>0||r.reserved_stock!==0||l.has(r.product_id));k(A)}catch(s){console.error("Error loading stock summary:",s)}finally{N(!1)}},L=async s=>{try{const{data:t,error:c}=await u.from("batches").select("id, batch_number, current_stock, reserved_stock, expiry_date, import_date").eq("product_id",s).eq("is_active",!0).gt("current_stock",0).order("expiry_date",{ascending:!0,nullsFirst:!1});if(c)throw c;const l=(t||[]).map(m=>({...m,available_quantity:m.current_stock-(m.reserved_stock||0)}));S(l)}catch(t){console.error("Error loading product batches:",t)}},C=async s=>{_(s),await L(s.product_id)},D=()=>{v("batches")},h=s=>s?new Date(s)<new Date:!1,x=s=>{if(!s)return!1;const t=new Date;return t.setDate(t.getDate()+30),new Date(s)<=t&&!h(s)},E=(s,t)=>s===0?"text-gray-400":s<500?"text-orange-600":"text-green-600",P=[{key:"product_name",label:a("stock.productName"),render:(s,t)=>e.jsxs("div",{className:"py-1",children:[e.jsx("span",{className:"font-medium text-gray-900",children:t.product_name}),e.jsxs("span",{className:"text-xs text-gray-500 ml-2 capitalize",children:["(",t.category,")"]})]})},{key:"stock",label:a("stock.totalStock"),render:(s,t)=>e.jsxs("span",{className:`font-semibold ${E(t.total_current_stock,t.active_batch_count)}`,children:[t.total_current_stock.toLocaleString()," ",t.unit]})},{key:"reserved",label:a("stock.reserved"),render:(s,t)=>t.reserved_stock===0?e.jsx("span",{className:"text-gray-400",children:"-"}):t.reserved_stock<0?e.jsxs("span",{className:"text-red-600 font-semibold",children:[t.reserved_stock.toLocaleString()," ",t.unit]}):e.jsxs("span",{className:"text-orange-600 font-medium",children:[t.reserved_stock.toLocaleString()," ",t.unit]})},{key:"available",label:a("stock.available"),render:(s,t)=>e.jsxs("span",{className:"text-green-600 font-semibold",children:[t.available_quantity.toLocaleString()," ",t.unit]})},{key:"batches",label:a("stock.batches"),render:(s,t)=>e.jsxs("span",{className:"text-sm",children:[e.jsx("span",{className:"text-blue-600 font-medium",children:t.active_batch_count}),t.expired_batch_count>0&&e.jsxs("span",{className:"text-red-600 ml-1",children:["(",t.expired_batch_count," expired)"]})]})},{key:"expiry",label:a("stock.nearestExpiry"),render:(s,t)=>t.nearest_expiry_date?e.jsxs("span",{className:`text-sm ${h(t.nearest_expiry_date)?"text-red-700 font-semibold":x(t.nearest_expiry_date)?"text-orange-600 font-semibold":"text-gray-700"}`,children:[new Date(t.nearest_expiry_date).toLocaleDateString(),x(t.nearest_expiry_date)&&e.jsx(f,{className:"w-3 h-3 inline ml-1"})]}):e.jsx("span",{className:"text-gray-400 text-sm",children:"-"})}],B=[{key:"batch_number",label:a("stock.batchNumber"),render:(s,t)=>e.jsx("span",{className:"font-mono text-sm",children:t.batch_number})},{key:"current_stock",label:a("stock.totalStock"),render:(s,t)=>e.jsxs("span",{className:"font-semibold text-sm",children:[t.current_stock.toLocaleString()," ",n==null?void 0:n.unit]})},{key:"reserved_stock",label:a("stock.reserved"),render:(s,t)=>e.jsx("span",{className:"text-orange-600 font-medium text-sm",children:t.reserved_stock>0?`${t.reserved_stock.toLocaleString()} ${n==null?void 0:n.unit}`:"-"})},{key:"available_quantity",label:a("stock.available"),render:(s,t)=>e.jsxs("span",{className:"text-green-600 font-semibold text-sm",children:[t.available_quantity.toLocaleString()," ",n==null?void 0:n.unit]})},{key:"import_date",label:a("stock.imported"),render:(s,t)=>e.jsx("span",{className:"text-sm text-gray-600",children:new Date(t.import_date).toLocaleDateString()})},{key:"expiry_date",label:a("stock.expiry"),render:(s,t)=>e.jsx("span",{className:`text-sm ${h(t.expiry_date)?"text-red-700 font-semibold":x(t.expiry_date)?"text-orange-600 font-semibold":"text-gray-700"}`,children:t.expiry_date?new Date(t.expiry_date).toLocaleDateString():"-"})}],T=o.reduce((s,t)=>s+t.total_current_stock,0),R=o.length,$=o.filter(s=>s.total_current_stock<500).length,W=o.filter(s=>s.nearest_expiry_date&&x(s.nearest_expiry_date)).length;return e.jsx(H,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:a("stock.title")}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Current stock levels across all products"})]}),e.jsxs("button",{onClick:D,className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition",children:[e.jsx(g,{className:"w-5 h-5"}),"View Batches"]})]}),n&&e.jsxs("div",{className:"bg-blue-50 rounded-lg shadow-md p-4 border-l-4 border-blue-500",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:[n.product_name," - Batch Details"]}),e.jsx("button",{onClick:()=>_(null),className:"text-gray-500 hover:text-gray-700 text-xl font-bold",children:"âœ•"})]}),e.jsx(j,{columns:B,data:w,loading:!1})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:[e.jsx(j,{columns:P,data:o,loading:p,onRowClick:C}),!p&&o.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(g,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-500 text-lg",children:"No stock available"}),e.jsx("p",{className:"text-gray-400 text-sm mt-2",children:"All products are currently out of stock"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg shadow-lg p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-blue-100 text-sm font-medium",children:"Products In Stock"}),e.jsx("p",{className:"text-3xl font-bold mt-1",children:R})]}),e.jsx(g,{className:"w-10 h-10 text-blue-200"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-green-500 to-green-600 rounded-lg shadow-lg p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-green-100 text-sm font-medium",children:"Total Stock Units"}),e.jsx("p",{className:"text-3xl font-bold mt-1",children:T.toLocaleString()})]}),e.jsx(J,{className:"w-10 h-10 text-green-200"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg shadow-lg p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-orange-100 text-sm font-medium",children:"Low Stock Items"}),e.jsx("p",{className:"text-3xl font-bold mt-1",children:$})]}),e.jsx(f,{className:"w-10 h-10 text-orange-200"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-lg p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-red-100 text-sm font-medium",children:"Near Expiry"}),e.jsx("p",{className:"text-3xl font-bold mt-1",children:W})]}),e.jsx(G,{className:"w-10 h-10 text-red-200"})]})})]})]})})}export{ee as Stock};
