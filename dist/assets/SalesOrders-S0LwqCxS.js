import{c as ke,u as xe,d as ie,r as b,s as N,j as e,F as Y,X as he,T as ge,f as y,h as X,m as De,i as pe}from"./index-CKfpb48H.js";import{L as Ce}from"./Layout-CYchWaOk.js";import{P as be,M as ne}from"./Modal-5mKOe-a5.js";import{S as Pe}from"./SearchableSelect--rmycQNW.js";import{P as Ee,h as Ae,E as Re}from"./html2canvas.esm-orZ44ulK.js";import{D as Te}from"./download-BHGVBkDb.js";import{f as oe}from"./dateFormat-E6B5rKFz.js";import{S as Fe}from"./search-Doi2Y3_1.js";import{X as ce}from"./x-circle-CfqbOicI.js";import{E as Oe}from"./eye-BxGXgDrB.js";import{S as Ie}from"./square-pen-qhCVKoGC.js";import{E as qe}from"./external-link-CjcEUJLV.js";import"./chevron-down-DyIIW3M8.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=ke("FileCheck",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"m9 15 2 2 4-4",key:"1grp1n"}]]);function Me({existingOrder:l,onSuccess:F,onCancel:S}){const{user:P}=xe(),{t:x}=ie(),[g,k]=b.useState([]),[H,$]=b.useState([]),[z,Q]=b.useState({}),[L,V]=b.useState(!1),[p,E]=b.useState({customer_id:"",customer_po_number:"",customer_po_date:new Date().toISOString().split("T")[0],so_date:new Date().toISOString().split("T")[0],expected_delivery_date:"",notes:"",currency:"IDR"}),[j,M]=b.useState(null),[a,v]=b.useState([{product_id:"",quantity:1,unit_price:0,discount_percent:0,discount_amount:0,tax_percent:0,tax_amount:0,line_total:0,item_delivery_date:"",notes:""}]);b.useEffect(()=>{w(),A()},[]),b.useEffect(()=>{if(l&&(E({customer_id:l.customer_id,customer_po_number:l.customer_po_number,customer_po_date:l.customer_po_date,so_date:l.so_date,expected_delivery_date:l.expected_delivery_date||"",notes:l.notes||"",currency:l.currency||"IDR"}),l.sales_order_items&&l.sales_order_items.length>0)){const s=l.sales_order_items.map(r=>({product_id:r.product_id,quantity:r.quantity,unit_price:r.unit_price,discount_percent:r.discount_percent,discount_amount:r.discount_amount,tax_percent:r.tax_percent,tax_amount:r.tax_amount,line_total:r.line_total,item_delivery_date:r.item_delivery_date||"",notes:r.notes||""}));v(s),s.forEach(r=>{r.product_id&&h(r.product_id)})}},[l]);const w=async()=>{try{const{data:s,error:r}=await N.from("customers").select("id, company_name").eq("is_active",!0).order("company_name");if(r)throw r;k(s||[])}catch(s){console.error("Error fetching customers:",s.message)}},A=async()=>{try{const{data:s,error:r}=await N.from("products").select("id, product_name, product_code").eq("is_active",!0).order("product_name");if(r)throw r;$(s||[])}catch(s){console.error("Error fetching products:",s.message)}},h=async s=>{try{const{data:r,error:o}=await N.from("batches").select("id, current_stock").eq("product_id",s);if(o)throw o;const n=(r==null?void 0:r.reduce((_,f)=>_+Number(f.current_stock),0))||0,{data:d}=await N.from("stock_reservations").select("reserved_quantity").eq("product_id",s).eq("status","active"),T=(d==null?void 0:d.reduce((_,f)=>_+Number(f.reserved_quantity),0))||0,U=n-T;Q(_=>({..._,[s]:{total_stock:n,reserved_stock:T,free_stock:U}}))}catch(r){console.error("Error fetching stock info:",r.message)}},i=(s,r)=>{if(!H.find(d=>d.id===r))return;const n=[...a];n[s].product_id=r,n[s].unit_price=0,v(n),u(s),h(r)},u=s=>{const r=a[s],o=r.quantity*r.unit_price,n=r.discount_percent>0?o*r.discount_percent/100:r.discount_amount,d=o-n,T=d*r.tax_percent/100,U=d+T,_=[...a];_[s]={...r,discount_amount:n,tax_amount:T,line_total:U},v(_)},m=(s,r,o)=>{const n=[...a];n[s]={...n[s],[r]:o};const d=n[s],T=d.quantity*d.unit_price,U=d.discount_percent>0?T*d.discount_percent/100:d.discount_amount,_=T-U,f=_*d.tax_percent/100,B=_+f;n[s]={...d,discount_amount:U,tax_amount:f,line_total:B},v(n)},R=()=>{v([...a,{product_id:"",quantity:1,unit_price:0,discount_percent:0,discount_amount:0,tax_percent:0,tax_amount:0,line_total:0,item_delivery_date:"",notes:""}])},q=s=>{if(a.length===1){y({type:"warning",title:"Warning",message:"At least one item is required"});return}console.log("Removing item at index:",s,"Current items count:",a.length);const r=a.filter((o,n)=>n!==s);console.log("New items count after removal:",r.length),v(r)},O=async()=>{if(!j)return null;try{console.log("Starting file upload:",j.name);const s=j.name.split(".").pop(),o=`customer-po/${`${Date.now()}_${Math.random().toString(36).substring(7)}.${s}`}`;console.log("Uploading to path:",o);const{data:n,error:d}=await N.storage.from("sales-order-documents").upload(o,j,{cacheControl:"3600",upsert:!1});if(d)throw console.error("Upload error:",d),d;console.log("File uploaded successfully:",n);const{data:{publicUrl:T}}=N.storage.from("sales-order-documents").getPublicUrl(o);return console.log("Public URL generated:",T),T}catch(s){throw console.error("Error uploading file:",s),y({type:"error",title:"Error",message:`Failed to upload PO file: ${s.message||"Unknown error"}`}),s}},K=async(s,r=!1)=>{if(s.preventDefault(),!p.customer_id){y({type:"error",title:"Error",message:"Please select a customer"});return}if(!p.customer_po_number.trim()){y({type:"error",title:"Error",message:"Please enter customer PO number"});return}if(a.length===0||a.some(n=>!n.product_id||n.quantity<=0)){y({type:"error",title:"Error",message:"Please add valid items to the order"});return}const o=l&&["approved","stock_reserved","shortage","pending_approval"].includes(l.status);if(!(o&&l&&!await X({title:"Confirm",message:`Warning: This order has been approved or is awaiting approval.

Editing will:
- Release existing stock reservations
- Require re-approval from admin
- Reset status to "Pending Approval"

Do you want to continue?`,variant:"warning"})))try{V(!0);let n=(l==null?void 0:l.customer_po_file_url)||null;if(j&&(console.log("Uploading PO file..."),n=await O(),console.log("PO file URL:",n),!n))throw new Error("File upload returned no URL");const d=a.reduce((_,f)=>_+(f.quantity*f.unit_price-f.discount_amount),0),T=a.reduce((_,f)=>_+f.tax_amount,0),U=a.reduce((_,f)=>_+f.line_total,0);if(l){if(o){console.log("Releasing stock reservations for order:",l.id);const{error:I}=await N.rpc("fn_release_reservation_by_so_id",{p_so_id:l.id,p_released_by:P==null?void 0:P.id});I&&console.error("Error releasing reservations:",I)}let _;o||r?_="pending_approval":_="draft",console.log("Updating order. Items count:",a.length);const{error:f}=await N.from("sales_orders").update({customer_id:p.customer_id,customer_po_number:p.customer_po_number,customer_po_date:p.customer_po_date,customer_po_file_url:n,so_date:p.so_date,currency:p.currency,expected_delivery_date:p.expected_delivery_date||null,notes:p.notes||null,status:_,subtotal_amount:d,tax_amount:T,total_amount:U,updated_at:new Date().toISOString()}).eq("id",l.id);if(f)throw f;const{error:B}=await N.from("sales_order_items").delete().eq("sales_order_id",l.id);if(B)throw B;const J=a.map(I=>({sales_order_id:l.id,product_id:I.product_id,quantity:I.quantity,unit_price:I.unit_price,discount_percent:I.discount_percent,discount_amount:I.discount_amount,tax_percent:I.tax_percent,tax_amount:I.tax_amount,line_total:I.line_total,item_delivery_date:I.item_delivery_date||null,notes:I.notes||null}));console.log("Inserting items. Count:",J.length);const{data:D,error:ae}=await N.from("sales_order_items").insert(J).select();if(ae)throw ae;console.log("Items inserted successfully. Count:",(D==null?void 0:D.length)||0),D&&D.length!==a.length&&(console.error("WARNING: Item count mismatch!",{expected:a.length,inserted:D.length}),y({type:"warning",title:"Warning",message:`Expected ${a.length} items but only ${D.length} were saved. Please verify the order.`})),y({type:"success",title:"Success",message:`Sales order updated successfully${o?" and submitted for re-approval. Stock reservations have been released.":r?" and submitted for approval":""}!`})}else{const{data:_,error:f}=await N.from("sales_orders").insert({so_number:"",customer_id:p.customer_id,customer_po_number:p.customer_po_number,customer_po_date:p.customer_po_date,customer_po_file_url:n,so_date:p.so_date,currency:p.currency,expected_delivery_date:p.expected_delivery_date||null,notes:p.notes||null,status:r?"pending_approval":"draft",subtotal_amount:d,tax_amount:T,total_amount:U,created_by:P==null?void 0:P.id}).select().single();if(f)throw f;const B=a.map(D=>({sales_order_id:_.id,product_id:D.product_id,quantity:D.quantity,unit_price:D.unit_price,discount_percent:D.discount_percent,discount_amount:D.discount_amount,tax_percent:D.tax_percent,tax_amount:D.tax_amount,line_total:D.line_total,item_delivery_date:D.item_delivery_date||null,notes:D.notes||null})),{error:J}=await N.from("sales_order_items").insert(B);if(J)throw J;y({type:"success",title:"Success",message:`Sales order created successfully${r?" and submitted for approval":""}!`})}F()}catch(n){console.error(l?"Error updating sales order:":"Error creating sales order:",n.message),y({type:"error",title:"Error",message:(l?"Failed to update sales order: ":"Failed to create sales order: ")+n.message})}finally{V(!1)}},ee=(s,r)=>{const o=z[s];if(!o)return null;const n=o.free_stock>=r;return e.jsxs("div",{className:`text-xs ${n?"text-green-600":"text-red-600"}`,children:[x("salesOrders.freeStock"),": ",o.free_stock," ",!n&&"(Insufficient!)"]})},te=a.reduce((s,r)=>s+(r.quantity*r.unit_price-r.discount_amount),0),se=a.reduce((s,r)=>s+r.tax_amount,0),re=a.reduce((s,r)=>s+r.line_total,0),W=s=>p.currency==="USD"?`$ ${s.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:`Rp ${s.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return e.jsxs("form",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x("sales.customer")," *"]}),e.jsx(Pe,{value:p.customer_id,onChange:s=>E({...p,customer_id:s}),options:g.map(s=>({value:s.id,label:s.company_name})),placeholder:`${x("common.filter")} ${x("sales.customer")}`})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x("salesOrders.customerPoNumber")," *"]}),e.jsx("input",{type:"text",value:p.customer_po_number,onChange:s=>E({...p,customer_po_number:s.target.value}),className:"w-full border rounded-lg px-3 py-2",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[x("salesOrders.customerPoDate")," *"]}),e.jsx("input",{type:"date",value:p.customer_po_date,onChange:s=>E({...p,customer_po_date:s.target.value}),className:"w-full border rounded-lg px-3 py-2",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:x("salesOrders.soDate")}),e.jsx("input",{type:"date",value:p.so_date,onChange:s=>E({...p,so_date:s.target.value}),className:"w-full border rounded-lg px-3 py-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency *"}),e.jsxs("select",{value:p.currency,onChange:s=>E({...p,currency:s.target.value}),className:"w-full border rounded-lg px-3 py-2",required:!0,children:[e.jsx("option",{value:"IDR",children:"IDR (Rp)"}),e.jsx("option",{value:"USD",children:"USD ($)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:x("salesOrders.expectedDeliveryDate")}),e.jsx("input",{type:"date",value:p.expected_delivery_date,onChange:s=>E({...p,expected_delivery_date:s.target.value}),className:"w-full border rounded-lg px-3 py-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:x("salesOrders.uploadPo")}),(l==null?void 0:l.customer_po_file_url)&&!j&&e.jsxs("div",{className:"mb-2 p-2 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-4 h-4 text-blue-600"}),e.jsx("span",{className:"text-sm text-blue-700",children:"PO file already uploaded"})]}),e.jsx("a",{href:l.customer_po_file_url,target:"_blank",rel:"noopener noreferrer",className:"text-sm text-blue-600 hover:text-blue-800 underline",children:"View"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"file",accept:".pdf,.jpg,.jpeg,.png",onChange:s=>{var r;return M(((r=s.target.files)==null?void 0:r[0])||null)},className:"w-full border rounded-lg px-3 py-2"}),j&&e.jsx("button",{type:"button",onClick:()=>M(null),className:"text-red-600 hover:text-red-800",title:"Remove selected file",children:e.jsx(he,{className:"w-5 h-5"})})]}),j&&e.jsxs("p",{className:"mt-1 text-sm text-green-600 flex items-center gap-1",children:[e.jsx(Y,{className:"w-4 h-4"}),"Ready to upload: ",j.name]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:x("salesOrders.notes")}),e.jsx("textarea",{value:p.notes,onChange:s=>E({...p,notes:s.target.value}),className:"w-full border rounded-lg px-3 py-2",rows:2})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-3",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Order Items"}),e.jsxs("button",{type:"button",onClick:R,className:"flex items-center gap-1 text-blue-600 hover:text-blue-800 text-sm",children:[e.jsx(be,{className:"w-4 h-4"})," ",x("sales.addItem")]})]}),e.jsx("div",{className:"space-y-3 max-h-96 overflow-y-auto",children:a.map((s,r)=>e.jsxs("div",{className:"border rounded-lg p-3 bg-gray-50",children:[e.jsxs("div",{className:"grid grid-cols-6 gap-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsxs("label",{className:"text-xs text-gray-600",children:[x("salesOrders.product")," *"]}),e.jsxs("select",{value:s.product_id,onChange:o=>i(r,o.target.value),className:"w-full border rounded px-2 py-1 text-sm",required:!0,children:[e.jsx("option",{value:"",children:"Select Product"}),H.map(o=>e.jsx("option",{value:o.id,children:o.product_name},o.id))]}),s.product_id&&ee(s.product_id,s.quantity)]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs text-gray-600",children:[x("sales.quantity")," *"]}),e.jsx("input",{type:"text",value:s.quantity===0?"":s.quantity,onChange:o=>{const n=o.target.value;if(n==="")m(r,"quantity",0);else{const d=parseFloat(n);isNaN(d)||m(r,"quantity",d)}},onBlur:o=>{o.target.value===""&&m(r,"quantity",0)},className:"w-full border rounded px-2 py-1 text-sm",placeholder:"Enter quantity",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:x("sales.unitPrice")}),e.jsx("input",{type:"text",value:s.unit_price===0?"":s.unit_price,onChange:o=>{const n=o.target.value;if(n==="")m(r,"unit_price",0);else{const d=parseFloat(n);isNaN(d)||m(r,"unit_price",d)}},onBlur:o=>{o.target.value===""&&m(r,"unit_price",0)},className:"w-full border rounded px-2 py-1 text-sm",placeholder:"Enter price"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:x("salesOrders.discountPercent")}),e.jsx("input",{type:"text",value:s.discount_percent===0?"":s.discount_percent,onChange:o=>{const n=o.target.value;if(n==="")m(r,"discount_percent",0);else{const d=parseFloat(n);!isNaN(d)&&d>=0&&d<=100&&m(r,"discount_percent",d)}},onBlur:o=>{o.target.value===""&&m(r,"discount_percent",0)},className:"w-full border rounded px-2 py-1 text-sm",placeholder:"0"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:x("salesOrders.taxPercent")}),e.jsx("input",{type:"text",value:s.tax_percent===0?"":s.tax_percent,onChange:o=>{const n=o.target.value;if(n==="")m(r,"tax_percent",0);else{const d=parseFloat(n);!isNaN(d)&&d>=0&&d<=100&&m(r,"tax_percent",d)}},onBlur:o=>{o.target.value===""&&m(r,"tax_percent",0)},className:"w-full border rounded px-2 py-1 text-sm",placeholder:"0"})]})]}),e.jsxs("div",{className:"grid grid-cols-6 gap-2 mt-2",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Item Delivery Date"}),e.jsx("input",{type:"date",value:s.item_delivery_date,onChange:o=>m(r,"item_delivery_date",o.target.value),className:"w-full border rounded px-2 py-1 text-sm"})]}),e.jsxs("div",{className:"col-span-3",children:[e.jsx("label",{className:"text-xs text-gray-600",children:"Notes"}),e.jsx("input",{type:"text",value:s.notes,onChange:o=>m(r,"notes",o.target.value),className:"w-full border rounded px-2 py-1 text-sm"})]}),e.jsxs("div",{className:"flex items-end justify-between",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-gray-600",children:x("salesOrders.lineTotal")}),e.jsx("div",{className:"text-sm font-medium",children:W(s.line_total)})]}),e.jsx("button",{type:"button",onClick:()=>q(r),className:"text-red-600 hover:text-red-800",children:e.jsx(ge,{className:"w-4 h-4"})})]})]})]},r))})]}),e.jsx("div",{className:"bg-gray-50 p-4 rounded-lg",children:e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:[x("sales.subtotal"),":"]}),e.jsx("span",{className:"font-medium",children:W(te)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:[x("sales.tax"),":"]}),e.jsx("span",{className:"font-medium",children:W(se)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-2",children:[e.jsxs("span",{children:[x("salesOrders.grandTotal"),":"]}),e.jsx("span",{children:W(re)})]})]})}),e.jsxs("div",{className:"flex justify-end gap-3",children:[e.jsx("button",{type:"button",onClick:S,className:"px-4 py-2 border rounded-lg hover:bg-gray-50",disabled:L,children:x("common.cancel")}),!(l&&["approved","stock_reserved","shortage","pending_approval"].includes(l.status))&&e.jsx("button",{type:"button",onClick:s=>K(s,!1),className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",disabled:L,children:x(L?"common.loading":"salesOrders.saveAsDraft")}),e.jsx("button",{type:"button",onClick:s=>K(s,!0),className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",disabled:L,children:L?`${x("common.submit")}...`:l&&["approved","stock_reserved","shortage","pending_approval"].includes(l.status)?"Submit for Re-Approval":x("salesOrders.submitForApproval")})]})]})}function Ue({salesOrder:l,items:F,onClose:S}){const P=b.useRef(null),{t:x,language:g}=ie(),k=l.currency||"IDR",H=k==="IDR"?"Rp":k==="USD"?"$":k,$=a=>a==null?`${H} 0,00`:k==="IDR"?`${a.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:`${H} ${a.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`,z=a=>{const v=new Date(a),w=g==="id"?["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"]:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],A=v.getDate(),h=w[v.getMonth()],i=v.getFullYear();return`${A} ${h} ${i}`},Q=a=>g==="id"?L(a):V(a),L=a=>{if(a===0)return"Nol";const v=["","Satu","Dua","Tiga","Empat","Lima","Enam","Tujuh","Delapan","Sembilan"],w=["Sepuluh","Sebelas","Dua Belas","Tiga Belas","Empat Belas","Lima Belas","Enam Belas","Tujuh Belas","Delapan Belas","Sembilan Belas"],A=["","","Dua Puluh","Tiga Puluh","Empat Puluh","Lima Puluh","Enam Puluh","Tujuh Puluh","Delapan Puluh","Sembilan Puluh"],h=i=>{if(i===0)return"";if(i<10)return v[i];if(i>=10&&i<20)return w[i-10];if(i<100){const q=Math.floor(i/10),O=i%10;return A[q]+(O>0?" "+v[O]:"")}const u=Math.floor(i/100),m=i%100;return(u===1?"Seratus":v[u]+" Ratus")+(m>0?" "+h(m):"")};if(a<1e3)return h(a);if(a<1e6){const i=Math.floor(a/1e3),u=a%1e3;return(i===1?"Seribu":h(i)+" Ribu")+(u>0?" "+h(u):"")}if(a<1e9){const i=Math.floor(a/1e6),u=a%1e6,m=h(i)+" Juta",R=u>=1e3?(Math.floor(u/1e3)===1?"Seribu":h(Math.floor(u/1e3))+" Ribu")+(u%1e3>0?" "+h(u%1e3):""):u>0?h(u):"";return m+(R?" "+R:"")}return a.toString()},V=a=>{if(a===0)return"Zero";const v=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"],w=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],A=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"],h=i=>{if(i===0)return"";if(i<10)return v[i];if(i>=10&&i<20)return w[i-10];if(i<100){const R=Math.floor(i/10),q=i%10;return A[R]+(q>0?" "+v[q]:"")}const u=Math.floor(i/100),m=i%100;return v[u]+" Hundred"+(m>0?" "+h(m):"")};if(a<1e3)return h(a);if(a<1e6){const i=Math.floor(a/1e3),u=a%1e3;return h(i)+" Thousand"+(u>0?" "+h(u):"")}if(a<1e9){const i=Math.floor(a/1e6),u=a%1e6,m=u>=1e3?h(Math.floor(u/1e3))+" Thousand"+(u%1e3>0?" "+h(u%1e3):""):u>0?h(u):"";return h(i)+" Million"+(m?" "+m:"")}return a.toString()},p=()=>{window.print()},E=async()=>{if(P.current)try{const a=await Ae(P.current,{scale:2,useCORS:!0,allowTaint:!0,logging:!1,backgroundColor:"#ffffff",windowWidth:P.current.scrollWidth,windowHeight:P.current.scrollHeight,onclone:q=>{const O=q.getElementById("proforma-print-content");O&&(O.style.width="210mm")}}),v=a.toDataURL("image/png",1),w=new Re("p","mm","a4"),A=w.internal.pageSize.getWidth(),h=w.internal.pageSize.getHeight(),i=a.width,u=a.height,m=A/i,R=u*m;if(R>h){let q=0,O=R;for(;O>0;)w.addImage(v,"PNG",0,q,A,R),O-=h,q-=h,O>0&&w.addPage()}else w.addImage(v,"PNG",0,0,A,R);w.save(`Proforma-Invoice-${l.so_number}.pdf`)}catch(a){console.error("Error generating PDF:",a),alert("Failed to generate PDF. Please try again.")}},j=l.customers,M=F.some(a=>(a.discount_amount||0)>0);return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 print:static print:bg-white print:overflow-visible",children:[e.jsx("div",{className:"flex min-h-screen items-start justify-center p-4 pt-10 print:p-0 print:min-h-0 print:block",children:e.jsxs("div",{className:"relative w-full max-w-5xl bg-white shadow-xl print:shadow-none print:max-w-full",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b bg-white px-6 py-4",style:{printColorAdjust:"exact",WebkitPrintColorAdjust:"exact"},children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:[g==="id"?"Faktur Proforma":"Proforma Invoice"," ",l.so_number]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:p,className:"flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[e.jsx(Ee,{className:"h-4 w-4"}),g==="id"?"Cetak":"Print"]}),e.jsxs("button",{onClick:E,className:"flex items-center gap-2 rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700",children:[e.jsx(Te,{className:"h-4 w-4"}),"PDF"]}),e.jsx("button",{onClick:S,className:"rounded-lg bg-gray-100 p-2 text-gray-600 hover:bg-gray-200",children:e.jsx(he,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{id:"proforma-print-content",ref:P,className:"p-8",children:[e.jsxs("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:[e.jsxs("div",{className:"mb-2 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-16 w-16 flex items-center justify-center print:h-12 print:w-12",style:{backgroundColor:"#fff"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",width:"100%",height:"100%",viewBox:"0 0 15686.55 15480.24",style:{shapeRendering:"geometricPrecision",fillRule:"evenodd",clipRule:"evenodd"},children:e.jsxs("g",{children:[e.jsx("path",{fill:"#FDB763",d:"M69.94 10438.12l10353.39 0 0 -1798.67 1665.92 0 0 1868.6 0 320.44 0 4552.28c0,38.48 -31.45,69.94 -69.94,69.94l-11949.38 0c-38.48,0 -69.94,-31.45 -69.94,-69.94l0 -4872.72c0,-38.48 31.45,-69.94 69.94,-69.94zm1605.9 1710.15l8737.57 0c13.58,0 24.68,11.11 24.68,24.68l0 1719.84c0,13.58 -11.11,24.68 -24.68,24.68l-8737.57 0c-13.58,0 -24.68,-11.11 -24.68,-24.68l0 -1719.84c0,-13.58 11.11,-24.68 24.68,-24.68z"}),e.jsx("path",{fill:"#FDB763",d:"M15587.15 5136.67l-10353.49 0 0 1822.07 -1665.92 0 0 -1892.9 0 -324.61 0 -4611.43c0,-39 31.45,-70.87 69.94,-70.87l11949.47 0c38.48,0 69.94,31.87 69.94,70.87l0 4936.04c0,39 -31.45,70.83 -69.94,70.83zm-1605.9 -1732.36l-8737.67 0c-13.58,0 -24.68,-11.27 -24.68,-25l0 -1742.21c0,-13.74 11.11,-25 24.68,-25l8737.67 0c13.58,0 24.68,11.27 24.68,25l0 1742.21c0,13.74 -11.11,25 -24.68,25z"}),e.jsx("polygon",{fill:"#FD6D26",points:"-0,0 1651.16,0 1651.16,6929.27 15657.09,6929.27 15657.09,6958.74 15686.55,6958.74 15686.55,15480.24 14022.85,15480.24 14022.85,8639.45 1651.16,8639.45 -0,8639.45 -0,6929.27"})]})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-base font-bold print:text-sm",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Komplek Ruko Metro Sunter Blok A1 NO.15, Jl. Metro Indah Raya,"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Kelurahan Papanggo, Kec. Tanjung Priok, Jakarta Utara - 14340"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Telp: (+62 21) 65832426"})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("h2",{className:"text-3xl font-bold print:text-2xl",children:g==="id"?"FAKTUR PROFORMA":"PROFORMA INVOICE"})})]}),e.jsxs("div",{className:"text-xs space-y-0.5 print:text-[10px] print:space-y-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No izin PBF"}),e.jsx("span",{className:"ml-16",children:": 27092400534390007"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No Sertifikasi CDOB"}),e.jsx("span",{className:"ml-4",children:": 270924005343900070001"})]})]})]}),e.jsx("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 flex-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Company Name:"}),e.jsxs("span",{className:"font-semibold",children:[" ",(j==null?void 0:j.company_name)||""]})]}),e.jsxs("div",{className:"pt-1 flex",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Address:"}),e.jsxs("div",{children:[e.jsx("p",{children:(j==null?void 0:j.address)||""}),e.jsx("p",{children:(j==null?void 0:j.city)||""})]})]}),e.jsxs("div",{className:"flex pt-1",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Phone:"}),e.jsx("span",{children:(j==null?void 0:j.phone)||""})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"NPWP:"}),e.jsx("span",{children:(j==null?void 0:j.npwp)||""})]})]}),e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 text-right",style:{minWidth:"220px"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"SO Number:"}),e.jsx("span",{className:"ml-2",children:l.so_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"SO Date:"}),e.jsx("span",{className:"ml-2",children:z(l.so_date)})]}),e.jsxs("div",{className:"pt-1",children:[e.jsx("span",{className:"font-bold",children:"Customer PO No:"}),e.jsx("span",{className:"ml-2",children:l.customer_po_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Customer PO Date:"}),e.jsx("span",{className:"ml-2",children:z(l.customer_po_date)})]}),l.expected_delivery_date&&e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Expected Delivery:"}),e.jsx("span",{className:"ml-2",children:z(l.expected_delivery_date)})]})]})]})}),e.jsx("div",{children:e.jsxs("table",{className:"w-full border-2 border-black text-xs print:text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-black bg-white",children:[e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"No."}),e.jsx("th",{className:"border-r border-black p-1.5 text-left font-bold print:p-1",children:"Product Name"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Total Qty"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"UOM"}),e.jsx("th",{className:"border-r border-black p-1.5 text-right font-bold print:p-1 ",children:g==="id"?`Unit Price (${k})`:`Unit Price (${k})`}),M&&e.jsx("th",{className:"border-r border-black p-1.5 text-right font-bold print:p-1",children:"Discount"}),e.jsx("th",{className:"p-1.5 text-right font-bold print:p-1",children:g==="id"?`Sub Total (${k})`:`Sub Total (${k})`})]})}),e.jsxs("tbody",{children:[F.map((a,v)=>{var u,m;const w=a.quantity||0,A=a.unit_price||0,h=a.discount_amount||0,i=w*A-h;return e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:v+1}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:((u=a.products)==null?void 0:u.product_name)||"Unknown Product"}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:w.toLocaleString()}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:((m=a.products)==null?void 0:m.unit)||"Kg"}),e.jsx("td",{className:"border-r border-black p-1.5 text-right print:p-1 ",children:$(A)}),M&&e.jsx("td",{className:"border-r border-black p-1.5 text-right print:p-1",children:$(h)}),e.jsx("td",{className:"p-1.5 text-right print:p-1",children:$(i)})]},a.id||v)}),F.length<2&&Array.from({length:2-F.length}).map((a,v)=>e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),M&&e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"p-1.5 print:p-1",children:" "})]},`empty-${v}`))]})]})}),e.jsxs("div",{className:"border-2 border-black border-t-0",children:[e.jsxs("div",{className:"flex items-stretch border-b-2 border-black",children:[e.jsxs("div",{className:"flex-1 p-2 border-r-2 border-black print:p-1.5",children:[e.jsx("p",{className:"text-xs font-bold print:text-[10px]",children:g==="id"?"Amount In words:":"Amount in words:"}),e.jsxs("p",{className:"text-xs mt-0.5 font-bold uppercase print:text-[10px] print:mt-0",children:[k," ",Q(Math.round(l.total_amount))," ",k==="IDR"?"RUPIAH":k==="USD"?"DOLLARS":""]})]}),e.jsxs("div",{className:"w-80 text-xs p-2 print:text-[10px] print:p-1.5",children:[e.jsxs("div",{className:"flex justify-between py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"Sub Total"}),e.jsx("span",{className:"font-bold",children:$(l.subtotal_amount)})]}),e.jsxs("div",{className:"flex justify-between border-t border-black py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"VAT (PPN) 11%"}),e.jsx("span",{className:"font-bold",children:$(l.tax_amount)})]}),e.jsxs("div",{className:"flex justify-between border-t-2 border-black py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"Grand Total"}),e.jsx("span",{className:"font-bold text-sm print:text-xs",children:$(l.total_amount)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-0 text-xs print:text-[10px]",children:[e.jsxs("div",{className:"p-3 border-r-2 border-black print:p-2",children:[e.jsx("p",{className:"font-semibold mb-2 print:mb-1",children:"Bank Details:"}),e.jsxs("div",{className:"space-y-0.5 print:space-y-0",children:[e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-semibold",style:{minWidth:"95px"},children:"Bank Name"}),e.jsx("span",{className:"mr-2",children:":"}),e.jsx("span",{children:"BCA"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-semibold",style:{minWidth:"95px"},children:"Branch"}),e.jsx("span",{className:"mr-2",children:":"}),e.jsx("span",{children:"Sunter Mall, Jakarta"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-semibold",style:{minWidth:"95px"},children:"Account Name"}),e.jsx("span",{className:"mr-2",children:":"}),e.jsx("span",{className:"whitespace-nowrap",children:"PT. Shubham Anzen Pharma Jaya"})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-semibold",style:{minWidth:"95px"},children:"Account No."}),e.jsx("span",{className:"mr-2",children:":"}),e.jsx("span",{children:"0930 2010 14 (IDR)"})]})]})]}),e.jsxs("div",{className:"p-3 print:p-2",children:[e.jsx("p",{className:"font-semibold mb-1",children:"Authorized Signatory:"}),e.jsx("p",{className:"font-semibold mb-10 print:mb-8",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("div",{className:"w-4/5 border-t border-black pt-1",children:"Pharmacist"})]})]})]}),l.notes&&e.jsx("div",{className:"border-2 border-black border-t-0 p-2 print:p-1.5",children:e.jsxs("p",{className:"text-xs print:text-[10px]",children:[e.jsx("span",{className:"font-bold",children:"Notes: "}),e.jsx("span",{children:l.notes})]})}),e.jsx("div",{className:"border-2 border-black border-t-0 p-2.5 print:p-2",children:e.jsx("p",{className:"text-xs font-semibold text-center print:text-[10px]",children:g==="id"?"Ini adalah Faktur Proforma dan bukan tagihan resmi. Faktur resmi akan diterbitkan setelah pengiriman barang.":"This is a Proforma Invoice and not an official bill. Official invoice will be issued after delivery of goods."})})]})]})}),e.jsx("style",{children:`
        @media print {
          @page {
            size: A4 portrait;
            margin: 8mm;
          }

          .sticky {
            display: none !important;
          }

          body {
            margin: 0;
            padding: 0;
          }

          body * {
            visibility: hidden;
          }

          #proforma-print-content,
          #proforma-print-content * {
            visibility: visible;
          }

          #proforma-print-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            page-break-inside: avoid;
            page-break-after: auto;
          }

          #proforma-print-content > div {
            page-break-inside: avoid;
          }

          table {
            page-break-inside: auto;
          }

          tr {
            page-break-inside: avoid;
            page-break-after: auto;
          }

          thead {
            display: table-header-group;
          }

          tfoot {
            display: table-footer-group;
          }
        }
      `})]})}function Qe(){const{user:l,profile:F}=xe(),{t:S}=ie(),{dateRange:P}=De(),[x,g]=b.useState("active"),[k,H]=b.useState([]),[$,z]=b.useState([]),[Q,L]=b.useState([]),[V,p]=b.useState(!0),[E,j]=b.useState(""),[M,a]=b.useState("all"),[v,w]=b.useState(!1),[A,h]=b.useState(null),[i,u]=b.useState(!1),[m,R]=b.useState(""),[q,O]=b.useState(null),[K,ee]=b.useState(!1),[te,se]=b.useState(null),[re,W]=b.useState(!1),[s,r]=b.useState(""),[o,n]=b.useState(null),[d,T]=b.useState(!1),[U,_]=b.useState(null);b.useEffect(()=>{f(),B()},[x,P.startDate,P.endDate]),b.useEffect(()=>{D()},[E,M,k,x]);const f=async()=>{try{p(!0);let t=N.from("sales_orders").select(`
          *,
          customers (
            id,
            company_name,
            address,
            city,
            phone,
            npwp,
            pharmacy_license,
            gst_vat_type
          ),
          sales_order_items (
            id,
            product_id,
            quantity,
            unit_price,
            discount_percent,
            discount_amount,
            tax_percent,
            tax_amount,
            line_total,
            item_delivery_date,
            notes,
            delivered_quantity,
            products (
              id,
              product_name,
              product_code,
              unit
            )
          )
        `);x==="active"?t=t.eq("is_archived",!1):t=t.eq("is_archived",!0),t=t.gte("so_date",P.startDate).lte("so_date",P.endDate);const{data:c,error:C}=await t.order("created_at",{ascending:!1});if(C)throw C;H(c||[])}catch(t){console.error("Error fetching sales orders:",t.message),y({type:"error",title:"Error",message:S("errors.failedToLoadSalesOrders")})}finally{p(!1)}},B=async()=>{try{const{data:t,error:c}=await N.from("customers").select("id, company_name").eq("is_active",!0).order("company_name");if(c)throw c;L(t||[])}catch(t){console.error("Error fetching customers:",t.message)}},J=(t,c)=>c==="USD"?`$ ${t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:`Rp ${t.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,D=()=>{let t=k;E&&(t=t.filter(c=>{var C;return c.so_number.toLowerCase().includes(E.toLowerCase())||c.customer_po_number.toLowerCase().includes(E.toLowerCase())||((C=c.customers)==null?void 0:C.company_name.toLowerCase().includes(E.toLowerCase()))})),M!=="all"&&(t=t.filter(c=>c.status===M)),z(t)},ae=t=>{const C={draft:{color:"bg-gray-100 text-gray-800",label:S("common.draft")},pending_approval:{color:"bg-yellow-100 text-yellow-800",label:S("common.pending")},approved:{color:"bg-green-100 text-green-800",label:S("common.approved")},rejected:{color:"bg-red-100 text-red-800",label:S("common.rejected")},stock_reserved:{color:"bg-blue-100 text-blue-800",label:S("stock.reserved")},shortage:{color:"bg-orange-100 text-orange-800",label:"Shortage"},pending_delivery:{color:"bg-purple-100 text-purple-800",label:"Pending Delivery"},partially_delivered:{color:"bg-indigo-100 text-indigo-800",label:"Partially Delivered"},delivered:{color:"bg-teal-100 text-teal-800",label:"Delivered"},closed:{color:"bg-gray-100 text-gray-800",label:"Closed"},cancelled:{color:"bg-red-100 text-red-800",label:S("common.cancelled")}}[t]||{color:"bg-gray-100 text-gray-800",label:t};return e.jsx("span",{className:`px-2 py-1 text-xs font-medium rounded-full ${C.color}`,children:C.label})},de=async t=>{if(await X({title:"Confirm",message:S("salesOrders.submitForApproval")+"?",variant:"warning"}))try{const{error:c}=await N.from("sales_orders").update({status:"pending_approval",updated_at:new Date().toISOString()}).eq("id",t);if(c)throw c;y({type:"success",title:"Success",message:S("success.salesOrderSubmitted")}),f()}catch(c){console.error("Error submitting for approval:",c.message),y({type:"error",title:"Error",message:S("errors.failedToUpdate")})}},I=async()=>{if(!o||!s.trim()){y({type:"error",title:"Error",message:S("validation.enterArchiveReason")});return}try{const{data:{user:t}}=await N.auth.getUser();if(!t)throw new Error("Not authenticated");const{error:c}=await N.from("sales_orders").update({is_archived:!0,archived_at:new Date().toISOString(),archived_by:t.id,archive_reason:s,updated_at:new Date().toISOString()}).eq("id",o);if(c)throw c;y({type:"success",title:"Success",message:S("success.salesOrderArchived")}),W(!1),r(""),n(null),f()}catch(t){console.error("Error archiving order:",t.message),y({type:"error",title:"Error",message:S("errors.failedToUpdate")})}},fe=async t=>{if(await X({title:"Confirm",message:S("common.unarchive")+"?",variant:"warning"}))try{const{error:c}=await N.from("sales_orders").update({is_archived:!1,archived_at:null,archived_by:null,archive_reason:null,updated_at:new Date().toISOString()}).eq("id",t);if(c)throw c;y({type:"success",title:"Success",message:S("success.salesOrderUnarchived")}),f()}catch(c){console.error("Error unarchiving order:",c.message),y({type:"error",title:"Error",message:S("errors.failedToUpdate")})}},ve=async t=>{const c=prompt("Enter cancellation reason:");if(c)try{const{data:{user:C}}=await N.auth.getUser();if(!C)throw new Error("Not authenticated");const{error:G}=await N.rpc("fn_cancel_sales_order",{p_so_id:t,p_canceller_id:C.id,p_reason:c});if(G)throw G;y({type:"success",title:"Success",message:S("success.salesOrderCancelled")}),f()}catch(C){console.error("Error cancelling order:",C.message),y({type:"error",title:"Error",message:"Failed to cancel order"})}},ye=async t=>{if(await X({title:"Confirm",message:"Are you sure you want to delete this sales order?",variant:"danger",confirmLabel:"Delete"}))try{const{error:c}=await N.from("sales_orders").delete().eq("id",t);if(c)throw c;y({type:"success",title:"Success",message:"Sales order deleted successfully!"}),f()}catch(c){console.error("Error deleting order:",c.message),y({type:"error",title:"Error",message:"Failed to delete order"})}},je=t=>{_(t),T(!0)},_e=t=>{h(t),w(!0)},Ne=async t=>{if(await X({title:"Confirm",message:"Approve this sales order? Stock will be reserved automatically.",variant:"warning"}))try{const{data:{user:c}}=await N.auth.getUser();if(!c)throw new Error("Not authenticated");const{error:C}=await N.from("sales_orders").update({status:"approved",approved_by:c.id,approved_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",t);if(C)throw C;const{data:G,error:le}=await N.rpc("fn_reserve_stock_for_so_v2",{p_so_id:t});if(le)console.error("Error reserving stock:",le),console.error("Supabase request failed",le),y({type:"warning",title:"Warning",message:"Order approved but stock reservation failed: "+le.message});else if(G&&G.length>0){const ue=G[0];ue.success?y({type:"success",title:"Success",message:"Sales order approved and stock fully reserved!"}):y({type:"warning",title:"Warning",message:`Order approved with stock shortage.

`+ue.message+`

Import requirements have been created automatically.`})}else y({type:"success",title:"Success",message:"Sales order approved!"});f()}catch(c){console.error("Error approving order:",c.message),y({type:"error",title:"Error",message:"Failed to approve order"})}},we=async()=>{if(!q||!m.trim()){y({type:"error",title:"Error",message:"Please enter a rejection reason"});return}try{const{data:{user:t}}=await N.auth.getUser();if(!t)throw new Error("Not authenticated");const{error:c}=await N.from("sales_orders").update({status:"rejected",rejected_by:t.id,rejected_at:new Date().toISOString(),rejection_reason:m,updated_at:new Date().toISOString()}).eq("id",q);if(c)throw c;y({type:"success",title:"Success",message:"Sales order rejected"}),u(!1),R(""),O(null),f()}catch(t){console.error("Error rejecting order:",t.message),y({type:"error",title:"Error",message:"Failed to reject order"})}},Se=t=>{se(t),ee(!0)},Z={total:k.length,pending_approval:k.filter(t=>t.status==="pending_approval").length,stock_reserved:k.filter(t=>t.status==="stock_reserved").length,shortage:k.filter(t=>t.status==="shortage").length,delivered:k.filter(t=>t.status==="delivered").length};return e.jsx(Ce,{children:e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Sales Orders"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage customer purchase orders and track delivery"})]}),e.jsxs("button",{onClick:()=>w(!0),className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:[e.jsx(be,{className:"w-5 h-5"}),"New Sales Order"]})]}),e.jsx("div",{className:"mb-6 border-b border-gray-200",children:e.jsxs("nav",{className:"flex gap-4",children:[e.jsx("button",{onClick:()=>g("active"),className:`px-4 py-2 font-medium border-b-2 transition ${x==="active"?"border-blue-600 text-blue-600":"border-transparent text-gray-600 hover:text-gray-900"}`,children:"Active Orders"}),e.jsx("button",{onClick:()=>g("archived"),className:`px-4 py-2 font-medium border-b-2 transition ${x==="archived"?"border-blue-600 text-blue-600":"border-transparent text-gray-600 hover:text-gray-900"}`,children:"Archived Orders"})]})}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 md:gap-4 mb-6",children:[e.jsxs("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Total Orders"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-gray-900",children:Z.total})]}),e.jsxs("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Pending Approval"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-yellow-600",children:Z.pending_approval})]}),e.jsxs("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Stock Reserved"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-blue-600",children:Z.stock_reserved})]}),e.jsxs("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Shortage"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-orange-600",children:Z.shortage})]}),e.jsxs("div",{className:"bg-white p-3 md:p-4 rounded-lg shadow",children:[e.jsx("div",{className:"text-xs md:text-sm text-gray-600 truncate",children:"Delivered"}),e.jsx("div",{className:"text-xl md:text-2xl font-bold text-green-600",children:Z.delivered})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow mb-6",children:[e.jsxs("div",{className:"p-4 border-b flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(Fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search by SO number, PO number, or customer...",value:E,onChange:t=>j(t.target.value),className:"w-full pl-10 pr-4 py-2 border rounded-lg"})]}),e.jsxs("select",{value:M,onChange:t=>a(t.target.value),className:"border rounded-lg px-4 py-2",children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"draft",children:"Draft"}),e.jsx("option",{value:"pending_approval",children:"Pending Approval"}),e.jsx("option",{value:"approved",children:"Approved"}),e.jsx("option",{value:"stock_reserved",children:"Stock Reserved"}),e.jsx("option",{value:"shortage",children:"Shortage"}),e.jsx("option",{value:"pending_delivery",children:"Pending Delivery"}),e.jsx("option",{value:"partially_delivered",children:"Partially Delivered"}),e.jsx("option",{value:"delivered",children:"Delivered"}),e.jsx("option",{value:"rejected",children:"Rejected"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"SO Number"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Customer"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"PO Number"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"SO Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Delivery Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Amount"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Docs"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Status / Approval"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:V?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-4 text-center text-gray-500",children:"Loading..."})}):$.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"px-6 py-4 text-center text-gray-500",children:"No sales orders found"})}):$.map(t=>{var c;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.so_number})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:(c=t.customers)==null?void 0:c.company_name})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap",children:[e.jsx("div",{className:"text-sm text-gray-900",children:t.customer_po_number}),e.jsx("div",{className:"text-xs text-gray-500",children:oe(t.customer_po_date)})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:oe(t.so_date)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:t.expected_delivery_date?oe(t.expected_delivery_date):"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:J(t.total_amount,t.currency||"IDR")}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"flex items-center justify-center",children:t.customer_po_file_url?e.jsxs("button",{onClick:()=>Se(t.customer_po_file_url),className:"inline-flex items-center gap-1 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg border border-blue-200 hover:bg-blue-100 transition",title:"View Customer PO",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:"1"})]}):e.jsx("span",{className:"text-gray-400 text-sm",children:"-"})})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[ae(t.status),t.status==="pending_approval"&&(F==null?void 0:F.role)==="admin"&&e.jsxs("div",{className:"flex items-center gap-1 ml-2",children:[e.jsx("button",{onClick:C=>{C.stopPropagation(),Ne(t.id)},className:"p-2 bg-green-100 hover:bg-green-200 rounded-lg transition-colors",title:"Approve Order",children:e.jsx(pe,{className:"w-6 h-6 text-green-600"})}),e.jsx("button",{onClick:C=>{C.stopPropagation(),O(t.id),u(!0)},className:"p-2 bg-red-100 hover:bg-red-200 rounded-lg transition-colors",title:"Reject Order",children:e.jsx(ce,{className:"w-6 h-6 text-red-600"})})]}),t.status==="approved"&&e.jsx(pe,{className:"w-5 h-5 text-green-600 ml-2",title:"Approved"}),t.status==="rejected"&&e.jsx(ce,{className:"w-5 h-5 text-red-600 ml-2",title:"Rejected"})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>je(t),className:"text-blue-600 hover:text-blue-800",title:"View Proforma Invoice",children:e.jsx(Oe,{className:"w-4 h-4"})}),!["delivered","closed","cancelled","partially_delivered","pending_delivery"].includes(t.status)&&e.jsx("button",{onClick:()=>_e(t),className:"text-indigo-600 hover:text-indigo-800",title:"Edit",children:e.jsx(Ie,{className:"w-4 h-4"})}),t.status==="draft"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>de(t.id),className:"text-green-600 hover:text-green-800",title:"Submit for Approval",children:e.jsx(me,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ye(t.id),className:"text-red-600 hover:text-red-800",title:"Delete",children:e.jsx(ge,{className:"w-4 h-4"})})]}),!["cancelled","closed","delivered","rejected"].includes(t.status)&&x==="active"&&e.jsx("button",{onClick:()=>ve(t.id),className:"text-orange-600 hover:text-orange-800",title:"Cancel",children:e.jsx(ce,{className:"w-4 h-4"})}),x==="active"&&["admin","sales"].includes((F==null?void 0:F.role)||"")&&["delivered","cancelled"].includes(t.status)&&e.jsx("button",{onClick:()=>{n(t.id),W(!0)},className:"text-gray-600 hover:text-gray-800",title:"Archive Order",children:e.jsx(Y,{className:"w-4 h-4"})}),x==="archived"&&["admin","sales"].includes((F==null?void 0:F.role)||"")&&e.jsx("button",{onClick:()=>fe(t.id),className:"text-green-600 hover:text-green-800",title:"Unarchive Order",children:e.jsx(me,{className:"w-4 h-4"})})]})})]},t.id)})})]})})]}),v&&e.jsx(ne,{isOpen:v,onClose:()=>{w(!1),h(null)},title:A?"Edit Sales Order":"Create Sales Order",maxWidth:"max-w-6xl",children:e.jsx(Me,{existingOrder:A||void 0,onSuccess:()=>{w(!1),h(null),f()},onCancel:()=>{w(!1),h(null)}})}),i&&e.jsx(ne,{isOpen:i,onClose:()=>{u(!1),R(""),O(null)},title:"Reject Sales Order",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Rejection Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:m,onChange:t=>R(t.target.value),rows:4,className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500",placeholder:"Enter reason for rejecting this sales order..."})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{u(!1),R(""),O(null)},className:"px-4 py-2 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:we,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",disabled:!m.trim(),children:"Reject Order"})]})]})}),re&&e.jsx(ne,{isOpen:re,onClose:()=>{W(!1),r(""),n(null)},title:"Archive Sales Order",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Archive Reason ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{value:s,onChange:t=>r(t.target.value),rows:4,className:"w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500",placeholder:"Enter reason for archiving this sales order (e.g., Completed and delivered, Cancelled by customer)..."})]}),e.jsxs("div",{className:"flex gap-2 justify-end",children:[e.jsx("button",{onClick:()=>{W(!1),r(""),n(null)},className:"px-4 py-2 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:I,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",disabled:!s.trim(),children:"Archive Order"})]})]})}),K&&te&&e.jsx(ne,{isOpen:K,onClose:()=>{ee(!1),se(null)},title:"Customer Purchase Order",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("a",{href:te,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition",children:[e.jsx(Y,{className:"w-6 h-6 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:"Customer Purchase Order"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Click to open in new tab"})]}),e.jsx(qe,{className:"w-5 h-5 text-gray-400 flex-shrink-0"})]}),e.jsx("div",{className:"text-xs text-gray-500 text-center pt-2",children:"Document opens in a new browser tab"})]})}),d&&U&&e.jsx(Ue,{salesOrder:U,items:U.sales_order_items||[],onClose:()=>{T(!1),_(null)}})]})})}export{Qe as default};
