import{r as b,s as k,j as e,i as y}from"./index-CKfpb48H.js";import{L as G}from"./loader-BgjKCBom.js";import{X as j}from"./x-circle-CfqbOicI.js";function E(){const[d,s]=b.useState("loading"),[m,r]=b.useState("Processing Gmail connection...");b.useEffect(()=>{C()},[]);const C=async()=>{try{console.log("Starting Gmail OAuth callback...");const o=new URLSearchParams(window.location.search),u=o.get("code"),g=o.get("error");if(console.log("Callback params:",{hasCode:!!u,error:g}),g){s("error"),r(`Authorization failed: ${g}`),setTimeout(()=>window.close(),3e3);return}if(!u){s("error"),r("No authorization code received"),setTimeout(()=>window.close(),3e3);return}console.log("[GmailCallback] === CHECKING AUTH ===");const{data:{user:t}}=await k.auth.getUser();if(console.log("[GmailCallback] Current user:",t==null?void 0:t.id),!t){console.error("[GmailCallback] No user found!"),s("error"),r("User not authenticated"),setTimeout(()=>window.close(),3e3);return}const h=void 0,w=void 0,p=`${window.location.origin}/auth/gmail/callback`;if(console.log("OAuth config:",{hasClientId:!!h,hasClientSecret:!!w,redirectUri:p}),!h||!w)throw new Error("Google OAuth credentials not configured. Please check your .env file.");console.log("Exchanging code for token...");const x=await fetch("https://oauth2.googleapis.com/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({code:u,client_id:h,client_secret:w,redirect_uri:p,grant_type:"authorization_code"})});if(!x.ok){const n=await x.text();throw console.error("Token exchange failed:",n),new Error(`Token exchange failed: ${n}`)}const l=await x.json();console.log("Token received, fetching profile...");const a=await fetch("https://www.googleapis.com/oauth2/v2/userinfo",{headers:{Authorization:`Bearer ${l.access_token}`}});if(!a.ok){const n=await a.text();throw console.error("Profile fetch failed:",{status:a.status,statusText:a.statusText,body:n}),new Error(`Failed to fetch Gmail profile (${a.status}): ${n}`)}const f=await a.json();console.log("Profile fetched:",f.email);const c=new Date;c.setSeconds(c.getSeconds()+l.expires_in),console.log("[GmailCallback] === SAVING TO DATABASE ==="),console.log("[GmailCallback] Saving for user_id:",t.id),console.log("[GmailCallback] Email:",f.email),console.log("[GmailCallback] Expires at:",c.toISOString());const{data:_,error:i}=await k.from("gmail_connections").upsert({user_id:t.id,email_address:f.email,access_token:l.access_token,refresh_token:l.refresh_token,access_token_expires_at:c.toISOString(),is_connected:!0,sync_enabled:!0,last_sync:null},{onConflict:"user_id,email_address"}).select();if(console.log("[GmailCallback] Insert result:",_),console.log("[GmailCallback] Insert error:",i),i)throw console.error("[GmailCallback] Database error:",i),i;console.log("[GmailCallback] Gmail connection saved to database successfully"),s("success"),r("Gmail connected successfully! You can close this window."),setTimeout(()=>{window.opener&&window.opener.location.reload(),window.close()},2e3)}catch(o){console.error("Callback error:",o),s("error"),r(o instanceof Error?o.message:"Failed to connect Gmail"),setTimeout(()=>window.close(),5e3)}};return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center",children:[d==="loading"&&e.jsxs(e.Fragment,{children:[e.jsx(G,{className:"w-16 h-16 text-blue-600 mx-auto mb-4 animate-spin"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Connecting Gmail..."}),e.jsx("p",{className:"text-gray-600",children:m})]}),d==="success"&&e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-16 h-16 text-green-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Success!"}),e.jsx("p",{className:"text-gray-600",children:m})]}),d==="error"&&e.jsxs(e.Fragment,{children:[e.jsx(j,{className:"w-16 h-16 text-red-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Connection Failed"}),e.jsx("p",{className:"text-gray-600",children:m}),e.jsx("button",{onClick:()=>window.close(),className:"mt-4 px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg transition",children:"Close Window"})]})]})})}export{E as GmailCallback};
