import{u as q,r as o,s as n,f as d,j as e,i as v,A as B,h as $}from"./index-Bqpro8KL.js";import{L as H,P as K}from"./Layout-BToEj-kL.js";import{P as V,M as W}from"./Modal-BJLUH_oV.js";import{S as Y}from"./SearchableSelect-BogjG1Fk.js";import{f as Z}from"./dateFormat-E6B5rKFz.js";import{S as w}from"./square-pen-C7r27JVi.js";import{L as z}from"./lock-BlECj8GY.js";import"./chevron-down-D3Q6seEY.js";import"./search-DVwgCoyq.js";function le(){const{user:b}=q(),[_,C]=o.useState([]),[k,S]=o.useState([]),[I,j]=o.useState(!0),[N,m]=o.useState(!1),[x,u]=o.useState(null),[y,f]=o.useState([]),[s,a]=o.useState({container_ref:"",supplier_id:"",import_date:new Date().toISOString().split("T")[0],import_invoice_value:0,currency:"USD",exchange_rate:15e3,duty_bm:0,ppn_import:0,pph_import:0,freight_charges:0,clearing_forwarding:0,port_charges:0,container_handling:0,transportation:0,loading_import:0,bpom_ski_fees:0,other_import_costs:0,notes:""});o.useEffect(()=>{g(),D();const t=n.channel("container-changes").on("postgres_changes",{event:"*",schema:"public",table:"import_containers"},()=>{g()}).subscribe(),r=n.channel("expense-container-changes").on("postgres_changes",{event:"*",schema:"public",table:"finance_expenses"},()=>{g()}).subscribe();return()=>{t.unsubscribe(),r.unsubscribe()}},[]);const g=async()=>{try{j(!0);const{data:t,error:r}=await n.from("import_containers").select(`
          *,
          suppliers (
            id,
            company_name
          )
        `).order("created_at",{ascending:!1});if(r)throw r;const l=await Promise.all((t||[]).map(async c=>{const{data:i}=await n.from("finance_expenses").select("amount").eq("import_container_id",c.id),O=(i==null?void 0:i.reduce((M,U)=>M+Number(U.amount),0))||0;return{...c,linked_expenses_total:O}}));C(l)}catch(t){console.error("Error fetching containers:",t.message),d({type:"error",title:"Error",message:"Failed to load import containers"})}finally{j(!1)}},D=async()=>{try{const{data:t,error:r}=await n.from("suppliers").select("id, company_name").eq("is_active",!0).order("company_name");if(r)throw r;S(t||[])}catch(t){console.error("Error fetching suppliers:",t.message)}},F=async t=>{t.preventDefault();try{const r={...s,created_by:b==null?void 0:b.id};if(x){const{error:l}=await n.from("import_containers").update(r).eq("id",x.id);if(l)throw l;d({type:"success",title:"Success",message:"Container updated successfully"})}else{const{error:l}=await n.from("import_containers").insert([r]);if(l)throw l;d({type:"success",title:"Success",message:"Container created successfully"})}m(!1),u(null),h(),g()}catch(r){console.error("Error saving container:",r.message),d({type:"error",title:"Error",message:"Failed to save container: "+r.message})}},E=async t=>{var r;if(await $({title:"Confirm",message:"Are you sure you want to allocate import costs to batches? This cannot be undone.",variant:"warning",confirmLabel:"Allocate"}))try{const{data:l,error:c}=await n.rpc("allocate_import_costs_to_batches",{p_container_id:t});if(c)throw c;const i=l;i.success?(d({type:"success",title:"Success",message:`Allocated costs to ${i.batches_allocated} batches. Total cost: Rp ${(r=i.total_cost)==null?void 0:r.toLocaleString()}`}),g()):d({type:"error",title:"Error",message:i.error})}catch(l){console.error("Error allocating costs:",l.message),d({type:"error",title:"Error",message:"Failed to allocate costs: "+l.message})}},h=()=>{a({container_ref:"",supplier_id:"",import_date:new Date().toISOString().split("T")[0],import_invoice_value:0,currency:"USD",exchange_rate:15e3,duty_bm:0,ppn_import:0,pph_import:0,freight_charges:0,clearing_forwarding:0,port_charges:0,container_handling:0,transportation:0,other_import_costs:0,notes:""}),f([])},L=async t=>{try{const{data:r,error:l}=await n.from("finance_expenses").select("id, expense_category, amount, expense_date, description").eq("import_container_id",t).order("expense_date",{ascending:!1});if(l)throw l;f(r||[])}catch(r){console.error("Error loading linked expenses:",r),f([])}},P=t=>({duty_customs:"Duty & Customs (BM)",ppn_import:"PPN Import",pph_import:"PPh Import",freight_import:"Freight (Import)",clearing_forwarding:"Clearing & Forwarding",port_charges:"Port Charges",container_handling:"Container Handling",transport_import:"Transportation (Import)",loading_import:"Loading / Unloading (Import)",bpom_ski_fees:"BPOM / SKI Fees"})[t]||t,R=async t=>{u(t),a({container_ref:t.container_ref,supplier_id:t.supplier_id,import_date:t.import_date,import_invoice_value:t.import_invoice_value,currency:t.currency,exchange_rate:t.exchange_rate,duty_bm:t.duty_bm||0,ppn_import:t.ppn_import||0,pph_import:t.pph_import||0,freight_charges:t.freight_charges||0,clearing_forwarding:t.clearing_forwarding||0,port_charges:t.port_charges||0,container_handling:t.container_handling||0,transportation:t.transportation||0,loading_import:t.loading_import||0,bpom_ski_fees:t.bpom_ski_fees||0,other_import_costs:t.other_import_costs||0,notes:t.notes||""}),await L(t.id),m(!0)},A=t=>{const r={draft:{color:"bg-gray-100 text-gray-800",label:"Draft",icon:w},allocated:{color:"bg-green-100 text-green-800",label:"Allocated",icon:v},locked:{color:"bg-blue-100 text-blue-800",label:"Locked",icon:z}},l=r[t]||r.draft,c=l.icon;return e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-1 text-xs font-medium rounded ${l.color}`,children:[e.jsx(c,{className:"w-3 h-3"}),l.label]})},p=(t,r="IDR")=>r==="USD"?`$ ${t==null?void 0:t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:`Rp ${t==null?void 0:t.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,T=()=>(s.duty_bm||0)+(s.ppn_import||0)+(s.pph_import||0)+(s.freight_charges||0)+(s.clearing_forwarding||0)+(s.port_charges||0)+(s.container_handling||0)+(s.transportation||0)+(s.loading_import||0)+(s.bpom_ski_fees||0)+(s.other_import_costs||0);return e.jsx(H,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(K,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Import Containers"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Track import shipments and allocate costs to batches"})]})]}),e.jsxs("button",{onClick:()=>{u(null),h(),m(!0)},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(V,{className:"w-5 h-5"}),"New Container"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Container Ref"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Supplier"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Import Date"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Invoice Value"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Import Expenses"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:I?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-8 text-center text-gray-500",children:"Loading..."})}):_.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-6 py-8 text-center text-gray-500",children:"No import containers found. Create your first container to start tracking costs."})}):_.map(t=>{var r;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.container_ref})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:(r=t.suppliers)==null?void 0:r.company_name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:Z(t.import_date)})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:e.jsx("div",{className:"text-sm text-gray-900",children:p(t.import_invoice_value,t.currency)})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right",children:[e.jsx("div",{className:"text-sm text-gray-900 font-semibold",children:p(t.linked_expenses_total||0,"IDR")}),t.total_import_expenses>0&&t.total_import_expenses!==t.linked_expenses_total&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Direct: ",p(t.total_import_expenses,"IDR")]})]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:A(t.status)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[t.status==="draft"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>R(t),className:"text-blue-600 hover:text-blue-800",title:"Edit",children:e.jsx(w,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>E(t.id),className:"text-green-600 hover:text-green-800",title:"Allocate Costs",children:e.jsx(v,{className:"w-4 h-4"})})]}),t.status!=="draft"&&e.jsx("span",{className:"text-gray-400 text-xs",children:"Locked"})]})})]},t.id)})})]})}),N&&e.jsx(W,{isOpen:N,onClose:()=>{m(!1),u(null),h()},title:x?"Edit Import Container":"New Import Container",maxWidth:"max-w-4xl",children:e.jsxs("form",{onSubmit:F,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Container Ref ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:s.container_ref,onChange:t=>a({...s,container_ref:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Supplier ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx(Y,{value:s.supplier_id,onChange:t=>a({...s,supplier_id:t}),options:k.map(t=>({value:t.id,label:t.company_name})),placeholder:"Select Supplier"})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Import Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:s.import_date,onChange:t=>a({...s,import_date:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency"}),e.jsxs("select",{value:s.currency,onChange:t=>a({...s,currency:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"USD",children:"USD"}),e.jsx("option",{value:"IDR",children:"IDR"}),e.jsx("option",{value:"CNY",children:"CNY"}),e.jsx("option",{value:"INR",children:"INR"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Exchange Rate"}),e.jsx("input",{type:"number",step:"0.01",value:s.exchange_rate,onChange:t=>a({...s,exchange_rate:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Invoice Value ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",value:s.import_invoice_value,onChange:t=>a({...s,import_invoice_value:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-3",children:"Import Cost Breakdown (IDR)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"BM (Duty)"}),e.jsx("input",{type:"number",step:"0.01",value:s.duty_bm,onChange:t=>a({...s,duty_bm:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"PPN Import"}),e.jsx("input",{type:"number",step:"0.01",value:s.ppn_import,onChange:t=>a({...s,ppn_import:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"PPh Import"}),e.jsx("input",{type:"number",step:"0.01",value:s.pph_import,onChange:t=>a({...s,pph_import:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Freight Charges"}),e.jsx("input",{type:"number",step:"0.01",value:s.freight_charges,onChange:t=>a({...s,freight_charges:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Clearing & Forwarding"}),e.jsx("input",{type:"number",step:"0.01",value:s.clearing_forwarding,onChange:t=>a({...s,clearing_forwarding:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Port Charges"}),e.jsx("input",{type:"number",step:"0.01",value:s.port_charges,onChange:t=>a({...s,port_charges:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Container Handling"}),e.jsx("input",{type:"number",step:"0.01",value:s.container_handling,onChange:t=>a({...s,container_handling:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Transportation"}),e.jsx("input",{type:"number",step:"0.01",value:s.transportation,onChange:t=>a({...s,transportation:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Loading / Unloading"}),e.jsx("input",{type:"number",step:"0.01",value:s.loading_import,onChange:t=>a({...s,loading_import:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"BPOM / SKI Fees"}),e.jsx("input",{type:"number",step:"0.01",value:s.bpom_ski_fees,onChange:t=>a({...s,bpom_ski_fees:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:["Other Import Costs",e.jsx("span",{className:"text-xs text-blue-600 ml-2",children:"âœ“ Auto-calculated from expenses"})]}),e.jsx("input",{type:"number",step:"0.01",value:s.other_import_costs,readOnly:!0,disabled:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-100 cursor-not-allowed",title:"This is automatically calculated from all 'Other (Import)' expenses linked to this container"}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:'Add expenses with category "Other (Import)" in Finance â†’ Expenses to update this'})]})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-blue-200",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-blue-900",children:"Total Import Expenses:"}),e.jsx("span",{className:"text-lg font-bold text-blue-900",children:p(T(),"IDR")})]})})]}),x&&y.length>0&&e.jsxs("div",{className:"bg-green-50 border-2 border-green-200 rounded-lg p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-green-900 mb-3",children:"ðŸ“Ž Linked Expenses from Finance Tracker"}),e.jsx("div",{className:"space-y-2 max-h-60 overflow-y-auto",children:y.map(t=>e.jsxs("div",{className:"bg-white rounded p-3 flex justify-between items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm text-gray-900",children:P(t.expense_category)}),e.jsxs("div",{className:"text-xs text-gray-600",children:[t.expense_date," â€¢ ",t.description||"No description"]})]}),e.jsx("div",{className:"text-right",children:e.jsx("div",{className:"font-semibold text-green-700",children:p(t.amount,"IDR")})})]},t.id))}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-green-300 flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-green-900",children:"Total from Linked Expenses:"}),e.jsx("span",{className:"text-lg font-bold text-green-900",children:p(y.reduce((t,r)=>t+r.amount,0),"IDR")})]}),e.jsx("p",{className:"mt-2 text-xs text-green-700",children:"ðŸ’¡ These expenses are automatically linked to this container. Add new expenses in the Finance > Expense Manager and select this container."})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:s.notes,onChange:t=>a({...s,notes:t.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsx("div",{className:"bg-amber-50 border border-amber-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{className:"w-5 h-5 text-amber-600 flex-shrink-0"}),e.jsxs("div",{className:"text-sm text-amber-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Important:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsx("li",{children:"Link batches to this container before allocating costs"}),e.jsx("li",{children:"Once allocated, container and batch costs are locked"}),e.jsx("li",{children:"Costs are allocated proportionally by invoice value"}),e.jsx("li",{children:"All import costs will be CAPITALIZED to inventory"})]})]})]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{m(!1),u(null),h()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[x?"Update":"Create"," Container"]})]})]})})]})})}export{le as default};
