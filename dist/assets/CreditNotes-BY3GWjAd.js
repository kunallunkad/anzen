import{r as f,d as $,j as e,X as me,u as ue,s as N,A as he,i as xe,T as z,h as U,f as C}from"./index-05MON0zc.js";import{L as be}from"./Layout-9pjiZa2A.js";import{D as ge}from"./DataTable-DghMVdqP.js";import{M as fe}from"./Modal-DojL8f5j.js";import{S as je}from"./SearchableSelect-rThwoRtO.js";import{h as ye,E as ve}from"./html2canvas.esm-2-KN9102.js";import{P as Ne}from"./printer-DeVD-0IS.js";import{D as _e}from"./download-DgYIVgez.js";import{f as J}from"./dateFormat-E6B5rKFz.js";import{P as we}from"./plus-C8ciBmA_.js";import{E as Ce}from"./eye-ZtrRT66G.js";import{X as ke}from"./x-circle-9F53lfQy.js";import"./search-CGgsAlNq.js";import"./chevron-up-TszMf-vQ.js";import"./chevron-down-C44n7mhs.js";function Se({creditNote:x,items:j,onClose:u}){const k=f.useRef(null),{language:d}=$(),S=s=>s==null?"Rp 0,00":`Rp ${s.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,I=s=>{const p=new Date(s),h=d==="id"?["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agt","Sep","Okt","Nov","Des"]:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],g=p.getDate(),c=h[p.getMonth()],n=p.getFullYear();return`${g} ${c} ${n}`},q=s=>d==="id"?P(s):W(s),P=s=>{if(s===0)return"Nol";const p=["","Satu","Dua","Tiga","Empat","Lima","Enam","Tujuh","Delapan","Sembilan"],h=["Sepuluh","Sebelas","Dua Belas","Tiga Belas","Empat Belas","Lima Belas","Enam Belas","Tujuh Belas","Delapan Belas","Sembilan Belas"],g=["","","Dua Puluh","Tiga Puluh","Empat Puluh","Lima Puluh","Enam Puluh","Tujuh Puluh","Delapan Puluh","Sembilan Puluh"],c=n=>{if(n===0)return"";if(n<10)return p[n];if(n>=10&&n<20)return h[n-10];if(n<100){const v=Math.floor(n/10),l=n%10;return g[v]+(l>0?" "+p[l]:"")}const o=Math.floor(n/100),b=n%100;return(o===1?"Seratus":p[o]+" Ratus")+(b>0?" "+c(b):"")};if(s<1e3)return c(s);if(s<1e6){const n=Math.floor(s/1e3),o=s%1e3;return(n===1?"Seribu":c(n)+" Ribu")+(o>0?" "+c(o):"")}if(s<1e9){const n=Math.floor(s/1e6),o=s%1e6,b=c(n)+" Juta",y=o>=1e3?(Math.floor(o/1e3)===1?"Seribu":c(Math.floor(o/1e3))+" Ribu")+(o%1e3>0?" "+c(o%1e3):""):o>0?c(o):"";return b+(y?" "+y:"")}return s.toString()},W=s=>{if(s===0)return"Zero";const p=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"],h=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"],g=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"],c=n=>{if(n===0)return"";if(n<10)return p[n];if(n>=10&&n<20)return h[n-10];if(n<100){const y=Math.floor(n/10),v=n%10;return g[y]+(v>0?" "+p[v]:"")}const o=Math.floor(n/100),b=n%100;return p[o]+" Hundred"+(b>0?" "+c(b):"")};if(s<1e3)return c(s);if(s<1e6){const n=Math.floor(s/1e3),o=s%1e3;return c(n)+" Thousand"+(o>0?" "+c(o):"")}if(s<1e9){const n=Math.floor(s/1e6),o=s%1e6,b=o>=1e3?c(Math.floor(o/1e3))+" Thousand"+(o%1e3>0?" "+c(o%1e3):""):o>0?c(o):"";return c(n)+" Million"+(b?" "+b:"")}return s.toString()},A=()=>{window.print()},F=async()=>{if(k.current)try{const s=await ye(k.current,{scale:2,useCORS:!0,allowTaint:!0,logging:!1,backgroundColor:"#ffffff",windowWidth:k.current.scrollWidth,windowHeight:k.current.scrollHeight,onclone:v=>{const l=v.getElementById("credit-note-print-content");l&&(l.style.width="210mm")}}),p=s.toDataURL("image/png",1),h=new ve("p","mm","a4"),g=h.internal.pageSize.getWidth(),c=h.internal.pageSize.getHeight(),n=s.width,o=s.height,b=g/n,y=o*b;if(y>c){let v=0,l=y;for(;l>0;)h.addImage(p,"PNG",0,v,g,y),l-=c,v-=c,l>0&&h.addPage()}else h.addImage(p,"PNG",0,0,g,y);h.save(`CreditNote-${x.credit_note_number}.pdf`)}catch(s){console.error("Error generating PDF:",s),alert("Failed to generate PDF. Please try again.")}},m=x.customers;return e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 print:static print:bg-white print:overflow-visible",children:[e.jsx("div",{className:"flex min-h-screen items-start justify-center p-4 pt-10 print:p-0 print:min-h-0 print:block",children:e.jsxs("div",{className:"relative w-full max-w-5xl bg-white shadow-xl print:shadow-none print:max-w-full",children:[e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b bg-white px-6 py-4",style:{printColorAdjust:"exact",WebkitPrintColorAdjust:"exact"},children:[e.jsxs("h2",{className:"text-xl font-bold text-gray-900",children:[d==="id"?"Nota Kredit":"Credit Note"," ",x.credit_note_number]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:A,className:"flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-white hover:bg-blue-700",children:[e.jsx(Ne,{className:"h-4 w-4"}),d==="id"?"Cetak":"Print"]}),e.jsxs("button",{onClick:F,className:"flex items-center gap-2 rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700",children:[e.jsx(_e,{className:"h-4 w-4"}),"PDF"]}),e.jsx("button",{onClick:u,className:"rounded-lg bg-gray-100 p-2 text-gray-600 hover:bg-gray-200",children:e.jsx(me,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{id:"credit-note-print-content",ref:k,className:"p-8",children:[e.jsxs("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:[e.jsxs("div",{className:"mb-2 flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-16 w-16 flex items-center justify-center print:h-12 print:w-12",style:{backgroundColor:"#fff"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",width:"100%",height:"100%",viewBox:"0 0 15686.55 15480.24",style:{shapeRendering:"geometricPrecision",fillRule:"evenodd",clipRule:"evenodd"},children:e.jsxs("g",{children:[e.jsx("path",{fill:"#FDB763",d:"M69.94 10438.12l10353.39 0 0 -1798.67 1665.92 0 0 1868.6 0 320.44 0 4552.28c0,38.48 -31.45,69.94 -69.94,69.94l-11949.38 0c-38.48,0 -69.94,-31.45 -69.94,-69.94l0 -4872.72c0,-38.48 31.45,-69.94 69.94,-69.94zm1605.9 1710.15l8737.57 0c13.58,0 24.68,11.11 24.68,24.68l0 1719.84c0,13.58 -11.11,24.68 -24.68,24.68l-8737.57 0c-13.58,0 -24.68,-11.11 -24.68,-24.68l0 -1719.84c0,-13.58 11.11,-24.68 24.68,-24.68z"}),e.jsx("path",{fill:"#FDB763",d:"M15587.15 5136.67l-10353.49 0 0 1822.07 -1665.92 0 0 -1892.9 0 -324.61 0 -4611.43c0,-39 31.45,-70.87 69.94,-70.87l11949.47 0c38.48,0 69.94,31.87 69.94,70.87l0 4936.04c0,39 -31.45,70.83 -69.94,70.83zm-1605.9 -1732.36l-8737.67 0c-13.58,0 -24.68,-11.27 -24.68,-25l0 -1742.21c0,-13.74 11.11,-25 24.68,-25l8737.67 0c13.58,0 24.68,11.27 24.68,25l0 1742.21c0,13.74 -11.11,25 -24.68,25z"}),e.jsx("polygon",{fill:"#FD6D26",points:"-0,0 1651.16,0 1651.16,6929.27 15657.09,6929.27 15657.09,6958.74 15686.55,6958.74 15686.55,15480.24 14022.85,15480.24 14022.85,8639.45 1651.16,8639.45 -0,8639.45 -0,6929.27"})]})})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-base font-bold print:text-sm",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Komplek Ruko Metro Sunter Blok A1 NO.15, Jl. Metro Indah Raya,"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Kelurahan Papanggo, Kec. Tanjung Priok, Jakarta Utara - 14340"}),e.jsx("p",{className:"text-xs print:text-[10px]",children:"Telp: (+62 21) 65832426"})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("h2",{className:"text-3xl font-bold text-red-600 print:text-2xl",children:"CREDIT NOTE"})})]}),e.jsxs("div",{className:"text-xs space-y-0.5 print:text-[10px] print:space-y-0",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No izin PBF"}),e.jsx("span",{className:"ml-16",children:": 27092400534390007"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-semibold",children:"No Sertifikasi CDOB"}),e.jsx("span",{className:"ml-4",children:": 270924005343900070001"})]})]})]}),e.jsx("div",{className:"mb-3 border-2 border-black p-3 print:mb-2 print:p-2",children:e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 flex-1",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Company Name:"}),e.jsxs("span",{className:"font-semibold",children:[" ",(m==null?void 0:m.company_name)||""]})]}),e.jsxs("div",{className:"pt-1 flex",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Address:"}),e.jsxs("div",{children:[e.jsx("p",{children:(m==null?void 0:m.address)||""}),e.jsx("p",{children:(m==null?void 0:m.city)||""})]})]}),e.jsxs("div",{className:"flex pt-1",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"Phone:"}),e.jsx("span",{children:(m==null?void 0:m.phone)||""})]}),e.jsxs("div",{className:"flex",children:[e.jsx("span",{className:"font-bold",style:{minWidth:"72px"},children:"NPWP:"}),e.jsx("span",{children:(m==null?void 0:m.npwp)||""})]})]}),e.jsxs("div",{className:"space-y-1 text-xs print:text-[10px] print:space-y-0 text-right",style:{minWidth:"200px"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Credit Note No:"}),e.jsx("span",{className:"ml-2",children:x.credit_note_number})]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-bold",children:"Date:"}),e.jsx("span",{className:"ml-2",children:I(x.credit_note_date)})]}),x.original_invoice_number&&e.jsxs("div",{className:"pt-1",children:[e.jsx("span",{className:"font-bold",children:"Original Invoice:"}),e.jsx("span",{className:"ml-2",children:x.original_invoice_number})]})]})]})}),e.jsx("div",{children:e.jsxs("table",{className:"w-full border-2 border-black text-xs print:text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b-2 border-black bg-white",children:[e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"No."}),e.jsx("th",{className:"border-r border-black p-1.5 text-left font-bold print:p-1",children:"Product Name"}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Batch No."}),e.jsx("th",{className:"border-r border-black p-1.5 text-center font-bold print:p-1",children:"Quantity"}),e.jsx("th",{className:"border-r border-black p-1.5 text-right font-bold print:p-1",children:"Unit Price (IDR)"}),e.jsx("th",{className:"p-1.5 text-right font-bold print:p-1",children:"Sub Total (IDR)"})]})}),e.jsxs("tbody",{children:[j.map((s,p)=>{var n,o;const h=s.quantity||0,g=s.unit_price||0,c=h*g;return e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:p+1}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:((n=s.products)==null?void 0:n.product_name)||"Unknown Product"}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:((o=s.batches)==null?void 0:o.batch_number)||"N/A"}),e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:h.toLocaleString()}),e.jsx("td",{className:"border-r border-black p-1.5 text-right print:p-1",children:S(g)}),e.jsx("td",{className:"p-1.5 text-right print:p-1",children:S(c)})]},s.id||p)}),j.length<2&&Array.from({length:2-j.length}).map((s,p)=>e.jsxs("tr",{className:"border-b border-black",children:[e.jsx("td",{className:"border-r border-black p-1.5 text-center print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"border-r border-black p-1.5 print:p-1",children:" "}),e.jsx("td",{className:"p-1.5 print:p-1",children:" "})]},`empty-${p}`))]})]})}),e.jsxs("div",{className:"border-2 border-black border-t-0",children:[e.jsxs("div",{className:"flex items-stretch border-b-2 border-black",children:[e.jsxs("div",{className:"flex-1 p-2 border-r-2 border-black print:p-1.5",children:[e.jsx("p",{className:"text-xs font-bold print:text-[10px]",children:d==="id"?"Amount In words:":"Amount in words:"}),e.jsxs("p",{className:"text-xs mt-0.5 font-bold uppercase print:text-[10px] print:mt-0",children:["IDR ",q(Math.round(x.total_amount))," RUPIAH"]})]}),e.jsxs("div",{className:"w-80 text-xs p-2 print:text-[10px] print:p-1.5",children:[e.jsxs("div",{className:"flex justify-between py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"Sub Total"}),e.jsx("span",{className:"font-bold",children:S(x.subtotal)})]}),e.jsxs("div",{className:"flex justify-between border-t border-black py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"VAT (PPN) 11%"}),e.jsx("span",{className:"font-bold",children:S(x.tax_amount)})]}),e.jsxs("div",{className:"flex justify-between border-t-2 border-black py-1 print:py-0.5",children:[e.jsx("span",{className:"font-bold",children:"Total Credit"}),e.jsx("span",{className:"font-bold text-sm text-red-600 print:text-xs",children:S(x.total_amount)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-0 text-xs print:text-[10px]",children:[e.jsxs("div",{className:"p-3 border-r-2 border-black print:p-2",children:[e.jsx("p",{className:"font-semibold mb-2 print:mb-1",children:"Reason for Credit:"}),e.jsx("p",{className:"text-sm",children:x.reason})]}),e.jsxs("div",{className:"p-3 print:p-2",children:[e.jsx("p",{className:"font-semibold mb-1",children:"Authorized Signatory:"}),e.jsx("p",{className:"font-semibold mb-10 print:mb-8",children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("div",{className:"w-4/5 border-t border-black pt-1",children:"Pharmacist"})]})]})]}),x.notes&&e.jsx("div",{className:"mt-3 border-2 border-black p-2 print:mt-2 print:p-1.5",children:e.jsxs("p",{className:"text-xs print:text-[10px]",children:[e.jsx("span",{className:"font-bold",children:"Notes: "}),e.jsx("span",{children:x.notes})]})})]})]})}),e.jsx("style",{children:`
        @media print {
          @page {
            size: A4 portrait;
            margin: 8mm;
          }

          .sticky {
            display: none !important;
          }

          body {
            margin: 0;
            padding: 0;
          }

          body * {
            visibility: hidden;
          }

          #credit-note-print-content,
          #credit-note-print-content * {
            visibility: visible;
          }

          #credit-note-print-content {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            page-break-inside: avoid;
            page-break-after: auto;
          }

          #credit-note-print-content > div {
            page-break-inside: avoid;
          }

          table {
            page-break-inside: auto;
          }

          tr {
            page-break-inside: avoid;
            page-break-after: auto;
          }

          thead {
            display: table-header-group;
          }

          tfoot {
            display: table-footer-group;
          }
        }
      `})]})}function ze(){const{t:x}=$(),{user:j,profile:u}=ue(),[k,d]=f.useState([]),[S,I]=f.useState(!0),[q,P]=f.useState(!1),[W,A]=f.useState(!1),[F,m]=f.useState(null),[s,p]=f.useState([]),[h,g]=f.useState([]),[c,n]=f.useState([]),[o,b]=f.useState([]),[y,v]=f.useState([]),[l,D]=f.useState({credit_note_number:"",credit_note_date:new Date().toISOString().split("T")[0],customer_id:"",original_invoice_id:"",original_invoice_number:"",reason:"",notes:"",currency:"IDR"}),[_,T]=f.useState([{product_id:"",batch_id:"",quantity:0,unit_price:0}]);f.useEffect(()=>{E()},[]);const E=async()=>{I(!0),await K(),await V(),await Q(),I(!1)},K=async()=>{try{const{data:t,error:r}=await N.from("credit_notes").select(`
          *,
          customers(company_name, address, city, phone, npwp, pharmacy_license)
        `).order("created_at",{ascending:!1});if(r)throw r;d(t||[])}catch(t){console.error("Error loading credit notes:",t)}},V=async()=>{try{const{data:t,error:r}=await N.from("customers").select("id, company_name").eq("is_active",!0).order("company_name");if(r)throw r;g(t||[])}catch(t){console.error("Error loading customers:",t)}},Q=async()=>{try{const{data:t,error:r}=await N.from("products").select("id, product_name, product_code").eq("is_active",!0).order("product_name");if(r)throw r;n(t||[])}catch(t){console.error("Error loading products:",t)}},G=async t=>{try{const{data:r,error:a}=await N.from("batches").select("id, batch_number, product_id, current_stock").eq("product_id",t).eq("is_active",!0).order("batch_number");if(a)throw a;b(r||[])}catch(r){console.error("Error loading batches:",r)}},X=async t=>{m(t);try{const{data:r,error:a}=await N.from("credit_note_items").select(`
          *,
          products(product_name, product_code),
          batches(batch_number)
        `).eq("credit_note_id",t.id);if(a)throw a;p(r||[]),A(!0)}catch(r){console.error("Error loading credit note items:",r)}},Y=async t=>{try{const{data:r,error:a}=await N.from("sales_invoices").select("id, invoice_number, invoice_date, total_amount").eq("customer_id",t).order("invoice_date",{ascending:!1});if(a)throw a;v(r||[])}catch(r){console.error("Error loading invoices:",r)}},Z=t=>{D({...l,customer_id:t,original_invoice_id:"",original_invoice_number:""}),t?Y(t):v([])},ee=async t=>{const r=y.find(a=>a.id===t);D({...l,original_invoice_id:t,original_invoice_number:(r==null?void 0:r.invoice_number)||""}),t?await te(t):T([{product_id:"",batch_id:"",quantity:0,unit_price:0}])},te=async t=>{try{const{data:r,error:a}=await N.from("sales_invoice_items").select(`
          product_id,
          batch_id,
          quantity,
          unit_price,
          products(product_name, product_code),
          batches(batch_number, current_stock)
        `).eq("invoice_id",t);if(a)throw a;if(r&&r.length>0){const i=r.map(w=>({product_id:w.product_id,batch_id:w.batch_id||"",quantity:w.quantity,unit_price:w.unit_price}));T(i)}}catch(r){console.error("Error loading invoice items:",r)}},re=()=>{T([..._,{product_id:"",batch_id:"",quantity:0,unit_price:0}])},se=t=>{_.length>1&&T(_.filter((r,a)=>a!==t))},R=(t,r,a)=>{const i=[..._];i[t]={...i[t],[r]:a},r==="product_id"&&(G(a),i[t].batch_id=""),T(i)},B=()=>{const t=_.reduce((i,w)=>i+w.quantity*w.unit_price,0),r=t*.11,a=t+r;return{subtotal:t,tax_amount:r,total_amount:a}},ae=async t=>{if(t.preventDefault(),!l.customer_id||!l.reason||_.length===0){C({type:"error",title:"Error",message:"Please complete all required fields"});return}if(_.some(a=>!a.product_id||!a.batch_id||a.quantity<=0||a.unit_price<=0)){C({type:"error",title:"Error",message:"Please complete all item details"});return}try{const a=B(),{data:i,error:w}=await N.from("credit_notes").insert({...l,...a,created_by:j==null?void 0:j.id}).select().single();if(w)throw w;const de=_.map(pe=>({...pe,credit_note_id:i.id})),{error:H}=await N.from("credit_note_items").insert(de);if(H)throw H;C({type:"success",title:"Success",message:"Credit note created successfully. Stock has been added back to inventory."}),P(!1),M(),E()}catch(a){console.error("Error creating credit note:",a),C({type:"error",title:"Error",message:a.message||"Failed to create credit note. Please try again."})}},ne=async t=>{if(await U({title:"Confirm",message:"Approve this credit note? Stock will be adjusted accordingly.",variant:"warning"}))try{const{error:r}=await N.from("credit_notes").update({status:"approved",approved_by:j==null?void 0:j.id}).eq("id",t);if(r)throw r;C({type:"success",title:"Success",message:"Credit note approved successfully"}),E()}catch(r){console.error("Error approving credit note:",r),C({type:"error",title:"Error",message:r.message||"Failed to approve credit note"})}},ie=async t=>{const r=prompt("Enter reason for rejection:");if(r)try{const{error:a}=await N.from("credit_notes").update({status:"rejected",approved_by:j==null?void 0:j.id,notes:r}).eq("id",t);if(a)throw a;C({type:"success",title:"Success",message:"Credit note rejected"}),E()}catch(a){console.error("Error rejecting credit note:",a),C({type:"error",title:"Error",message:a.message||"Failed to reject credit note"})}},oe=async t=>{if(await U({title:"Confirm",message:"Are you sure you want to delete this credit note? This will reverse the stock adjustment.",variant:"danger",confirmLabel:"Delete"}))try{const{error:r}=await N.from("credit_notes").delete().eq("id",t);if(r)throw r;C({type:"success",title:"Success",message:"Credit note deleted successfully"}),E()}catch(r){console.error("Error deleting credit note:",r),C({type:"error",title:"Error",message:r.message||"Failed to delete credit note"})}},M=()=>{D({credit_note_number:"",credit_note_date:new Date().toISOString().split("T")[0],customer_id:"",original_invoice_id:"",original_invoice_number:"",reason:"",notes:"",currency:"IDR"}),T([{product_id:"",batch_id:"",quantity:0,unit_price:0}])},O=(u==null?void 0:u.role)==="admin"||(u==null?void 0:u.role)==="sales"||(u==null?void 0:u.role)==="manager",le=(u==null?void 0:u.role)==="admin"||(u==null?void 0:u.role)==="manager",ce=[{key:"credit_note_number",label:"Credit Note #",render:(t,r)=>r.credit_note_number||"Pending"},{key:"credit_note_date",label:"Date",render:(t,r)=>J(r.credit_note_date)},{key:"customer",label:"Customer",render:(t,r)=>{var a;return((a=r.customers)==null?void 0:a.company_name)||"N/A"}},{key:"original_invoice_number",label:"Original Invoice",render:(t,r)=>r.original_invoice_number||"N/A"},{key:"total_amount",label:"Amount",render:(t,r)=>`${r.currency} ${r.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2})}`},{key:"status",label:"Status",render:(t,r)=>{var a;return e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${r.status==="approved"?"bg-green-100 text-green-800":r.status==="rejected"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:((a=r.status)==null?void 0:a.replace("_"," "))||"pending approval"})}},{key:"reason",label:"Reason",render:(t,r)=>e.jsx("span",{className:"text-sm text-gray-600 truncate max-w-xs block",children:r.reason})}],L=B();return e.jsx(be,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Credit Notes"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage credit notes for returns and adjustments after invoicing"})]}),O&&e.jsxs("button",{onClick:()=>{M(),P(!0)},className:"flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition",children:[e.jsx(we,{className:"w-5 h-5"}),"Create Credit Note"]})]}),e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex gap-3",children:[e.jsx(he,{className:"w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"text-sm text-yellow-800",children:[e.jsx("p",{className:"font-medium",children:"When to use Credit Notes:"}),e.jsx("p",{className:"mt-1",children:"Use Credit Notes for goods returned or price adjustments AFTER an invoice has been issued and filed for tax purposes. For physical returns before invoicing, use Material Returns instead."})]})]}),e.jsx(ge,{columns:ce,data:k,loading:S,actions:t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>X(t),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"View Credit Note",children:e.jsx(Ce,{className:"w-4 h-4"})}),le&&(!t.status||t.status==="pending_approval")&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ne(t.id),className:"p-1 text-green-600 hover:bg-green-50 rounded",title:"Approve Credit Note",children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ie(t.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Reject Credit Note",children:e.jsx(ke,{className:"w-4 h-4"})})]}),O&&(!t.status||t.status==="pending_approval")&&e.jsx("button",{onClick:()=>oe(t.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete Credit Note",children:e.jsx(z,{className:"w-4 h-4"})})]})}),e.jsx(fe,{isOpen:q,onClose:()=>{P(!1),M()},title:"Create Credit Note",children:e.jsxs("form",{onSubmit:ae,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer *"}),e.jsx(je,{value:l.customer_id,onChange:t=>Z(t),options:h.map(t=>({value:t.id,label:t.company_name})),placeholder:"Select Customer"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Original Invoice (Optional)"}),e.jsxs("select",{value:l.original_invoice_id,onChange:t=>ee(t.target.value),disabled:!l.customer_id,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select Invoice"}),y.map(t=>e.jsxs("option",{value:t.id,children:[t.invoice_number," - ",J(t.invoice_date)," - Rp ",t.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Credit Note Date *"}),e.jsx("input",{type:"date",value:l.credit_note_date,onChange:t=>D({...l,credit_note_date:t.target.value}),required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency"}),e.jsxs("select",{value:l.currency,onChange:t=>D({...l,currency:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent",children:[e.jsx("option",{value:"IDR",children:"IDR"}),e.jsx("option",{value:"USD",children:"USD"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reason for Credit Note *"}),e.jsx("textarea",{value:l.reason,onChange:t=>D({...l,reason:t.target.value}),required:!0,rows:2,placeholder:"e.g., Goods returned due to quality issue, Price adjustment, etc.",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Items Being Credited"}),!l.original_invoice_id&&e.jsx("button",{type:"button",onClick:re,className:"text-sm text-red-600 hover:text-red-700 font-medium",children:"+ Add Item"})]}),e.jsx("div",{className:"space-y-3",children:_.map((t,r)=>{var a;return e.jsxs("div",{className:"p-3 border border-gray-200 rounded-lg space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsxs("select",{value:t.product_id,onChange:i=>R(r,"product_id",i.target.value),required:!0,disabled:!!l.original_invoice_id,className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select Product"}),c.map(i=>e.jsxs("option",{value:i.id,children:[i.product_name," (",i.product_code,")"]},i.id))]}),t.product_id&&c.find(i=>i.id===t.product_id)&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:(a=c.find(i=>i.id===t.product_id))==null?void 0:a.product_name})]}),e.jsx("div",{children:e.jsxs("select",{value:t.batch_id,onChange:i=>R(r,"batch_id",i.target.value),required:!0,disabled:!t.product_id||!!l.original_invoice_id,className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg disabled:bg-gray-100",children:[e.jsx("option",{value:"",children:"Select Batch"}),o.filter(i=>i.product_id===t.product_id).map(i=>e.jsxs("option",{value:i.id,children:[i.batch_number," (Stock: ",i.current_stock,")"]},i.id))]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Quantity (Kg)"}),e.jsx("input",{type:"number",step:"0.001",placeholder:"Quantity in Kg",value:t.quantity||"",onChange:i=>R(r,"quantity",parseFloat(i.target.value)||0),required:!0,min:"0.001",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Unit Price (per Kg)"}),e.jsx("input",{type:"number",step:"0.01",placeholder:"Price per Kg",value:t.unit_price||"",onChange:i=>R(r,"unit_price",parseFloat(i.target.value)||0),required:!0,min:"0",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600",children:["Line Total: ",e.jsxs("span",{className:"font-semibold",children:[l.currency," ",(t.quantity*t.unit_price).toLocaleString("id-ID",{minimumFractionDigits:2})]})]}),_.length>1&&e.jsx("button",{type:"button",onClick:()=>se(r),className:"text-red-600 hover:text-red-800",children:e.jsx(z,{className:"w-4 h-4"})})]})]},r)})})]}),e.jsx("div",{className:"border-t pt-4",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsxs("span",{className:"font-semibold",children:[l.currency," ",L.subtotal.toLocaleString("id-ID",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-2",children:[e.jsx("span",{children:"Total Credit:"}),e.jsxs("span",{className:"text-red-600",children:[l.currency," ",L.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2})]})]})]})}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Additional Notes"}),e.jsx("textarea",{value:l.notes,onChange:t=>D({...l,notes:t.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{P(!1),M()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition",children:"Create Credit Note"})]})]})}),W&&F&&e.jsx(Se,{creditNote:F,items:s,onClose:()=>{A(!1),m(null),p([])}})]})})}export{ze as CreditNotes};
