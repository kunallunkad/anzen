import{c as u,u as ge,r as a,s as o,j as s,X as w,F as pe}from"./index-B8TvHX1I.js";import{M as he}from"./Modal-N9RPCWXO.js";import{S as be}from"./search-B_8Clcwu.js";import{L as fe}from"./loader-BWQD9qzr.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=u("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=u("Circle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=u("Flame",[["path",{d:"M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z",key:"96xj49"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=u("Minus",[["path",{d:"M5 12h14",key:"1ays0h"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=u("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=u("Tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]);function qe({isOpen:b,onClose:k,onSuccess:X,initialData:m}){const{user:c}=ge(),[f,_]=a.useState(!1),[C,G]=a.useState([]),[J,Q]=a.useState([]),[W,Y]=a.useState([]),[Z,O]=a.useState([]),S=a.useRef(null),[x,ee]=a.useState(""),[T,se]=a.useState(""),[y,q]=a.useState(""),[j,P]=a.useState(""),[$,te]=a.useState("medium"),[l,E]=a.useState([]),[F,U]=a.useState(""),[A,D]=a.useState(""),[M,L]=a.useState(""),[d,R]=a.useState([]),[g,z]=a.useState(""),[p,I]=a.useState([]),[v,re]=a.useState(""),[ae,le]=a.useState(!1);a.useEffect(()=>{if(b){oe(),ne(),ie(),ce(),m&&(U(m.inquiry_id||""),D(m.customer_id||""),L(m.product_id||""));const e=new Date;e.setDate(e.getDate()+1),q(e.toISOString().split("T")[0]),P("17:00")}},[b,m]);const oe=async()=>{try{const{data:e,error:t}=await o.from("user_profiles").select("id, full_name, email, role").eq("is_active",!0).order("full_name");if(t)throw t;G(e||[])}catch(e){console.error("Error loading users:",e)}},ne=async()=>{try{const{data:e,error:t}=await o.from("crm_inquiries").select("id, inquiry_number, company_name, product_name").order("created_at",{ascending:!1}).limit(100);if(t)throw t;Q((e||[]).map(r=>({id:r.id,label:`${r.inquiry_number} - ${r.company_name} (${r.product_name})`})))}catch(e){console.error("Error loading inquiries:",e)}},ie=async()=>{try{const{data:e,error:t}=await o.from("customers").select("id, company_name, contact_person").eq("is_active",!0).order("company_name");if(t)throw t;Y((e||[]).map(r=>({id:r.id,label:`${r.company_name}${r.contact_person?` (${r.contact_person})`:""}`})))}catch(e){console.error("Error loading customers:",e)}},ce=async()=>{try{const{data:e,error:t}=await o.from("products").select("id, product_name, product_code").eq("is_active",!0).order("product_name");if(t)throw t;O((e||[]).map(r=>({id:r.id,label:`${r.product_name}${r.product_code?` (${r.product_code})`:""}`})))}catch(e){console.error("Error loading products:",e)}},B=e=>{l.includes(e)?E(l.filter(t=>t!==e)):E([...l,e])},H=()=>{g.trim()&&!d.includes(g.trim())&&(R([...d,g.trim()]),z(""))},de=e=>{R(d.filter(t=>t!==e))},ue=async e=>{const t=[];for(const r of p){const n=`${Date.now()}_${r.name}`,i=`tasks/${e}/${n}`,{error:h}=await o.storage.from("task-attachments").upload(i,r);h?console.error("Error uploading file:",h):t.push(i)}return t},me=async e=>{if(e.preventDefault(),!x.trim()){alert("Please enter a task title");return}if(!y||!j){alert("Please set a deadline");return}if(l.length===0){alert("Please assign at least one user");return}try{_(!0);const t=`${y}T${j}:00`,r={title:x.trim(),description:T.trim()||null,deadline:t,priority:$,created_by:c==null?void 0:c.id,assigned_users:l,inquiry_id:F||null,customer_id:A||null,product_id:M||null,tags:d},{data:n,error:i}=await o.from("tasks").insert([r]).select().single();if(i)throw i;if(p.length>0&&n){const N=await ue(n.id),{error:V}=await o.from("tasks").update({attachment_urls:N}).eq("id",n.id);if(V)throw V}const h=l.map(N=>({task_id:n.id,assigned_user_id:N,assigned_by:c==null?void 0:c.id})),{error:K}=await o.from("task_assignments").insert(h);if(K)throw K;X()}catch(t){console.error("Error creating task:",t),alert("Failed to create task. Please try again.")}finally{_(!1)}},xe=C.filter(e=>e.full_name.toLowerCase().includes(v.toLowerCase())||e.email.toLowerCase().includes(v.toLowerCase()));return s.jsx(he,{isOpen:b,onClose:k,title:"Create New Task",size:"lg",children:s.jsxs("form",{onSubmit:me,className:"space-y-6",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Task Title ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"text",value:x,onChange:e=>ee(e.target.value),placeholder:"e.g., Send quotation to customer",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),s.jsx("textarea",{value:T,onChange:e=>se(e.target.value),placeholder:"Add detailed instructions or notes...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",rows:4})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Deadline Date ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"date",value:y,onChange:e=>q(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Deadline Time ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsx("input",{type:"time",value:j,onChange:e=>P(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",required:!0})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Priority ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("select",{value:$,onChange:e=>te(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"low",children:"Low"}),s.jsx("option",{value:"medium",children:"Medium"}),s.jsx("option",{value:"high",children:"High"}),s.jsx("option",{value:"urgent",children:"Urgent"})]})]})]}),s.jsxs("div",{children:[s.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Assign To ",s.jsx("span",{className:"text-red-500",children:"*"})]}),s.jsxs("div",{className:"relative",children:[s.jsx("input",{type:"text",value:v,onChange:e=>re(e.target.value),onFocus:()=>le(!0),placeholder:"Search users...",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),s.jsx(be,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),ae&&s.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto",children:xe.map(e=>s.jsxs("button",{type:"button",onClick:()=>B(e.id),className:`w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center justify-between ${l.includes(e.id)?"bg-blue-50":""}`,children:[s.jsxs("div",{children:[s.jsx("p",{className:"text-sm font-medium text-gray-900",children:e.full_name}),s.jsxs("p",{className:"text-xs text-gray-500",children:[e.email," â€¢ ",e.role]})]}),l.includes(e.id)&&s.jsx("div",{className:"w-5 h-5 bg-blue-600 rounded-full flex items-center justify-center",children:s.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:s.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})})]},e.id))})]}),l.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:l.map(e=>{const t=C.find(r=>r.id===e);return s.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm",children:[t==null?void 0:t.full_name,s.jsx("button",{type:"button",onClick:()=>B(e),className:"text-blue-600 hover:text-blue-800",children:s.jsx(w,{className:"w-4 h-4"})})]},e)})})]}),s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Inquiry"}),s.jsxs("select",{value:F,onChange:e=>U(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"",children:"None"}),J.map(e=>s.jsx("option",{value:e.id,children:e.label},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Customer"}),s.jsxs("select",{value:A,onChange:e=>D(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"",children:"None"}),W.map(e=>s.jsx("option",{value:e.id,children:e.label},e.id))]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Related Product"}),s.jsxs("select",{value:M,onChange:e=>L(e.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500",children:[s.jsx("option",{value:"",children:"None"}),Z.map(e=>s.jsx("option",{value:e.id,children:e.label},e.id))]})]})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tags"}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("input",{type:"text",value:g,onChange:e=>z(e.target.value),onKeyPress:e=>e.key==="Enter"&&(e.preventDefault(),H()),placeholder:"Add tag and press Enter",className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"}),s.jsx("button",{type:"button",onClick:H,className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition",children:"Add"})]}),d.length>0&&s.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:d.map(e=>s.jsxs("span",{className:"inline-flex items-center gap-1 px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-sm",children:[s.jsx(je,{className:"w-3 h-3"}),e,s.jsx("button",{type:"button",onClick:()=>de(e),className:"text-gray-500 hover:text-red-600",children:s.jsx(w,{className:"w-3 h-3"})})]},e))})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Attachments"}),s.jsx("input",{ref:S,type:"file",multiple:!0,onChange:e=>{e.target.files&&I(Array.from(e.target.files))},className:"hidden"}),s.jsxs("button",{type:"button",onClick:()=>{var e;return(e=S.current)==null?void 0:e.click()},className:"flex items-center gap-2 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:[s.jsx(ye,{className:"w-4 h-4"}),"Choose Files"]}),p.length>0&&s.jsx("div",{className:"mt-2 space-y-2",children:p.map((e,t)=>s.jsxs("div",{className:"flex items-center justify-between p-2 bg-gray-50 border border-gray-200 rounded-lg",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(pe,{className:"w-4 h-4 text-gray-500"}),s.jsx("span",{className:"text-sm text-gray-700",children:e.name}),s.jsxs("span",{className:"text-xs text-gray-500",children:["(",(e.size/1024).toFixed(1)," KB)"]})]}),s.jsx("button",{type:"button",onClick:()=>I(r=>r.filter((n,i)=>i!==t)),className:"text-red-600 hover:text-red-700",children:s.jsx(w,{className:"w-4 h-4"})})]},t))})]}),s.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[s.jsx("button",{type:"button",onClick:k,disabled:f,className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition disabled:opacity-50",children:"Cancel"}),s.jsx("button",{type:"submit",disabled:f||!x.trim()||l.length===0,className:"flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed",children:f?s.jsxs(s.Fragment,{children:[s.jsx(fe,{className:"w-4 h-4 animate-spin"}),"Creating..."]}):"Create Task"})]})]})})}export{_e as A,Ce as C,Se as F,Te as M,ye as P,qe as T,je as a};
