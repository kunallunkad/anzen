import{c as ft,r as n,s as l,j as e,X as yt,f as fe,T as pt,h as kt,m as xt,n as it,F as Ue,u as Rt,i as ja,d as Ut,a as Na,A as $t,e as va,C as sa}from"./index-DvtEbx4A.js";import{D as Ye,P as lt,C as wa,U as ka,T as qt,L as Da,c as Sa}from"./Layout-B_Kx8kGP.js";import{P as mt,M as qe}from"./Modal-BV7rDng6.js";import{S as Vt}from"./SearchableSelect-1QvNirE6.js";import{F as Ca,C as Ea}from"./FileUpload-8O2mgeQD.js";import{f as ct}from"./dateFormat-E6B5rKFz.js";import{S as _t}from"./search-Do2F0vlo.js";import{E as Lt}from"./eye-RI7-6vtf.js";import{P as na,h as ra,E as ia}from"./html2canvas.esm-DiWwnxg4.js";import{P as la,B as Ve,r as Ia,u as Bt,w as Pa}from"./xlsx-BSnFKn_c.js";import{D as Dt}from"./download-CxXm7ySC.js";import{E as Mt}from"./external-link-CvAnoLls.js";import{U as Pt}from"./upload-XkkKomxd.js";import{I as Aa}from"./image-BgCannwK.js";import{S as Nt}from"./square-pen-BZK9yoKc.js";import{R as At}from"./refresh-cw-2-X_InNp.js";import{M as Fa}from"./mail-BzlgycWa.js";import{D as Ft}from"./DataTable-C-riE1av.js";import{C as Ra}from"./chevron-up-BtuUn4j2.js";import{C as Wt}from"./chevron-down-CgafNpCv.js";import{X as Tt}from"./x-circle-CHUFxQCO.js";import{C as Ot}from"./check-circle-2-Da0uTHW0.js";import{C as ca}from"./chevron-right-4HZQum3c.js";import{T as La}from"./trending-down-C1FLmZd-.js";import{R as Ta}from"./rotate-ccw-B5UP7qZf.js";import{S as Oa}from"./save-Bm9L5uec.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=ft("ArrowDownCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 8v8",key:"napkw2"}],["path",{d:"m8 12 4 4 4-4",key:"k98ssh"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=ft("ArrowRightLeft",[["path",{d:"m16 3 4 4-4 4",key:"1x1c3m"}],["path",{d:"M20 7H4",key:"zbl0bi"}],["path",{d:"m8 21-4-4 4-4",key:"h9nckh"}],["path",{d:"M4 17h16",key:"g4d7ey"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=ft("ArrowUpCircle",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m16 12-4-4-4 4",key:"177agl"}],["path",{d:"M12 16V8",key:"1sbj14"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oa=ft("BookOpen",[["path",{d:"M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z",key:"vv98re"}],["path",{d:"M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z",key:"1cyq3y"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ba=ft("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $a=ft("FileDown",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 18v-6",key:"17g6i2"}],["path",{d:"m9 15 3 3 3-3",key:"1npd3o"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qa=ft("Landmark",[["line",{x1:"3",x2:"21",y1:"22",y2:"22",key:"j8o0r"}],["line",{x1:"6",x2:"6",y1:"18",y2:"11",key:"10tf0k"}],["line",{x1:"10",x2:"10",y1:"18",y2:"11",key:"54lgf6"}],["line",{x1:"14",x2:"14",y1:"18",y2:"11",key:"380y"}],["line",{x1:"18",x2:"18",y1:"18",y2:"11",key:"1kevvc"}],["polygon",{points:"12 2 20 7 4 7",key:"jkujk7"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const aa=ft("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);function Ma({canManage:x}){var V;const[W,L]=n.useState([]),[G,ee]=n.useState([]),[M,O]=n.useState([]),[K,Z]=n.useState([]),[H,A]=n.useState(!0),[U,Q]=n.useState(!1),[R,B]=n.useState(!1),[m,C]=n.useState(null),[P,a]=n.useState(""),[j,c]=n.useState(!1),[h,N]=n.useState({invoice_number:"",supplier_id:"",invoice_date:new Date().toISOString().split("T")[0],due_date:"",currency:"IDR",exchange_rate:1,faktur_pajak_number:"",notes:"",document_urls:[]}),[o,Y]=n.useState([{item_type:"inventory",product_id:null,description:"",quantity:1,unit:"pcs",unit_price:0,line_total:0,expense_account_id:null,asset_account_id:null,tax_amount:0}]);n.useEffect(()=>{p(),T(),_(),i()},[]);const p=async()=>{try{const{data:S,error:d}=await l.from("purchase_invoices").select("*, suppliers(company_name, pkp_status)").order("invoice_date",{ascending:!1});if(d)throw d;L(S||[])}catch(S){console.error("Error loading invoices:",S)}finally{A(!1)}},T=async()=>{const{data:S}=await l.from("suppliers").select("id, company_name, npwp, pkp_status, address, contact_person, phone, email").order("company_name");ee(S||[])},_=async()=>{const{data:S}=await l.from("products").select("id, product_name, unit, current_stock").order("product_name");O(S||[])},i=async()=>{const{data:S}=await l.from("chart_of_accounts").select("id, code, name, account_type").in("account_type",["Expense","Asset","Cost of Goods Sold"]).order("code");Z(S||[])},g=G.find(S=>S.id===h.supplier_id),v=()=>{Y([...o,{item_type:"inventory",product_id:null,description:"",quantity:1,unit:"pcs",unit_price:0,line_total:0,expense_account_id:null,asset_account_id:null,tax_amount:0}])},$=S=>{o.length>1&&Y(o.filter((d,k)=>k!==S))},u=(S,d,k)=>{const ne=[...o];if(ne[S]={...ne[S],[d]:k},(d==="quantity"||d==="unit_price")&&(ne[S].line_total=ne[S].quantity*ne[S].unit_price),d==="item_type"&&(ne[S].product_id=null,ne[S].expense_account_id=null,ne[S].asset_account_id=null,ne[S].description=""),d==="product_id"&&k){const Se=M.find(y=>y.id===k);Se&&(ne[S].description=Se.product_name,ne[S].unit=Se.unit,ne[S].product_name=Se.product_name)}Y(ne)},D=()=>{const S=o.reduce((ne,Se)=>ne+Se.line_total,0),d=o.reduce((ne,Se)=>ne+Se.tax_amount,0),k=S+d;return{subtotal:S,taxTotal:d,total:k}},I=async S=>{var k;if(S.preventDefault(),!x){fe({type:"error",title:"Error",message:"You do not have permission to create purchase invoices"});return}if(!h.supplier_id){fe({type:"error",title:"Error",message:"Please select a supplier"});return}if(o.length===0||o.every(ne=>ne.line_total===0)){fe({type:"error",title:"Error",message:"Please add at least one line item"});return}if(h.currency==="USD"&&h.exchange_rate<=1){fe({type:"error",title:"Error",message:"Please enter a valid exchange rate for USD"});return}for(let ne=0;ne<o.length;ne++){const Se=o[ne];if(Se.item_type==="inventory"&&!Se.product_id){fe({type:"error",title:"Error",message:`Line ${ne+1}: Please select a product for inventory items`});return}if(Se.item_type==="expense"&&!Se.expense_account_id){fe({type:"error",title:"Error",message:`Line ${ne+1}: Please select an expense account`});return}if(Se.item_type==="fixed_asset"&&!Se.asset_account_id){fe({type:"error",title:"Error",message:`Line ${ne+1}: Please select an asset account`});return}if(!Se.description.trim()){fe({type:"error",title:"Error",message:`Line ${ne+1}: Please enter a description`});return}}const d=D();try{const{data:ne}=await l.auth.getUser(),Se={invoice_number:h.invoice_number.trim(),supplier_id:h.supplier_id,invoice_date:h.invoice_date,due_date:h.due_date||null,currency:h.currency,exchange_rate:h.exchange_rate,subtotal:d.subtotal,tax_amount:d.taxTotal,total_amount:d.total,paid_amount:0,balance_amount:d.total,status:"unpaid",faktur_pajak_number:h.faktur_pajak_number.trim()||null,notes:h.notes.trim()||null,document_urls:h.document_urls,requires_faktur_pajak:(g==null?void 0:g.pkp_status)||!1,created_by:(k=ne.user)==null?void 0:k.id},{data:y,error:q}=await l.from("purchase_invoices").insert([Se]).select().single();if(q)throw q;const xe=o.map(ie=>({purchase_invoice_id:y.id,item_type:ie.item_type,product_id:ie.product_id,description:ie.description,quantity:ie.quantity,unit:ie.unit,unit_price:ie.unit_price,line_total:ie.line_total,tax_amount:ie.tax_amount,expense_account_id:ie.expense_account_id,asset_account_id:ie.asset_account_id})),{error:F}=await l.from("purchase_invoice_items").insert(xe);if(F)throw F;fe({type:"success",title:"Success",message:"Purchase invoice created successfully!"}),r(),Q(!1),p()}catch(ne){console.error("Error creating purchase invoice:",ne),fe({type:"error",title:"Error",message:`Error: ${ne.message}`})}},oe=async S=>{c(!0);try{const d=[];for(const k of S){const ne=k.name.split(".").pop(),y=`purchase-invoices/${`${Date.now()}-${Math.random().toString(36).substring(7)}.${ne}`}`,{error:q,data:xe}=await l.storage.from("documents").upload(y,k);if(q)throw q;const{data:{publicUrl:F}}=l.storage.from("documents").getPublicUrl(y);d.push(F)}N(k=>({...k,document_urls:[...k.document_urls,...d]}))}catch(d){console.error("Error uploading files:",d),fe({type:"error",title:"Error",message:`Error uploading files: ${d.message}`})}finally{c(!1)}},he=S=>{N(d=>({...d,document_urls:d.document_urls.filter((k,ne)=>ne!==S)}))},r=()=>{N({invoice_number:"",supplier_id:"",invoice_date:new Date().toISOString().split("T")[0],due_date:"",currency:"IDR",exchange_rate:1,faktur_pajak_number:"",notes:"",document_urls:[]}),Y([{item_type:"inventory",product_id:null,description:"",quantity:1,unit:"pcs",unit_price:0,line_total:0,expense_account_id:null,asset_account_id:null,tax_amount:0}])},te=W.filter(S=>{var d,k;return S.invoice_number.toLowerCase().includes(P.toLowerCase())||((k=(d=S.suppliers)==null?void 0:d.company_name)==null?void 0:k.toLowerCase().includes(P.toLowerCase()))}),be=D();return H?e.jsx("div",{className:"p-8 text-center",children:"Loading..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900",children:"Purchase Invoices"}),x&&e.jsxs("button",{onClick:()=>{r(),Q(!0)},className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(mt,{className:"w-4 h-4"}),"New Purchase Invoice"]})]}),e.jsx("div",{className:"flex items-center gap-4",children:e.jsxs("div",{className:"flex-1 relative",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search by invoice number or supplier...",value:P,onChange:S=>a(S.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Invoice #"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Supplier"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Currency"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Total"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Balance"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:te.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-6 py-12 text-center text-gray-500",children:"No purchase invoices found. Create your first one!"})}):te.map(S=>{var d;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:S.invoice_number}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:(d=S.suppliers)==null?void 0:d.company_name}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:ct(S.invoice_date)}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[S.currency,S.currency==="USD"&&e.jsxs("span",{className:"text-xs text-gray-400 ml-1",children:["@ ",S.exchange_rate.toLocaleString()]})]}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right text-gray-900 font-medium",children:[S.currency," ",S.total_amount.toLocaleString()]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-right font-medium",children:e.jsxs("span",{className:S.balance_amount>0?"text-red-600":"text-green-600",children:[S.currency," ",S.balance_amount.toLocaleString()]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:`px-2 py-1 text-xs font-semibold rounded-full ${S.status==="paid"?"bg-green-100 text-green-800":S.status==="partial"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:S.status})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium",children:e.jsx("button",{onClick:()=>{C(S),B(!0)},className:"text-blue-600 hover:text-blue-900 mr-3",title:"View Details",children:e.jsx(Lt,{className:"w-4 h-4"})})})]},S.id)})})]})}),e.jsx(qe,{isOpen:U,onClose:()=>{Q(!1),r()},title:"New Purchase Invoice",children:e.jsxs("form",{onSubmit:I,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier *"}),e.jsx(Vt,{value:h.supplier_id,onChange:S=>N({...h,supplier_id:S}),options:G.map(S=>({value:S.id,label:`${S.company_name}${S.pkp_status?" (PKP)":""}`})),placeholder:"Select Supplier"}),g&&g.npwp&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["NPWP: ",g.npwp]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Invoice Number *"}),e.jsx("input",{type:"text",value:h.invoice_number,onChange:S=>N({...h,invoice_number:S.target.value}),required:!0,placeholder:"INV-001",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Invoice Date *"}),e.jsx("input",{type:"date",value:h.invoice_date,onChange:S=>N({...h,invoice_date:S.target.value}),required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:h.due_date,onChange:S=>N({...h,due_date:S.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency *"}),e.jsxs("select",{value:h.currency,onChange:S=>N({...h,currency:S.target.value,exchange_rate:S.target.value==="IDR"?1:h.exchange_rate}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"IDR",children:"IDR"}),e.jsx("option",{value:"USD",children:"USD"})]})]}),h.currency==="USD"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Exchange Rate * (1 USD = ? IDR)"}),e.jsx("input",{type:"number",value:h.exchange_rate,onChange:S=>N({...h,exchange_rate:parseFloat(S.target.value)||1}),min:"1",step:"0.01",required:!0,placeholder:"15750",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),(g==null?void 0:g.pkp_status)&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Faktur Pajak Number"}),e.jsx("input",{type:"text",value:h.faktur_pajak_number,onChange:S=>N({...h,faktur_pajak_number:S.target.value}),placeholder:"010.000-00.00000000",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:h.notes,onChange:S=>N({...h,notes:S.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Attachments (Supplier Invoice)"}),e.jsx(Ca,{onUpload:oe,accept:".pdf,.jpg,.jpeg,.png",multiple:!0,disabled:j}),h.document_urls.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:h.document_urls.map((S,d)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 px-3 py-2 rounded",children:[e.jsx("span",{className:"text-sm text-gray-600 truncate",children:S.split("/").pop()}),e.jsx("button",{type:"button",onClick:()=>he(d),className:"text-red-600 hover:text-red-800",children:e.jsx(yt,{className:"w-4 h-4"})})]},d))})]})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Line Items"}),e.jsxs("button",{type:"button",onClick:v,className:"inline-flex items-center gap-1 px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:[e.jsx(mt,{className:"w-4 h-4"}),"Add Line"]})]}),e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:o.map((S,d)=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:["Line ",d+1]}),o.length>1&&e.jsx("button",{type:"button",onClick:()=>$(d),className:"text-red-600 hover:text-red-800",children:e.jsx(yt,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Type *"}),e.jsxs("select",{value:S.item_type,onChange:k=>u(d,"item_type",k.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"inventory",children:"Inventory (Stock)"}),e.jsx("option",{value:"fixed_asset",children:"Fixed Asset"}),e.jsx("option",{value:"expense",children:"Expense"}),e.jsx("option",{value:"freight",children:"Freight"}),e.jsx("option",{value:"duty",children:"Import Duty"}),e.jsx("option",{value:"insurance",children:"Insurance"}),e.jsx("option",{value:"clearing",children:"Clearing & Forwarding"}),e.jsx("option",{value:"other",children:"Other Cost"})]})]}),S.item_type==="inventory"?e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Product *"}),e.jsxs("select",{value:S.product_id||"",onChange:k=>u(d,"product_id",k.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Product"}),M.map(k=>e.jsxs("option",{value:k.id,children:[k.product_name," (Stock: ",k.current_stock,")"]},k.id))]})]}):S.item_type==="expense"?e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Expense Account *"}),e.jsxs("select",{value:S.expense_account_id||"",onChange:k=>u(d,"expense_account_id",k.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Account"}),K.filter(k=>k.account_type==="Expense"||k.account_type==="Cost of Goods Sold").map(k=>e.jsxs("option",{value:k.id,children:[k.code," - ",k.name]},k.id))]})]}):S.item_type==="fixed_asset"?e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Asset Account *"}),e.jsxs("select",{value:S.asset_account_id||"",onChange:k=>u(d,"asset_account_id",k.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Account"}),K.filter(k=>k.account_type==="Asset").map(k=>e.jsxs("option",{value:k.id,children:[k.code," - ",k.name]},k.id))]})]}):e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Ledger (Optional - defaults to Inventory)"}),e.jsxs("select",{value:S.expense_account_id||"",onChange:k=>u(d,"expense_account_id",k.target.value),className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Capitalize to Inventory (Default)"}),K.filter(k=>k.account_type==="Expense"||k.account_type==="Cost of Goods Sold").map(k=>e.jsxs("option",{value:k.id,children:[k.code," - ",k.name]},k.id))]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Description *"}),e.jsx("input",{type:"text",value:S.description,onChange:k=>u(d,"description",k.target.value),placeholder:"Item description",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{className:"grid grid-cols-5 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Qty *"}),e.jsx("input",{type:"number",value:S.quantity,onChange:k=>u(d,"quantity",parseFloat(k.target.value)||0),min:"0",step:"0.01",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Unit"}),e.jsx("input",{type:"text",value:S.unit,onChange:k=>u(d,"unit",k.target.value),placeholder:"pcs",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Rate *"}),e.jsx("input",{type:"number",value:S.unit_price,onChange:k=>u(d,"unit_price",parseFloat(k.target.value)||0),min:"0",step:"0.01",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Tax"}),e.jsx("input",{type:"number",value:S.tax_amount,onChange:k=>u(d,"tax_amount",parseFloat(k.target.value)||0),min:"0",step:"0.01",className:"w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Amount"}),e.jsx("input",{type:"text",value:S.line_total.toLocaleString(),readOnly:!0,className:"w-full px-2 py-1.5 text-sm border border-gray-200 rounded bg-gray-50 font-medium"})]})]})]},d))}),e.jsxs("div",{className:"mt-6 border-t pt-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal:"}),e.jsxs("span",{className:"font-medium",children:[h.currency," ",be.subtotal.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Tax:"}),e.jsxs("span",{className:"font-medium",children:[h.currency," ",be.taxTotal.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t pt-2",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{className:"text-blue-600",children:[h.currency," ",be.total.toLocaleString()]})]}),h.currency==="USD"&&h.exchange_rate>1&&e.jsxs("div",{className:"flex justify-between text-sm text-gray-500",children:[e.jsx("span",{children:"Equivalent (IDR):"}),e.jsxs("span",{children:["IDR ",(be.total*h.exchange_rate).toLocaleString()]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-6 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{Q(!1),r()},className:"px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",disabled:j,className:"px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:j?"Uploading...":"Create Invoice"})]})]})}),m&&e.jsx(qe,{isOpen:R,onClose:()=>{B(!1),C(null)},title:`Purchase Invoice: ${m.invoice_number}`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Supplier:"}),e.jsx("p",{className:"font-medium",children:(V=m.suppliers)==null?void 0:V.company_name})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Invoice Date:"}),e.jsx("p",{className:"font-medium",children:ct(m.invoice_date)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Currency:"}),e.jsx("p",{className:"font-medium",children:m.currency})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600",children:"Total:"}),e.jsxs("p",{className:"font-medium text-lg",children:[m.currency," ",m.total_amount.toLocaleString()]})]})]}),m.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-gray-600 text-sm",children:"Notes:"}),e.jsx("p",{className:"text-sm",children:m.notes})]})]})})]})}function Ua({canManage:x}){var q,xe,F,ie,_e;const W=n.useRef(null),[L,G]=n.useState([]),[ee,M]=n.useState([]),[O,K]=n.useState([]),[Z,H]=n.useState([]),[A,U]=n.useState(!0),[Q,R]=n.useState(!1),[B,m]=n.useState(!1),[C,P]=n.useState(!1),[a,j]=n.useState(null),[c,h]=n.useState([]),[N,o]=n.useState(""),[Y,p]=n.useState([]),[T,_]=n.useState(""),[i,g]=n.useState(""),[v,$]=n.useState({voucher_date:new Date().toISOString().split("T")[0],customer_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,description:""});n.useEffect(()=>{D(),I(),oe(),u()},[]);const u=async()=>{const{data:w}=await l.from("app_settings").select("company_name, company_address").limit(1).maybeSingle();w&&(_(w.company_name||""),g(w.company_address||""))};n.useEffect(()=>{v.customer_id?he(v.customer_id):(H([]),p([]))},[v.customer_id]);const D=async()=>{try{const{data:w,error:le}=await l.from("receipt_vouchers").select("*, customers(company_name), bank_accounts(account_name, bank_name, alias)").order("voucher_date",{ascending:!1});if(le)throw le;const je=await Promise.all((w||[]).map(async ye=>{const{data:De}=await l.from("voucher_allocations").select(`
              allocated_amount,
              sales_invoice_id,
              sales_order_id,
              sales_invoices(invoice_number),
              sales_orders(so_number)
            `).eq("receipt_voucher_id",ye.id);let Ie="-";if(De&&De.length>0){const Fe=De.map(st=>st.sales_invoice_id&&st.sales_invoices?`${st.sales_invoices.invoice_number} (Invoice)`:st.sales_order_id&&st.sales_orders?`${st.sales_orders.so_number} (Advance)`:null).filter(Boolean);Ie=Fe.length>0?Fe.join(", "):"-"}return{...ye,allocated_to:Ie}}));G(je)}catch(w){console.error("Error loading vouchers:",w)}finally{U(!1)}},I=async()=>{const{data:w}=await l.from("customers").select("id, company_name").order("company_name");M(w||[])},oe=async()=>{const{data:w}=await l.from("bank_accounts").select("id, account_name, bank_name, account_number, alias").eq("is_active",!0);K(w||[])},he=async(w,le=!1,je)=>{try{const{data:ye}=await l.rpc("get_invoices_with_balance",{customer_uuid:w}),De=(ye||[]).filter(f=>f.balance_amount>0),{data:Ie}=await l.from("sales_orders").select("id, so_number, so_date, total_amount, advance_payment_amount, advance_payment_status, status").eq("customer_id",w).not("status","in","(cancelled,closed)").order("so_date");let Fe=[],st=[];if(je){const{data:f}=await l.from("voucher_allocations").select("sales_invoice_id, sales_order_id").eq("receipt_voucher_id",je);if(f){const z=f.filter(ae=>ae.sales_invoice_id).map(ae=>ae.sales_invoice_id),re=f.filter(ae=>ae.sales_order_id).map(ae=>ae.sales_order_id);if(z.length>0){const{data:ae}=await l.rpc("get_invoices_with_balance",{customer_uuid:w});Fe=(ae||[]).filter(pe=>z.includes(pe.id))}if(re.length>0){const{data:ae}=await l.from("sales_orders").select("id, so_number, so_date, total_amount, advance_payment_amount, advance_payment_status, status").in("id",re);st=ae||[]}}}const ht=[...De||[],...Fe],gt=Array.from(new Map(ht.map(f=>[f.id,f])).values()),b=[...Ie||[],...st],t=[...Array.from(new Map(b.map(f=>[f.id,f])).values()).filter(f=>f.advance_payment_status!=="full").map(f=>({...f,balance_due:f.total_amount-(f.advance_payment_amount||0),type:"salesorder"})),...gt.map(f=>({...f,type:"invoice"}))];H(t),le||p([])}catch(ye){console.error("Error loading allocation targets:",ye)}},r=async()=>{const{data:w,error:le}=await l.rpc("generate_voucher_number",{p_prefix:"RV"});if(le)throw le;return w},te=(w,le,je)=>{p(ye=>ye.find(Ie=>Ie.targetId===w)?je<=0?ye.filter(Ie=>Ie.targetId!==w):ye.map(Ie=>Ie.targetId===w?{...Ie,amount:je}:Ie):je>0?[...ye,{targetId:w,targetType:le,amount:je}]:ye)},be=Y.reduce((w,le)=>w+le.amount,0),V=async()=>{if(!(!W.current||!a))try{const w=await ra(W.current,{scale:2,useCORS:!0,logging:!1}),le=w.toDataURL("image/png"),je=new ia("p","mm","a4"),ye=je.internal.pageSize.getWidth(),De=w.height*ye/w.width;je.addImage(le,"PNG",0,0,ye,De),je.save(`Receipt-${a.voucher_number}.pdf`)}catch(w){console.error("Error generating PDF:",w),fe({type:"error",title:"Error",message:"Error generating PDF. Please try again."})}},S=async w=>{if(w.preventDefault(),Y.length>0&&be>v.amount){fe({type:"error",title:"Error",message:"Total allocated amount cannot exceed payment amount"});return}try{const{data:{user:le}}=await l.auth.getUser();if(!le)throw new Error("Not authenticated");let je;if(C&&a){const{data:ye,error:De}=await l.from("receipt_vouchers").update({voucher_date:v.voucher_date,payment_method:v.payment_method,bank_account_id:v.bank_account_id||null,reference_number:v.reference_number||null,amount:v.amount,description:v.description||null}).eq("id",a.id).select().single();if(De)throw De;je=ye,await l.from("voucher_allocations").delete().eq("receipt_voucher_id",a.id)}else{const ye=await r(),{data:De,error:Ie}=await l.from("receipt_vouchers").insert([{voucher_number:ye,voucher_date:v.voucher_date,customer_id:v.customer_id,payment_method:v.payment_method,bank_account_id:v.bank_account_id||null,reference_number:v.reference_number||null,amount:v.amount,description:v.description||null,created_by:le.id}]).select().single();if(Ie)throw Ie;je=De}for(const ye of Y)ye.targetType==="invoice"?await l.from("voucher_allocations").insert({voucher_type:"receipt",receipt_voucher_id:je.id,sales_invoice_id:ye.targetId,allocated_amount:ye.amount}):ye.targetType==="salesorder"&&await l.from("voucher_allocations").insert({voucher_type:"receipt",receipt_voucher_id:je.id,sales_order_id:ye.targetId,allocated_amount:ye.amount});R(!1),d(),D()}catch(le){console.error("Error saving voucher:",le),fe({type:"error",title:"Error",message:"Failed to save: "+le.message})}},d=()=>{$({voucher_date:new Date().toISOString().split("T")[0],customer_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,description:""}),p([]),H([]),P(!1),j(null)},k=async w=>{j(w);const{data:le}=await l.from("voucher_allocations").select(`
        *,
        sales_invoices(invoice_number, total_amount),
        sales_orders(so_number, total_amount)
      `).eq("receipt_voucher_id",w.id);h(le||[]),m(!0)},ne=async w=>{j(w),P(!0),$({voucher_date:w.voucher_date,customer_id:w.customer_id,payment_method:w.payment_method,bank_account_id:w.bank_account_id||"",reference_number:w.reference_number||"",amount:w.amount,description:w.description||""}),await he(w.customer_id,!1,w.id);const{data:le}=await l.from("voucher_allocations").select("*").eq("receipt_voucher_id",w.id);if(le){const je=le.map(ye=>({targetId:ye.sales_invoice_id||ye.sales_order_id,targetType:ye.sales_invoice_id?"invoice":"salesorder",amount:Number(ye.allocated_amount)}));p(je)}R(!0)},Se=async w=>{if(await kt({title:"Confirm",message:`Delete receipt voucher ${w.voucher_number}? This will remove all allocations and cannot be undone.`,variant:"danger",confirmLabel:"Delete"}))try{await l.from("voucher_allocations").delete().eq("receipt_voucher_id",w.id);const{error:le}=await l.from("receipt_vouchers").delete().eq("id",w.id);if(le)throw le;alert("Receipt voucher deleted successfully"),D()}catch(le){console.error("Error deleting voucher:",le),alert("Failed to delete: "+le.message)}},y=L.filter(w=>{var le,je;return w.voucher_number.toLowerCase().includes(N.toLowerCase())||((je=(le=w.customers)==null?void 0:le.company_name)==null?void 0:je.toLowerCase().includes(N.toLowerCase()))});return A?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search receipts...",value:N,onChange:w=>o(w.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),x&&e.jsxs("button",{onClick:()=>{d(),R(!0)},className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700",children:[e.jsx(Ht,{className:"w-5 h-5"}),"New Receipt"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Method"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Bank"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Allocated To"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Amount"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y",children:[y.map(w=>{var le,je,ye;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:w.voucher_number}),e.jsx("td",{className:"px-4 py-3",children:new Date(w.voucher_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-4 py-3",children:(le=w.customers)==null?void 0:le.company_name}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs capitalize",children:w.payment_method.replace("_"," ")})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:((je=w.bank_accounts)==null?void 0:je.alias)||((ye=w.bank_accounts)==null?void 0:ye.account_name)||"-"}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:w.allocated_to}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-green-600",children:["Rp ",w.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>k(w),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",title:"View Details",children:e.jsx(Lt,{className:"w-4 h-4"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>ne(w),className:"p-1 text-amber-600 hover:bg-amber-50 rounded",title:"Edit",children:e.jsx(la,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>Se(w),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Delete",children:e.jsx(pt,{className:"w-4 h-4"})})]})]})})]},w.id)}),y.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No receipt vouchers found"})})]})]})}),e.jsx(qe,{isOpen:Q,onClose:()=>{R(!1),d()},title:C?"Edit Receipt Voucher":"New Receipt Voucher",children:e.jsxs("form",{onSubmit:S,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date *"}),e.jsx("input",{type:"date",required:!0,value:v.voucher_date,onChange:w=>$({...v,voucher_date:w.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer *"}),C?e.jsx("div",{className:"w-full px-3 py-2 border border-gray-200 rounded-lg bg-gray-50",children:((q=ee.find(w=>w.id===v.customer_id))==null?void 0:q.company_name)||"Unknown"}):e.jsx(Vt,{value:v.customer_id,onChange:w=>$({...v,customer_id:w}),options:ee.map(w=>({value:w.id,label:w.company_name})),placeholder:"Select customer"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{required:!0,value:v.payment_method,onChange:w=>$({...v,payment_method:w.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"giro",children:"Giro"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),e.jsx("input",{type:"number",required:!0,value:v.amount,onChange:w=>$({...v,amount:parseFloat(w.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),v.payment_method!=="cash"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:v.bank_account_id,onChange:w=>$({...v,bank_account_id:w.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Select account"}),O.map(w=>e.jsx("option",{value:w.id,children:w.alias||`${w.bank_name} - ${w.account_name}`},w.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference No."}),e.jsx("input",{type:"text",value:v.reference_number,onChange:w=>$({...v,reference_number:w.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Check/Transfer reference"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:v.description,onChange:w=>$({...v,description:w.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:2})]}),(Z.length>0||Y.length>0||C)&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-2",children:"Allocate Payment"}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3",children:[e.jsx("p",{className:"text-sm text-blue-900 font-medium mb-1",children:"How to allocate:"}),e.jsxs("ul",{className:"text-xs text-blue-800 space-y-1 ml-4 list-disc",children:[e.jsxs("li",{children:[e.jsx("strong",{className:"text-purple-700",children:"SO (Advance)"})," = Record advance payment against Sales Order"]}),e.jsxs("li",{children:[e.jsx("strong",{className:"text-blue-700",children:"Invoice"})," = Record payment against Sales Invoice"]}),e.jsx("li",{children:'Enter amount in "Allocate (Rp)" column to link payment to document'}),e.jsx("li",{children:"You can allocate partial amounts to multiple documents"})]})]}),Z.length>0?e.jsx("div",{className:"max-h-64 overflow-y-auto border rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Document"}),e.jsx("th",{className:"px-3 py-2 text-center",children:"Type"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Balance Due"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Allocate (Rp)"})]})}),e.jsx("tbody",{className:"divide-y",children:Z.map(w=>{var De;const le=w.type==="invoice"?w.balance_amount:w.balance_due,je=w.type==="invoice"?w.invoice_number:w.so_number,ye=w.type==="invoice"?w.invoice_date:w.so_date;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-mono text-xs",children:je}),e.jsx("div",{className:"text-gray-500 text-xs",children:new Date(ye).toLocaleDateString("id-ID")})]}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${w.type==="salesorder"?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}`,children:w.type==="salesorder"?"SO (Advance)":"Invoice"})}),e.jsxs("td",{className:"px-3 py-2 text-right text-red-600 font-medium",children:["Rp ",le.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",min:0,max:le,value:((De=Y.find(Ie=>Ie.targetId===w.id))==null?void 0:De.amount)||"",onChange:Ie=>te(w.id,w.type,parseFloat(Ie.target.value)||0),className:"w-28 px-2 py-1 border rounded text-right text-xs",placeholder:"0"})})]},`${w.type}-${w.id}`)})})]})}):e.jsxs("div",{className:"border rounded-lg p-4 text-center text-gray-500 text-sm",children:[e.jsx("p",{children:"No unpaid invoices or sales orders found for this customer."}),C&&Y.length>0&&e.jsx("p",{className:"mt-2 text-xs",children:"This voucher had allocations that are now fully paid or no longer available."})]}),e.jsxs("div",{className:"mt-3 flex justify-between items-center text-sm",children:[e.jsxs("div",{className:"text-gray-600",children:[e.jsx("span",{className:"font-medium",children:Y.length})," allocation(s)"]}),e.jsxs("div",{className:"text-right",children:[e.jsx("span",{className:"text-gray-500",children:"Total Allocated:"}),e.jsxs("span",{className:`ml-2 font-bold text-lg ${be>v.amount?"text-red-600":"text-green-600"}`,children:["Rp ",be.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("span",{className:"text-gray-400 ml-1",children:["/ Rp ",v.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{R(!1),d()},className:"px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:C?"Update Receipt":"Save Receipt"})]})]})}),e.jsx(qe,{isOpen:B,onClose:()=>{m(!1),j(null),h([])},title:"Receipt Voucher Details",children:a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Voucher Number"}),e.jsx("p",{className:"font-mono font-medium",children:a.voucher_number})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Date"}),e.jsx("p",{children:new Date(a.voucher_date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Customer"}),e.jsx("p",{children:(xe=a.customers)==null?void 0:xe.company_name})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Payment Method"}),e.jsx("p",{className:"capitalize",children:a.payment_method.replace("_"," ")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Bank Account"}),e.jsx("p",{children:((F=a.bank_accounts)==null?void 0:F.alias)||(a.bank_accounts?`${a.bank_accounts.bank_name} - ${a.bank_accounts.account_name}`:"-")})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Reference"}),e.jsx("p",{children:a.reference_number||"-"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Amount"}),e.jsxs("p",{className:"text-2xl font-bold text-green-600",children:["Rp ",a.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),a.description&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-500",children:"Description"}),e.jsx("p",{className:"text-gray-700",children:a.description})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"Allocations"}),c.length>0?e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Document"}),e.jsx("th",{className:"px-3 py-2 text-center",children:"Type"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Amount"})]})}),e.jsx("tbody",{className:"divide-y",children:c.map((w,le)=>{var je;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-mono text-xs",children:w.sales_invoices?w.sales_invoices.invoice_number:(je=w.sales_orders)==null?void 0:je.so_number}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("span",{className:`px-2 py-0.5 rounded text-xs font-medium ${w.sales_order_id?"bg-purple-100 text-purple-700":"bg-blue-100 text-blue-700"}`,children:w.sales_order_id?"SO (Advance)":"Invoice"})}),e.jsxs("td",{className:"px-3 py-2 text-right font-medium",children:["Rp ",w.allocated_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},le)})})]})}):e.jsx("p",{className:"text-gray-500 text-sm",children:"No allocations"})]}),e.jsxs("div",{className:"flex justify-between pt-4",children:[e.jsxs("button",{onClick:V,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center gap-2",children:[e.jsx(na,{className:"w-4 h-4"}),"Print PDF"]}),e.jsx("button",{onClick:()=>{m(!1),j(null),h([])},className:"px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",children:"Close"})]})]})}),a&&e.jsxs("div",{ref:W,style:{position:"absolute",left:"-9999px",width:"210mm",padding:"15mm",backgroundColor:"#fff"},children:[e.jsxs("div",{style:{textAlign:"center",marginBottom:"20px",borderBottom:"2px solid #333",paddingBottom:"15px"},children:[e.jsx("h1",{style:{fontSize:"24px",fontWeight:"bold",margin:"0 0 5px 0",color:"#1a1a1a"},children:T||"Company Name"}),i&&e.jsx("p",{style:{fontSize:"11px",margin:"0",color:"#666"},children:i}),e.jsx("h2",{style:{fontSize:"18px",fontWeight:"bold",margin:"15px 0 0 0",color:"#2563eb"},children:"RECEIPT VOUCHER"})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"15px",marginBottom:"20px"},children:[e.jsxs("div",{children:[e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",color:"#666",margin:"0 0 3px 0"},children:"Voucher No:"}),e.jsx("p",{style:{fontSize:"14px",fontWeight:"bold",margin:"0",fontFamily:"monospace"},children:a.voucher_number})]}),e.jsxs("div",{children:[e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",color:"#666",margin:"0 0 3px 0"},children:"Date:"}),e.jsx("p",{style:{fontSize:"14px",fontWeight:"bold",margin:"0"},children:new Date(a.voucher_date).toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"})})]})]}),e.jsxs("div",{style:{marginBottom:"20px",padding:"12px",backgroundColor:"#f3f4f6",borderRadius:"6px"},children:[e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",color:"#666",margin:"0 0 5px 0"},children:"Received From:"}),e.jsx("p",{style:{fontSize:"15px",fontWeight:"bold",margin:"0",color:"#1a1a1a"},children:(ie=a.customers)==null?void 0:ie.company_name})]}),e.jsxs("div",{style:{marginBottom:"20px",padding:"15px",backgroundColor:"#dbeafe",borderRadius:"8px",border:"2px solid #2563eb"},children:[e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",color:"#1e40af",margin:"0 0 5px 0"},children:"Amount Received:"}),e.jsxs("p",{style:{fontSize:"24px",fontWeight:"bold",margin:"0",color:"#1e40af"},children:["Rp ",a.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx("div",{style:{marginBottom:"20px"},children:e.jsx("table",{style:{width:"100%",fontSize:"12px",borderCollapse:"collapse"},children:e.jsxs("tbody",{children:[e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px 0",fontWeight:"600",color:"#666",width:"35%"},children:"Payment Method:"}),e.jsx("td",{style:{padding:"8px 0",textTransform:"capitalize"},children:a.payment_method.replace("_"," ")})]}),e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px 0",fontWeight:"600",color:"#666"},children:"Bank Account:"}),e.jsx("td",{style:{padding:"8px 0"},children:((_e=a.bank_accounts)==null?void 0:_e.alias)||(a.bank_accounts?`${a.bank_accounts.bank_name} - ${a.bank_accounts.account_name}`:"-")})]}),a.reference_number&&e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px 0",fontWeight:"600",color:"#666"},children:"Reference:"}),e.jsx("td",{style:{padding:"8px 0",fontFamily:"monospace"},children:a.reference_number})]})]})})}),c.length>0&&e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("p",{style:{fontSize:"13px",fontWeight:"bold",margin:"0 0 10px 0",color:"#1a1a1a"},children:"Allocation Details:"}),e.jsxs("table",{style:{width:"100%",fontSize:"11px",borderCollapse:"collapse",border:"1px solid #d1d5db"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f3f4f6"},children:[e.jsx("th",{style:{padding:"8px",textAlign:"left",borderBottom:"1px solid #d1d5db"},children:"Document"}),e.jsx("th",{style:{padding:"8px",textAlign:"center",borderBottom:"1px solid #d1d5db"},children:"Type"}),e.jsx("th",{style:{padding:"8px",textAlign:"right",borderBottom:"1px solid #d1d5db"},children:"Amount"})]})}),e.jsx("tbody",{children:c.map((w,le)=>{var je;return e.jsxs("tr",{children:[e.jsx("td",{style:{padding:"8px",borderBottom:le<c.length-1?"1px solid #e5e7eb":"none",fontFamily:"monospace"},children:w.sales_invoices?w.sales_invoices.invoice_number:(je=w.sales_orders)==null?void 0:je.so_number}),e.jsx("td",{style:{padding:"8px",textAlign:"center",borderBottom:le<c.length-1?"1px solid #e5e7eb":"none"},children:w.sales_order_id?"SO (Advance)":"Invoice"}),e.jsxs("td",{style:{padding:"8px",textAlign:"right",borderBottom:le<c.length-1?"1px solid #e5e7eb":"none",fontWeight:"600"},children:["Rp ",w.allocated_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},le)})})]})]}),a.description&&e.jsxs("div",{style:{marginBottom:"20px"},children:[e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",color:"#666",margin:"0 0 5px 0"},children:"Description:"}),e.jsx("p",{style:{fontSize:"12px",margin:"0",color:"#1a1a1a"},children:a.description})]}),e.jsxs("div",{style:{marginTop:"40px",display:"grid",gridTemplateColumns:"1fr 1fr",gap:"40px"},children:[e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{height:"60px"}}),e.jsx("div",{style:{borderTop:"1px solid #333",paddingTop:"5px"},children:e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",margin:"0"},children:"Received By"})})]}),e.jsxs("div",{style:{textAlign:"center"},children:[e.jsx("div",{style:{height:"60px"}}),e.jsx("div",{style:{borderTop:"1px solid #333",paddingTop:"5px"},children:e.jsx("p",{style:{fontSize:"11px",fontWeight:"600",margin:"0"},children:"Approved By"})})]})]}),e.jsx("div",{style:{marginTop:"30px",textAlign:"center",paddingTop:"15px",borderTop:"1px solid #e5e7eb"},children:e.jsx("p",{style:{fontSize:"10px",color:"#999",margin:"0"},children:"This is a computer-generated document. No signature required."})})]})]})}function Va({canManage:x}){n.useRef(null);const[W,L]=n.useState([]),[G,ee]=n.useState([]),[M,O]=n.useState([]),[K,Z]=n.useState([]),[H,A]=n.useState([]),[U,Q]=n.useState(!0),[R,B]=n.useState(!1),[m,C]=n.useState(!1),[P,a]=n.useState(null),[j,c]=n.useState([]),[h,N]=n.useState(""),[o,Y]=n.useState([]),[p,T]=n.useState(""),[_,i]=n.useState(""),[g,v]=n.useState({voucher_date:new Date().toISOString().split("T")[0],supplier_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,pph_code_id:"",pph_amount:0,description:""});n.useEffect(()=>{$(),u(),D(),I()},[]),n.useEffect(()=>{g.supplier_id?oe(g.supplier_id):(Z([]),Y([]))},[g.supplier_id]),n.useEffect(()=>{if(g.pph_code_id&&g.amount>0){const d=H.find(k=>k.id===g.pph_code_id);if(d){const k=g.amount*(d.rate/100);v(ne=>({...ne,pph_amount:Math.round(k)}))}}else v(d=>({...d,pph_amount:0}))},[g.pph_code_id,g.amount,H]);const $=async()=>{try{const{data:d,error:k}=await l.from("payment_vouchers").select("*, suppliers(company_name), bank_accounts(account_name, bank_name)").order("voucher_date",{ascending:!1});if(k)throw k;L(d||[])}catch(d){console.error("Error loading vouchers:",d)}finally{Q(!1)}},u=async()=>{const{data:d}=await l.from("suppliers").select("id, company_name").order("company_name");ee(d||[])},D=async()=>{const{data:d}=await l.from("bank_accounts").select("id, account_name, bank_name").eq("is_active",!0);O(d||[])},I=async()=>{const{data:d}=await l.from("tax_codes").select("id, code, name, rate").eq("is_withholding",!0);A(d||[])},oe=async d=>{const{data:k}=await l.from("purchase_invoices").select("id, invoice_number, invoice_date, total_amount, paid_amount, balance_amount").eq("supplier_id",d).gt("balance_amount",0).order("invoice_date");Z(k||[]),Y([])},he=async()=>{const d=new Date().getFullYear().toString().slice(-2),k=(new Date().getMonth()+1).toString().padStart(2,"0"),{count:ne}=await l.from("payment_vouchers").select("*",{count:"exact",head:!0}).like("voucher_number",`PV${d}${k}%`);return`PV${d}${k}-${String((ne||0)+1).padStart(4,"0")}`},r=(d,k)=>{Y(ne=>ne.find(y=>y.invoiceId===d)?k<=0?ne.filter(y=>y.invoiceId!==d):ne.map(y=>y.invoiceId===d?{...y,amount:k}:y):k>0?[...ne,{invoiceId:d,amount:k}]:ne)};o.reduce((d,k)=>d+k.amount,0);const te=g.amount-g.pph_amount,be=async d=>{d.preventDefault();try{const{data:{user:k}}=await l.auth.getUser();if(!k)throw new Error("Not authenticated");const ne=await he(),{data:Se,error:y}=await l.from("payment_vouchers").insert([{voucher_number:ne,voucher_date:g.voucher_date,supplier_id:g.supplier_id,payment_method:g.payment_method,bank_account_id:g.bank_account_id||null,reference_number:g.reference_number||null,amount:g.amount,pph_amount:g.pph_amount,pph_code_id:g.pph_code_id||null,description:g.description||null,created_by:k.id}]).select().single();if(y)throw y;for(const q of o){await l.from("voucher_allocations").insert({voucher_type:"payment",payment_voucher_id:Se.id,purchase_invoice_id:q.invoiceId,allocated_amount:q.amount});const xe=K.find(F=>F.id===q.invoiceId);if(xe){const F=(xe.paid_amount||0)+q.amount,ie=xe.total_amount-F;await l.from("purchase_invoices").update({paid_amount:F,status:ie<=0?"paid":"partial"}).eq("id",q.invoiceId)}}B(!1),V(),$()}catch(k){console.error("Error saving voucher:",k),alert("Failed to save: "+k.message)}},V=()=>{v({voucher_date:new Date().toISOString().split("T")[0],supplier_id:"",payment_method:"bank_transfer",bank_account_id:"",reference_number:"",amount:0,pph_code_id:"",pph_amount:0,description:""}),Y([]),Z([])},S=W.filter(d=>{var k,ne;return d.voucher_number.toLowerCase().includes(h.toLowerCase())||((ne=(k=d.suppliers)==null?void 0:k.company_name)==null?void 0:ne.toLowerCase().includes(h.toLowerCase()))});return U?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search payments...",value:h,onChange:d=>N(d.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),x&&e.jsxs("button",{onClick:()=>{V(),B(!0)},className:"flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700",children:[e.jsx(Yt,{className:"w-5 h-5"}),"New Payment"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Supplier"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Method"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Gross"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"PPh"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Net Paid"})]})}),e.jsxs("tbody",{className:"divide-y",children:[S.map(d=>{var k;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:d.voucher_number}),e.jsx("td",{className:"px-4 py-3",children:new Date(d.voucher_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-4 py-3",children:(k=d.suppliers)==null?void 0:k.company_name}),e.jsx("td",{className:"px-4 py-3",children:e.jsx("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs capitalize",children:d.payment_method.replace("_"," ")})}),e.jsxs("td",{className:"px-4 py-3 text-right",children:["Rp ",d.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-4 py-3 text-right text-orange-600",children:d.pph_amount>0?`Rp ${d.pph_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsxs("td",{className:"px-4 py-3 text-right font-medium text-red-600",children:["Rp ",d.net_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},d.id)}),S.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No payment vouchers found"})})]})]})}),e.jsx(qe,{isOpen:R,onClose:()=>B(!1),title:"New Payment Voucher",children:e.jsxs("form",{onSubmit:be,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date *"}),e.jsx("input",{type:"date",required:!0,value:g.voucher_date,onChange:d=>v({...g,voucher_date:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier *"}),e.jsx(Vt,{value:g.supplier_id,onChange:d=>v({...g,supplier_id:d}),options:G.map(d=>({value:d.id,label:d.company_name})),placeholder:"Select supplier"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{required:!0,value:g.payment_method,onChange:d=>v({...g,payment_method:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"check",children:"Check"}),e.jsx("option",{value:"giro",children:"Giro"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Gross Amount (Rp) *"}),e.jsx("input",{type:"number",required:!0,value:g.amount,onChange:d=>v({...g,amount:parseFloat(d.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),g.payment_method!=="cash"&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:g.bank_account_id,onChange:d=>v({...g,bank_account_id:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Select account"}),M.map(d=>e.jsxs("option",{value:d.id,children:[d.bank_name," - ",d.account_name]},d.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference No."}),e.jsx("input",{type:"text",value:g.reference_number,onChange:d=>v({...g,reference_number:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"PPh Withholding (Potong Pajak)"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"PPh Type"}),e.jsxs("select",{value:g.pph_code_id,onChange:d=>v({...g,pph_code_id:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"No withholding"}),H.map(d=>e.jsxs("option",{value:d.id,children:[d.code," - ",d.name," (",d.rate,"%)"]},d.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"PPh Amount"}),e.jsx("input",{type:"number",value:g.pph_amount,onChange:d=>v({...g,pph_amount:parseFloat(d.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-orange-50"})]})]}),e.jsxs("div",{className:"mt-2 p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Gross Amount:"}),e.jsxs("span",{children:["Rp ",g.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm text-orange-600",children:[e.jsx("span",{children:"Less: PPh Withholding:"}),e.jsxs("span",{children:["-Rp ",g.pph_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between font-medium text-lg border-t mt-2 pt-2",children:[e.jsx("span",{children:"Net Payment:"}),e.jsxs("span",{className:"text-red-600",children:["Rp ",te.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:g.description,onChange:d=>v({...g,description:d.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:2})]}),K.length>0&&e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"Allocate to Purchase Invoices"}),e.jsx("div",{className:"max-h-48 overflow-y-auto border rounded-lg",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Invoice"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Balance"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Allocate"})]})}),e.jsx("tbody",{className:"divide-y",children:K.map(d=>{var k;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-mono",children:d.invoice_number}),e.jsx("div",{className:"text-gray-500 text-xs",children:new Date(d.invoice_date).toLocaleDateString("id-ID")})]}),e.jsxs("td",{className:"px-3 py-2 text-right text-red-600",children:["Rp ",d.balance_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("input",{type:"number",min:0,max:d.balance_amount,value:((k=o.find(ne=>ne.invoiceId===d.id))==null?void 0:k.amount)||"",onChange:ne=>r(d.id,parseFloat(ne.target.value)||0),className:"w-24 px-2 py-1 border rounded text-right",placeholder:"0"})})]},d.id)})})]})})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>B(!1),className:"px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700",children:"Save Payment"})]})]})})]})}const at=[{value:"duty_customs",label:"Duty & Customs (BM)",type:"import",icon:Ve,description:"Import duties and customs charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"ppn_import",label:"PPN Import",type:"operations",icon:Ye,description:"Import VAT - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"pph_import",label:"PPh Import",type:"import",icon:Ve,description:"Import withholding tax - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"freight_import",label:"Freight (Import)",type:"import",icon:lt,description:"International freight charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"clearing_forwarding",label:"Clearing & Forwarding",type:"import",icon:Ve,description:"Customs clearance - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"port_charges",label:"Port Charges",type:"import",icon:Ve,description:"Port handling charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"container_handling",label:"Container Handling",type:"import",icon:lt,description:"Container unloading - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"transport_import",label:"Transportation (Import)",type:"import",icon:it,description:"Port to godown transport - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"loading_import",label:"Loading / Unloading (Import)",type:"import",icon:it,description:"Import container loading/unloading - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"bpom_ski_fees",label:"BPOM / SKI Fees",type:"import",icon:Ue,description:"BPOM/SKI regulatory fees - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"other_import",label:"Other (Import)",type:"import",icon:Ye,description:"Other import-related expenses - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"delivery_sales",label:"Delivery / Dispatch (Sales)",type:"sales",icon:it,description:"Customer delivery - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"loading_sales",label:"Loading / Unloading (Sales)",type:"sales",icon:it,description:"Sales loading charges - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"other_sales",label:"Other (Sales)",type:"sales",icon:Ye,description:"Other sales-related expenses - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"salary",label:"Salary",type:"staff",icon:Ye,description:"Staff salaries - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"staff_overtime",label:"Staff Overtime",type:"staff",icon:Ye,description:"Overtime payments - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"staff_welfare",label:"Staff Welfare / Allowances",type:"staff",icon:Ye,description:"Driver food, snacks, overtime meals, welfare - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"travel_conveyance",label:"Travel & Conveyance",type:"staff",icon:it,description:"Local travel, taxi, fuel reimbursements, tolls - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"warehouse_rent",label:"Warehouse Rent",type:"operations",icon:Ve,description:"Rent expense - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"utilities",label:"Utilities",type:"operations",icon:Ve,description:"Electricity, water, etc - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"bank_charges",label:"Bank Charges",type:"operations",icon:Ye,description:"Bank fees, charges, and transaction costs - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"office_admin",label:"Office & Admin",type:"admin",icon:Ve,description:"General admin expenses - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"},{value:"office_shifting_renovation",label:"Office Shifting & Renovation",type:"admin",icon:Ve,description:"Office shifting, partition work, electrical, cabling, interior renovation - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"},{value:"other",label:"Other",type:"admin",icon:Ye,description:"Miscellaneous expenses - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"}];function Wa({canManage:x}){var b,se;const[W,L]=n.useState([]),[G,ee]=n.useState([]),[M,O]=n.useState([]),[K,Z]=n.useState([]),[H,A]=n.useState([]),[U,Q]=n.useState(new Set),[R,B]=n.useState([]),[m,C]=n.useState(""),[P,a]=n.useState(!0),[j,c]=n.useState(!1),[h,N]=n.useState(null),[o,Y]=n.useState(null),[p,T]=n.useState(!1),[_,i]=n.useState("all"),[g,v]=n.useState("all"),[$,u]=n.useState("all"),[D,I]=n.useState([]),[oe,he]=n.useState(!1),[r,te]=n.useState(null),{dateRange:be}=xt(),V=be.startDate,S=be.endDate,[d,k]=n.useState({expense_category:"other",amount:0,expense_date:new Date().toISOString().split("T")[0],description:"",batch_id:"",import_container_id:"",delivery_challan_id:"",payment_method:"bank_transfer",bank_account_id:"",payment_reference:"",document_urls:[]});n.useEffect(()=>{ne();const t=l.channel("expense-changes").on("postgres_changes",{event:"*",schema:"public",table:"finance_expenses"},()=>{ne()}).subscribe(),f=l.channel("bank-statement-changes").on("postgres_changes",{event:"*",schema:"public",table:"bank_statement_lines"},()=>{ne()}).subscribe();return()=>{t.unsubscribe(),f.unsubscribe()}},[be]),n.useEffect(()=>{const t=f=>{var ae;if(!j)return;const z=(ae=f.clipboardData)==null?void 0:ae.items;if(!z)return;const re=[];for(let pe=0;pe<z.length;pe++){const we=z[pe];if(we.type.indexOf("image")!==-1){f.preventDefault();const Ee=we.getAsFile();if(Ee){const Oe=`pasted-image-${Date.now()}.png`,Le=new File([Ee],Oe,{type:Ee.type});re.push(Le)}}}re.length>0&&(I([...D,...re]),he(!0),setTimeout(()=>he(!1),2e3))};return document.addEventListener("paste",t),()=>document.removeEventListener("paste",t)},[j,D]);const ne=async()=>{try{a(!0);const[t,f,z,re,ae,pe]=await Promise.all([l.from("finance_expenses").select(`
            *,
            batches(batch_number),
            import_containers(container_ref),
            delivery_challans(challan_number),
            bank_accounts(bank_name, account_number, alias, currency),
            bank_statement_lines(
              id,
              transaction_date,
              description,
              debit_amount,
              credit_amount,
              bank_account_id,
              bank_accounts(bank_name, account_number, alias, currency)
            )
          `).order("expense_date",{ascending:!1}).order("created_at",{ascending:!1}),l.from("batches").select("id, batch_number").order("batch_number"),l.from("import_containers").select("id, container_ref").order("container_ref"),l.from("delivery_challans").select("id, challan_number, challan_date, customers(company_name)").order("challan_number",{ascending:!1}).limit(50),l.from("bank_accounts").select("id, bank_name, account_number, alias, currency").order("bank_name"),l.from("bank_statement_lines").select("matched_expense_id").not("matched_expense_id","is",null)]);if(t.error)throw t.error;L(t.data||[]),ee(f.data||[]),O(z.data||[]),Z(re.data||[]),A(ae.data||[]);const we=new Set;pe.data&&pe.data.forEach(Ee=>{Ee.matched_expense_id&&we.add(Ee.matched_expense_id)}),Q(we)}catch(t){console.error("Error loading data:",t.message),fe({type:"error",title:"Error",message:"Failed to load expenses"})}finally{a(!1)}},Se=async(t,f)=>{try{let z=l.from("bank_statement_lines").select(`
          id,
          transaction_date,
          description,
          debit_amount,
          credit_amount,
          bank_account_id,
          bank_accounts(bank_name, account_number, alias, currency)
        `).or(`matched_expense_id.is.null,matched_expense_id.eq.${f||"NULL"}`).is("matched_receipt_id",null).is("matched_petty_cash_id",null).is("matched_entry_id",null).is("matched_fund_transfer_id",null).order("transaction_date",{ascending:!1});t&&(z=z.eq("bank_account_id",t));const{data:re,error:ae}=await z;if(ae)throw ae;const pe=(re||[]).filter(we=>we.debit_amount&&we.debit_amount>0);B(pe)}catch(z){console.error("Error loading unlinked transactions:",z)}},y=async t=>{t.preventDefault(),console.log("=== EXPENSE FORM SUBMIT ==="),console.log("Editing:",!!h),console.log("Files to upload:",D.length),console.log("Existing URLs:",d.document_urls);try{const f=at.find(pe=>pe.value===d.expense_category),z=[];if(D.length>0){console.log("=== UPLOADING",D.length,"FILES ===");for(const pe of D){console.log("Uploading file:",pe.name,"(",pe.size,"bytes)");const we=`${Date.now()}_${pe.name.replace(/[^a-zA-Z0-9.-]/g,"_")}`,Ee=`${d.expense_category}/${we}`;console.log("Storage path:",Ee);const{data:Oe,error:Le}=await l.storage.from("expense-documents").upload(Ee,pe,{cacheControl:"3600",upsert:!1});if(Le)throw console.error("Upload error:",Le),new Error(`Failed to upload ${pe.name}: ${Le.message}`);console.log("Upload successful:",Oe);const{data:{publicUrl:Ke}}=l.storage.from("expense-documents").getPublicUrl(Ee);console.log("Public URL:",Ke),z.push(Ke)}console.log("All uploads complete. Uploaded URLs:",z)}else console.log("No new files to upload");const re=[...d.document_urls,...z];console.log("Combined document URLs:",re);const ae={expense_category:d.expense_category,expense_type:(f==null?void 0:f.type)||"admin",amount:d.amount,expense_date:d.expense_date,description:d.description||null,batch_id:d.batch_id||null,import_container_id:d.import_container_id||null,delivery_challan_id:d.delivery_challan_id||null,payment_method:d.payment_method,bank_account_id:d.bank_account_id||null,payment_reference:d.payment_reference||null,paid_by:"bank",document_urls:re.length>0?re:null};if(console.log("=== EXPENSE DATA TO SAVE ==="),console.log("document_urls:",ae.document_urls),console.log("Full expense data:",ae),h){console.log("=== UPDATING EXPENSE ==="),console.log("Expense ID:",h.id);const{error:pe}=await l.from("finance_expenses").update(ae).eq("id",h.id);if(pe)throw console.error("Update error:",pe),pe;console.log("Update successful! Fetching updated data...");const{data:we,error:Ee}=await l.from("finance_expenses").select(`
            *,
            batches (batch_number),
            import_containers (container_ref),
            delivery_challans (challan_number),
            bank_accounts (bank_name, account_number, alias, currency),
            bank_statement_lines (
              id,
              transaction_date,
              description,
              debit_amount,
              credit_amount,
              bank_account_id,
              bank_accounts (bank_name, account_number)
            )
          `).eq("id",h.id).single();if(Ee)throw console.error("Fetch error:",Ee),Ee;if(console.log("=== FETCHED UPDATED EXPENSE ==="),console.log("document_urls from DB:",we.document_urls),console.log("Full updated expense:",we),L(Oe=>Oe.map(Le=>Le.id===h.id?we:Le)),m){const{data:{user:Oe}}=await l.auth.getUser(),{error:Le}=await l.from("bank_statement_lines").update({matched_expense_id:h.id,reconciliation_status:"matched",matched_at:new Date().toISOString(),matched_by:Oe==null?void 0:Oe.id}).eq("id",m);if(Le)console.error("Error linking to bank transaction:",Le),fe({type:"warning",title:"Warning",message:"Expense updated but failed to link to bank transaction. Please link manually from Bank Reconciliation."});else{const{data:Ke,error:St}=await l.from("finance_expenses").select(`
                *,
                batches (batch_number),
                import_containers (container_ref),
                delivery_challans (challan_number),
                bank_accounts (bank_name, account_number, alias, currency),
                bank_statement_lines (
                  id,
                  transaction_date,
                  description,
                  debit_amount,
                  credit_amount,
                  bank_account_id,
                  bank_accounts (bank_name, account_number)
                )
              `).eq("id",h.id).single();!St&&Ke&&(L(ut=>ut.map(bt=>bt.id===h.id?Ke:bt)),B(ut=>ut.filter(bt=>bt.id!==m)),Q(ut=>new Set(ut).add(h.id)))}}fe({type:"success",title:"Success",message:"Expense updated successfully"})}else{const{data:{user:pe}}=await l.auth.getUser();if(!pe)throw new Error("Not authenticated");console.log("=== CREATING NEW EXPENSE ===");const{data:we,error:Ee}=await l.from("finance_expenses").insert([{...ae,created_by:pe.id}]).select(`
            *,
            batches (batch_number),
            import_containers (container_ref),
            delivery_challans (challan_number),
            bank_accounts (bank_name, account_number, alias, currency),
            bank_statement_lines (
              id,
              transaction_date,
              description,
              debit_amount,
              credit_amount,
              bank_account_id,
              bank_accounts (bank_name, account_number)
            )
          `).single();if(Ee)throw console.error("Insert error:",Ee),Ee;console.log("=== NEW EXPENSE CREATED ==="),console.log("document_urls from DB:",we==null?void 0:we.document_urls),console.log("Full new expense:",we);let Oe=we;if(m&&we){const{error:Le}=await l.from("bank_statement_lines").update({matched_expense_id:we.id,reconciliation_status:"matched",matched_at:new Date().toISOString(),matched_by:pe.id}).eq("id",m);if(Le)console.error("Error linking to bank transaction:",Le),fe({type:"warning",title:"Warning",message:"Expense created but failed to link to bank transaction. Please link manually from Bank Reconciliation."});else{const{data:Ke,error:St}=await l.from("finance_expenses").select(`
                *,
                batches (batch_number),
                import_containers (container_ref),
                delivery_challans (challan_number),
                bank_accounts (bank_name, account_number, alias, currency),
                bank_statement_lines (
                  id,
                  transaction_date,
                  description,
                  debit_amount,
                  credit_amount,
                  bank_account_id,
                  bank_accounts (bank_name, account_number)
                )
              `).eq("id",we.id).single();!St&&Ke&&(Oe=Ke,B(ut=>ut.filter(bt=>bt.id!==m)),Q(ut=>new Set(ut).add(we.id)))}}L(Le=>[Oe,...Le]),fe({type:"success",title:"Success",message:"Expense recorded successfully"})}c(!1),w()}catch(f){console.error("Error saving expense:",f.message);const z=f.message||"Unknown error occurred";z.includes("Import expenses must be linked")?fe({type:"error",title:"Error",message:"Context Required: Import expenses must be linked to an Import Container. Please select a container before saving."}):fe({type:"error",title:"Error",message:"Failed to save expense: "+z})}},q=async t=>{N(t);const f=t.bank_statement_lines&&t.bank_statement_lines.length>0?t.bank_statement_lines[0]:null,z=(f==null?void 0:f.bank_account_id)||t.bank_account_id||"",re=f!=null&&f.bank_account_id?"bank_transfer":t.payment_method||"bank_transfer";k({expense_category:t.expense_category,amount:t.amount,expense_date:t.expense_date,description:t.description||"",batch_id:t.batch_id||"",import_container_id:t.import_container_id||"",delivery_challan_id:t.delivery_challan_id||"",payment_method:re,bank_account_id:z,payment_reference:t.payment_reference||"",document_urls:t.document_urls||[]}),C((f==null?void 0:f.id)||""),z&&await Se(z,t.id),c(!0)},xe=async t=>{if(await kt({title:"Confirm",message:"Are you sure you want to delete this expense?",variant:"danger",confirmLabel:"Delete"}))try{const{data:f,error:z}=await l.from("bank_statement_lines").select("id").eq("matched_expense_id",t);if(z)throw z;if(f&&f.length>0){const{error:ae}=await l.from("bank_statement_lines").update({matched_expense_id:null,reconciliation_status:"unmatched",matched_at:null,matched_by:null,notes:null}).eq("matched_expense_id",t);if(ae)throw ae}const{error:re}=await l.from("finance_expenses").delete().eq("id",t);if(re)throw re;L(ae=>ae.filter(pe=>pe.id!==t)),fe({type:"success",title:"Success",message:"Expense deleted successfully"})}catch(f){console.error("Error deleting expense:",f.message),fe({type:"error",title:"Error",message:"Failed to delete expense: "+f.message})}},F=async t=>{if(await kt({title:"Confirm",message:`Are you sure you want to unlink this expense from the bank statement?

The bank statement line will be set back to "Unmatched" status.`,variant:"warning"}))try{const{error:f}=await l.from("bank_statement_lines").update({matched_expense_id:null,reconciliation_status:"unmatched",matched_at:null,matched_by:null,notes:null}).eq("matched_expense_id",t);if(f)throw f;const{data:z,error:re}=await l.from("finance_expenses").select(`
          *,
          batches (batch_number),
          import_containers (container_ref),
          delivery_challans (challan_number),
          bank_accounts (bank_name, account_number),
          bank_statement_lines (
            id,
            transaction_date,
            description,
            debit_amount,
            credit_amount,
            bank_account_id,
            bank_accounts (bank_name, account_number)
          )
        `).eq("id",t).single();if(re)throw re;L(ae=>ae.map(pe=>pe.id===t?z:pe)),fe({type:"success",title:"Success",message:"Expense unlinked from bank statement successfully"}),c(!1),N(null),w()}catch(f){console.error("Error unlinking expense:",f.message),fe({type:"error",title:"Error",message:"Failed to unlink expense: "+f.message})}},ie=t=>{k({...d,document_urls:d.document_urls.filter(f=>f!==t)})},_e=t=>{I(D.filter((f,z)=>z!==t))},w=()=>{N(null),I([]),k({expense_category:"other",amount:0,expense_date:new Date().toISOString().split("T")[0],description:"",batch_id:"",import_container_id:"",delivery_challan_id:"",payment_method:"bank_transfer",bank_account_id:"",payment_reference:"",document_urls:[]})},le=at.find(t=>t.value===d.expense_category),je=(le==null?void 0:le.type)==="import",ye=(le==null?void 0:le.type)==="sales",De=W.filter(t=>{if(_!=="all"){const f=at.find(z=>z.value===t.expense_category);if((f==null?void 0:f.type)!==_)return!1}if($!=="all"&&t.expense_category!==$)return!1;if(g==="reconciled"){if(!U.has(t.id))return!1}else if(g==="not_reconciled"&&U.has(t.id))return!1;return!(V&&t.expense_date<V||S&&t.expense_date>S)}),Ie=t=>{let f="asc";r&&r.key===t&&r.direction==="asc"&&(f="desc"),te({key:t,direction:f})},Fe=[...De].sort((t,f)=>{var we,Ee;if(!r)return 0;const{key:z,direction:re}=r;let ae,pe;if(z==="date")ae=new Date(t.expense_date).getTime(),pe=new Date(f.expense_date).getTime();else if(z==="category"){const Oe=at.find(Ke=>Ke.value===t.expense_category),Le=at.find(Ke=>Ke.value===f.expense_category);ae=((we=Oe==null?void 0:Oe.label)==null?void 0:we.toLowerCase())||"",pe=((Ee=Le==null?void 0:Le.label)==null?void 0:Ee.toLowerCase())||""}else if(z==="amount")ae=Number(t.amount)||0,pe=Number(f.amount)||0;else if(z==="description")ae=(t.description||"").toLowerCase(),pe=(f.description||"").toLowerCase();else if(z==="payment_method")ae=(t.payment_method||"unknown").toLowerCase(),pe=(f.payment_method||"unknown").toLowerCase();else if(z==="reconciliation"){const Oe=t.bank_statement_lines&&t.bank_statement_lines.length>0,Le=f.bank_statement_lines&&f.bank_statement_lines.length>0;ae=Oe?1:0,pe=Le?1:0}else ae=t[z],pe=f[z],typeof ae=="string"&&(ae=ae.toLowerCase()),typeof pe=="string"&&(pe=pe.toLowerCase());return ae<pe?re==="asc"?-1:1:ae>pe?re==="asc"?1:-1:0}),st=()=>{if(De.length===0){fe({type:"info",title:"Notice",message:"No expenses to export"});return}const t=["Date","Category","Description","Amount"],f=De.map(we=>{const Ee=at.find(Oe=>Oe.value===we.expense_category);return[we.expense_date,(Ee==null?void 0:Ee.label)||we.expense_category,we.description||"",we.amount.toString()]}),z=[t.join(","),...f.map(we=>we.map(Ee=>`"${Ee}"`).join(","))].join(`
`),re=new Blob([z],{type:"text/csv;charset=utf-8;"}),ae=document.createElement("a"),pe=URL.createObjectURL(re);ae.setAttribute("href",pe),ae.setAttribute("download",`expenses_${V||"all"}_to_${S||"all"}.csv`),ae.style.visibility="hidden",document.body.appendChild(ae),ae.click(),document.body.removeChild(ae)},ht=t=>{switch(t){case"import":return"bg-blue-100 text-blue-800 border-blue-300";case"sales":return"bg-green-100 text-green-800 border-green-300";case"staff":return"bg-purple-100 text-purple-800 border-purple-300";case"operations":return"bg-orange-100 text-orange-800 border-orange-300";case"admin":return"bg-gray-100 text-gray-800 border-gray-300";default:return"bg-gray-100 text-gray-800 border-gray-300"}},gt=t=>{const f=new Date(t),z=String(f.getDate()).padStart(2,"0"),re=String(f.getMonth()+1).padStart(2,"0"),ae=f.getFullYear();return`${z}/${re}/${ae}`};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-600 to-blue-700 rounded-lg p-2.5 text-white shadow-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h2",{className:"text-sm font-bold",children:"Expense Tracker"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"bg-white/20 rounded px-2.5 py-1",children:[e.jsx("div",{className:"text-blue-100 text-[9px] leading-tight",children:"Total"}),e.jsxs("div",{className:"text-xs font-bold",children:["Rp ",De.reduce((t,f)=>t+f.amount,0).toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:0})]})]}),e.jsxs("div",{className:"bg-white/20 rounded px-2.5 py-1",children:[e.jsx("div",{className:"text-blue-100 text-[9px] leading-tight",children:"Reconciled"}),e.jsxs("div",{className:"text-xs font-bold",children:[W.filter(t=>U.has(t.id)).length," / ",W.length]})]})]})]}),x&&e.jsxs("button",{onClick:()=>{w(),c(!0)},className:"flex items-center gap-1.5 px-2.5 py-1.5 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium transition-all shadow-sm text-xs",children:[e.jsx(mt,{className:"w-3.5 h-3.5"}),"New"]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-2",children:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("div",{className:"flex gap-1",children:[{value:"all",label:"All",icon:""},{value:"import",label:"Import",icon:""},{value:"sales",label:"Sales",icon:""},{value:"staff",label:"Staff",icon:""},{value:"operations",label:"Ops",icon:""},{value:"admin",label:"Admin",icon:""}].map(t=>e.jsxs("button",{onClick:()=>i(t.value),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${_===t.value?"bg-blue-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[t.icon," ",t.label]},t.value))}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsx("div",{className:"flex gap-1",children:[{value:"all",label:"All"},{value:"reconciled",label:" Linked"},{value:"not_reconciled",label:" Unlinked"}].map(t=>e.jsx("button",{onClick:()=>v(t.value),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${g===t.value?"bg-green-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:t.label},t.value))}),e.jsxs("select",{value:$,onChange:t=>u(t.target.value),className:"px-2 py-1 border border-gray-300 rounded-md text-xs",children:[e.jsx("option",{value:"all",children:"All Categories"}),at.sort((t,f)=>{const z={"Import Costs":1,"Sales & Distribution":2,"Staff Costs":3,Operations:4,Administrative:5},re=z[t.group]||999,ae=z[f.group]||999;return re!==ae?re-ae:t.label.localeCompare(f.label)}).map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))]}),e.jsxs("button",{onClick:st,disabled:De.length===0,className:"ml-auto px-3 py-1.5 bg-green-600 text-white rounded-md text-xs hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-1.5 font-medium",children:[e.jsx(Dt,{className:"w-3.5 h-3.5"}),"Export (",De.length,")"]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{onClick:()=>Ie("date"),className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Date",(r==null?void 0:r.key)==="date"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ie("category"),className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Category",(r==null?void 0:r.key)==="category"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),e.jsx("th",{className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600",children:"Context"}),e.jsx("th",{onClick:()=>Ie("description"),className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Description",(r==null?void 0:r.key)==="description"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ie("amount"),className:"px-4 py-2.5 text-right text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["Amount",(r==null?void 0:r.key)==="amount"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ie("payment_method"),className:"px-4 py-2.5 text-center text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:["Payment",(r==null?void 0:r.key)==="payment_method"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),e.jsx("th",{className:"px-4 py-2.5 text-center text-xs font-semibold text-gray-600",children:"Type"}),e.jsx("th",{onClick:()=>Ie("reconciliation"),className:"px-4 py-2.5 text-center text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 transition-colors",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:["Status",(r==null?void 0:r.key)==="reconciliation"&&e.jsx("span",{className:"text-blue-600 text-sm",children:r.direction==="asc"?"":""})]})}),x&&e.jsx("th",{className:"px-4 py-2.5 text-center text-xs font-semibold text-gray-600",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[P?e.jsx("tr",{children:e.jsx("td",{colSpan:x?9:8,className:"px-6 py-8 text-center text-gray-500",children:"Loading..."})}):De.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:x?9:8,className:"px-6 py-8 text-center text-gray-500",children:"No expenses found"})}):Fe.map(t=>{var ae;const f=at.find(pe=>pe.value===t.expense_category),z=t.bank_statement_lines&&t.bank_statement_lines.length>0,re=z?t.bank_statement_lines[0].bank_accounts:null;return e.jsxs("tr",{className:"hover:bg-blue-50/50 transition-colors",children:[e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap",children:e.jsx("div",{className:"text-xs text-gray-900 font-medium",children:gt(t.expense_date)})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("div",{className:"text-xs font-medium text-gray-900",children:(f==null?void 0:f.label)||t.expense_category})}),e.jsx("td",{className:"px-4 py-2.5",children:t.import_container_id&&t.import_containers?e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(lt,{className:"w-3.5 h-3.5 text-blue-600 flex-shrink-0"}),e.jsx("span",{className:"text-blue-700 font-medium",children:t.import_containers.container_ref})]}):t.delivery_challan_id&&t.delivery_challans?e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(it,{className:"w-3.5 h-3.5 text-green-600 flex-shrink-0"}),e.jsx("span",{className:"text-green-700 font-medium",children:t.delivery_challans.challan_number})]}):f!=null&&f.requiresContainer?e.jsx("span",{className:"inline-flex items-center gap-1 px-1.5 py-0.5 text-[10px] font-medium text-red-700 bg-red-50 border border-red-200 rounded",children:" Missing"}):e.jsx("span",{className:"text-gray-400 text-xs",children:""})}),e.jsx("td",{className:"px-4 py-2.5",children:e.jsx("div",{className:"text-xs text-gray-700 line-clamp-1",children:t.description||""})}),e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap text-right",children:e.jsxs("div",{className:"text-xs font-semibold text-gray-900",children:[((ae=t.bank_accounts)==null?void 0:ae.currency)==="USD"?"$":"Rp"," ",t.amount.toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:0})]})}),e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap text-center",children:z&&re?e.jsx("div",{className:"text-xs",children:e.jsx("div",{className:"font-medium text-blue-700",children:re.alias||re.bank_name})}):t.bank_account_id&&t.bank_accounts?e.jsx("div",{className:"text-xs",children:e.jsx("div",{className:"font-medium text-gray-700",children:t.bank_accounts.alias||t.bank_accounts.bank_name})}):e.jsx("span",{className:"text-xs text-gray-600",children:t.payment_method?t.payment_method.replace("_"," "):""})}),e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap text-center",children:e.jsxs("span",{className:`inline-flex px-1.5 py-0.5 text-[10px] font-bold rounded ${ht((f==null?void 0:f.type)||"admin")}`,children:[(f==null?void 0:f.type)==="import"&&"CAP",(f==null?void 0:f.type)==="sales"&&"EXP",(f==null?void 0:f.type)==="staff"&&"EXP",(f==null?void 0:f.type)==="operations"&&"EXP",(f==null?void 0:f.type)==="admin"&&"EXP"]})}),e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap text-center",children:z?e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-bold text-green-700 bg-green-50 border border-green-300 rounded",children:" LINKED"}):e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-[10px] font-bold text-orange-700 bg-orange-50 border border-orange-300 rounded",children:" UNLINKED"})}),x&&e.jsx("td",{className:"px-4 py-2.5 whitespace-nowrap text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1.5",children:[e.jsx("button",{onClick:()=>{Y(t),T(!0)},className:"p-1 text-blue-600 hover:bg-blue-50 rounded transition-colors",title:"View",children:e.jsx(Lt,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>q(t),className:"p-1 text-green-600 hover:bg-green-50 rounded transition-colors",title:"Edit",children:e.jsx(Ba,{className:"w-3.5 h-3.5"})}),e.jsx("button",{onClick:()=>xe(t.id),className:"p-1 text-red-600 hover:bg-red-50 rounded transition-colors",title:"Delete",children:e.jsx(pt,{className:"w-3.5 h-3.5"})})]})})]},t.id)}),!P&&Fe.length>0&&e.jsxs("tr",{className:"bg-gradient-to-r from-blue-50 to-blue-100 border-t-2 border-blue-200 font-bold",children:[e.jsxs("td",{colSpan:4,className:"px-4 py-2.5 text-right text-xs text-gray-900",children:["TOTAL (",Fe.length," expenses):"]}),e.jsxs("td",{className:"px-4 py-2.5 text-right text-sm text-blue-900 font-bold",children:["Rp ",Fe.reduce((t,f)=>t+f.amount,0).toLocaleString("id-ID",{minimumFractionDigits:0,maximumFractionDigits:0})]}),e.jsx("td",{colSpan:x?4:3})]})]})]})}),j&&e.jsx(qe,{isOpen:j,onClose:()=>{c(!1),w()},title:h?"Edit Expense":"Record New Expense",maxWidth:"max-w-2xl",children:e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Expense Category ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.expense_category,onChange:t=>{const f=t.target.value,z=at.find(re=>re.value===f);k({...d,expense_category:f,import_container_id:(z==null?void 0:z.type)==="import"?d.import_container_id:"",delivery_challan_id:(z==null?void 0:z.type)==="sales"?d.delivery_challan_id:""})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",required:!0,children:[e.jsx("option",{value:"",children:"Select Category"}),e.jsx("optgroup",{label:" IMPORT COSTS (Capitalized to Inventory) ",children:at.filter(t=>t.group==="Import Costs").map(t=>e.jsxs("option",{value:t.value,children:[t.label," [Requires Container]"]},t.value))}),e.jsx("optgroup",{label:" SALES & DISTRIBUTION (P&L Expense) ",children:at.filter(t=>t.group==="Sales & Distribution").map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("optgroup",{label:" STAFF COSTS (P&L Expense) ",children:at.filter(t=>t.group==="Staff Costs").map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("optgroup",{label:" OPERATIONS (P&L Expense) ",children:at.filter(t=>t.group==="Operations").map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("optgroup",{label:" ADMINISTRATIVE (P&L Expense) ",children:at.filter(t=>t.group==="Administrative").map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]}),le&&e.jsxs("div",{className:`mt-2 p-3 rounded-lg border ${ht(le.type)}`,children:[e.jsx("p",{className:"text-sm font-medium",children:le.description}),le.requiresContainer&&e.jsx("p",{className:"text-xs font-semibold text-red-600 mt-1",children:" Must be linked to Import Container"})]})]}),je&&e.jsxs("div",{className:"bg-blue-50 border-2 border-blue-300 rounded-lg p-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-blue-900 mb-2",children:[e.jsx(lt,{className:"w-4 h-4 inline mr-1"}),"Import Container ",e.jsx("span",{className:"text-red-500",children:"* REQUIRED"})]}),e.jsxs("select",{value:d.import_container_id,onChange:t=>k({...d,import_container_id:t.target.value}),className:"w-full px-3 py-2 border border-blue-300 rounded-lg bg-white",required:je,children:[e.jsx("option",{value:"",children:"Select Container (Required)"}),M.map(t=>e.jsx("option",{value:t.id,children:t.container_ref},t.id))]}),e.jsx("p",{className:"mt-2 text-xs text-blue-800 font-medium",children:" This expense will be CAPITALIZED to inventory and allocated to batches"}),e.jsx("p",{className:"mt-1 text-xs text-red-700 font-semibold",children:" Backend will block saving without a container selection"})]}),ye&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsx("label",{className:"block text-sm font-medium text-green-900 mb-2",children:"Delivery Challan (Optional)"}),e.jsxs("select",{value:d.delivery_challan_id,onChange:t=>k({...d,delivery_challan_id:t.target.value}),className:"w-full px-3 py-2 border border-green-300 rounded-lg",children:[e.jsx("option",{value:"",children:"Select DC (Optional)"}),K.map(t=>{var f;return e.jsxs("option",{value:t.id,children:[t.challan_number," - ",new Date(t.challan_date).toLocaleDateString("en-GB")," - ",((f=t.customers)==null?void 0:f.company_name)||"No Customer"]},t.id)})]}),e.jsx("p",{className:"mt-2 text-xs text-green-700",children:"This expense will be EXPENSED to P&L (not capitalized)"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:d.expense_date,onChange:t=>k({...d,expense_date:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Amount (Rp) ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",value:d.amount,onChange:t=>k({...d,amount:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]})]}),e.jsxs("div",{className:"border-2 border-blue-200 rounded-lg p-4 bg-blue-50",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-3",children:"Payment Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Payment Method ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.payment_method,onChange:t=>k({...d,payment_method:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"bank_transfer",children:" Bank Transfer"}),e.jsx("option",{value:"check",children:" Check"}),e.jsx("option",{value:"giro",children:" Giro"}),e.jsx("option",{value:"other",children:" Other"})]}),e.jsx("p",{className:"text-xs text-gray-600 mt-1",children:" Will appear in Bank Reconciliation"}),e.jsx("p",{className:"text-xs text-blue-600 mt-1",children:" For cash expenses, use Petty Cash Manager"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Bank Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:d.bank_account_id,onChange:t=>{k({...d,bank_account_id:t.target.value}),t.target.value?Se(t.target.value,h==null?void 0:h.id):B([]),C("")},className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select Bank Account"}),H.map(t=>e.jsxs("option",{value:t.id,children:[t.bank_name," - ",t.alias||t.account_number]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Link to Bank Transaction"}),d.bank_account_id&&R.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:m,onChange:t=>C(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"Choose a transaction..."}),R.map(t=>{var we,Ee;const f=new Date(t.transaction_date),z=String(f.getDate()).padStart(2,"0"),re=String(f.getMonth()+1).padStart(2,"0"),ae=String(f.getFullYear()).slice(-2),pe=`${z}/${re}/${ae}`;return e.jsxs("option",{value:t.id,children:[pe," - ",((we=t.description)==null?void 0:we.substring(0,50))||"No description"," - Rp ",(Ee=t.debit_amount)==null?void 0:Ee.toLocaleString()]},t.id)})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[R.length," unreconciled transaction",R.length!==1?"s":""]})]}):d.bank_account_id?e.jsx("div",{className:"text-sm text-gray-500 italic py-2 px-3 bg-gray-50 rounded-lg border border-gray-200",children:"No unreconciled transactions"}):e.jsx("input",{type:"text",value:d.payment_reference,onChange:t=>k({...d,payment_reference:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Enter reference number"})]})]})]}),h&&h.bank_statement_lines&&h.bank_statement_lines.length>0&&e.jsxs("div",{className:"p-4 bg-green-50 border border-green-300 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-green-600"}),e.jsx("h4",{className:"font-semibold text-green-900",children:"Linked Bank Transaction"})]}),x&&e.jsx("button",{type:"button",onClick:()=>F(h.id),className:"text-sm text-red-600 hover:text-red-700 font-medium",children:"Unlink"})]}),h.bank_statement_lines.map(t=>{var f,z,re;return e.jsxs("div",{className:"space-y-2 text-sm bg-white p-3 rounded border border-green-200",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Bank:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[((f=t.bank_accounts)==null?void 0:f.alias)||((z=t.bank_accounts)==null?void 0:z.bank_name)," - ",(re=t.bank_accounts)==null?void 0:re.account_number]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Transaction Date:"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(t.transaction_date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:["Rp ",(t.debit_amount||t.credit_amount||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),t.description&&e.jsxs("div",{className:"pt-2 border-t border-green-200",children:[e.jsx("div",{className:"text-gray-600 mb-1",children:"Bank Description:"}),e.jsx("div",{className:"text-gray-900 font-medium",children:t.description})]})]},t.id)})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:d.description,onChange:t=>k({...d,description:t.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(Ue,{className:"w-4 h-4 inline mr-1"}),"Supporting Documents (Invoices, Receipts, Bills)"]}),d.document_urls.length>0&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("p",{className:"text-xs text-gray-600 font-medium mb-2",children:["Existing Documents (",d.document_urls.length,"):"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:d.document_urls.map((t,f)=>{const z=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(t),re=t.split("/").pop()||`Document ${f+1}`;return e.jsxs("div",{className:"group relative border border-gray-200 rounded-lg overflow-hidden hover:border-red-500 transition-colors",children:[z?e.jsx("div",{className:"aspect-square bg-gray-100 relative",children:e.jsx("img",{src:t,alt:re,className:"w-full h-full object-cover"})}):e.jsxs("div",{className:"aspect-square bg-red-50 flex flex-col items-center justify-center p-3",children:[e.jsx(Ue,{className:"h-10 w-10 text-red-600 mb-2"}),e.jsx("p",{className:"text-xs text-center text-gray-700 line-clamp-2 px-2",children:re})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs px-2 py-1.5 flex items-center justify-between",children:[e.jsxs("span",{children:["Doc ",f+1]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"p-1 hover:bg-white hover:bg-opacity-20 rounded",onClick:ae=>ae.stopPropagation(),children:e.jsx(Mt,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>ie(t),className:"p-1 hover:bg-red-500 rounded",children:e.jsx(yt,{className:"h-3.5 w-3.5"})})]})]})]},f)})})]}),D.length>0&&e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-600 font-medium",children:"Files to Upload:"}),D.map((t,f)=>e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-blue-50 border border-blue-200 rounded",children:[e.jsx(Pt,{className:"w-4 h-4 text-blue-600 flex-shrink-0"}),e.jsx("span",{className:"flex-1 text-sm text-blue-700 truncate",children:t.name}),e.jsxs("span",{className:"text-xs text-blue-600",children:[(t.size/1024).toFixed(1)," KB"]}),e.jsx("button",{type:"button",onClick:()=>_e(f),className:"p-1 text-red-600 hover:bg-red-100 rounded",children:e.jsx(yt,{className:"w-3 h-3"})})]},f))]}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-gray-400 transition-colors",onMouseEnter:()=>he(!0),onMouseLeave:()=>he(!1),children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/*,.pdf,.doc,.docx,.xls,.xlsx",onChange:t=>{const f=t.target.files;f&&f.length>0&&I([...D,...Array.from(f)])},className:"hidden",id:"expense-file-upload"}),e.jsxs("label",{htmlFor:"expense-file-upload",className:"cursor-pointer flex flex-col items-center",children:[e.jsx(Pt,{className:"w-8 h-8 text-gray-400 mb-2"}),e.jsx("span",{className:"text-sm text-blue-600 font-medium",children:h&&d.document_urls.length>0?"Click to upload additional files":"Click to upload files"}),e.jsx("span",{className:"text-xs text-gray-500 mt-1",children:"PDF, images, or documents (max 10MB each)"})]}),oe&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-green-600 font-medium animate-pulse mt-2",children:[e.jsx(Ea,{className:"w-4 h-4"}),e.jsx("span",{children:"Press Ctrl+V to paste images from clipboard"})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{c(!1),w()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[h?"Update":"Record"," Expense"]})]})]})}),p&&o&&e.jsx(qe,{isOpen:p,onClose:()=>{T(!1),Y(null)},title:"Expense Receipt",maxWidth:"max-w-lg",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-2 rounded -mt-1 -mx-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs opacity-90",children:"Category"}),e.jsx("p",{className:"text-base font-bold",children:((b=at.find(t=>t.value===o.expense_category))==null?void 0:b.label)||o.expense_category})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs opacity-90",children:"Date"}),e.jsx("p",{className:"text-base font-semibold",children:new Date(o.expense_date).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})})]})]})}),e.jsx("div",{className:"py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[o.expense_type&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Type"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 capitalize",children:o.expense_type})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Category"}),e.jsx("div",{className:"flex items-center gap-1.5",children:(()=>{const t=at.find(z=>z.value===o.expense_category),f=t==null?void 0:t.icon;return e.jsxs(e.Fragment,{children:[f&&e.jsx(f,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:t==null?void 0:t.label})]})})()})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Amount"}),e.jsxs("p",{className:"text-lg font-bold text-gray-900",children:["Rp ",o.amount.toLocaleString("id-ID")]})]})]})}),o.description&&e.jsxs("div",{className:"py-2 border-b border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Description"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:o.description})]}),e.jsxs("div",{className:"py-2 border-b border-gray-200 space-y-1.5",children:[e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Payment Method:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900 capitalize",children:(se=o.payment_method)==null?void 0:se.replace("_"," ")})]}),o.payment_reference&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Reference:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:o.payment_reference})]})]}),o.bank_accounts&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Bank Account:"}),e.jsxs("p",{className:"text-sm font-medium text-gray-900",children:[o.bank_accounts.alias||o.bank_accounts.bank_name," - ",o.bank_accounts.account_number]})]})]}),(o.batches||o.import_containers||o.delivery_challans)&&e.jsxs("div",{className:"py-2 border-b border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1.5",children:"Linked To"}),e.jsxs("div",{className:"space-y-1",children:[o.batches&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(lt,{className:"h-3.5 w-3.5 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"Batch:"}),e.jsx("span",{className:"font-medium text-gray-900",children:o.batches.batch_number})]}),o.import_containers&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(lt,{className:"h-3.5 w-3.5 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"Container:"}),e.jsx("span",{className:"font-medium text-gray-900",children:o.import_containers.container_ref})]}),o.delivery_challans&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(it,{className:"h-3.5 w-3.5 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"Challan:"}),e.jsx("span",{className:"font-medium text-gray-900",children:o.delivery_challans.challan_number})]})]})]}),o.bank_statement_lines&&o.bank_statement_lines.length>0&&e.jsxs("div",{className:"py-2 border-b border-gray-200",children:[e.jsxs("p",{className:"text-xs text-gray-500 mb-2 flex items-center gap-1",children:[e.jsx(Ue,{className:"h-3.5 w-3.5"}),"Bank Reconciliation"]}),e.jsx("div",{className:"space-y-2",children:o.bank_statement_lines.map(t=>{var f,z;return e.jsxs("div",{className:"p-3 bg-green-50 border border-green-200 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 text-xs font-semibold text-green-700 bg-green-200 rounded",children:" LINKED"}),e.jsx("span",{className:"text-xs text-gray-700 font-medium",children:((f=t.bank_accounts)==null?void 0:f.alias)||((z=t.bank_accounts)==null?void 0:z.bank_name)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Bank Amount:"}),e.jsxs("span",{className:"font-bold text-green-700 ml-1",children:["Rp ",(t.debit_amount||t.credit_amount||0).toLocaleString("id-ID")]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"font-medium text-gray-900 ml-1",children:new Date(t.transaction_date).toLocaleDateString("id-ID")})]})]}),t.description&&e.jsx("p",{className:"text-xs text-gray-700 mt-2 pt-2 border-t border-green-200 font-medium",children:t.description})]},t.id)})})]}),o.document_urls&&o.document_urls.length>0&&e.jsxs("div",{className:"pt-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Attachments (",o.document_urls.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:o.document_urls.map((t,f)=>{const z=/\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(t),re=t.split("/").pop()||`Document ${f+1}`;return e.jsxs("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"group relative border border-gray-200 rounded overflow-hidden hover:border-blue-500 transition-colors",children:[z?e.jsxs("div",{className:"aspect-square bg-gray-100 relative",children:[e.jsx("img",{src:t,alt:re,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity flex items-center justify-center",children:e.jsx(Mt,{className:"h-5 w-5 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]}):e.jsxs("div",{className:"aspect-square bg-red-50 flex flex-col items-center justify-center p-3",children:[e.jsx(Ue,{className:"h-8 w-8 text-red-600 mb-2"}),e.jsx("p",{className:"text-xs text-center text-gray-700 line-clamp-2",children:re})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs px-2 py-0.5",children:["Doc ",f+1]})]},f)})})]})]})})]})}const Et=[{value:"duty_customs",label:"Duty & Customs (BM)",type:"import",icon:Ve,description:"Import duties and customs charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"ppn_import",label:"PPN Import",type:"operations",icon:Ye,description:"Import VAT - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"pph_import",label:"PPh Import",type:"import",icon:Ve,description:"Import withholding tax - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"freight_import",label:"Freight (Import)",type:"import",icon:lt,description:"International freight charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"clearing_forwarding",label:"Clearing & Forwarding",type:"import",icon:Ve,description:"Customs clearance - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"port_charges",label:"Port Charges",type:"import",icon:Ve,description:"Port handling charges - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"container_handling",label:"Container Handling",type:"import",icon:lt,description:"Container unloading - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"transport_import",label:"Transportation (Import)",type:"import",icon:it,description:"Port to godown transport - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"loading_import",label:"Loading / Unloading (Import)",type:"import",icon:it,description:"Import container loading/unloading - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"bpom_ski_fees",label:"BPOM / SKI Fees",type:"import",icon:Ue,description:"BPOM/SKI regulatory fees - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"other_import",label:"Other (Import)",type:"import",icon:Ye,description:"Other import-related expenses - CAPITALIZED to inventory",requiresContainer:!0,group:"Import Costs"},{value:"delivery_sales",label:"Delivery / Dispatch (Sales)",type:"sales",icon:it,description:"Customer delivery - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"loading_sales",label:"Loading / Unloading (Sales)",type:"sales",icon:it,description:"Sales loading charges - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"other_sales",label:"Other (Sales)",type:"sales",icon:Ye,description:"Other sales-related expenses - EXPENSED to P&L",requiresContainer:!1,group:"Sales & Distribution"},{value:"salary",label:"Salary",type:"staff",icon:Ye,description:"Staff salaries - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"staff_overtime",label:"Staff Overtime",type:"staff",icon:Ye,description:"Overtime payments - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"staff_welfare",label:"Staff Welfare / Allowances",type:"staff",icon:Ye,description:"Driver food, snacks, overtime meals, welfare - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"travel_conveyance",label:"Travel & Conveyance",type:"staff",icon:it,description:"Local travel, taxi, fuel reimbursements, tolls - EXPENSED to P&L",requiresContainer:!1,group:"Staff Costs"},{value:"warehouse_rent",label:"Warehouse Rent",type:"operations",icon:Ve,description:"Rent expense - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"utilities",label:"Utilities",type:"operations",icon:Ve,description:"Electricity, water, etc - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"bank_charges",label:"Bank Charges",type:"operations",icon:Ye,description:"Bank fees, charges, and transaction costs - EXPENSED to P&L",requiresContainer:!1,group:"Operations"},{value:"office_admin",label:"Office & Admin",type:"admin",icon:Ve,description:"General admin expenses - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"},{value:"office_shifting_renovation",label:"Office Shifting & Renovation",type:"admin",icon:Ve,description:"Office shifting, partition work, electrical, cabling, interior renovation - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"},{value:"fixed_assets",label:"Fixed Assets / Equipment",type:"assets",icon:lt,description:"Purchase of fixed assets - CAPITALIZED (see Asset Guide)",requiresContainer:!1,group:"Assets"},{value:"other",label:"Other",type:"admin",icon:Ye,description:"Miscellaneous expenses - EXPENSED to P&L",requiresContainer:!1,group:"Administrative"}];function za({canManage:x,onNavigateToFundTransfer:W}){const[L,G]=n.useState([]),[ee,M]=n.useState([]),[O,K]=n.useState([]),[Z,H]=n.useState([]),[A,U]=n.useState(!0),[Q,R]=n.useState(!1),[B,m]=n.useState(!1),[C,P]=n.useState(null),[a,j]=n.useState(null),[c,h]=n.useState(0),[N,o]=n.useState(!1),[Y,p]=n.useState([]),[T,_]=n.useState([]),[i,g]=n.useState(null),[v,$]=n.useState(!1),[u,D]=n.useState("all"),[I,oe]=n.useState("all"),{dateRange:he}=xt(),{profile:r}=Rt(),te=he.startDate,be=he.endDate,[V,S]=n.useState({transaction_type:"expense",transaction_date:new Date().toISOString().split("T")[0],amount:0,description:"",expense_category:"",bank_account_id:"",paid_to:"",paid_by_staff_name:"",paid_by:"cash",source:"",received_by_staff_name:"",import_container_id:"",delivery_challan_id:""}),d=n.useCallback(async()=>{try{const[b,se,t,f,z]=await Promise.all([l.from("petty_cash_transactions").select(`
            *,
            bank_accounts:bank_account_id (
              account_name,
              bank_name,
              alias,
              currency
            ),
            import_containers:import_container_id (
              container_ref
            ),
            delivery_challans:delivery_challan_id (
              challan_number
            ),
            petty_cash_documents (*)
          `).gte("transaction_date",te).lte("transaction_date",be).order("transaction_date",{ascending:!1}).order("transaction_number",{ascending:!1}),l.rpc("get_petty_cash_balance"),l.from("import_containers").select("id, container_ref").order("container_ref",{ascending:!1}),l.from("delivery_challans").select(`
            id,
            challan_number,
            challan_date,
            customers:customer_id (
              company_name
            )
          `).order("challan_date",{ascending:!1}),l.from("bank_accounts").select("*").order("bank_name",{ascending:!0})]);if(b.error)throw b.error;if(se.error)throw se.error;G(b.data||[]),h(se.data||0),M(t.data||[]),K(f.data||[]),H(z.data||[])}catch(b){console.error("Error loading petty cash data:",b),fe({type:"error",title:"Error",message:"Failed to load petty cash data: "+b.message})}finally{U(!1),o(!1)}},[te,be]);n.useEffect(()=>{d();const b=l.channel("petty-cash-changes").on("postgres_changes",{event:"*",schema:"public",table:"petty_cash_transactions"},()=>{d()}).subscribe();return()=>{b.unsubscribe()}},[d]);const k=async b=>{const se=Array.from(b.target.files||[]);se.length!==0&&p(se)},ne=async b=>{const t=Array.from(b.clipboardData.items).filter(f=>f.type.startsWith("image/"));if(t.length>0){b.preventDefault();const z=(await Promise.all(t.map(re=>{const ae=re.getAsFile();return ae?new File([ae],`pasted-image-${Date.now()}.png`,{type:ae.type}):null}))).filter(re=>re!==null);z.length>0&&p(re=>[...re,...z])}},Se=b=>{p(se=>se.filter((t,f)=>f!==b))},y=async b=>{if(await kt({title:"Confirm",message:"Are you sure you want to delete this document?",variant:"danger",confirmLabel:"Delete"}))try{const{error:se}=await l.from("petty_cash_documents").delete().eq("id",b);if(se)throw se;_(t=>t.filter(f=>f.id!==b)),fe({type:"success",title:"Success",message:"Document deleted successfully!"})}catch(se){console.error("Error deleting document:",se),fe({type:"error",title:"Error",message:"Failed to delete document"})}},q=()=>{R(!1),j(null),_([]),p([])},xe=()=>{j(null),S({transaction_type:"expense",transaction_date:new Date().toISOString().split("T")[0],amount:0,description:"",expense_category:"",bank_account_id:"",paid_to:"",paid_by_staff_name:"",paid_by:"cash",source:"",received_by_staff_name:"",import_container_id:"",delivery_challan_id:""}),_([]),p([]),R(!0)},F=b=>{j(b),S({transaction_type:b.transaction_type,transaction_date:b.transaction_date,amount:b.amount,description:b.description,expense_category:b.expense_category||"",bank_account_id:b.bank_account_id||"",paid_to:b.paid_to||"",paid_by_staff_name:b.paid_by_staff_name||"",paid_by:"cash",source:b.source||"",received_by_staff_name:b.received_by_staff_name||"",import_container_id:b.import_container_id||"",delivery_challan_id:b.delivery_challan_id||""}),_(b.petty_cash_documents||[]),p([]),R(!0)},ie=async b=>{if(b.preventDefault(),V.transaction_type==="expense"&&!V.expense_category){fe({type:"error",title:"Error",message:"Please select an expense category"});return}const se=Et.find(t=>t.value===V.expense_category);if(se!=null&&se.requiresContainer&&!V.import_container_id){fe({type:"error",title:"Error",message:`${se.label} requires linking to an import container`});return}try{const t={transaction_type:V.transaction_type,transaction_date:V.transaction_date,amount:V.amount,description:V.description,expense_category:V.transaction_type==="expense"?V.expense_category:null,bank_account_id:V.transaction_type==="withdraw"?V.bank_account_id:null,paid_to:V.transaction_type==="expense"?V.paid_to:null,paid_by_staff_name:V.transaction_type==="expense"?V.paid_by_staff_name:null,source:V.transaction_type==="withdraw"?V.source:null,received_by_staff_name:V.transaction_type==="withdraw"?V.received_by_staff_name:null,import_container_id:V.import_container_id||null,delivery_challan_id:V.delivery_challan_id||null};let f;if(a){const{error:z}=await l.from("petty_cash_transactions").update(t).eq("id",a.id);if(z)throw z;f=a.id}else{const{data:z,error:re}=await l.from("petty_cash_transactions").insert([t]).select("id").single();if(re)throw re;if(!z)throw new Error("Failed to create transaction");f=z.id}if(Y.length>0){const z=Y.map(async re=>{const ae=re.name.split(".").pop(),we=`${`${f}_${Date.now()}.${ae}`}`,{error:Ee}=await l.storage.from("petty-cash-receipts").upload(we,re);if(Ee)throw Ee;const{data:{publicUrl:Oe}}=l.storage.from("petty-cash-receipts").getPublicUrl(we);let Le="proof";re.type.startsWith("image/")?Le="photo":re.type==="application/pdf"&&(Le="invoice");const{error:Ke}=await l.from("petty_cash_documents").insert([{petty_cash_transaction_id:f,file_type:Le,file_name:re.name,file_url:Oe,file_size:re.size,uploaded_by:r==null?void 0:r.id}]);if(Ke)throw Ke});await Promise.all(z)}fe({type:"success",title:"Success",message:a?"Petty cash transaction updated successfully!":"Petty cash transaction added successfully!"}),q(),d()}catch(t){console.error("Error saving petty cash transaction:",t),fe({type:"error",title:"Error",message:"Failed to save transaction: "+t.message})}},_e=async b=>{if(await kt({title:"Confirm",message:"Are you sure you want to delete this transaction?",variant:"danger",confirmLabel:"Delete"}))try{const{data:se}=await l.from("petty_cash_documents").select("file_url").eq("petty_cash_transaction_id",b),{error:t}=await l.from("petty_cash_transactions").delete().eq("id",b);if(t)throw t;if(se&&se.length>0){const f=se.map(z=>z.file_url.split("/").pop()||"").filter(Boolean);f.length>0&&await l.storage.from("petty-cash-receipts").remove(f)}fe({type:"success",title:"Success",message:"Transaction deleted successfully!"}),await d()}catch(se){console.error("Error deleting transaction:",se),fe({type:"error",title:"Error",message:"Failed to delete transaction: "+se.message})}},w=()=>{if(De.length===0){fe({type:"info",title:"Notice",message:"No transactions to export"});return}const b=["Date","Number","Type","Category","Description","Amount","Paid To"],se=De.map(ae=>{const pe=ae.expense_category?Ie(ae.expense_category):null;return[ae.transaction_date,ae.transaction_number,ae.transaction_type==="withdraw"?"Withdrawal":"Expense",(pe==null?void 0:pe.label)||"",ae.description,ae.amount.toString(),ae.paid_to||""]}),t=[b.join(","),...se.map(ae=>ae.map(pe=>`"${pe}"`).join(","))].join(`
`),f=new Blob([t],{type:"text/csv;charset=utf-8;"}),z=document.createElement("a"),re=URL.createObjectURL(f);z.setAttribute("href",re),z.setAttribute("download",`petty_cash_${te||"all"}_to_${be||"all"}.csv`),z.style.visibility="hidden",document.body.appendChild(z),z.click(),document.body.removeChild(z)},le=b=>{P(b),m(!0)},je=b=>{let se="asc";i&&i.key===b&&i.direction==="asc"&&(se="desc"),g({key:b,direction:se})},De=[...L].sort((b,se)=>{if(!i)return 0;const t=b[i.key],f=se[i.key];return t==null?1:f==null?-1:t<f?i.direction==="asc"?-1:1:t>f?i.direction==="asc"?1:-1:0}).filter(b=>{if(u!=="all"&&b.transaction_type==="expense"){const se=Et.find(t=>t.value===b.expense_category);if(!se||se.type!==u)return!1}return!(I!=="all"&&b.expense_category!==I)}),Ie=b=>Et.find(se=>se.value===b),Fe=Ie(V.expense_category);if(A)return e.jsx("div",{className:"flex items-center justify-center h-64",children:"Loading petty cash data..."});const st=De.filter(b=>b.transaction_type==="expense").reduce((b,se)=>b+Number(se.amount),0),ht=De.filter(b=>b.transaction_type==="withdraw").reduce((b,se)=>b+Number(se.amount),0),gt=Et.reduce((b,se)=>(b[se.group]||(b[se.group]=[]),b[se.group].push(se),b),{});return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Petty Cash"}),e.jsx("p",{className:"text-xs text-gray-600 mt-0.5",children:"Track cash withdrawals and expenses"})]}),e.jsxs("div",{className:"flex items-center gap-4 ml-8",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Balance"}),e.jsxs("div",{className:"text-sm font-bold text-green-600",children:["Rp ",c.toLocaleString()]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Withdrawals"}),e.jsxs("div",{className:"text-sm font-bold text-blue-600",children:["Rp ",ht.toLocaleString()]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Expenses"}),e.jsxs("div",{className:"text-sm font-bold text-red-600",children:["Rp ",st.toLocaleString()]})]})]})]}),x&&e.jsxs("button",{onClick:xe,className:"flex items-center gap-1.5 px-2.5 py-1.5 bg-white text-blue-600 rounded hover:bg-blue-50 font-medium transition-all shadow-sm text-xs",children:[e.jsx(mt,{className:"w-3.5 h-3.5"}),"New"]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-2",children:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("div",{className:"flex gap-1",children:[{value:"all",label:"All",icon:""},{value:"import",label:"Import",icon:""},{value:"sales",label:"Sales",icon:""},{value:"staff",label:"Staff",icon:""},{value:"operations",label:"Ops",icon:""},{value:"admin",label:"Admin",icon:""},{value:"assets",label:"Assets",icon:""}].map(b=>e.jsxs("button",{onClick:()=>D(b.value),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${u===b.value?"bg-blue-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[b.icon," ",b.label]},b.value))}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("select",{value:I,onChange:b=>oe(b.target.value),className:"px-2 py-1 border border-gray-300 rounded-md text-xs",children:[e.jsx("option",{value:"all",children:"All Categories"}),Et.map(b=>e.jsx("option",{value:b.value,children:b.label},b.value))]}),e.jsxs("button",{onClick:w,disabled:De.length===0,className:"ml-auto px-3 py-1.5 bg-green-600 text-white rounded-md text-xs hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-1.5 font-medium",children:[e.jsx(Dt,{className:"w-3.5 h-3.5"}),"Export (",De.length,")"]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{onClick:()=>je("transaction_date"),className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Date",(i==null?void 0:i.key)==="transaction_date"&&e.jsx("span",{className:"text-blue-600 text-sm",children:i.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>je("transaction_number"),className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Number",(i==null?void 0:i.key)==="transaction_number"&&e.jsx("span",{className:"text-blue-600 text-sm",children:i.direction==="asc"?"":""})]})}),e.jsx("th",{className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600",children:"Type"}),e.jsx("th",{className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600",children:"Category"}),e.jsx("th",{className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600",children:"Description"}),e.jsx("th",{className:"px-4 py-2.5 text-left text-xs font-semibold text-gray-600",children:"Linked To"}),e.jsx("th",{onClick:()=>je("amount"),className:"px-4 py-2.5 text-right text-xs font-semibold text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["Amount",(i==null?void 0:i.key)==="amount"&&e.jsx("span",{className:"text-blue-600 text-sm",children:i.direction==="asc"?"":""})]})}),x&&e.jsx("th",{className:"px-4 py-2.5 text-center text-xs font-semibold text-gray-600",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:A?e.jsx("tr",{children:e.jsx("td",{colSpan:x?8:7,className:"px-6 py-8 text-center text-gray-500",children:"Loading..."})}):De.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:x?8:7,className:"px-6 py-8 text-center text-gray-500",children:"No transactions found"})}):De.map(b=>{const se=b.expense_category?Ie(b.expense_category):null,t=se==null?void 0:se.icon;return e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-sm text-gray-900",children:ct(b.transaction_date)}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-blue-600",children:b.transaction_number}),b.voucher_number&&e.jsx("span",{className:"text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded",children:b.voucher_number})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:e.jsx("span",{className:`inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium ${b.transaction_type==="withdraw"?"bg-blue-100 text-blue-800":"bg-red-100 text-red-800"}`,children:b.transaction_type==="withdraw"?e.jsxs(e.Fragment,{children:[e.jsx(Ht,{className:"h-3 w-3"}),"Withdrawal"]}):e.jsxs(e.Fragment,{children:[e.jsx(Yt,{className:"h-3 w-3"}),"Expense"]})})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap",children:se&&e.jsxs("div",{className:"flex items-center gap-2",children:[t&&e.jsx(t,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"text-sm text-gray-900",children:se.label})]})}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:e.jsxs("div",{className:"max-w-xs truncate",children:[b.description,b.paid_to&&e.jsxs("div",{className:"text-xs text-gray-500",children:["To: ",b.paid_to]})]})}),e.jsx("td",{className:"px-4 py-3 text-sm",children:e.jsxs("div",{className:"space-y-1",children:[b.import_containers&&e.jsxs("div",{className:"flex items-center gap-1 text-purple-600",children:[e.jsx(lt,{className:"h-3 w-3"}),e.jsx("span",{className:"text-xs",children:b.import_containers.container_ref})]}),b.delivery_challans&&e.jsxs("div",{className:"flex items-center gap-1 text-green-600",children:[e.jsx(it,{className:"h-3 w-3"}),e.jsx("span",{className:"text-xs",children:b.delivery_challans.challan_number})]})]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-right",children:e.jsxs("span",{className:`text-sm font-medium ${b.transaction_type==="withdraw"?"text-blue-600":"text-red-600"}`,children:["Rp ",Number(b.amount).toLocaleString()]})}),e.jsx("td",{className:"px-4 py-3 whitespace-nowrap text-right text-sm",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>le(b),className:"text-blue-600 hover:text-blue-900",title:"View Details",children:e.jsx(Lt,{className:"h-4 w-4"})}),x&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>F(b),className:"text-yellow-600 hover:text-yellow-900",title:"Edit",children:e.jsx(la,{className:"h-4 w-4"})}),e.jsx("button",{onClick:()=>_e(b.id),className:"text-red-600 hover:text-red-900",title:"Delete",children:e.jsx(pt,{className:"h-4 w-4"})})]})]})})]},b.id)})})]})}),e.jsx(qe,{isOpen:Q,onClose:q,title:a?"Edit Transaction":"Add Petty Cash Transaction",children:e.jsxs("form",{onSubmit:ie,className:"space-y-4",onPaste:ne,children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Transaction Type"}),e.jsxs("select",{value:V.transaction_type,onChange:b=>S({...V,transaction_type:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"expense",children:"Expense (Cash Out)"}),e.jsx("option",{value:"withdraw",children:"Withdraw from Bank"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:V.transaction_date,onChange:b=>S({...V,transaction_date:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp)"}),e.jsx("input",{type:"number",value:V.amount||"",onChange:b=>S({...V,amount:parseFloat(b.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,min:"0",step:"0.01"})]})]}),V.transaction_type==="expense"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Expense Category ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:V.expense_category,onChange:b=>S({...V,expense_category:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"",children:"Select expense category..."}),Object.entries(gt).map(([b,se])=>e.jsx("optgroup",{label:b,children:se.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))},b))]}),V.expense_category&&Fe&&e.jsx("p",{className:"mt-1 text-xs text-gray-600",children:Fe.description})]}),(Fe==null?void 0:Fe.requiresContainer)&&e.jsx("div",{className:"bg-orange-50 border border-orange-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(lt,{className:"h-5 w-5 text-orange-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-orange-900",children:"Import Container Required"}),e.jsx("div",{className:"text-xs text-orange-700 mt-1",children:"This expense category requires linking to an import container for proper cost allocation"})]})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Link to Container ",(Fe==null?void 0:Fe.requiresContainer)&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:V.import_container_id,onChange:b=>S({...V,import_container_id:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:Fe==null?void 0:Fe.requiresContainer,children:[e.jsx("option",{value:"",children:"None"}),ee.map(b=>e.jsx("option",{value:b.id,children:b.container_ref},b.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Link to Delivery Challan (Sales)"}),e.jsxs("select",{value:V.delivery_challan_id,onChange:b=>S({...V,delivery_challan_id:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"None"}),O.map(b=>{var se;return e.jsxs("option",{value:b.id,children:[b.challan_number," - ",(se=b.customers)==null?void 0:se.company_name," (",ct(b.challan_date),")"]},b.id)})]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Paid To"}),e.jsx("input",{type:"text",value:V.paid_to,onChange:b=>S({...V,paid_to:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Vendor/Supplier name"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Paid By (Staff)"}),e.jsx("input",{type:"text",value:V.paid_by_staff_name,onChange:b=>S({...V,paid_by_staff_name:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Staff member name"})]})]})]}),V.transaction_type==="withdraw"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:V.bank_account_id,onChange:b=>S({...V,bank_account_id:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select bank account"}),Z.map(b=>e.jsxs("option",{value:b.id,children:[b.alias||b.bank_name," - ",b.account_number," (",b.currency,")"]},b.id))]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Source/Reference"}),e.jsx("input",{type:"text",value:V.source,onChange:b=>S({...V,source:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Check number, transfer ref"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Received By"}),e.jsx("input",{type:"text",value:V.received_by_staff_name,onChange:b=>S({...V,received_by_staff_name:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Staff member name"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:V.description,onChange:b=>S({...V,description:b.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:3,required:!0,placeholder:"Enter transaction details"})]}),a&&T.length>0&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:["Existing Documents (",T.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-3 mb-4",children:T.map(b=>e.jsxs("div",{className:"group relative border border-gray-200 rounded-lg overflow-hidden hover:border-red-500 transition-colors",children:[b.file_type==="photo"?e.jsx("div",{className:"aspect-square bg-gray-100 relative",children:e.jsx("img",{src:b.file_url,alt:b.file_name,className:"w-full h-full object-cover"})}):e.jsxs("div",{className:"aspect-square bg-red-50 flex flex-col items-center justify-center p-3",children:[e.jsx(Ue,{className:"h-10 w-10 text-red-600 mb-2"}),e.jsx("p",{className:"text-xs text-center text-gray-700 line-clamp-2 px-2",children:b.file_name})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs px-2 py-1.5 flex items-center justify-between",children:[e.jsxs("span",{children:[(b.file_size/1024).toFixed(0)," KB"]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx("a",{href:b.file_url,target:"_blank",rel:"noopener noreferrer",className:"p-1 hover:bg-white hover:bg-opacity-20 rounded",onClick:se=>se.stopPropagation(),children:e.jsx(Mt,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>y(b.id),className:"p-1 hover:bg-red-500 rounded",children:e.jsx(yt,{className:"h-3.5 w-3.5"})})]})]})]},b.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:a?"Upload Additional Documents/Receipts":"Upload Documents/Receipts"}),e.jsxs("div",{className:"border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors",children:[e.jsx("input",{type:"file",onChange:k,accept:"image/*,.pdf",multiple:!0,className:"hidden",id:"file-upload"}),e.jsxs("label",{htmlFor:"file-upload",className:"cursor-pointer",children:[e.jsx(Pt,{className:"h-8 w-8 text-gray-400 mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Click to upload or drag and drop"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Images or PDF files"})]}),!v&&Y.length===0&&e.jsx("button",{type:"button",onClick:()=>$(!0),className:"text-xs text-blue-600 hover:text-blue-700 mt-2",children:" You can also paste images here"})]}),Y.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:[Y.length," file(s) ready:"]}),e.jsx("div",{className:"space-y-1",children:Y.map((b,se)=>e.jsxs("div",{className:"flex items-center justify-between bg-gray-50 px-3 py-2 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[b.type.startsWith("image/")?e.jsx(Aa,{className:"h-4 w-4 text-blue-600"}):e.jsx(Ue,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"text-sm text-gray-700",children:b.name}),e.jsxs("span",{className:"text-xs text-gray-500",children:["(",(b.size/1024).toFixed(1)," KB)"]})]}),e.jsx("button",{type:"button",onClick:()=>Se(se),className:"text-red-600 hover:text-red-800",children:e.jsx(yt,{className:"h-4 w-4"})})]},se))})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:q,className:"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[a?"Update":"Save"," Transaction"]})]})]})}),e.jsx(qe,{isOpen:B,onClose:()=>m(!1),title:"Petty Cash Receipt",maxWidth:"max-w-lg",children:C&&e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsx("div",{className:"bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-2 rounded -mt-1 -mx-1",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs opacity-90",children:"Transaction #"}),e.jsx("p",{className:"text-base font-bold",children:C.transaction_number})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs opacity-90",children:"Date"}),e.jsx("p",{className:"text-base font-semibold",children:new Date(C.transaction_date).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"})})]})]})}),e.jsx("div",{className:"py-2 border-b border-gray-200",children:e.jsxs("div",{className:"flex items-center justify-between flex-wrap gap-3",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Type"}),e.jsx("div",{className:"flex items-center gap-1",children:C.transaction_type==="withdraw"?e.jsxs(e.Fragment,{children:[e.jsx(Ht,{className:"h-3.5 w-3.5 text-blue-600"}),e.jsx("span",{className:"text-sm font-medium text-blue-900",children:"Withdrawal"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Yt,{className:"h-3.5 w-3.5 text-red-600"}),e.jsx("span",{className:"text-sm font-medium text-red-900",children:"Expense"})]})})]}),C.expense_category&&e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Category"}),e.jsx("div",{className:"flex items-center gap-1.5",children:(()=>{const b=Ie(C.expense_category),se=b==null?void 0:b.icon;return e.jsxs(e.Fragment,{children:[se&&e.jsx(se,{className:"h-4 w-4 text-amber-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:b==null?void 0:b.label})]})})()})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-gray-500 mb-0.5",children:"Amount"}),e.jsxs("p",{className:"text-lg font-bold text-gray-900",children:["Rp ",Number(C.amount).toLocaleString("id-ID")]})]})]})}),e.jsxs("div",{className:"py-2 border-b border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"Description"}),e.jsx("p",{className:"text-sm font-semibold text-gray-900",children:C.description})]}),e.jsxs("div",{className:"py-2 border-b border-gray-200 space-y-1.5",children:[(C.paid_to||C.paid_by_staff_name)&&e.jsxs("div",{className:"flex items-center gap-4 flex-wrap",children:[C.paid_to&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Paid To:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:C.paid_to})]}),C.paid_by_staff_name&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Paid By:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:C.paid_by_staff_name})]})]}),C.received_by_staff_name&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Received By:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:C.received_by_staff_name})]}),C.source&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Source:"}),e.jsx("p",{className:"text-sm font-medium text-gray-900",children:C.source})]})]}),(C.import_containers||C.delivery_challans||C.bank_accounts)&&e.jsxs("div",{className:"py-2 border-b border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1.5",children:"Linked To"}),e.jsxs("div",{className:"space-y-1",children:[C.import_containers&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(lt,{className:"h-3.5 w-3.5 text-purple-600"}),e.jsx("span",{className:"text-gray-600",children:"Container:"}),e.jsx("span",{className:"font-medium text-gray-900",children:C.import_containers.container_ref})]}),C.delivery_challans&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(it,{className:"h-3.5 w-3.5 text-green-600"}),e.jsx("span",{className:"text-gray-600",children:"Challan:"}),e.jsx("span",{className:"font-medium text-gray-900",children:C.delivery_challans.challan_number})]}),C.bank_accounts&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs",children:[e.jsx(Ve,{className:"h-3.5 w-3.5 text-blue-600"}),e.jsx("span",{className:"text-gray-600",children:"Bank:"}),e.jsx("span",{className:"font-medium text-gray-900",children:C.bank_accounts.alias||C.bank_accounts.bank_name})]})]})]}),C.petty_cash_documents&&C.petty_cash_documents.length>0&&e.jsxs("div",{className:"pt-2",children:[e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Attachments (",C.petty_cash_documents.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:C.petty_cash_documents.map(b=>e.jsxs("a",{href:b.file_url,target:"_blank",rel:"noopener noreferrer",className:"group relative border border-gray-200 rounded overflow-hidden hover:border-blue-500 transition-colors",children:[b.file_type==="photo"?e.jsxs("div",{className:"aspect-square bg-gray-100 relative",children:[e.jsx("img",{src:b.file_url,alt:b.file_name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity flex items-center justify-center",children:e.jsx(Mt,{className:"h-5 w-5 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]}):e.jsxs("div",{className:"aspect-square bg-red-50 flex flex-col items-center justify-center p-3",children:[e.jsx(Ue,{className:"h-8 w-8 text-red-600 mb-2"}),e.jsx("p",{className:"text-xs text-center text-gray-700 line-clamp-2",children:b.file_name})]}),b.file_size&&e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-black bg-opacity-60 text-white text-xs px-2 py-0.5",children:[(b.file_size/1024).toFixed(0)," KB"]})]},b.id))})]})]})}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ue,{className:"h-5 w-5 text-blue-600 flex-shrink-0 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-2",children:"Recording Fixed Assets"}),e.jsxs("div",{className:"text-sm text-blue-800 space-y-2",children:[e.jsx("p",{children:e.jsx("strong",{children:"For Equipment/Asset Purchases:"})}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1 ml-2",children:[e.jsx("li",{children:'Use category "Fixed Assets / Equipment"'}),e.jsx("li",{children:"Record the purchase here with full details"}),e.jsx("li",{children:'This creates a debit to "Fixed Assets" account'}),e.jsx("li",{children:"Assets are CAPITALIZED (not expensed immediately)"}),e.jsx("li",{children:"Later: Finance team will set up depreciation schedule"})]}),e.jsx("p",{className:"text-xs mt-2 bg-blue-100 p-2 rounded",children:" Examples: Computers, machinery, furniture, vehicles, AC units, shelving"})]})]})]})})]})}const zt=x=>{const W=new Date(x),L=W.getDate().toString().padStart(2,"0"),G=(W.getMonth()+1).toString().padStart(2,"0"),ee=W.getFullYear().toString().slice(-2);return`${L}/${G}/${ee}`};function Ga({canManage:x}){const[W,L]=n.useState([]),[G,ee]=n.useState([]),[M,O]=n.useState([]),[K,Z]=n.useState([]),[H,A]=n.useState(!0),[U,Q]=n.useState(!1),[R,B]=n.useState(null),[m,C]=n.useState({transfer_date:new Date().toISOString().split("T")[0],from_amount:0,to_amount:0,from_account_type:"bank",to_account_type:"bank",from_bank_account_id:"",to_bank_account_id:"",from_bank_statement_line_id:"",to_bank_statement_line_id:"",description:""});n.useEffect(()=>{P();const i=l.channel("bank-statement-fund-transfer-changes").on("postgres_changes",{event:"*",schema:"public",table:"bank_statement_lines"},()=>{m.from_bank_account_id&&a(m.from_bank_account_id,"from",(R==null?void 0:R.from_bank_statement_line_id)||void 0),m.to_bank_account_id&&a(m.to_bank_account_id,"to",(R==null?void 0:R.to_bank_statement_line_id)||void 0)}).subscribe();return()=>{i.unsubscribe()}},[m.from_bank_account_id,m.to_bank_account_id]);const P=async()=>{var i;try{console.log("loadData: Starting to load fund transfers..."),A(!0);const[g,v]=await Promise.all([l.from("vw_fund_transfers_detailed").select("*").order("transfer_date",{ascending:!1}).order("created_at",{ascending:!1}).limit(100),l.from("bank_accounts").select("id, bank_name, account_number, alias, currency").eq("is_active",!0).order("bank_name")]);if(console.log("loadData: Transfers result:",(i=g.data)==null?void 0:i.length,"records"),g.error)throw g.error;if(v.error)throw v.error;L(g.data||[]),ee(v.data||[])}catch(g){console.error("Error loading fund transfers:",g.message),fe({type:"error",title:"Error",message:"Failed to load fund transfers"})}finally{A(!1)}},a=async(i,g,v)=>{if(!i){g==="from"?O([]):Z([]);return}try{let $=l.from("bank_statement_lines").select("id, transaction_date, description, debit_amount, credit_amount, reconciliation_status").eq("bank_account_id",i).is("matched_fund_transfer_id",null).is("matched_expense_id",null).is("matched_receipt_id",null).is("matched_petty_cash_id",null).is("matched_entry_id",null).order("transaction_date",{ascending:!1});const{data:u,error:D}=await $;if(D)throw D;let I=u||[];if(v){const{data:oe}=await l.from("bank_statement_lines").select("id, transaction_date, description, debit_amount, credit_amount, reconciliation_status").eq("id",v).single();oe&&!I.find(he=>he.id===oe.id)&&(I=[oe,...I])}g==="from"?O(I):Z(I)}catch($){console.error("Error loading bank statements:",$)}},j=()=>{if(m.from_account_type==="bank"&&m.from_bank_account_id){const i=G.find(g=>g.id===m.from_bank_account_id);return(i==null?void 0:i.currency)||"IDR"}return"IDR"},c=()=>{if(m.to_account_type==="bank"&&m.to_bank_account_id){const i=G.find(g=>g.id===m.to_bank_account_id);return(i==null?void 0:i.currency)||"IDR"}return"IDR"},h=()=>{const i=j(),g=c();return m.from_amount>0&&m.to_amount>0&&i!==g?m.to_amount/m.from_amount:null},N=async i=>{if(i.preventDefault(),m.from_amount<=0){fe({type:"error",title:"Error",message:"From Amount must be greater than 0"});return}if(m.to_amount<=0){fe({type:"error",title:"Error",message:"To Amount must be greater than 0"});return}if(m.from_account_type===m.to_account_type)if(m.from_account_type==="bank"){if(m.from_bank_account_id===m.to_bank_account_id){fe({type:"error",title:"Error",message:"Cannot transfer to the same bank account"});return}}else{fe({type:"error",title:"Error",message:"Cannot transfer to the same account type"});return}if(m.from_account_type==="bank"&&!m.from_bank_account_id){fe({type:"error",title:"Error",message:"Please select source bank account"});return}if(m.to_account_type==="bank"&&!m.to_bank_account_id){fe({type:"error",title:"Error",message:"Please select destination bank account"});return}try{const{data:{user:g}}=await l.auth.getUser();if(!g)throw new Error("Not authenticated");const v=h();if(R){const $={transfer_date:m.transfer_date,amount:m.from_amount,from_amount:m.from_amount,to_amount:m.to_amount,exchange_rate:v,from_account_type:m.from_account_type,to_account_type:m.to_account_type,description:m.description||null,from_bank_account_id:m.from_account_type==="bank"?m.from_bank_account_id:null,to_bank_account_id:m.to_account_type==="bank"?m.to_bank_account_id:null,from_bank_statement_line_id:m.from_bank_statement_line_id||null,to_bank_statement_line_id:m.to_bank_statement_line_id||null};console.log("Updating fund transfer:",R.id,$);const{data:u,error:D}=await l.from("fund_transfers").update($).eq("id",R.id).select();if(console.log("Update result:",{updatedData:u,error:D}),D)throw D;fe({type:"success",title:"Success",message:"Fund transfer updated successfully!"})}else{const{data:$,error:u}=await l.rpc("generate_fund_transfer_number");if(u)throw u;const D={transfer_number:$,transfer_date:m.transfer_date,amount:m.from_amount,from_amount:m.from_amount,to_amount:m.to_amount,exchange_rate:v,from_account_type:m.from_account_type,to_account_type:m.to_account_type,description:m.description||null,created_by:g.id};m.from_account_type==="bank"&&(D.from_bank_account_id=m.from_bank_account_id),m.to_account_type==="bank"&&(D.to_bank_account_id=m.to_bank_account_id),m.from_bank_statement_line_id&&(D.from_bank_statement_line_id=m.from_bank_statement_line_id),m.to_bank_statement_line_id&&(D.to_bank_statement_line_id=m.to_bank_statement_line_id);const{data:I,error:oe}=await l.from("fund_transfers").insert([D]).select().single();if(oe)throw oe;if(m.to_account_type==="petty_cash"&&I){const he="PCW",r=new Date().getFullYear().toString().slice(-2),te=(new Date().getMonth()+1).toString().padStart(2,"0"),{count:be}=await l.from("petty_cash_transactions").select("*",{count:"exact",head:!0}).like("transaction_number",`${he}${r}${te}%`),V=`${he}${r}${te}-${String((be||0)+1).padStart(4,"0")}`;let S="Bank";if(m.from_account_type==="bank"&&m.from_bank_account_id){const k=G.find(ne=>ne.id===m.from_bank_account_id);S=(k==null?void 0:k.alias)||(k==null?void 0:k.bank_name)||"Bank"}const{error:d}=await l.from("petty_cash_transactions").insert([{transaction_number:V,transaction_date:m.transfer_date,transaction_type:"withdraw",amount:m.to_amount,description:m.description||`Fund transfer from ${S}`,bank_account_id:m.from_account_type==="bank"?m.from_bank_account_id:null,source:`Fund Transfer ${$}`,fund_transfer_id:I.id,created_by:g.id}]);d?(console.error("Error creating petty cash transaction:",d),fe({type:"warning",title:"Warning",message:"Fund transfer created but petty cash entry failed: "+d.message})):console.log("Petty cash transaction created successfully:",V)}m.from_bank_statement_line_id&&I&&await l.from("bank_statement_lines").update({matched_fund_transfer_id:I.id,reconciliation_status:"matched",matched_at:new Date().toISOString(),matched_by:g.id,notes:`Linked to Fund Transfer ${$}`}).eq("id",m.from_bank_statement_line_id),m.to_bank_statement_line_id&&I&&await l.from("bank_statement_lines").update({matched_fund_transfer_id:I.id,reconciliation_status:"matched",matched_at:new Date().toISOString(),matched_by:g.id,notes:`Linked to Fund Transfer ${$}`}).eq("id",m.to_bank_statement_line_id),fe({type:"success",title:"Success",message:"Fund transfer created and posted successfully!"})}Q(!1),o(),P()}catch(g){console.error("Error with fund transfer:",g.message),fe({type:"error",title:"Error",message:"Failed to save fund transfer: "+g.message})}},o=()=>{C({transfer_date:new Date().toISOString().split("T")[0],from_amount:0,to_amount:0,from_account_type:"bank",to_account_type:"bank",from_bank_account_id:"",to_bank_account_id:"",from_bank_statement_line_id:"",to_bank_statement_line_id:"",description:""}),O([]),Z([]),B(null)},Y=async i=>{B(i),C({transfer_date:i.transfer_date,from_amount:i.from_amount,to_amount:i.to_amount,from_account_type:i.from_account_type,to_account_type:i.to_account_type,from_bank_account_id:i.from_bank_account_id||"",to_bank_account_id:i.to_bank_account_id||"",from_bank_statement_line_id:i.from_bank_statement_line_id||"",to_bank_statement_line_id:i.to_bank_statement_line_id||"",description:i.description||""}),i.from_bank_account_id&&a(i.from_bank_account_id,"from",i.from_bank_statement_line_id||void 0),i.to_bank_account_id&&a(i.to_bank_account_id,"to",i.to_bank_statement_line_id||void 0),Q(!0)},p=async i=>{if(await kt({title:"Confirm",message:"Are you sure you want to delete this fund transfer? This will also delete the associated petty cash transaction and journal entry.",variant:"danger",confirmLabel:"Delete"}))try{const{error:g}=await l.from("petty_cash_transactions").delete().eq("fund_transfer_id",i);g&&console.error("Error deleting petty cash transaction:",g),await l.from("bank_statement_lines").update({matched_fund_transfer_id:null,reconciliation_status:"unmatched",matched_at:null,matched_by:null,notes:null}).eq("matched_fund_transfer_id",i);const{error:v}=await l.from("fund_transfers").delete().eq("id",i);if(v)throw v;fe({type:"success",title:"Success",message:"Fund transfer deleted successfully!"}),P()}catch(g){console.error("Error deleting fund transfer:",g.message),fe({type:"error",title:"Error",message:"Failed to delete fund transfer: "+g.message})}},T=i=>{switch(i){case"petty_cash":return"Petty Cash";case"cash_on_hand":return"Cash on Hand";case"bank":return"Bank Account";default:return i}},_=i=>{switch(i){case"posted":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-green-700 bg-green-50 border border-green-200 rounded",children:[e.jsx(ja,{className:"w-3 h-3"}),"Posted"]});case"pending":return e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-1 text-xs font-medium text-yellow-700 bg-yellow-50 border border-yellow-200 rounded",children:[e.jsx(wa,{className:"w-3 h-3"}),"Pending"]});default:return e.jsx("span",{className:"text-xs text-gray-500",children:i})}};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:"Fund Transfers"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Transfer funds between accounts"})]}),x&&e.jsxs("button",{onClick:()=>{o(),Q(!0)},className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(mt,{className:"w-4 h-4"}),"New Transfer"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Date"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Transfer #"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"From"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:""}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"To"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Description"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Amount"}),e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Status"}),x&&e.jsx("th",{className:"px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:H?e.jsx("tr",{children:e.jsx("td",{colSpan:x?9:8,className:"px-6 py-8 text-center text-gray-500",children:"Loading..."})}):W.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:x?9:8,className:"px-6 py-8 text-center text-gray-500",children:"No fund transfers found"})}):W.map(i=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-900",children:zt(i.transfer_date)}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap font-mono text-sm text-gray-900",children:i.transfer_number}),e.jsxs("td",{className:"px-6 py-4 text-sm text-gray-900",children:[e.jsx("div",{className:"font-medium",children:i.from_account_name}),e.jsx("div",{className:"text-xs text-gray-500",children:T(i.from_account_type)})]}),e.jsx("td",{className:"px-6 py-4 text-center",children:e.jsx(ta,{className:"w-4 h-4 text-blue-600 inline"})}),e.jsxs("td",{className:"px-6 py-4 text-sm text-gray-900",children:[e.jsx("div",{className:"font-medium",children:i.to_account_name}),e.jsx("div",{className:"text-xs text-gray-500",children:T(i.to_account_type)})]}),e.jsx("td",{className:"px-6 py-4 text-sm text-gray-700",children:i.description||"-"}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900",children:i.from_currency===i.to_currency?e.jsxs("div",{children:[i.from_currency==="USD"?"$":"Rp"," ",i.from_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}):e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"text-red-600",children:[i.from_currency==="USD"?"$":"Rp"," ",i.from_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("div",{className:"text-xs text-gray-500",children:""}),e.jsxs("div",{className:"text-green-600",children:[i.to_currency==="USD"?"$":"Rp"," ",i.to_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),i.exchange_rate&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Rate: ",i.exchange_rate.toFixed(6)]})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:_(i.status)}),x&&e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("button",{onClick:()=>Y(i),className:"text-blue-600 hover:text-blue-800",title:"Edit Transfer",children:e.jsx(Nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>p(i.id),className:"text-red-600 hover:text-red-800",title:"Delete Transfer",children:e.jsx(pt,{className:"w-4 h-4"})})]})})]},i.id))})]})}),U&&e.jsx(qe,{isOpen:U,onClose:()=>{Q(!1),o()},title:R?"Edit Fund Transfer":"New Fund Transfer",maxWidth:"max-w-2xl",children:e.jsxs("form",{onSubmit:N,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Transfer Date ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"date",value:m.transfer_date,onChange:i=>C({...m,transfer_date:i.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0})]}),e.jsxs("div",{className:"border-2 border-blue-200 rounded-lg p-4 bg-blue-50",children:[e.jsx("h3",{className:"text-sm font-semibold text-blue-900 mb-3",children:"From (Source Account)"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Account Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:m.from_account_type,onChange:i=>C({...m,from_account_type:i.target.value,from_bank_account_id:i.target.value==="bank"?m.from_bank_account_id:""}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"bank",children:"Bank Account"}),e.jsx("option",{value:"cash_on_hand",children:"Cash on Hand"}),e.jsx("option",{value:"petty_cash",children:"Petty Cash"})]})]}),m.from_account_type==="bank"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Bank Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:m.from_bank_account_id,onChange:i=>{C({...m,from_bank_account_id:i.target.value,from_bank_statement_line_id:""}),a(i.target.value,"from")},className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select Bank Account"}),G.map(i=>e.jsxs("option",{value:i.id,children:[i.alias||i.bank_name," - ",i.account_number," (",i.currency,")"]},i.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Amount (",j(),") ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",value:m.from_amount||"",onChange:i=>{const g=parseFloat(i.target.value)||0,v=j(),$=c();C(v===$?{...m,from_amount:g,to_amount:g}:{...m,from_amount:g})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,min:"0.01"})]}),m.from_bank_account_id&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:" Link to Bank Statement (Optional)"}),M.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:m.from_bank_statement_line_id,onChange:i=>C({...m,from_bank_statement_line_id:i.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"No link"}),M.map(i=>{var g;return e.jsxs("option",{value:i.id,children:[zt(i.transaction_date)," - ",(g=i.description)==null?void 0:g.substring(0,40)," -",j()==="USD"?"$":"Rp"," ",(i.debit_amount||i.credit_amount||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]},i.id)})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[M.length," unlinked transaction",M.length!==1?"s":""," available"]})]}):e.jsx("div",{className:"text-sm text-gray-500 italic py-2 px-3 bg-gray-50 rounded-lg border border-gray-200",children:"No unlinked transactions available"})]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(ta,{className:"w-6 h-6 text-gray-400"})}),e.jsxs("div",{className:"border-2 border-green-200 rounded-lg p-4 bg-green-50",children:[e.jsx("h3",{className:"text-sm font-semibold text-green-900 mb-3",children:"To (Destination Account)"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Account Type ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:m.to_account_type,onChange:i=>C({...m,to_account_type:i.target.value,to_bank_account_id:i.target.value==="bank"?m.to_bank_account_id:""}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"petty_cash",children:"Petty Cash"}),e.jsx("option",{value:"cash_on_hand",children:"Cash on Hand"}),e.jsx("option",{value:"bank",children:"Bank Account"})]})]}),m.to_account_type==="bank"&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Bank Account ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{value:m.to_bank_account_id,onChange:i=>{C({...m,to_bank_account_id:i.target.value,to_bank_statement_line_id:""}),a(i.target.value,"to")},className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,children:[e.jsx("option",{value:"",children:"Select Bank Account"}),G.map(i=>e.jsxs("option",{value:i.id,children:[i.alias||i.bank_name," - ",i.account_number," (",i.currency,")"]},i.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Amount (",c(),") ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"number",step:"0.01",value:m.to_amount||"",onChange:i=>C({...m,to_amount:parseFloat(i.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",required:!0,min:"0.01"}),j()!==c()&&m.from_amount>0&&m.to_amount>0&&e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Exchange Rate: 1 USD = ",(j()==="USD"?m.to_amount/m.from_amount:m.from_amount/m.to_amount).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})," IDR"]})]}),m.to_bank_account_id&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:" Link to Bank Statement (Optional)"}),K.length>0?e.jsxs(e.Fragment,{children:[e.jsxs("select",{value:m.to_bank_statement_line_id,onChange:i=>C({...m,to_bank_statement_line_id:i.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg text-sm",children:[e.jsx("option",{value:"",children:"No link"}),K.map(i=>{var g;return e.jsxs("option",{value:i.id,children:[zt(i.transaction_date)," - ",(g=i.description)==null?void 0:g.substring(0,40)," -",c()==="USD"?"$":"Rp"," ",(i.debit_amount||i.credit_amount||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]},i.id)})]}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:[K.length," unlinked transaction",K.length!==1?"s":""," available"]})]}):e.jsx("div",{className:"text-sm text-gray-500 italic py-2 px-3 bg-gray-50 rounded-lg border border-gray-200",children:"No unlinked transactions available"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:m.description,onChange:i=>C({...m,description:i.target.value}),rows:2,className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Purpose of transfer (optional)"})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Note:"})," The journal entry will be posted automatically when you create this transfer. Both accounts will be updated immediately."]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{Q(!1),o()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Create Transfer"})]})]})})]})}const Xa={sales_invoice:"Sales Invoice",sales_invoice_cogs:"COGS Entry",purchase_invoice:"Purchase Invoice",receipt:"Receipt Voucher",payment:"Payment Voucher",petty_cash:"Petty Cash",fund_transfer:"Fund Transfer",manual:"Manual Entry"};function Ha({canManage:x}){const{dateRange:W}=xt(),[L,G]=n.useState([]),[ee,M]=n.useState(!0),[O,K]=n.useState(""),[Z,H]=n.useState(null),[A,U]=n.useState([]),[Q,R]=n.useState(!1),[B,m]=n.useState("all");n.useEffect(()=>{C()},[W,B]);const C=async()=>{try{M(!0);let h=l.from("journal_voucher_view").select("*").gte("date",W.startDate).lte("date",W.endDate);B!=="all"&&(h=h.eq("source_module",B));const{data:N,error:o}=await h;if(o)throw o;G(N||[])}catch(h){console.error("Error loading voucher journal:",h)}finally{M(!1)}},P=async h=>{try{const{data:N,error:o}=await l.from("journal_entry_lines").select("*, chart_of_accounts(code, name), customers(company_name), suppliers(company_name)").eq("journal_entry_id",h).order("line_number");if(o)throw o;U(N||[])}catch(N){console.error("Error loading lines:",N)}},a=async h=>{try{const{data:N,error:o}=await l.from("journal_entries").select("*").eq("id",h.journal_entry_id).single();if(o)throw o;H(N),await P(h.journal_entry_id),R(!0)}catch(N){console.error("Error loading voucher details:",N)}},j=L.filter(h=>h.voucher_no.toLowerCase().includes(O.toLowerCase())||h.debit_account&&h.debit_account.toLowerCase().includes(O.toLowerCase())||h.credit_account&&h.credit_account.toLowerCase().includes(O.toLowerCase())||h.narration&&h.narration.toLowerCase().includes(O.toLowerCase())||h.reference_number&&h.reference_number.toLowerCase().includes(O.toLowerCase())),c={debit:j.reduce((h,N)=>h+N.amount,0),credit:j.reduce((h,N)=>h+N.amount,0)};return ee?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px]",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search voucher, accounts, narration...",value:O,onChange:h=>K(h.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("select",{value:B,onChange:h=>m(h.target.value),className:"px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"all",children:"All Sources"}),e.jsx("option",{value:"sales_invoice",children:"Sales Invoices"}),e.jsx("option",{value:"sales_invoice_cogs",children:"COGS"}),e.jsx("option",{value:"purchase_invoice",children:"Purchase Invoices"}),e.jsx("option",{value:"receipt",children:"Receipts"}),e.jsx("option",{value:"payment",children:"Payments"}),e.jsx("option",{value:"petty_cash",children:"Petty Cash"}),e.jsx("option",{value:"fund_transfer",children:"Fund Transfers"}),e.jsx("option",{value:"manual",children:"Manual"})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Date"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Type"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Debit Account"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Credit Account"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r",children:"Narration"}),e.jsx("th",{className:"px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Details"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-200 bg-white",children:[j.map(h=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-gray-900 border-r",children:e.jsx("div",{className:"text-xs",children:new Date(h.date).toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"2-digit"})})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap border-r",children:e.jsx("span",{className:"px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded",children:h.voucher_type})}),e.jsx("td",{className:"px-3 py-2 border-r",children:e.jsx("div",{className:"text-xs text-gray-900 max-w-xs truncate",children:h.debit_account||"-"})}),e.jsx("td",{className:"px-3 py-2 border-r",children:e.jsx("div",{className:"text-xs text-gray-900 max-w-xs truncate",children:h.credit_account||"-"})}),e.jsx("td",{className:"px-3 py-2 text-right whitespace-nowrap border-r",children:e.jsxs("span",{className:"text-gray-900 font-medium text-xs",children:["Rp ",h.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})}),e.jsx("td",{className:"px-3 py-2 text-gray-600 text-xs border-r",children:e.jsx("div",{className:"max-w-md truncate",children:h.narration||"-"})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("button",{onClick:()=>a(h),className:"text-blue-600 hover:text-blue-800",title:"View detailed breakdown",children:e.jsx(Ue,{className:"w-4 h-4"})})})]},h.journal_entry_id)),j.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"px-4 py-8 text-center text-gray-500",children:"No journal entries found"})})]}),e.jsx("tfoot",{className:"bg-gray-50 font-bold",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"px-3 py-2 text-right",children:"Total:"}),e.jsxs("td",{className:"px-3 py-2 text-right text-gray-900 border-r",children:["Rp ",c.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{colSpan:2})]})})]})})}),e.jsx(qe,{isOpen:Q,onClose:()=>R(!1),title:`Journal Entry: ${Z==null?void 0:Z.entry_number}`,children:Z&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"}),e.jsx("span",{className:"ml-2 font-medium",children:new Date(Z.entry_date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Source:"}),e.jsx("span",{className:"ml-2",children:Z.source_module?Xa[Z.source_module]:"Manual"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Reference:"}),e.jsx("span",{className:"ml-2 font-mono",children:Z.reference_number||"-"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Posted:"}),e.jsx("span",{className:"ml-2",children:new Date(Z.posted_at).toLocaleString("id-ID")})]})]}),Z.description&&e.jsx("div",{className:"p-3 bg-gray-50 rounded-lg text-sm",children:Z.description}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Account"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Description"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Debit"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Credit"})]})}),e.jsx("tbody",{className:"divide-y",children:A.map(h=>{var N,o;return e.jsxs("tr",{children:[e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-mono text-xs text-gray-500",children:(N=h.chart_of_accounts)==null?void 0:N.code}),e.jsx("div",{children:(o=h.chart_of_accounts)==null?void 0:o.name}),h.customers&&e.jsx("div",{className:"text-xs text-blue-600",children:h.customers.company_name}),h.suppliers&&e.jsx("div",{className:"text-xs text-purple-600",children:h.suppliers.company_name})]}),e.jsx("td",{className:"px-3 py-2 text-gray-600",children:h.description||"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-blue-600",children:h.debit>0?`Rp ${h.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""}),e.jsx("td",{className:"px-3 py-2 text-right text-green-600",children:h.credit>0?`Rp ${h.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""})]},h.id)})}),e.jsx("tfoot",{className:"bg-gray-50 font-medium",children:e.jsxs("tr",{children:[e.jsx("td",{colSpan:2,className:"px-3 py-2 text-right",children:"Total:"}),e.jsxs("td",{className:"px-3 py-2 text-right text-blue-700",children:["Rp ",Z.total_debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("td",{className:"px-3 py-2 text-right text-green-700",children:["Rp ",Z.total_credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})})]})}),Z.total_debit!==Z.total_credit&&e.jsx("div",{className:"p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm",children:"Warning: Debit and Credit totals do not match!"})]})})]})}function Ya(){const{dateRange:x}=xt(),[W,L]=n.useState([]),[G,ee]=n.useState(null),[M,O]=n.useState([]),[K,Z]=n.useState(0),[H,A]=n.useState(!0),[U,Q]=n.useState("");n.useEffect(()=>{R()},[]),n.useEffect(()=>{G&&B()},[G,x]);const R=async()=>{try{const{data:j,error:c}=await l.from("chart_of_accounts").select("*").eq("is_active",!0).eq("is_header",!1).order("code");if(c)throw c;L(j||[])}catch(j){console.error("Error loading accounts:",j)}finally{A(!1)}},B=async()=>{if(G)try{A(!0);const{data:j,error:c}=await l.from("journal_entry_lines").select("debit, credit, journal_entries!inner(entry_date)").eq("account_id",G.id).lt("journal_entries.entry_date",x.startDate);if(c)throw c;let h=0;j==null||j.forEach(_=>{G.normal_balance==="debit"?h+=_.debit-_.credit:h+=_.credit-_.debit}),Z(h);const{data:N,error:o}=await l.from("journal_entry_lines").select(`
          *,
          journal_entries!inner(
            id,
            entry_number,
            entry_date,
            source_module,
            reference_number
          )
        `).eq("account_id",G.id).gte("journal_entries.entry_date",x.startDate).lte("journal_entries.entry_date",x.endDate).order("line_number");if(o)throw console.error("Error loading ledger:",o),o;const Y=(N||[]).sort((_,i)=>{const g=new Date(_.journal_entries.entry_date).getTime(),v=new Date(i.journal_entries.entry_date).getTime();return g!==v?g-v:_.line_number-i.line_number});let p=h;const T=Y.map(_=>{const i=_.journal_entries;return G.normal_balance==="debit"?p+=_.debit-_.credit:p+=_.credit-_.debit,{id:_.id,line_number:_.line_number,journal_entry_id:i.id,entry_date:i.entry_date,entry_number:i.entry_number,source_module:i.source_module,reference_number:i.reference_number,description:_.description,debit:_.debit,credit:_.credit,balance:p}});O(T)}catch(j){console.error("Error loading ledger:",j)}finally{A(!1)}},m=()=>{window.print()},C=W.filter(j=>j.code.toLowerCase().includes(U.toLowerCase())||j.name.toLowerCase().includes(U.toLowerCase())),P=M.length>0?M[M.length-1].balance:K,a=M.reduce((j,c)=>({debit:j.debit+c.debit,credit:j.credit+c.credit}),{debit:0,credit:0});return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search account by code or name...",value:U,onChange:j=>Q(j.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("select",{value:(G==null?void 0:G.id)||"",onChange:j=>{const c=W.find(h=>h.id===j.target.value);ee(c||null)},className:"px-4 py-2 border border-gray-300 rounded-lg min-w-[300px]",children:[e.jsx("option",{value:"",children:"Select Account..."}),C.map(j=>e.jsxs("option",{value:j.id,children:[j.code," - ",j.name]},j.id))]}),G&&e.jsxs("button",{onClick:m,className:"flex items-center gap-2 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700",children:[e.jsx(na,{className:"w-4 h-4"}),"Print"]})]}),!G&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-6 text-center",children:[e.jsx("p",{className:"text-blue-800 font-medium mb-2",children:"Select an account to view its ledger"}),e.jsx("p",{className:"text-blue-600 text-sm mb-4",children:"Use the dropdown above to choose an account, or search by code or name."}),e.jsxs("div",{className:"bg-white border border-blue-200 rounded p-3 text-left max-w-md mx-auto",children:[e.jsxs("p",{className:"text-sm text-gray-700 mb-1",children:[e.jsx("span",{className:"font-semibold",children:"Tip:"})," To view all journal entries across all accounts:"]}),e.jsxs("p",{className:"text-sm text-blue-700",children:["Go to ",e.jsx("span",{className:"font-mono bg-blue-100 px-2 py-0.5 rounded",children:"Journal Register"})," in the Books menu (Ctrl+J)"]})]})]}),G&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"bg-white border rounded-lg p-4 print:border-0",children:[e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("h2",{className:"text-xl font-bold",children:"Account Ledger"}),e.jsxs("h3",{className:"text-lg font-medium mt-1",children:[G.code," - ",G.name]}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Period: ",new Date(x.startDate).toLocaleDateString("id-ID")," to ",new Date(x.endDate).toLocaleDateString("id-ID")]})]}),e.jsxs("div",{className:"flex justify-between items-center py-2 border-t border-b font-medium bg-gray-50 px-3",children:[e.jsx("span",{children:"Opening Balance:"}),e.jsxs("span",{className:K>=0?"text-green-600":"text-red-600",children:["Rp ",Math.abs(K).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}),K<0&&" (Cr)"]})]}),e.jsx("div",{className:"mt-4 overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b-2 border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase",children:"Date"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase",children:"Voucher No"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase",children:"Type"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-700 uppercase",children:"Debit"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-700 uppercase",children:"Credit"}),e.jsx("th",{className:"px-3 py-2 text-right text-xs font-medium text-gray-700 uppercase",children:"Balance"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-medium text-gray-700 uppercase",children:"Narration"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200 bg-white",children:M.map(j=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:new Date(j.entry_date).toLocaleDateString("id-ID",{day:"2-digit",month:"2-digit",year:"numeric"})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap font-mono text-blue-600",children:j.entry_number}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("span",{className:"px-2 py-1 text-xs bg-gray-100 rounded",children:j.source_module||"Manual"})}),e.jsx("td",{className:"px-3 py-2 text-right whitespace-nowrap text-blue-600",children:j.debit>0?`Rp ${j.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""}),e.jsx("td",{className:"px-3 py-2 text-right whitespace-nowrap text-green-600",children:j.credit>0?`Rp ${j.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""}),e.jsx("td",{className:"px-3 py-2 text-right whitespace-nowrap font-medium",children:e.jsxs("span",{className:j.balance>=0?"text-green-600":"text-red-600",children:["Rp ",Math.abs(j.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})}),e.jsx("td",{className:"px-3 py-2 text-gray-600 text-xs max-w-xs truncate",children:j.description||j.reference_number||"-"})]},j.id))}),e.jsxs("tfoot",{className:"bg-gray-50 border-t-2 border-gray-200 font-bold",children:[e.jsxs("tr",{children:[e.jsx("td",{colSpan:3,className:"px-3 py-2 text-right",children:"Total:"}),e.jsxs("td",{className:"px-3 py-2 text-right text-blue-700",children:["Rp ",a.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("td",{className:"px-3 py-2 text-right text-green-700",children:["Rp ",a.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsx("td",{colSpan:2})]}),e.jsxs("tr",{children:[e.jsx("td",{colSpan:5,className:"px-3 py-2 text-right",children:"Closing Balance:"}),e.jsx("td",{className:"px-3 py-2 text-right",children:e.jsxs("span",{className:P>=0?"text-green-700":"text-red-700",children:["Rp ",Math.abs(P).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}),P<0&&" (Cr)"]})}),e.jsx("td",{})]})]})]})}),M.length===0&&!H&&e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No transactions found for this account in the selected period."})]})}),!G&&!H&&e.jsxs("div",{className:"text-center py-12 text-gray-500 bg-white rounded-lg border",children:[e.jsx(Ka,{className:"w-12 h-12 mx-auto text-gray-300 mb-3"}),e.jsx("p",{children:"Select an account to view its ledger"})]})]})}function Ka(x){return e.jsx("svg",{...x,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"})})}function Za(){const{dateRange:x}=xt(),W=n.useRef(null),[L,G]=n.useState("customer"),[ee,M]=n.useState([]),[O,K]=n.useState(""),[Z,H]=n.useState([]),[A,U]=n.useState(!1),[Q,R]=n.useState(0),[B,m]=n.useState(!1);n.useEffect(()=>{C()},[L]),n.useEffect(()=>{O?P():(H([]),R(0))},[O,x.startDate,x.endDate]);const C=async()=>{const _=L==="customer"?"customers":"suppliers",{data:i}=await l.from(_).select("id, company_name, email, phone, address, city, npwp").order("company_name");i&&M(i.map(g=>({...g,name:g.company_name,type:L}))),K("")},P=async()=>{if(O){U(!0);try{const _=[];if(L==="customer"){const{data:g}=await l.from("sales_invoices").select("id, invoice_date, invoice_number, total_amount, payment_status").eq("customer_id",O).gte("invoice_date",x.startDate).lte("invoice_date",x.endDate).order("invoice_date");g&&g.forEach(u=>{_.push({id:u.id,entry_date:u.invoice_date,particulars:`Sales Invoice - ${u.payment_status||"Unpaid"}`,reference:u.invoice_number,debit:u.total_amount,credit:0,running_balance:0,type:"invoice"})});const{data:v}=await l.from("receipt_vouchers").select("id, voucher_date, voucher_number, amount, description").eq("customer_id",O).gte("voucher_date",x.startDate).lte("voucher_date",x.endDate).order("voucher_date");v&&v.forEach(u=>{_.push({id:u.id,entry_date:u.voucher_date,particulars:u.description||"Receipt",reference:u.voucher_number,debit:0,credit:u.amount,running_balance:0,type:"receipt"})});const{data:$}=await l.from("credit_notes").select("id, credit_note_date, credit_note_number, total_amount").eq("customer_id",O).gte("credit_note_date",x.startDate).lte("credit_note_date",x.endDate).eq("status","approved").order("credit_note_date");$&&$.forEach(u=>{_.push({id:u.id,entry_date:u.credit_note_date,particulars:"Credit Note",reference:u.credit_note_number,debit:0,credit:u.total_amount,running_balance:0,type:"receipt"})})}else{const{data:g}=await l.from("purchase_invoices").select("id, invoice_date, invoice_number, total_amount, payment_status").eq("supplier_id",O).gte("invoice_date",x.startDate).lte("invoice_date",x.endDate).order("invoice_date");g&&g.forEach($=>{_.push({id:$.id,entry_date:$.invoice_date,particulars:`Purchase Invoice - ${$.payment_status||"Unpaid"}`,reference:$.invoice_number,debit:0,credit:$.total_amount,running_balance:0,type:"invoice"})});const{data:v}=await l.from("payment_vouchers").select("id, voucher_date, voucher_number, amount, description").eq("supplier_id",O).gte("voucher_date",x.startDate).lte("voucher_date",x.endDate).order("voucher_date");v&&v.forEach($=>{_.push({id:$.id,entry_date:$.voucher_date,particulars:$.description||"Payment",reference:$.voucher_number,debit:$.amount,credit:0,running_balance:0,type:"payment"})})}_.sort((g,v)=>new Date(g.entry_date).getTime()-new Date(v.entry_date).getTime());let i=Q;_.forEach(g=>{i+=g.debit-g.credit,g.running_balance=i}),H(_)}catch(_){console.error("Error loading ledger:",_),alert("Failed to load ledger data. Please check console for details.")}finally{U(!1)}}},a=_=>_===0?"-":`Rp ${_.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,j=_=>{const i=Math.abs(_),g=_>=0?"Dr":"Cr";return`${a(i)} ${g}`},c=Z.reduce((_,i)=>_+i.debit,0),h=Z.reduce((_,i)=>_+i.credit,0),N=Q+c-h,o=Math.abs(N),Y=async()=>{if(W.current)try{const _=await ra(W.current,{scale:2,useCORS:!0,allowTaint:!0,logging:!1,backgroundColor:"#ffffff"}),i=_.toDataURL("image/png",1),g=new ia("p","mm","a4"),v=g.internal.pageSize.getWidth(),$=g.internal.pageSize.getHeight(),u=_.width,D=_.height,I=v/u,oe=D*I;if(oe>$){let r=0,te=oe;for(;te>0;)g.addImage(i,"PNG",0,r,v,oe),te-=$,r-=$,te>0&&g.addPage()}else g.addImage(i,"PNG",0,0,v,oe);const he=ee.find(r=>r.id===O);g.save(`${L}_Ledger_${he==null?void 0:he.name.replace(/\s+/g,"_")}_${new Date().toISOString().split("T")[0]}.pdf`)}catch(_){console.error("Error generating PDF:",_),alert("Failed to generate PDF. Please try again.")}},p=async()=>{const _=ee.find(i=>i.id===O);if(!_||!_.email){alert("No email address found for this party");return}confirm(`Send Statement of Account to ${_.email}?`)&&(m(!0),await Y(),alert(`PDF downloaded. Please attach and send to ${_.email}`),m(!1))},T=ee.find(_=>_.id===O);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[L==="customer"?e.jsx(ka,{className:"w-5 h-5 text-blue-600"}):e.jsx(Ve,{className:"w-5 h-5 text-purple-600"}),e.jsxs("h2",{className:"text-xl font-semibold text-gray-800",children:[L==="customer"?"Customer":"Supplier"," Ledger"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:P,disabled:!O||A,className:"flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(At,{className:`w-4 h-4 ${A?"animate-spin":""}`}),"Refresh"]}),e.jsxs("button",{onClick:Y,disabled:!O||Z.length===0,className:"flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Dt,{className:"w-4 h-4"}),"Export PDF"]}),e.jsxs("button",{onClick:p,disabled:!O||Z.length===0||B,className:"flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Fa,{className:"w-4 h-4"}),B?"Sending...":"Email SOA"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Party Type"}),e.jsxs("select",{value:L,onChange:_=>{G(_.target.value),K("")},className:"w-full px-3 py-2 border rounded-lg",children:[e.jsx("option",{value:"customer",children:"Customer (Debtor)"}),e.jsx("option",{value:"supplier",children:"Supplier (Creditor)"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Select ",L==="customer"?"Customer":"Supplier"]}),e.jsxs("select",{value:O,onChange:_=>K(_.target.value),className:"w-full px-3 py-2 border rounded-lg",children:[e.jsx("option",{value:"",children:"Select Party"}),ee.map(_=>e.jsx("option",{value:_.id,children:_.name},_.id))]})]}),e.jsx("div",{className:"col-span-2",children:e.jsx("p",{className:"text-xs text-gray-500 mt-6",children:"Period is controlled by global date range at top"})})]}),T&&Z.length>0&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 uppercase",children:"Opening Balance"}),e.jsx("p",{className:"text-lg font-bold text-gray-900",children:j(Q)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 uppercase",children:"Total Debit"}),e.jsx("p",{className:"text-lg font-bold text-red-600",children:a(c)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 uppercase",children:"Total Credit"}),e.jsx("p",{className:"text-lg font-bold text-green-600",children:a(h)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 uppercase",children:"Outstanding"}),e.jsx("p",{className:"text-lg font-bold text-orange-600",children:a(o)})]})]})]}),O&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Particulars"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Ref No"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Debit (Dr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Credit (Cr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Balance"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[e.jsxs("tr",{className:"bg-blue-50 font-semibold",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",colSpan:3,children:"Opening Balance"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:j(Q)})]}),A?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"Loading entries..."})}):Z.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"No transactions found for this period"})}):Z.map(_=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",children:new Date(_.entry_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-900",children:_.particulars}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-600 font-mono",children:_.reference}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-medium",children:_.debit>0?a(_.debit):"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-medium",children:_.credit>0?a(_.credit):"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-semibold",children:j(_.running_balance)})]},_.id)),Z.length>0&&e.jsxs("tr",{className:"bg-gray-100 font-semibold border-t-2 border-gray-300",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",colSpan:3,children:"Closing Balance"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-bold",children:a(c)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-bold",children:a(h)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:j(N)})]})]})]})})}),T&&Z.length>0&&e.jsx("div",{style:{position:"absolute",left:"-9999px",top:0},children:e.jsxs("div",{ref:W,style:{width:"210mm",padding:"20mm",backgroundColor:"#ffffff"},children:[e.jsx("div",{style:{marginBottom:"15px",borderWidth:"2px",borderColor:"#000",borderStyle:"solid",padding:"15px"},children:e.jsx("div",{style:{display:"flex",alignItems:"flex-start",justifyContent:"space-between"},children:e.jsxs("div",{style:{display:"flex",alignItems:"flex-start",gap:"15px"},children:[e.jsx("div",{style:{width:"60px",height:"60px",display:"flex",alignItems:"center",justifyContent:"center",backgroundColor:"#fff"},children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",xmlSpace:"preserve",width:"100%",height:"100%",viewBox:"0 0 15686.55 15480.24",children:e.jsxs("g",{children:[e.jsx("path",{fill:"#FDB763",d:"M69.94 10438.12l10353.39 0 0 -1798.67 1665.92 0 0 1868.6 0 320.44 0 4552.28c0,38.48 -31.45,69.94 -69.94,69.94l-11949.38 0c-38.48,0 -69.94,-31.45 -69.94,-69.94l0 -4872.72c0,-38.48 31.45,-69.94 69.94,-69.94zm1605.9 1710.15l8737.57 0c13.58,0 24.68,11.11 24.68,24.68l0 1719.84c0,13.58 -11.11,24.68 -24.68,24.68l-8737.57 0c-13.58,0 -24.68,-11.11 -24.68,-24.68l0 -1719.84c0,-13.58 11.11,-24.68 24.68,-24.68z"}),e.jsx("path",{fill:"#FDB763",d:"M15587.15 5136.67l-10353.49 0 0 1822.07 -1665.92 0 0 -1892.9 0 -324.61 0 -4611.43c0,-39 31.45,-70.87 69.94,-70.87l11949.47 0c38.48,0 69.94,31.87 69.94,70.87l0 4936.04c0,39 -31.45,70.83 -69.94,70.83zm-1605.9 -1732.36l-8737.67 0c-13.58,0 -24.68,-11.27 -24.68,-25l0 -1742.21c0,-13.74 11.11,-25 24.68,-25l8737.67 0c13.58,0 24.68,11.27 24.68,25l0 1742.21c0,13.74 -11.11,25 -24.68,25z"}),e.jsx("polygon",{fill:"#FD6D26",points:"-0,0 1651.16,0 1651.16,6929.27 15657.09,6929.27 15657.09,6958.74 15686.55,6958.74 15686.55,15480.24 14022.85,15480.24 14022.85,8639.45 1651.16,8639.45 -0,8639.45 -0,6929.27"})]})})}),e.jsxs("div",{children:[e.jsx("h1",{style:{fontSize:"16px",fontWeight:"bold",marginBottom:"5px"},children:"PT. SHUBHAM ANZEN PHARMA JAYA"}),e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:"Komplek Ruko Metro Sunter Blok A1 NO.15, Jl. Metro Indah Raya,"}),e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:"Kelurahan Papanggo, Kec. Tanjung Priok, Jakarta Utara - 14340"}),e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:"Telp: (+62 21) 65832426"}),e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:"NPWP: 03.174.071.8-093.000"})]})]})})}),e.jsxs("div",{style:{textAlign:"center",marginBottom:"20px"},children:[e.jsx("h2",{style:{fontSize:"18px",fontWeight:"bold",marginBottom:"5px"},children:"STATEMENT OF ACCOUNT"}),e.jsxs("p",{style:{fontSize:"12px",color:"#666"},children:["Period: ",new Date(x.startDate).toLocaleDateString("id-ID")," to ",new Date(x.endDate).toLocaleDateString("id-ID")]})]}),e.jsxs("div",{style:{marginBottom:"20px",padding:"12px",backgroundColor:"#f3f4f6",borderRadius:"8px"},children:[e.jsxs("p",{style:{fontSize:"13px",fontWeight:"bold",marginBottom:"5px"},children:[L==="customer"?"Customer:":"Supplier:"," ",T.name]}),T.address&&e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:T.address}),T.city&&e.jsx("p",{style:{fontSize:"11px",margin:"2px 0"},children:T.city}),T.phone&&e.jsxs("p",{style:{fontSize:"11px",margin:"2px 0"},children:["Phone: ",T.phone]}),T.npwp&&e.jsxs("p",{style:{fontSize:"11px",margin:"2px 0"},children:["NPWP: ",T.npwp]})]}),e.jsxs("div",{style:{marginBottom:"15px",display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:"10px"},children:[e.jsxs("div",{style:{padding:"10px",backgroundColor:"#eff6ff",borderRadius:"6px"},children:[e.jsx("p",{style:{fontSize:"10px",fontWeight:"600",color:"#666",marginBottom:"3px"},children:"OPENING BALANCE"}),e.jsx("p",{style:{fontSize:"13px",fontWeight:"bold"},children:j(Q)})]}),e.jsxs("div",{style:{padding:"10px",backgroundColor:"#fef2f2",borderRadius:"6px"},children:[e.jsx("p",{style:{fontSize:"10px",fontWeight:"600",color:"#666",marginBottom:"3px"},children:"TOTAL DEBIT"}),e.jsx("p",{style:{fontSize:"13px",fontWeight:"bold",color:"#dc2626"},children:a(c)})]}),e.jsxs("div",{style:{padding:"10px",backgroundColor:"#f0fdf4",borderRadius:"6px"},children:[e.jsx("p",{style:{fontSize:"10px",fontWeight:"600",color:"#666",marginBottom:"3px"},children:"TOTAL CREDIT"}),e.jsx("p",{style:{fontSize:"13px",fontWeight:"bold",color:"#16a34a"},children:a(h)})]}),e.jsxs("div",{style:{padding:"10px",backgroundColor:"#fff7ed",borderRadius:"6px"},children:[e.jsx("p",{style:{fontSize:"10px",fontWeight:"600",color:"#666",marginBottom:"3px"},children:"OUTSTANDING"}),e.jsx("p",{style:{fontSize:"13px",fontWeight:"bold",color:"#ea580c"},children:a(o)})]})]}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse",marginBottom:"20px"},children:[e.jsx("thead",{children:e.jsxs("tr",{style:{backgroundColor:"#f9fafb",borderBottom:"2px solid #000"},children:[e.jsx("th",{style:{padding:"8px",textAlign:"left",fontSize:"10px",fontWeight:"600",borderRight:"1px solid #e5e7eb"},children:"Date"}),e.jsx("th",{style:{padding:"8px",textAlign:"left",fontSize:"10px",fontWeight:"600",borderRight:"1px solid #e5e7eb"},children:"Particulars"}),e.jsx("th",{style:{padding:"8px",textAlign:"left",fontSize:"10px",fontWeight:"600",borderRight:"1px solid #e5e7eb"},children:"Ref No"}),e.jsx("th",{style:{padding:"8px",textAlign:"right",fontSize:"10px",fontWeight:"600",borderRight:"1px solid #e5e7eb"},children:"Debit (Dr)"}),e.jsx("th",{style:{padding:"8px",textAlign:"right",fontSize:"10px",fontWeight:"600",borderRight:"1px solid #e5e7eb"},children:"Credit (Cr)"}),e.jsx("th",{style:{padding:"8px",textAlign:"right",fontSize:"10px",fontWeight:"600"},children:"Balance"})]})}),e.jsxs("tbody",{children:[e.jsxs("tr",{style:{backgroundColor:"#eff6ff",borderBottom:"1px solid #e5e7eb"},children:[e.jsx("td",{colSpan:3,style:{padding:"6px 8px",fontSize:"11px",fontWeight:"600"},children:"Opening Balance"}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"11px"},children:"-"}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"11px"},children:"-"}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"11px",fontWeight:"bold"},children:j(Q)})]}),Z.map(_=>e.jsxs("tr",{style:{borderBottom:"1px solid #e5e7eb"},children:[e.jsx("td",{style:{padding:"6px 8px",fontSize:"10px"},children:new Date(_.entry_date).toLocaleDateString("id-ID")}),e.jsx("td",{style:{padding:"6px 8px",fontSize:"10px"},children:_.particulars}),e.jsx("td",{style:{padding:"6px 8px",fontSize:"10px",fontFamily:"monospace"},children:_.reference}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"10px",color:_.debit>0?"#dc2626":"#000"},children:_.debit>0?a(_.debit):"-"}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"10px",color:_.credit>0?"#16a34a":"#000"},children:_.credit>0?a(_.credit):"-"}),e.jsx("td",{style:{padding:"6px 8px",textAlign:"right",fontSize:"10px",fontWeight:"600"},children:j(_.running_balance)})]},_.id)),e.jsxs("tr",{style:{backgroundColor:"#f3f4f6",borderTop:"2px solid #000",borderBottom:"2px solid #000"},children:[e.jsx("td",{colSpan:3,style:{padding:"8px",fontSize:"11px",fontWeight:"bold"},children:"Closing Balance"}),e.jsx("td",{style:{padding:"8px",textAlign:"right",fontSize:"11px",fontWeight:"bold",color:"#dc2626"},children:a(c)}),e.jsx("td",{style:{padding:"8px",textAlign:"right",fontSize:"11px",fontWeight:"bold",color:"#16a34a"},children:a(h)}),e.jsx("td",{style:{padding:"8px",textAlign:"right",fontSize:"11px",fontWeight:"bold"},children:j(N)})]})]})]}),e.jsxs("div",{style:{marginTop:"30px",padding:"12px",backgroundColor:"#f9fafb",borderRadius:"8px"},children:[e.jsxs("p",{style:{fontSize:"11px",color:"#666",marginBottom:"8px"},children:[e.jsx("strong",{children:"Note:"})," This is a computer-generated statement of account."]}),e.jsx("p",{style:{fontSize:"11px",color:"#666"},children:"Please review the above transactions and confirm. If you have any questions or discrepancies, please contact us immediately."})]}),e.jsxs("div",{style:{marginTop:"20px",textAlign:"center",borderTop:"1px solid #e5e7eb",paddingTop:"10px"},children:[e.jsxs("p",{style:{fontSize:"10px",color:"#999"},children:["Generated on ",new Date().toLocaleString("id-ID")]}),e.jsx("p",{style:{fontSize:"10px",color:"#999"},children:"PT. SHUBHAM ANZEN PHARMA JAYA"})]})]})})]})]})}function Ja({selectedBank:x}){var he;const{dateRange:W}=xt(),[L,G]=n.useState([]),[ee,M]=n.useState(""),[O,K]=n.useState([]),[Z,H]=n.useState(!1),[A,U]=n.useState(null),[Q,R]=n.useState(!1),[B,m]=n.useState([]),[C,P]=n.useState(!1),[a,j]=n.useState(0),[c,h]=n.useState(!1),[N,o]=n.useState({balance:0,date:"2025-01-01"});n.useEffect(()=>{p()},[]),n.useEffect(()=>{x&&M(x)},[x]),n.useEffect(()=>{ee&&T()},[ee,W.startDate,W.endDate]),n.useEffect(()=>{Q&&A&&A.type==="expense"&&Y()},[Q,A]);const Y=async()=>{if(!(!A||A.type!=="expense")){P(!0);try{const{data:r}=await l.storage.from("expense-documents").list(`${A.id}/`);if(r&&r.length>0){const te=r.map(be=>{const{data:V}=l.storage.from("expense-documents").getPublicUrl(`${A.id}/${be.name}`);return V.publicUrl});m(te)}else m([])}catch(r){console.error("Error loading expense documents:",r),m([])}finally{P(!1)}}},p=async()=>{const{data:r}=await l.from("bank_accounts").select("*").order("bank_name");r&&G(r)},T=async()=>{if(ee){H(!0);try{const r=L.find(q=>q.id===ee),te=(r==null?void 0:r.opening_balance)||0,be=(r==null?void 0:r.opening_balance_date)||"2025-01-01";console.log(" Loading ledger for bank:",r==null?void 0:r.bank_name,r==null?void 0:r.account_number,"ID:",ee),console.log(" Opening Balance:",te,"as of",be),console.log(" Date Range:",W.startDate,"to",W.endDate);let V=te;if(W.startDate>be){console.log(" Calculating opening balance from",be,"to",W.startDate);const{data:q}=await l.rpc("calculate_balance_between_dates",{p_bank_account_id:ee,p_start_date:be,p_end_date:W.startDate});if(q&&q.length>0){const xe=q[0].net_change||0;V=te+xe,console.log(" Net change:",xe," Effective opening balance:",V)}}j(V);const S=[],d=new Date(W.endDate);d.setDate(d.getDate()+1);const k=d.toISOString().split("T")[0],{data:ne}=await l.from("bank_statement_lines").select("id, transaction_date, description, reference, debit_amount, credit_amount, matched_expense_id, matched_receipt_id, matched_entry_id, notes").eq("bank_account_id",ee).gte("transaction_date",W.startDate).lt("transaction_date",k).order("transaction_date");console.log(" Bank statement lines found:",(ne==null?void 0:ne.length)||0),ne&&ne.forEach(q=>{S.push({id:q.id,entry_date:q.transaction_date,particulars:q.description||"Bank Transaction",reference:q.reference||"-",debit:Number(q.debit_amount||0),credit:Number(q.credit_amount||0),type:"bank",linkedId:q.matched_expense_id||q.matched_receipt_id||q.matched_entry_id,notes:q.notes})}),S.sort((q,xe)=>{const F=new Date(q.entry_date).getTime()-new Date(xe.entry_date).getTime();if(F!==0)return F;const ie=q.credit>0,_e=xe.credit>0;return ie&&!_e?-1:!ie&&_e?1:0});let Se=V;const y=S.map(q=>{const xe=q.debit||0,F=q.credit||0;return Se+=F-xe,{id:q.id,entry_date:q.entry_date,particulars:q.particulars,reference:q.reference,debit:xe,credit:F,running_balance:Se}});K(y)}catch(r){console.error("Error loading ledger:",r)}finally{H(!1)}}},_=async()=>{if(ee)try{const{error:r}=await l.from("bank_accounts").update({opening_balance:N.balance,opening_balance_date:N.date}).eq("id",ee);if(r)throw r;h(!1),await p(),await T()}catch(r){alert("Failed to update opening balance: "+r.message)}},i=()=>{const r=L.find(te=>te.id===ee);r&&(o({balance:r.opening_balance,date:r.opening_balance_date||"2025-01-01"}),h(!0))},g=r=>({IDR:"Rp",USD:"$",EUR:""})[r]||r,v=(r,te)=>r===0?"-":`${g(te)} ${r.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,$=()=>{const r=L.find(k=>k.id===ee);if(!r)return;const te=["Date","Particulars","Reference","Debit (Dr)","Credit (Cr)","Balance"],be=O.map(k=>[new Date(k.entry_date).toLocaleDateString("id-ID"),k.particulars,k.reference,k.debit>0?v(k.debit,r.currency):"",k.credit>0?v(k.credit,r.currency):"",v(k.running_balance,r.currency)]),V=[`Bank Ledger - ${r.bank_name} (${r.account_number})`,`Period: ${new Date(W.startDate).toLocaleDateString("id-ID")} to ${new Date(W.endDate).toLocaleDateString("id-ID")}`,`Opening Balance: ${v(a,r.currency)}`,"",te.join(","),...be.map(k=>k.join(","))].join(`
`),S=new Blob([V],{type:"text/csv;charset=utf-8;"}),d=document.createElement("a");d.href=URL.createObjectURL(S),d.download=`bank_ledger_${r.bank_name}_${new Date().toISOString().split("T")[0]}.csv`,d.click()},u=L.find(r=>r.id===ee),D=O.reduce((r,te)=>r+te.debit,0),I=O.reduce((r,te)=>r+te.credit,0),oe=a+I-D;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oa,{className:"w-5 h-5 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Bank Ledger (Bank Book)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:T,disabled:!ee||Z,className:"flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(At,{className:`w-4 h-4 ${Z?"animate-spin":""}`}),"Refresh"]}),e.jsxs("button",{onClick:$,disabled:!ee||O.length===0,className:"flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(Dt,{className:"w-4 h-4"}),"Export"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:ee,onChange:r=>M(r.target.value),className:"w-full px-3 py-2 border rounded-lg max-w-md",children:[e.jsx("option",{value:"",children:"Select Bank Account"}),L.map(r=>e.jsxs("option",{value:r.id,children:[r.bank_name," - ",r.account_number," (",r.currency,")"]},r.id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Period is controlled by global date range at top"})]}),u&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:["Opening Balance (as of ",new Date(W.startDate).toLocaleDateString("id-ID"),")"]}),e.jsx("p",{className:"text-lg font-bold text-blue-600",children:v(a,u.currency)}),W.startDate>u.opening_balance_date&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Adjusted for filtered date range"})]}),e.jsx("button",{onClick:i,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Update"})]})})]}),ee&&e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Particulars"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Ref No"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Debit (Dr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Credit (Cr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Balance"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[e.jsxs("tr",{className:"bg-blue-50 font-semibold",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",children:new Date(W.startDate).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"px-3 py-2 text-sm text-gray-900",colSpan:2,children:["Opening Balance",W.startDate>((u==null?void 0:u.opening_balance_date)||"")&&e.jsx("span",{className:"ml-2 text-xs font-normal text-gray-600",children:"(adjusted for date filter)"})]}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:u&&v(a,u.currency)})]}),Z?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"Loading entries..."})}):O.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"No recorded transactions found for this period"})}):O.map(r=>e.jsxs("tr",{className:"hover:bg-blue-50 cursor-pointer transition-colors",onClick:()=>{U(r),R(!0)},children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",children:new Date(r.entry_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-900",children:r.particulars}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-600 font-mono",children:r.reference}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-medium",children:u&&(r.debit>0?v(r.debit,u.currency):"-")}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-medium",children:u&&(r.credit>0?v(r.credit,u.currency):"-")}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-semibold",children:u&&v(r.running_balance,u.currency)})]},r.id)),O.length>0&&e.jsxs("tr",{className:"bg-gray-100 font-semibold border-t-2 border-gray-300",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",colSpan:3,children:"Closing Balance"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-bold",children:u&&v(D,u.currency)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-bold",children:u&&v(I,u.currency)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:u&&v(oe,u.currency)})]})]})]})})}),Q&&A&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:()=>R(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto",onClick:r=>r.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Transaction Details"}),e.jsx("button",{onClick:()=>R(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx("span",{className:"text-2xl",children:""})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Date"}),e.jsx("p",{className:"font-medium",children:new Date(A.entry_date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Reference"}),e.jsx("p",{className:"font-medium font-mono",children:A.reference})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Particulars"}),e.jsx("p",{className:"font-medium",children:A.particulars})]}),A.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Description"}),e.jsx("p",{className:"font-medium",children:A.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Debit"}),e.jsx("p",{className:"font-medium text-red-600",children:u&&(A.debit>0?v(A.debit,u.currency):"-")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Credit"}),e.jsx("p",{className:"font-medium text-green-600",children:u&&(A.credit>0?v(A.credit,u.currency):"-")})]})]}),A.type==="expense"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Expense Category"}),e.jsx("p",{className:"font-medium capitalize",children:(he=A.expenseCategory)==null?void 0:he.replace("_"," ")})]}),C?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-gray-500",children:"Loading documents..."})}):B.length>0?e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Attached Documents (",B.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:B.map((r,te)=>e.jsxs("a",{href:r,target:"_blank",rel:"noopener noreferrer",className:"block p-2 border rounded hover:bg-gray-50 text-sm text-blue-600 hover:text-blue-800 truncate",children:["Document ",te+1]},te))})]}):e.jsx("div",{className:"text-center py-2",children:e.jsx("p",{className:"text-sm text-gray-400",children:"No documents attached"})})]}),A.type==="receipt"&&A.customerName&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Customer"}),e.jsx("p",{className:"font-medium",children:A.customerName})]}),A.type==="payment"&&A.supplierName&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Supplier"}),e.jsx("p",{className:"font-medium",children:A.supplierName})]}),A.type==="bank"&&A.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Notes"}),e.jsx("p",{className:"font-medium",children:A.notes})]}),A.type==="bank"&&A.linkedId&&e.jsx("div",{className:"bg-blue-50 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-blue-900 font-medium",children:"This transaction is matched to a system entry"})})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:()=>R(!1),className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"Close"})})]})}),e.jsx(qe,{isOpen:c,onClose:()=>h(!1),title:"Update Opening Balance",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance Amount *"}),e.jsx("input",{type:"number",value:N.balance,onChange:r=>o({...N,balance:parseFloat(r.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance Date *"}),e.jsx("input",{type:"date",value:N.date,onChange:r=>o({...N,date:r.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Set the date when this opening balance is effective. All transactions from this date onwards will be included in the ledger."})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>h(!1),className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:_,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Update"})]})]})})]})}function Gt({initialReport:x="trial_balance"}){const{dateRange:W}=xt(),{t:L}=Ut(),[G,ee]=n.useState(x),[M,O]=n.useState(!1),[K,Z]=n.useState([]);n.useEffect(()=>{H()},[G,W]),n.useEffect(()=>{ee(x)},[x]);const H=async()=>{O(!0);try{const{data:a,error:j}=await l.rpc("get_trial_balance",{p_start_date:W.startDate,p_end_date:W.endDate});if(!j&&a)Z(a);else{const{data:c,error:h}=await l.from("trial_balance_view").select("*").order("code");if(h)throw h;Z(c||[])}}catch(a){console.error("Error loading report:",a)}finally{O(!1)}},A=K.reduce((a,j)=>({debit:a.debit+j.total_debit,credit:a.credit+j.total_credit}),{debit:0,credit:0}),U=K.filter(a=>a.account_type==="revenue").reduce((a,j)=>a+Math.abs(j.balance),0),Q=K.filter(a=>a.account_type==="expense").reduce((a,j)=>a+Math.abs(j.balance),0),R=U-Q,B=K.filter(a=>a.account_type==="asset").reduce((a,j)=>a+j.balance,0),m=K.filter(a=>{var j;return a.account_type==="contra"&&((j=a.account_group)==null?void 0:j.includes("Assets"))}).reduce((a,j)=>a+Math.abs(j.balance),0),C=K.filter(a=>a.account_type==="liability").reduce((a,j)=>a+Math.abs(j.balance),0),P=K.filter(a=>a.account_type==="equity").reduce((a,j)=>a+Math.abs(j.balance),0);return e.jsx("div",{children:M?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs(e.Fragment,{children:[G==="trial_balance"&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-gray-50",children:[e.jsxs("h3",{className:"font-bold text-base",children:["Trial Balance as of ",new Date(W.endDate).toLocaleDateString("id-ID")]}),e.jsxs("p",{className:"text-xs text-gray-600 italic",children:["Neraca Saldo per ",new Date(W.endDate).toLocaleDateString("id-ID")]})]}),e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-[10px] font-medium text-gray-500 uppercase",children:L("code","Code")}),e.jsx("th",{className:"px-3 py-2 text-left text-[10px] font-medium text-gray-500 uppercase",children:L("account_name","Account Name")}),e.jsx("th",{className:"px-3 py-2 text-right text-[10px] font-medium text-gray-500 uppercase",children:L("debit","Debit")}),e.jsx("th",{className:"px-3 py-2 text-right text-[10px] font-medium text-gray-500 uppercase",children:L("credit","Credit")})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[K.map(a=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-1.5 font-mono text-xs",children:a.code}),e.jsxs("td",{className:"px-3 py-1.5 text-sm",children:[e.jsx("div",{children:a.name}),a.name_id&&e.jsx("div",{className:"text-xs text-gray-500",children:a.name_id})]}),e.jsx("td",{className:"px-3 py-1.5 text-right text-sm text-blue-600",children:a.balance>0?`Rp ${a.balance.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""}),e.jsx("td",{className:"px-3 py-1.5 text-right text-sm text-green-600",children:a.balance<0?`Rp ${Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:""})]},a.code)),K.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-3 py-6 text-center text-sm text-gray-500",children:L("no_data","No transactions found")})})]}),e.jsx("tfoot",{className:"bg-gray-100 font-bold",children:e.jsxs("tr",{children:[e.jsxs("td",{colSpan:2,className:"px-3 py-2 text-right text-sm",children:[L("total","Total"),":"]}),e.jsxs("td",{className:"px-3 py-2 text-right text-sm text-blue-700",children:["Rp ",A.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("td",{className:"px-3 py-2 text-right text-sm text-green-700",children:["Rp ",A.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})})]})]}),G==="pnl"&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-gray-50",children:[e.jsxs("h3",{className:"font-bold text-base",children:["Profit & Loss Statement for period ",new Date(W.startDate).toLocaleDateString("id-ID")," - ",new Date(W.endDate).toLocaleDateString("id-ID")]}),e.jsxs("p",{className:"text-xs text-gray-600 italic",children:["Laporan Laba Rugi periode ",new Date(W.startDate).toLocaleDateString("id-ID")," - ",new Date(W.endDate).toLocaleDateString("id-ID")]}),e.jsx("p",{className:"text-[10px] text-amber-600 mt-1 italic",children:L("pnl_note","Note: Costs may change as import expenses are updated")})]}),e.jsxs("div",{className:"p-3",children:[e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"font-semibold text-green-700 text-xs mb-1.5 border-b pb-1",children:[L("revenue","Revenue")," (Pendapatan)"]}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[K.filter(a=>a.account_type==="revenue").map(a=>e.jsxs("tr",{children:[e.jsx("td",{className:"py-0.5 font-mono text-[10px] text-gray-500",children:a.code}),e.jsx("td",{className:"py-0.5 text-xs",children:a.name}),e.jsxs("td",{className:"py-0.5 text-right text-xs text-green-600",children:["Rp ",Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},a.code)),e.jsxs("tr",{className:"font-semibold border-t",children:[e.jsx("td",{colSpan:2,className:"py-1.5 text-xs",children:L("total_revenue","Total Revenue")}),e.jsxs("td",{className:"py-1.5 text-right text-xs text-green-700",children:["Rp ",U.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("h4",{className:"font-semibold text-red-700 text-xs mb-1.5 border-b pb-1",children:[L("expenses","Expenses")," (Beban)"]}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[K.filter(a=>a.account_type==="expense").map(a=>e.jsxs("tr",{children:[e.jsx("td",{className:"py-0.5 font-mono text-[10px] text-gray-500",children:a.code}),e.jsx("td",{className:"py-0.5 text-xs",children:a.name}),e.jsxs("td",{className:"py-0.5 text-right text-xs text-red-600",children:["Rp ",Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},a.code)),e.jsxs("tr",{className:"font-semibold border-t",children:[e.jsx("td",{colSpan:2,className:"py-1.5 text-xs",children:L("total_expenses","Total Expenses")}),e.jsxs("td",{className:"py-1.5 text-right text-xs text-red-700",children:["Rp ",Q.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})})]}),e.jsx("div",{className:`p-2.5 rounded ${R>=0?"bg-green-50":"bg-red-50"}`,children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("span",{className:"font-bold text-sm",children:[L("net_income","Net Income")," ",e.jsxs("span",{className:"text-xs font-normal italic",children:["(",L("provisional","Provisional"),")"]})]}),e.jsxs("span",{className:`font-bold text-base ${R>=0?"text-green-700":"text-red-700"}`,children:["Rp ",R.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})})]})]}),G==="balance_sheet"&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsxs("div",{className:"px-4 py-3 border-b bg-gray-50",children:[e.jsxs("h3",{className:"font-bold text-base",children:["Balance Sheet as of ",new Date(W.endDate).toLocaleDateString("id-ID")]}),e.jsxs("p",{className:"text-xs text-gray-600 italic",children:["Neraca per ",new Date(W.endDate).toLocaleDateString("id-ID")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3 p-3",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-blue-700 text-xs mb-1.5 border-b pb-1",children:[L("assets","Assets")," (Aset)"]}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[K.filter(a=>a.account_type==="asset").map(a=>e.jsxs("tr",{children:[e.jsxs("td",{className:"py-0.5 text-xs",children:[e.jsx("span",{className:"font-mono text-[10px] text-gray-500 mr-1.5",children:a.code}),a.name]}),e.jsxs("td",{className:"py-0.5 text-right text-xs text-blue-600",children:["Rp ",a.balance.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},a.code)),K.filter(a=>{var j;return a.account_type==="contra"&&((j=a.account_group)==null?void 0:j.includes("Assets"))}).map(a=>e.jsxs("tr",{className:"text-gray-500",children:[e.jsxs("td",{className:"py-0.5 text-xs",children:[e.jsx("span",{className:"font-mono text-[10px] mr-1.5",children:a.code}),a.name]}),e.jsxs("td",{className:"py-0.5 text-right text-xs",children:["(",Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}),")"]})]},a.code)),e.jsxs("tr",{className:"font-semibold border-t-2",children:[e.jsx("td",{className:"py-1.5 text-xs",children:L("total_assets","Total Assets")}),e.jsxs("td",{className:"py-1.5 text-right text-xs text-blue-700",children:["Rp ",(B-m).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})})]}),e.jsxs("div",{children:[e.jsxs("h4",{className:"font-semibold text-red-700 text-xs mb-1.5 border-b pb-1",children:[L("liabilities","Liabilities")," (Kewajiban)"]}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[K.filter(a=>a.account_type==="liability").map(a=>e.jsxs("tr",{children:[e.jsxs("td",{className:"py-0.5 text-xs",children:[e.jsx("span",{className:"font-mono text-[10px] text-gray-500 mr-1.5",children:a.code}),a.name]}),e.jsxs("td",{className:"py-0.5 text-right text-xs text-red-600",children:["Rp ",Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},a.code)),e.jsxs("tr",{className:"font-semibold border-t",children:[e.jsx("td",{className:"py-1.5 text-xs",children:L("total_liabilities","Total Liabilities")}),e.jsxs("td",{className:"py-1.5 text-right text-xs text-red-700",children:["Rp ",C.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})}),e.jsxs("h4",{className:"font-semibold text-purple-700 text-xs mb-1.5 border-b pb-1 mt-4",children:[L("equity","Equity")," (Modal)"]}),e.jsx("table",{className:"w-full",children:e.jsxs("tbody",{children:[K.filter(a=>a.account_type==="equity").map(a=>e.jsxs("tr",{children:[e.jsxs("td",{className:"py-0.5 text-xs",children:[e.jsx("span",{className:"font-mono text-[10px] text-gray-500 mr-1.5",children:a.code}),a.name]}),e.jsxs("td",{className:"py-0.5 text-right text-xs text-purple-600",children:["Rp ",Math.abs(a.balance).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]},a.code)),e.jsxs("tr",{children:[e.jsx("td",{className:"py-0.5 text-xs",children:L("current_year_earnings","Current Year Earnings")}),e.jsxs("td",{className:`py-0.5 text-right text-xs ${R>=0?"text-green-600":"text-red-600"}`,children:["Rp ",R.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("tr",{className:"font-semibold border-t",children:[e.jsx("td",{className:"py-1.5 text-xs",children:L("total_equity","Total Equity")}),e.jsxs("td",{className:"py-1.5 text-right text-xs text-purple-700",children:["Rp ",(P+R).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})}),e.jsx("div",{className:"mt-3 p-2 bg-gray-100 rounded",children:e.jsxs("div",{className:"flex justify-between font-bold text-xs",children:[e.jsx("span",{children:L("total_liabilities_equity","Total Liabilities + Equity")}),e.jsxs("span",{children:["Rp ",(C+P+R).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})})]})]})]})]})})}function Qa({canManage:x}){var $;const{setCurrentPage:W}=Na(),[L,G]=n.useState("invoices"),[ee,M]=n.useState([]),[O,K]=n.useState([]),[Z,H]=n.useState([]),[A,U]=n.useState(!0),[Q,R]=n.useState(!1),[B,m]=n.useState(!1),[C,P]=n.useState(null),[a,j]=n.useState([]),[c,h]=n.useState({}),[N,o]=n.useState({payment_number:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""}),Y=n.useCallback(async()=>{try{const[u,D,I]=await Promise.all([l.from("sales_invoices").select("*, customers(company_name)").in("payment_status",["pending","partial"]).order("due_date",{ascending:!0}),l.from("receipt_vouchers").select(`
            *,
            customers(company_name),
            bank_accounts(account_name, alias)
          `).order("voucher_date",{ascending:!1}).limit(50),l.from("bank_accounts").select("id, account_name, bank_name, alias").eq("is_active",!0).order("account_name")]);if(u.error)throw console.error("Error loading invoices:",u.error),u.error;if(D.error)throw console.error("Error loading payments:",D.error),D.error;if(I.error)throw console.error("Error loading banks:",I.error),I.error;const oe=await Promise.all((u.data||[]).map(async r=>{try{const{data:te,error:be}=await l.from("voucher_allocations").select("allocated_amount").eq("sales_invoice_id",r.id).eq("voucher_type","receipt");be&&console.error("Error loading allocations for invoice:",r.id,be);const V=(te==null?void 0:te.reduce((S,d)=>S+(Number(d.allocated_amount)||0),0))||0;return{...r,paid_amount:V,customers:r.customers||null}}catch(te){return console.error("Error processing invoice:",r.id,te),{...r,paid_amount:0,customers:r.customers||null}}})),he=await Promise.all((D.data||[]).map(async r=>{try{const{data:te,error:be}=await l.from("voucher_allocations").select("allocated_amount, sales_invoices(invoice_number)").eq("receipt_voucher_id",r.id).eq("voucher_type","receipt");return be&&console.error("Error loading allocations for voucher:",r.id,be),{...r,allocations:te||[],customers:r.customers||null,bank_accounts:r.bank_accounts||null}}catch(te){return console.error("Error processing voucher:",r.id,te),{...r,allocations:[],customers:r.customers||null,bank_accounts:r.bank_accounts||null}}}));M(oe),K(he),H(I.data||[])}catch(u){console.error("Error loading data:",u)}finally{U(!1),R(!1)}},[]);n.useEffect(()=>{Y();const u=setInterval(Y,3e4);return()=>clearInterval(u)},[Y]);const p=()=>{R(!0),Y()},T=async u=>{P(u);const D=u.total_amount-(u.paid_amount||0);o({...N,payment_number:`PAY-${Date.now()}`,amount:D});try{const{data:I,error:oe}=await l.from("sales_invoices").select("*").eq("customer_id",u.customer_id).in("payment_status",["pending","partial"]).order("invoice_date",{ascending:!0});if(oe)throw console.error("Error loading customer invoices:",oe),oe;const he=await Promise.all((I||[]).map(async r=>{try{const{data:te,error:be}=await l.from("voucher_allocations").select("allocated_amount").eq("sales_invoice_id",r.id).eq("voucher_type","receipt");be&&console.error("Error loading allocations for invoice:",r.id,be);const V=(te==null?void 0:te.reduce((S,d)=>S+(Number(d.allocated_amount)||0),0))||0;return{...r,paid_amount:V,customers:r.customers||null}}catch(te){return console.error("Error processing invoice:",r.id,te),{...r,paid_amount:0,customers:r.customers||null}}}));j(he),h({[u.id]:D})}catch(I){console.error("Error loading customer invoices:",I)}m(!0)},_=async u=>{if(u.preventDefault(),!C)return;const D=Object.values(c).reduce((I,oe)=>I+oe,0);if(D>N.amount){alert("Total allocated amount cannot exceed payment amount");return}if(D===0){alert("Please allocate the payment to at least one invoice");return}try{const{data:{user:I}}=await l.auth.getUser();if(!I)throw new Error("Not authenticated");const{data:oe,error:he}=await l.rpc("generate_voucher_number",{p_prefix:"RV"});if(he)throw he;const{data:r,error:te}=await l.from("receipt_vouchers").insert([{voucher_number:oe,voucher_date:N.payment_date,customer_id:C.customer_id,payment_method:N.payment_method,bank_account_id:N.bank_account_id||null,reference_number:N.reference_number||null,amount:N.amount,description:N.notes||null,created_by:I.id}]).select().single();if(te)throw te;for(const[be,V]of Object.entries(c))V<=0||await l.from("voucher_allocations").insert({voucher_type:"receipt",receipt_voucher_id:r.id,sales_invoice_id:be,allocated_amount:V});m(!1),P(null),j([]),h({}),i(),Y(),alert(`Receipt voucher ${oe} created and allocated successfully!`)}catch(I){console.error("Error recording payment:",I),alert(`Failed to record payment: ${I.message}`)}},i=()=>{o({payment_number:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""})},g=[{key:"invoice_number",label:"Invoice #",render:(u,D)=>e.jsx("button",{onClick:()=>W("sales"),className:"text-blue-600 hover:underline font-medium",children:D.invoice_number})},{key:"customer",label:"Customer",render:(u,D)=>{var I;return((I=D.customers)==null?void 0:I.company_name)||"N/A"}},{key:"invoice_date",label:"Date",render:(u,D)=>ct(D.invoice_date)},{key:"due_date",label:"Due Date",render:(u,D)=>{const he=new Date(D.due_date)<new Date&&D.payment_status!=="paid";return e.jsx("span",{className:he?"text-red-600 font-semibold":"",children:ct(D.due_date)})}},{key:"total_amount",label:"Amount",render:(u,D)=>`Rp ${D.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`},{key:"paid",label:"Paid",render:(u,D)=>e.jsxs("span",{className:"text-green-600",children:["Rp ",(D.paid_amount||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"balance",label:"Balance",render:(u,D)=>e.jsxs("span",{className:"font-semibold text-red-600",children:["Rp ",(D.total_amount-(D.paid_amount||0)).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"status",label:"Status",render:(u,D)=>e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${D.payment_status==="partial"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:D.payment_status})}],v=[{key:"voucher_number",label:"Voucher #",render:(u,D)=>D.voucher_number},{key:"voucher_date",label:"Date",render:(u,D)=>ct(D.voucher_date)},{key:"customer",label:"Customer",render:(u,D)=>{var I;return((I=D.customers)==null?void 0:I.company_name)||"N/A"}},{key:"invoices",label:"Invoices",render:(u,D)=>!D.allocations||D.allocations.length===0?"Unallocated":D.allocations.map(I=>{var oe;return((oe=I.sales_invoices)==null?void 0:oe.invoice_number)||"N/A"}).join(", ")},{key:"amount",label:"Amount",render:(u,D)=>e.jsxs("span",{className:"font-semibold text-green-600",children:["Rp ",D.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"method",label:"Method",render:(u,D)=>e.jsx("span",{className:"capitalize",children:D.payment_method.replace("_"," ")})},{key:"bank",label:"Bank Account",render:(u,D)=>D.bank_accounts?D.bank_accounts.alias||D.bank_accounts.account_name:"Cash"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>G("invoices"),className:`px-4 py-2 rounded-lg font-medium transition ${L==="invoices"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["Outstanding Invoices (",ee.length,")"]}),e.jsx("button",{onClick:()=>G("payments"),className:`px-4 py-2 rounded-lg font-medium transition ${L==="payments"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Payment History"})]}),e.jsxs("button",{onClick:p,disabled:Q,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition",title:"Refresh data",children:[e.jsx(At,{className:`w-4 h-4 ${Q?"animate-spin":""}`}),e.jsx("span",{className:"text-sm",children:"Refresh"})]})]}),L==="invoices"&&ee.length>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-blue-100 rounded-full p-2",children:e.jsx(qt,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900",children:"Recording Customer Payments"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Click the green ",e.jsx("span",{className:"font-semibold",children:'"Record Payment"'}),' button next to any invoice to record payment received from customers. The invoice status will automatically change from "pending" to "paid" once full payment is allocated.']})]})]}),L==="invoices"?e.jsx(e.Fragment,{children:ee.length===0&&!A?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(qt,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-lg font-medium",children:"All Caught Up!"}),e.jsx("p",{className:"text-sm mt-2",children:"No outstanding invoices - all payments received!"})]}):e.jsx(Ft,{columns:g,data:ee,loading:A,actions:x?u=>e.jsxs("button",{onClick:()=>T(u),className:"flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition shadow-sm",children:[e.jsx("span",{className:"text-lg",children:"+"}),"Record Payment"]}):void 0})}):e.jsx(Ft,{columns:v,data:O,loading:A}),e.jsx(qe,{isOpen:B,onClose:()=>{m(!1),P(null),j([]),h({}),i()},title:"Record Customer Payment",size:"lg",children:e.jsxs("form",{onSubmit:_,className:"space-y-4",children:[C&&e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-lg mb-2",children:($=C.customers)==null?void 0:$.company_name}),e.jsx("div",{className:"text-gray-600",children:"Recording payment for customer invoices"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Number *"}),e.jsx("input",{type:"text",value:N.payment_number,onChange:u=>o({...N,payment_number:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Date *"}),e.jsx("input",{type:"date",value:N.payment_date,onChange:u=>o({...N,payment_date:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),e.jsx("input",{type:"number",value:N.amount===0?"":N.amount,onChange:u=>o({...N,amount:u.target.value===""?0:Number(u.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{value:N.payment_method,onChange:u=>o({...N,payment_method:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"other",children:"Other"})]})]}),N.payment_method!=="cash"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:N.bank_account_id,onChange:u=>o({...N,bank_account_id:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Bank Account"}),Z.map(u=>e.jsx("option",{value:u.id,children:u.alias||`${u.account_name} - ${u.bank_name}`},u.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),e.jsx("input",{type:"text",value:N.reference_number,onChange:u=>o({...N,reference_number:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"Bank reference or cheque number"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:N.notes,onChange:u=>o({...N,notes:u.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:2})]})]}),a.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3 max-h-96 overflow-y-auto",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Allocate Payment to Invoices"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Select invoices and enter amount to allocate to each"}),a.map(u=>{const D=u.total_amount-(u.paid_amount||0),I=c[u.id]!==void 0,oe=c[u.id]||0;return e.jsx("div",{className:"border rounded p-3 space-y-2",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("input",{type:"checkbox",checked:I,onChange:he=>{if(he.target.checked)h(r=>({...r,[u.id]:Math.min(D,N.amount-Object.values(c).reduce((te,be)=>te+be,0))}));else{const r={...c};delete r[u.id],h(r)}},className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm",children:u.invoice_number}),e.jsxs("div",{className:"text-xs text-gray-600",children:["Date: ",ct(u.invoice_date)]}),e.jsxs("div",{className:"text-xs mt-1",children:["Total: Rp ",u.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["Balance: Rp ",D.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),I&&e.jsx("div",{className:"ml-3 w-32",children:e.jsx("input",{type:"number",value:oe||"",onChange:he=>{const r=parseFloat(he.target.value)||0;if(r>D){alert("Cannot allocate more than balance");return}h(te=>({...te,[u.id]:r}))},className:"w-full px-2 py-1 border rounded text-sm",placeholder:"Amount",min:"0",max:D,step:"0.01"})})]})},u.id)}),e.jsxs("div",{className:"border-t pt-3 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Payment Amount:"}),e.jsxs("span",{className:"font-bold",children:["Rp ",N.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Allocated:"}),e.jsxs("span",{className:Object.values(c).reduce((u,D)=>u+D,0)>N.amount?"text-red-600 font-bold":"text-green-600",children:["Rp ",Object.values(c).reduce((u,D)=>u+D,0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Unallocated:"}),e.jsxs("span",{className:"text-gray-600",children:["Rp ",(N.amount-Object.values(c).reduce((u,D)=>u+D,0)).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{m(!1),P(null),j([]),h({}),i()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",disabled:Object.values(c).reduce((u,D)=>u+D,0)===0,children:"Record Payment"})]})]})})]})}function es({canManage:x}){const{profile:W}=Rt(),[L,G]=n.useState("bills"),[ee,M]=n.useState([]),[O,K]=n.useState([]),[Z,H]=n.useState([]),[A,U]=n.useState(!0),[Q,R]=n.useState(!1),[B,m]=n.useState(!1),[C,P]=n.useState(null),[a,j]=n.useState(null),[c,h]=n.useState({bill_number:"",vendor_name:"",vendor_id:"",bill_date:new Date().toISOString().split("T")[0],due_date:"",amount:0,tax_amount:0,category:"expense",description:""}),[N,o]=n.useState({bill_id:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""});n.useEffect(()=>{Y()},[]);const Y=async()=>{U(!0),await Promise.all([p(),T(),_()]),U(!1)},p=async()=>{try{const{data:y,error:q}=await l.from("vendor_bills").select("*").order("bill_date",{ascending:!1});if(q)throw q;M(y||[])}catch(y){console.error("Error loading bills:",y)}},T=async()=>{try{const{data:y,error:q}=await l.from("vendor_payments").select(`
          *,
          vendor_bills (
            bill_number,
            vendor_name
          ),
          bank_accounts (
            account_name,
            bank_name
          )
        `).order("payment_date",{ascending:!1});if(q)throw q;K(y||[])}catch(y){console.error("Error loading payments:",y)}},_=async()=>{try{const{data:y,error:q}=await l.from("bank_accounts").select("id, account_name, bank_name").eq("is_active",!0).order("account_name");if(q)throw q;H(y||[])}catch(y){console.error("Error loading bank accounts:",y)}},i=async()=>{const y="BILL",q=new Date().getFullYear(),{data:xe}=await l.from("vendor_bills").select("bill_number").like("bill_number",`${y}-${q}%`).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(xe!=null&&xe.bill_number){const F=parseInt(xe.bill_number.split("-")[2]);return`${y}-${q}-${String(F+1).padStart(5,"0")}`}return`${y}-${q}-00001`},g=async()=>{const y="VPAY",q=new Date().getFullYear(),{data:xe}=await l.from("vendor_payments").select("payment_number").like("payment_number",`${y}-${q}%`).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(xe!=null&&xe.payment_number){const F=parseInt(xe.payment_number.split("-")[2]);return`${y}-${q}-${String(F+1).padStart(5,"0")}`}return`${y}-${q}-00001`},v=async y=>{y.preventDefault();try{const{data:{user:q}}=await l.auth.getUser();if(!q)throw new Error("Not authenticated");const xe=c.amount+c.tax_amount;if(C){const{error:F}=await l.from("vendor_bills").update({vendor_name:c.vendor_name,vendor_id:c.vendor_id||null,bill_date:c.bill_date,due_date:c.due_date||null,amount:c.amount,tax_amount:c.tax_amount,total_amount:xe,category:c.category,description:c.description||null}).eq("id",C.id);if(F)throw F}else{const F=await i(),{error:ie}=await l.from("vendor_bills").insert([{bill_number:F,vendor_name:c.vendor_name,vendor_id:c.vendor_id||null,bill_date:c.bill_date,due_date:c.due_date||null,amount:c.amount,tax_amount:c.tax_amount,total_amount:xe,category:c.category,description:c.description||null,created_by:q.id}]);if(ie)throw ie}R(!1),he(),p()}catch(q){console.error("Error saving bill:",q),alert("Failed to save bill. Please try again.")}},$=async y=>{y.preventDefault();try{const{data:{user:q}}=await l.auth.getUser();if(!q)throw new Error("Not authenticated");if(a){const{error:xe}=await l.from("vendor_payments").update({payment_date:N.payment_date,amount:N.amount,payment_method:N.payment_method,bank_account_id:N.bank_account_id||null,reference_number:N.reference_number||null,notes:N.notes||null}).eq("id",a.id);if(xe)throw xe}else{const xe=await g(),{error:F}=await l.from("vendor_payments").insert([{payment_number:xe,bill_id:N.bill_id,payment_date:N.payment_date,amount:N.amount,payment_method:N.payment_method,bank_account_id:N.bank_account_id||null,reference_number:N.reference_number||null,notes:N.notes||null,created_by:q.id}]);if(F)throw F}m(!1),r(),T(),p()}catch(q){console.error("Error saving payment:",q),alert("Failed to save payment. Please try again.")}},u=y=>{P(y),h({bill_number:y.bill_number,vendor_name:y.vendor_name,vendor_id:y.vendor_id||"",bill_date:y.bill_date,due_date:y.due_date||"",amount:y.amount,tax_amount:y.tax_amount,category:y.category,description:y.description||""}),R(!0)},D=y=>{j(y),o({bill_id:y.bill_id,payment_date:y.payment_date,amount:y.amount,payment_method:y.payment_method,bank_account_id:y.bank_account_id||"",reference_number:y.reference_number||"",notes:y.notes||""}),m(!0)},I=async y=>{if(confirm("Are you sure you want to delete this bill?"))try{const{error:q}=await l.from("vendor_bills").delete().eq("id",y);if(q)throw q;p()}catch(q){console.error("Error deleting bill:",q),alert("Failed to delete bill. Please try again.")}},oe=async y=>{if(confirm("Are you sure you want to delete this payment?"))try{const{error:q}=await l.from("vendor_payments").delete().eq("id",y);if(q)throw q;T(),p()}catch(q){console.error("Error deleting payment:",q),alert("Failed to delete payment. Please try again.")}},he=()=>{P(null),h({bill_number:"",vendor_name:"",vendor_id:"",bill_date:new Date().toISOString().split("T")[0],due_date:"",amount:0,tax_amount:0,category:"expense",description:""})},r=()=>{j(null),o({bill_id:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""})},te=y=>{switch(y){case"paid":return"bg-green-100 text-green-800";case"partial":return"bg-yellow-100 text-yellow-800";case"pending":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},be=y=>y?{inventory:"Inventory",expense:"Expense",asset:"Asset",other:"Other"}[y]||y:"N/A",V=y=>({cash:"Cash",bank_transfer:"Bank Transfer",cheque:"Cheque",credit_card:"Credit Card",other:"Other"})[y]||y,S=ee.filter(y=>y.payment_status!=="paid").reduce((y,q)=>y+q.total_amount,0),d=ee.filter(y=>!y.due_date||y.payment_status==="paid"?!1:new Date(y.due_date)<new Date),k=[{key:"bill_number",label:"Bill Number",render:y=>e.jsx("span",{className:"font-medium text-gray-900",children:y.bill_number})},{key:"vendor_name",label:"Vendor",render:y=>y.vendor_name},{key:"bill_date",label:"Bill Date",render:y=>ct(y.bill_date)},{key:"due_date",label:"Due Date",render:y=>{if(!y.due_date)return"N/A";const xe=new Date(y.due_date)<new Date&&y.payment_status!=="paid";return e.jsxs("span",{className:xe?"text-red-600 font-medium":"",children:[ct(y.due_date),xe&&e.jsx($t,{className:"w-3 h-3 inline ml-1"})]})}},{key:"category",label:"Category",render:y=>be(y.category)},{key:"total_amount",label:"Total Amount",render:y=>e.jsxs("span",{className:"font-semibold text-red-600",children:["Rp ",y.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"payment_status",label:"Status",render:y=>e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${te(y.payment_status)}`,children:y.payment_status.toUpperCase()})}],ne=[{key:"payment_number",label:"Payment Number",render:y=>e.jsx("span",{className:"font-medium text-gray-900",children:y.payment_number})},{key:"bill",label:"Bill Number",render:y=>{var q;return((q=y.vendor_bills)==null?void 0:q.bill_number)||"N/A"}},{key:"vendor",label:"Vendor",render:y=>{var q;return((q=y.vendor_bills)==null?void 0:q.vendor_name)||"N/A"}},{key:"payment_date",label:"Payment Date",render:y=>ct(y.payment_date)},{key:"amount",label:"Amount",render:y=>e.jsxs("span",{className:"font-semibold text-green-600",children:["Rp ",y.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"payment_method",label:"Method",render:y=>V(y.payment_method)},{key:"bank_account",label:"Bank Account",render:y=>y.bank_accounts?`${y.bank_accounts.account_name} - ${y.bank_accounts.bank_name}`:"N/A"}],Se=ee.filter(y=>y.payment_status!=="paid");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{className:"bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow p-6 text-white",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-red-100",children:"Total Payable"}),e.jsxs("p",{className:"text-2xl font-bold mt-1",children:["Rp ",S.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsx(Ye,{className:"w-8 h-8 text-red-200"})]})}),e.jsx("div",{className:"bg-orange-50 rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-orange-600",children:"Overdue Bills"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600 mt-1",children:d.length})]}),e.jsx($t,{className:"w-8 h-8 text-orange-400"})]})}),e.jsx("div",{className:"bg-blue-50 rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-blue-600",children:"Total Bills"}),e.jsx("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:ee.length})]}),e.jsx(Ue,{className:"w-8 h-8 text-blue-400"})]})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>G("bills"),className:`px-4 py-2 rounded-lg transition ${L==="bills"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Ue,{className:"w-4 h-4 inline mr-2"}),"Bills"]}),e.jsxs("button",{onClick:()=>G("payments"),className:`px-4 py-2 rounded-lg transition ${L==="payments"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Ye,{className:"w-4 h-4 inline mr-2"}),"Payments"]})]}),x&&e.jsxs("div",{className:"flex gap-2",children:[L==="bills"&&e.jsxs("button",{onClick:()=>{he(),R(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition",children:[e.jsx(mt,{className:"w-5 h-5"}),"Add Bill"]}),L==="payments"&&e.jsxs("button",{onClick:()=>{r(),m(!0)},className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition",children:[e.jsx(mt,{className:"w-5 h-5"}),"Record Payment"]})]})]}),L==="bills"?e.jsx(Ft,{columns:k,data:ee,loading:A,actions:x?y=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(y),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:e.jsx(Nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>I(y.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx(pt,{className:"w-4 h-4"})})]}):void 0}):e.jsx(Ft,{columns:ne,data:O,loading:A,actions:x?y=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>D(y),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:e.jsx(Nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>oe(y.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx(pt,{className:"w-4 h-4"})})]}):void 0}),e.jsx(qe,{isOpen:Q,onClose:()=>{R(!1),he()},title:C?"Edit Vendor Bill":"Add Vendor Bill",children:e.jsxs("form",{onSubmit:v,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor Name *"}),e.jsx("input",{type:"text",value:c.vendor_name,onChange:y=>h({...c,vendor_name:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor ID (Optional)"}),e.jsx("input",{type:"text",value:c.vendor_id,onChange:y=>h({...c,vendor_id:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category *"}),e.jsxs("select",{value:c.category||"",onChange:y=>h({...c,category:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"expense",children:"Expense"}),e.jsx("option",{value:"inventory",children:"Inventory"}),e.jsx("option",{value:"asset",children:"Asset"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bill Date *"}),e.jsx("input",{type:"date",value:c.bill_date,onChange:y=>h({...c,bill_date:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Due Date"}),e.jsx("input",{type:"date",value:c.due_date,onChange:y=>h({...c,due_date:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),e.jsx("input",{type:"number",value:c.amount===0?"":c.amount,onChange:y=>h({...c,amount:y.target.value===""?0:Number(y.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tax Amount (Rp)"}),e.jsx("input",{type:"number",value:c.tax_amount===0?"":c.tax_amount,onChange:y=>h({...c,tax_amount:y.target.value===""?0:Number(y.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",min:"0",step:"0.01"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Total Amount"}),e.jsxs("div",{className:"text-2xl font-bold text-gray-900",children:["Rp ",(c.amount+c.tax_amount).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:c.description,onChange:y=>h({...c,description:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:3})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{R(!1),he()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:C?"Update Bill":"Add Bill"})]})]})}),e.jsx(qe,{isOpen:B,onClose:()=>{m(!1),r()},title:a?"Edit Payment":"Record Payment",children:e.jsxs("form",{onSubmit:$,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bill *"}),e.jsxs("select",{value:N.bill_id,onChange:y=>{const q=y.target.value,xe=Se.find(F=>F.id===q);o({...N,bill_id:q,amount:xe?xe.total_amount:0})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,disabled:!!a,children:[e.jsx("option",{value:"",children:"Select a bill"}),Se.map(y=>e.jsxs("option",{value:y.id,children:[y.bill_number," - ",y.vendor_name," (Rp ",y.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}),")"]},y.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Date *"}),e.jsx("input",{type:"date",value:N.payment_date,onChange:y=>o({...N,payment_date:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),e.jsx("input",{type:"number",value:N.amount===0?"":N.amount,onChange:y=>o({...N,amount:y.target.value===""?0:Number(y.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{value:N.payment_method,onChange:y=>o({...N,payment_method:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:N.bank_account_id,onChange:y=>o({...N,bank_account_id:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select bank account"}),Z.map(y=>e.jsxs("option",{value:y.id,children:[y.account_name," - ",y.bank_name]},y.id))]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),e.jsx("input",{type:"text",value:N.reference_number,onChange:y=>o({...N,reference_number:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"Transaction/Check number"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:N.notes,onChange:y=>o({...N,notes:y.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:3})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{m(!1),r()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition",children:a?"Update Payment":"Record Payment"})]})]})})]})}function ts(){const{t:x}=Ut(),[W,L]=n.useState([]),[G,ee]=n.useState(!0),[M,O]=n.useState(new Date().toISOString().split("T")[0]),[K,Z]=n.useState(new Set);n.useEffect(()=>{H()},[M]);const H=async()=>{try{ee(!0);const{data:P,error:a}=await l.from("sales_invoices").select("*, customers(company_name)").in("payment_status",["pending","partial"]).order("due_date");if(a)throw a;const j=await Promise.all((P||[]).map(async N=>{var g;const{data:o}=await l.rpc("get_invoice_paid_amount",{p_invoice_id:N.id}),Y=o||0,p=N.total_amount-Y,T=new Date(N.due_date),_=new Date(M),i=Math.floor((_.getTime()-T.getTime())/(1e3*60*60*24));return{id:N.id,customer_id:N.customer_id,customer_name:((g=N.customers)==null?void 0:g.company_name)||"Unknown",invoice_number:N.invoice_number,invoice_date:N.invoice_date,due_date:N.due_date,total_amount:N.total_amount,paid_amount:Y,balance:p,days_overdue:i}})),c=new Map;j.forEach(N=>{const o=N.customer_id;c.has(o)||c.set(o,{customer_id:o,customer_name:N.customer_name,total_outstanding:0,invoice_count:0,oldest_overdue_days:-999,invoices:[]});const Y=c.get(o);Y.total_outstanding+=N.balance,Y.invoice_count+=1,Y.oldest_overdue_days=Math.max(Y.oldest_overdue_days,N.days_overdue),Y.invoices.push(N)});const h=Array.from(c.values()).sort((N,o)=>N.oldest_overdue_days!==o.oldest_overdue_days?o.oldest_overdue_days-N.oldest_overdue_days:o.total_outstanding-N.total_outstanding);L(h)}catch(P){console.error("Error loading ageing data:",P),alert("Failed to load ageing report")}finally{ee(!1)}},A=P=>{const a=new Set(K);a.has(P)?a.delete(P):a.add(P),Z(a)},U=()=>{const P=[];P.push(["Customer","Total Outstanding","Invoices","Oldest Overdue (Days)","Status"]),W.forEach(N=>{P.push([N.customer_name,N.total_outstanding.toString(),N.invoice_count.toString(),N.oldest_overdue_days.toString(),N.oldest_overdue_days>90?"CRITICAL":N.oldest_overdue_days>0?"OVERDUE":"CURRENT"]),P.push(["","Invoice #","Invoice Date","Due Date","Amount","Paid","Balance","Days Overdue"]),N.invoices.forEach(o=>{P.push(["",o.invoice_number,o.invoice_date,o.due_date,o.total_amount.toString(),o.paid_amount.toString(),o.balance.toString(),o.days_overdue.toString()])}),P.push([""])});const a=P.map(N=>N.join(",")).join(`
`),j=new Blob([a],{type:"text/csv"}),c=URL.createObjectURL(j),h=document.createElement("a");h.href=c,h.download=`ageing_report_${M}.csv`,h.click(),URL.revokeObjectURL(c)},Q=P=>P<0?"text-green-600":P===0?"text-gray-600":P<=30?"text-yellow-600":P<=60?"text-orange-600":P<=90?"text-red-600":"text-red-900 font-bold",R=P=>P<0?{text:x("not_due","Not Due"),color:"bg-green-100 text-green-800"}:P===0?{text:x("due_today","Due Today"),color:"bg-gray-100 text-gray-800"}:P<=30?{text:`${P}d ${x("overdue","Overdue")}`,color:"bg-yellow-100 text-yellow-800"}:P<=60?{text:`${P}d ${x("overdue","Overdue")}`,color:"bg-orange-100 text-orange-800"}:P<=90?{text:`${P}d ${x("overdue","Overdue")}`,color:"bg-red-100 text-red-800"}:{text:`${P}d ${x("critical","CRITICAL")}`,color:"bg-red-200 text-red-900 font-bold"},B=W.reduce((P,a)=>P+a.total_outstanding,0),m=W.reduce((P,a)=>P+a.invoice_count,0),C=W.filter(P=>P.oldest_overdue_days>90).length;return e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between bg-white rounded-lg shadow-sm border border-gray-200 p-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"text-xs font-medium text-gray-700",children:[x("as_of_date","As of Date"),":"]}),e.jsx("input",{type:"date",value:M,onChange:P=>O(P.target.value),className:"border border-gray-300 rounded px-2 py-1 text-xs focus:ring-2 focus:ring-blue-500"})]}),e.jsxs("button",{onClick:U,disabled:W.length===0,className:"flex items-center gap-1.5 bg-green-600 text-white px-2.5 py-1.5 rounded text-xs hover:bg-green-700 transition disabled:opacity-50",children:[e.jsx($a,{className:"w-3.5 h-3.5"}),x("export_csv","Export CSV")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-blue-500",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:x("total_outstanding","Total Outstanding")}),e.jsxs("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:["Rp ",B.toLocaleString("id-ID",{minimumFractionDigits:2})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-gray-400",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:x("total_invoices","Total Invoices")}),e.jsx("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:m})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-orange-500",children:[e.jsx("p",{className:"text-[10px] text-gray-600",children:x("customers","Customers")}),e.jsx("p",{className:"text-base font-bold text-gray-900 mt-0.5",children:W.length})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-2.5 border-l-4 border-red-600",children:[e.jsxs("p",{className:"text-[10px] text-gray-600 flex items-center gap-1",children:[e.jsx(va,{className:"w-3 h-3 text-red-600"}),x("critical_90_days","Critical (90+ days)")]}),e.jsx("p",{className:"text-base font-bold text-red-900 mt-0.5",children:C})]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:G?e.jsxs("div",{className:"p-8 text-center",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"}),e.jsxs("p",{className:"mt-2 text-sm text-gray-500",children:[x("loading","Loading ageing data"),"..."]})]}):W.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx("p",{className:"text-sm font-medium",children:x("no_outstanding","No Outstanding Invoices")}),e.jsx("p",{className:"text-xs mt-1",children:x("all_paid","All invoices are fully paid!")})]}):e.jsx("div",{className:"divide-y divide-gray-200",children:W.map(P=>{const a=K.has(P.customer_id),j=R(P.oldest_overdue_days);return e.jsxs("div",{children:[e.jsxs("div",{onClick:()=>A(P.customer_id),className:"p-2.5 hover:bg-gray-50 cursor-pointer flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 flex items-center gap-3",children:[e.jsx("button",{className:"text-gray-400 hover:text-gray-600",children:a?e.jsx(Ra,{className:"w-4 h-4"}):e.jsx(Wt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-sm text-gray-900",children:P.customer_name}),e.jsxs("p",{className:"text-xs text-gray-500",children:[P.invoice_count," ",x("invoices","invoice(s)")]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"font-bold text-sm text-gray-900",children:["Rp ",P.total_outstanding.toLocaleString("id-ID",{minimumFractionDigits:2})]})}),e.jsx("div",{className:"w-28",children:e.jsx("span",{className:`inline-block px-2 py-0.5 rounded-full text-[10px] ${j.color}`,children:j.text})})]})]}),a&&e.jsx("div",{className:"bg-gray-50 px-3 pb-3",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{className:"border-b border-gray-300",children:e.jsxs("tr",{className:"text-[10px] text-gray-600",children:[e.jsx("th",{className:"text-left py-1.5 px-2",children:x("invoice_number","Invoice #")}),e.jsx("th",{className:"text-left py-1.5 px-2",children:x("invoice_date","Invoice Date")}),e.jsx("th",{className:"text-left py-1.5 px-2",children:x("due_date","Due Date")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:x("amount","Amount")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:x("paid","Paid")}),e.jsx("th",{className:"text-right py-1.5 px-2",children:x("balance","Balance")}),e.jsx("th",{className:"text-center py-1.5 px-2",children:x("days_overdue","Days Overdue")})]})}),e.jsx("tbody",{className:"divide-y divide-gray-200",children:P.invoices.map(c=>e.jsxs("tr",{className:"hover:bg-gray-100",children:[e.jsx("td",{className:"py-1.5 px-2 font-mono text-blue-600",children:c.invoice_number}),e.jsx("td",{className:"py-1.5 px-2",children:new Date(c.invoice_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"py-1.5 px-2",children:new Date(c.due_date).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"py-1.5 px-2 text-right",children:["Rp ",c.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-1.5 px-2 text-right text-green-600",children:["Rp ",c.paid_amount.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsxs("td",{className:"py-1.5 px-2 text-right font-medium",children:["Rp ",c.balance.toLocaleString("id-ID",{minimumFractionDigits:2})]}),e.jsx("td",{className:"py-1.5 px-2 text-center",children:e.jsx("span",{className:`font-medium ${Q(c.days_overdue)}`,children:c.days_overdue<0?`${x("due_in","Due in")} ${Math.abs(c.days_overdue)}d`:c.days_overdue===0?x("today","Today"):`${c.days_overdue}d`})})]},c.id))})]})})]},P.customer_id)})})})]})}function as({canManage:x}){var Zt,Jt,Qt,ea;const[W,L]=n.useState([]),[G,ee]=n.useState(""),[M,O]=n.useState(null),[K,Z]=n.useState([]),[H,A]=n.useState(!1),[U,Q]=n.useState(!1),[R,B]=n.useState("unmatched"),[m,C]=n.useState(null),{dateRange:P}=xt(),a={start:P.startDate,end:P.endDate},[j,c]=n.useState(null),[h,N]=n.useState(!1),[o,Y]=n.useState([]),[p,T]=n.useState(!1),_=n.useRef(null),[i,g]=n.useState(null),[v,$]=n.useState(null),[u,D]=n.useState(null),[I,oe]=n.useState(null),[he,r]=n.useState(!1),[te,be]=n.useState({debit:0,credit:0,description:""}),[V,S]=n.useState(null),[d,k]=n.useState(!1),[ne,Se]=n.useState([]),[y,q]=n.useState(""),[xe,F]=n.useState([]),[ie,_e]=n.useState({}),[w,le]=n.useState(!1),[je,ye]=n.useState([]),[De,Ie]=n.useState(!1),Fe=[{value:"duty_customs",label:"Duty & Customs (BM)",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"ppn_import",label:"PPN Import",type:"operations",requiresContainer:!1,group:"Operations"},{value:"pph_import",label:"PPh Import",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"freight_import",label:"Freight (Import)",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"clearing_forwarding",label:"Clearing & Forwarding",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"port_charges",label:"Port Charges",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"container_handling",label:"Container Handling",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"transport_import",label:"Transportation (Import)",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"loading_import",label:"Loading / Unloading (Import)",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"bpom_ski_fees",label:"BPOM / SKI Fees",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"other_import",label:"Other (Import)",type:"import",requiresContainer:!0,group:"Import Costs"},{value:"delivery_sales",label:"Delivery / Dispatch (Sales)",type:"sales",requiresContainer:!1,group:"Sales & Distribution"},{value:"loading_sales",label:"Loading / Unloading (Sales)",type:"sales",requiresContainer:!1,group:"Sales & Distribution"},{value:"other_sales",label:"Other (Sales)",type:"sales",requiresContainer:!1,group:"Sales & Distribution"},{value:"salary",label:"Salary",type:"staff",requiresContainer:!1,group:"Staff Costs"},{value:"staff_overtime",label:"Staff Overtime",type:"staff",requiresContainer:!1,group:"Staff Costs"},{value:"staff_welfare",label:"Staff Welfare / Allowances",type:"staff",requiresContainer:!1,group:"Staff Costs"},{value:"travel_conveyance",label:"Travel & Conveyance",type:"staff",requiresContainer:!1,group:"Staff Costs"},{value:"warehouse_rent",label:"Warehouse Rent",type:"operations",requiresContainer:!1,group:"Operations"},{value:"utilities",label:"Utilities",type:"operations",requiresContainer:!1,group:"Operations"},{value:"bank_charges",label:"Bank Charges",type:"operations",requiresContainer:!1,group:"Operations"},{value:"office_admin",label:"Office & Admin",type:"admin",requiresContainer:!1,group:"Administrative"},{value:"office_shifting_renovation",label:"Office Shifting & Renovation",type:"admin",requiresContainer:!1,group:"Administrative"},{value:"other",label:"Other",type:"admin",requiresContainer:!1,group:"Administrative"}];n.useEffect(()=>{ht(),gt(),st();const s=l.channel("bank-statement-recon-changes").on("postgres_changes",{event:"*",schema:"public",table:"bank_statement_lines"},()=>{G&&b()}).subscribe(),E=l.channel("expense-recon-changes").on("postgres_changes",{event:"*",schema:"public",table:"finance_expenses"},()=>{gt(),G&&b()}).subscribe();return()=>{s.unsubscribe(),E.unsubscribe()}},[]);const st=async()=>{const{data:s}=await l.from("customers").select("id, company_name").order("company_name");s&&Se(s)};n.useEffect(()=>{if(G){const s=W.find(E=>E.id===G);O(s||null),b()}},[G,W,P]);const ht=async()=>{try{const{data:s,error:E}=await l.from("bank_accounts").select("id, account_name, bank_name, account_number, currency, alias").eq("is_active",!0).order("account_name");if(E)throw E;if(L(s||[]),s&&s.length>0){const X=s.find(J=>J.bank_name==="BCA Bank"&&J.account_number==="0930 2010 22"&&J.currency==="IDR");ee((X==null?void 0:X.id)||s[0].id)}}catch(s){console.error("Error loading bank accounts:",s)}},gt=async()=>{try{const{data:s,error:E}=await l.from("finance_expenses").select(`
          id,
          expense_date,
          description,
          amount,
          expense_category,
          voucher_number
        `).order("expense_date",{ascending:!1});if(E)throw E;const{data:X}=await l.from("bank_statement_lines").select("matched_expense_id").not("matched_expense_id","is",null),J=new Set((X||[]).map(ce=>ce.matched_expense_id)),ge=(s||[]).filter(ce=>!J.has(ce.id));Y(ge)}catch(s){console.error("Error loading expenses:",s)}},b=async()=>{if(G){A(!0);try{const s=new Date(a.end);s.setDate(s.getDate()+1);const E=s.toISOString().split("T")[0],{data:X,error:J}=await l.from("bank_statement_lines").select("*").eq("bank_account_id",G).gte("transaction_date",a.start).lt("transaction_date",E).order("transaction_date",{ascending:!1});if(J)throw J;const ge=(X||[]).map(de=>de.matched_expense_id).filter(Boolean),ce=(X||[]).map(de=>de.matched_receipt_id).filter(Boolean),ve=(X||[]).map(de=>de.matched_fund_transfer_id).filter(Boolean),Ze=new Map;if(ge.length>0){const{data:de}=await l.from("finance_expenses").select("id, expense_category, amount, description, expense_date, voucher_number").in("id",ge);de==null||de.forEach($e=>Ze.set($e.id,$e))}const We=new Map;if(ce.length>0){const{data:de}=await l.from("receipt_vouchers").select("id, amount, voucher_date, voucher_number, customer_id, customers(company_name)").in("id",ce);de==null||de.forEach($e=>{var ot;We.set($e.id,{id:$e.id,amount:$e.amount,payment_date:$e.voucher_date,payment_number:$e.voucher_number,customer_name:(ot=$e.customers)==null?void 0:ot.company_name})})}const ze=new Map;if(ve.length>0){const{data:de}=await l.from("fund_transfers").select("id, transfer_number, amount, description, transfer_date, from_account_type, to_account_type").in("id",ve);de==null||de.forEach($e=>ze.set($e.id,$e))}const Ae=(X||[]).map(de=>({id:de.id,date:de.transaction_date,description:de.description||"",reference:de.reference||"",debit:de.debit_amount||0,credit:de.credit_amount||0,balance:de.running_balance||0,currency:de.currency||"IDR",status:de.reconciliation_status||"unmatched",matchedEntry:de.matched_entry_id,matchedExpenseId:de.matched_expense_id,matchedReceiptId:de.matched_receipt_id,matchedFundTransferId:de.matched_fund_transfer_id,matchedExpense:de.matched_expense_id?Ze.get(de.matched_expense_id):null,matchedReceipt:de.matched_receipt_id?We.get(de.matched_receipt_id):null,matchedFundTransfer:de.matched_fund_transfer_id?ze.get(de.matched_fund_transfer_id):null,notes:de.notes}));Z(Ae)}catch(s){console.error("Error loading statement lines:",s),Z([])}finally{A(!1)}}},se=s=>{if(!s)return 0;const E=s.replace(/[^\d,\.]/g,"");if(E.includes(",")&&E.includes(".")){const X=E.lastIndexOf(","),J=E.lastIndexOf(".");return X>J?parseFloat(E.replace(/\./g,"").replace(/,/g,"."))||0:parseFloat(E.replace(/,/g,""))||0}else return E.includes(",")?parseFloat(E.replace(/,/g,"."))||0:parseFloat(E.replace(/,/g,""))||0},t=(s,E=";")=>{const X=[];let J="",ge=!1;for(let ce=0;ce<s.length;ce++){const ve=s[ce];ve==='"'?ge=!ge:ve===E&&!ge?(X.push(J.trim()),J=""):J+=ve}return X.push(J.trim()),X},f=async s=>{try{const E=new FileReader;E.onload=async X=>{var J,ge;try{const ce=(J=X.target)==null?void 0:J.result,ve=ce.split(`
`).slice(0,5).join(`
`),Ze=(ve.match(/,/g)||[]).length,We=(ve.match(/;/g)||[]).length,ze=Ze>We?",":";";console.log(` Detected delimiter: "${ze}" (commas: ${Ze}, semicolons: ${We})`);const Ae=[];let de="",$e=!1;for(let ke=0;ke<ce.length;ke++){const Be=ce[ke];if(Be==='"')$e=!$e,de+=Be;else if(Be===`
`&&!$e){if(de.trim()){const Xe=t(de,ze);Ae.push(Xe)}de=""}else Be!=="\r"&&(de+=Be)}if(de.trim()){const ke=t(de,ze);Ae.push(ke)}console.log(" CSV rows parsed:",Ae.length),console.log(" First 10 rows:"),Ae.slice(0,10).forEach((ke,Be)=>{console.log(`Row ${Be}:`,ke)});const ot=new Date().getFullYear(),dt=prompt(`CSV contains dates without year (e.g., 01/12).
Which year is this statement for?`,String(ot));if(!dt){alert(" Year is required to process the CSV");return}const Ne=parseInt(dt);if(isNaN(Ne)||Ne<2e3||Ne>2100){alert(" Invalid year provided");return}const{lines:me,metadata:ue}=Ee(Ae,Ne);if(console.log(" Parsed lines:",me.length),console.log(" Metadata:",ue),me.length===0){alert(" No transactions found in the CSV file. Check browser console for details.");return}const{data:Pe,error:Re}=await l.from("bank_statement_uploads").insert({bank_account_id:G,statement_period:ue.period||`${new Date().toLocaleString("default",{month:"long"})} ${new Date().getFullYear()}`,statement_start_date:ue.startDate||a.start,statement_end_date:ue.endDate||a.end,currency:(M==null?void 0:M.currency)||"IDR",opening_balance:ue.openingBalance||0,closing_balance:ue.closingBalance||((ge=me[me.length-1])==null?void 0:ge.balance)||0,total_debits:ue.totalDebits||me.reduce((ke,Be)=>ke+Be.debit,0),total_credits:ue.totalCredits||me.reduce((ke,Be)=>ke+Be.credit,0),transaction_count:me.length,status:"completed"}).select().single();if(Re)throw Re;const{data:{user:Qe}}=await l.auth.getUser(),He=me.map(ke=>({upload_id:Pe.id,bank_account_id:G,transaction_date:ke.date,description:ke.description,reference:ke.reference,debit_amount:ke.debit,credit_amount:ke.credit,running_balance:ke.balance,statement_balance:ke.balance,currency:(M==null?void 0:M.currency)||"IDR",reconciliation_status:"unmatched",created_by:Qe==null?void 0:Qe.id})),{data:et}=await l.from("bank_statement_lines").select("transaction_date, description, debit_amount, credit_amount, running_balance").eq("bank_account_id",G),Je=He.filter(ke=>et==null?void 0:et.some(Be=>Be.transaction_date===ke.transaction_date&&Be.description===ke.description&&Be.debit_amount===ke.debit_amount&&Be.credit_amount===ke.credit_amount&&Be.running_balance===ke.running_balance));let Ce=He;if(Je.length>0){let ke=` Found ${Je.length} potential duplicate transaction(s):

`;Je.slice(0,5).forEach((Xe,rt)=>{const fa=new Date(Xe.transaction_date).toLocaleDateString("en-GB"),_a=Xe.debit_amount||Xe.credit_amount;ke+=`${rt+1}. ${fa} - ${Xe.description.substring(0,40)} - Rp ${_a.toLocaleString()}
`}),Je.length>5&&(ke+=`... and ${Je.length-5} more
`),ke+=`
Do you want to ADD them anyway?
(Click OK to add, Cancel to skip duplicates)`,confirm(ke)||(Ce=He.filter(Xe=>!(et!=null&&et.some(rt=>rt.transaction_date===Xe.transaction_date&&rt.description===Xe.description&&rt.debit_amount===Xe.debit_amount&&rt.credit_amount===Xe.credit_amount&&rt.running_balance===Xe.running_balance))))}if(Ce.length===0){alert(" No new transactions to import (all were duplicates and skipped)");return}const{data:Me,error:tt}=await l.from("bank_statement_lines").insert(Ce).select();if(tt)throw console.error("Insert error:",tt),tt;const Te=(Me==null?void 0:Me.length)||0,Ge=He.length-Ce.length;let nt=` CSV Import complete!
`;nt+=`   Total processed: ${He.length} transaction(s)
`,nt+=`   New transactions added: ${Te}
`,Ge>0&&(nt+=`   Duplicates skipped: ${Ge}`),alert(nt);try{await b()}catch(ke){console.error("Load statement lines error:",ke)}if(Te>0)try{await Oe()}catch(ke){console.error("Auto-match error:",ke)}}catch(ce){console.error("CSV parsing error:",ce),alert(` Error parsing CSV: ${ce.message}`)}},E.onerror=()=>{console.error("FileReader error"),alert(" Failed to read CSV file")},E.readAsText(s)}catch(E){console.error("CSV upload error:",E),alert(` Failed to read CSV: ${E.message}`)}},z=async s=>{var X;const E=(X=s.target.files)==null?void 0:X[0];if(!E){alert(" No file selected");return}if(!G){alert(" Please select a bank account first");return}if(!M){alert(" Bank account not loaded. Please refresh the page.");return}Q(!0);try{const J=E.type==="application/pdf"||E.name.toLowerCase().endsWith(".pdf"),ge=E.type.startsWith("image/")||E.name.match(/\.(png|jpg|jpeg)$/i),ce=E.name.toLowerCase().endsWith(".csv");J?await re(E):ge?await re(E,!0):ce?await f(E):await we(E)}catch(J){console.error("File upload error:",J)}finally{Q(!1),_.current&&(_.current.value="")}},re=async(s,E=!1,X=!1)=>{try{Q(!0),g(null);const J=new FormData;J.append("file",s),J.append("bankAccountId",G),E&&J.append("useOCR","true"),X&&J.append("previewOnly","true");const{data:{session:ge}}=await l.auth.getSession();if(!ge)throw new Error("Not authenticated");const ce=await fetch("https://dkrtsqienlhpouohmfki.supabase.co/functions/v1/parse-bca-statement",{method:"POST",headers:{Authorization:`Bearer ${ge.access_token}`},body:J}),ve=await ce.json();if(!ce.ok){if(ve.canUseOCR)g({message:ve.error,canUseOCR:!0,suggestions:ve.suggestions}),D(s);else throw new Error(ve.error||"Failed to parse PDF");return}if(ve.preview){$(ve);return}const Ze=ve.usedOCR?" (via OCR)":"";let We=` Import complete from ${ve.period}${Ze}
`;We+=`   Imported: ${ve.insertedCount||ve.transactionCount} transaction(s)`,ve.duplicateCount>0&&(We+=`
   Skipped (duplicates): ${ve.duplicateCount} transaction(s)`),alert(We),g(null),D(null);try{await b()}catch(Ae){console.error("Load statement lines error:",Ae)}if((ve.insertedCount||ve.transactionCount||0)>0)try{await Oe()}catch(Ae){console.error("Auto-match error:",Ae)}}catch(J){console.error("PDF upload error:",J),alert(` Failed to parse PDF: ${J.message}`)}finally{Q(!1)}},ae=async()=>{if(u){Q(!0),g(null);try{await re(u,!0,!0)}catch(s){alert(` OCR failed: ${s.message}`),Q(!1)}}},pe=async()=>{if(u){$(null),Q(!0);try{await re(u,!0,!1)}catch(s){alert(` Failed to save: ${s.message}`)}finally{Q(!1)}}},we=async s=>{try{const E=new FileReader;E.onload=async X=>{var J,ge;try{const ce=(J=X.target)==null?void 0:J.result,ve=Ia(ce,{type:"binary"}),Ze=ve.SheetNames[0],We=ve.Sheets[Ze],ze=Bt.sheet_to_json(We,{header:1});console.log(" Raw Excel data rows:",ze.length),console.log(" First 10 rows:"),ze.slice(0,10).forEach((Ce,Me)=>{console.log(`Row ${Me}:`,Ce)});const{lines:Ae,metadata:de}=Ee(ze);if(console.log(" Parsed lines:",Ae.length),console.log(" Metadata:",de),Ae.length>0&&console.log(" First 3 transactions:",Ae.slice(0,3)),Ae.length===0){alert(" No valid transactions found in the file. Check browser console (F12) for details.");return}const{data:$e,error:ot}=await l.from("bank_statement_uploads").insert({bank_account_id:G,statement_period:de.period||`${new Date().toLocaleString("default",{month:"long"})} ${new Date().getFullYear()}`,statement_start_date:de.startDate||a.start,statement_end_date:de.endDate||a.end,currency:(M==null?void 0:M.currency)||"IDR",opening_balance:de.openingBalance||0,closing_balance:de.closingBalance||((ge=Ae[Ae.length-1])==null?void 0:ge.balance)||0,total_debits:de.totalDebits||Ae.reduce((Ce,Me)=>Ce+Me.debit,0),total_credits:de.totalCredits||Ae.reduce((Ce,Me)=>Ce+Me.credit,0),transaction_count:Ae.length,status:"completed"}).select().single();if(ot)throw ot;const{data:{user:dt}}=await l.auth.getUser(),Ne=Ae.map(Ce=>({upload_id:$e.id,bank_account_id:G,transaction_date:Ce.date,description:Ce.description,reference:Ce.reference,debit_amount:Ce.debit,credit_amount:Ce.credit,running_balance:Ce.balance,statement_balance:Ce.balance,currency:(M==null?void 0:M.currency)||"IDR",reconciliation_status:"unmatched",created_by:dt==null?void 0:dt.id})),{data:me}=await l.from("bank_statement_lines").select("transaction_date, description, debit_amount, credit_amount, running_balance").eq("bank_account_id",G),ue=Ne.filter(Ce=>me==null?void 0:me.some(Me=>Me.transaction_date===Ce.transaction_date&&Me.description===Ce.description&&Me.debit_amount===Ce.debit_amount&&Me.credit_amount===Ce.credit_amount&&Me.running_balance===Ce.running_balance));let Pe=Ne;if(ue.length>0){let Ce=` Found ${ue.length} potential duplicate transaction(s):

`;ue.slice(0,5).forEach((tt,Te)=>{const Ge=new Date(tt.transaction_date).toLocaleDateString("en-GB"),nt=tt.debit_amount||tt.credit_amount;Ce+=`${Te+1}. ${Ge} - ${tt.description.substring(0,40)} - Rp ${nt.toLocaleString()}
`}),ue.length>5&&(Ce+=`... and ${ue.length-5} more
`),Ce+=`
Do you want to ADD them anyway?
(Click OK to add, Cancel to skip duplicates)`,confirm(Ce)||(Pe=Ne.filter(tt=>!(me!=null&&me.some(Te=>Te.transaction_date===tt.transaction_date&&Te.description===tt.description&&Te.debit_amount===tt.debit_amount&&Te.credit_amount===tt.credit_amount&&Te.running_balance===tt.running_balance))))}if(Pe.length===0){alert(" No new transactions to import (all were duplicates and skipped)");return}const{data:Re,error:Qe}=await l.from("bank_statement_lines").insert(Pe).select();if(Qe)throw console.error("Insert error:",Qe),Qe;const He=(Re==null?void 0:Re.length)||0,et=Ne.length-Pe.length;let Je=` Excel Import complete!
`;Je+=`   Total processed: ${Ne.length} transaction(s)
`,Je+=`   New transactions added: ${He}
`,et>0&&(Je+=`   Duplicates skipped: ${et}`),alert(Je);try{await b()}catch(Ce){console.error("Load statement lines error:",Ce)}if(He>0)try{await Oe()}catch(Ce){console.error("Auto-match error:",Ce)}}catch(ce){console.error("Error parsing file:",ce),alert(" Failed to parse file: "+ce.message)}},E.readAsBinaryString(s)}catch(E){console.error("Excel upload error:",E),alert(` Failed to process file: ${E.message}`)}},Ee=(s,E)=>{const X=[],J={period:"",startDate:"",endDate:"",openingBalance:0,closingBalance:0,totalDebits:0,totalCredits:0};let ge=E||new Date().getFullYear();new Date().getMonth()+1;for(let Ne=0;Ne<Math.min(10,s.length);Ne++){const me=s[Ne];if(!me||me.length===0)continue;const ue=String(me[0]||"");if(ue.includes("Periode")){const Pe=ue.match(/(\d{2})\/(\d{2})\/(\d{4})\s*-\s*(\d{2})\/(\d{2})\/(\d{4})/);if(Pe){const Re=parseInt(Pe[1]),Qe=parseInt(Pe[2]),He=parseInt(Pe[3]),et=parseInt(Pe[4]),Je=parseInt(Pe[5]),Ce=parseInt(Pe[6]);ge=He,J.startDate=`${He}-${String(Qe).padStart(2,"0")}-${String(Re).padStart(2,"0")}`,J.endDate=`${Ce}-${String(Je).padStart(2,"0")}-${String(et).padStart(2,"0")}`;const Me=["","JANUARI","FEBRUARI","MARET","APRIL","MEI","JUNI","JULI","AGUSTUS","SEPTEMBER","OKTOBER","NOVEMBER","DESEMBER"];J.period=`${Me[Qe]} ${He}`}}}let ce=-1;for(let Ne=0;Ne<Math.min(20,s.length);Ne++){const me=s[Ne];if(!me||me.length===0)continue;const ue=me.map(Pe=>String(Pe||"").toLowerCase()).join("|");if((ue.includes("tanggal")||ue.includes("date")||ue.includes("tgl"))&&(ue.includes("keterangan")||ue.includes("description")||ue.includes("desc")||ue.includes("mutasi")||ue.includes("amount")||ue.includes("saldo")||ue.includes("balance"))){ce=Ne,console.log(` Found header at row ${Ne}:`,me);break}}if(console.log(" Header row index:",ce),ce===-1)return console.error(" Could not find column headers"),console.log(" All rows checked:"),s.slice(0,20).forEach((Ne,me)=>{console.log(`  Row ${me}:`,Ne)}),{lines:X,metadata:J};const ve=s[ce];let Ze=-1,We=-1,ze=-1,Ae=-1,de=-1,$e=-1,ot=-1;if(ve.forEach((Ne,me)=>{const ue=String(Ne||"").toLowerCase();(ue.includes("tanggal")||ue.includes("date")||ue.includes("tgl"))&&(Ze=me),(ue.includes("keterangan")||ue.includes("description")||ue.includes("desc"))&&(We=me),(ue.includes("cabang")||ue.includes("branch"))&&(ze=me),ue.includes("mutasi")&&!ue.includes("debet")&&!ue.includes("kredit")&&(Ae=me),(ue.includes("debet")||ue.includes("debit")||ue.includes("db"))&&($e=me),(ue.includes("kredit")||ue.includes("credit")||ue.includes("cr"))&&(ot=me),(ue.includes("saldo")||ue.includes("balance"))&&(de=me)}),console.log(" Column positions:",{dateCol:Ze,descCol:We,branchCol:ze,amountCol:Ae,debitCol:$e,creditCol:ot,balanceCol:de}),console.log(" Header row cells:",ve.map((Ne,me)=>`[${me}]: "${Ne}"`)),Ze===-1)return console.error(" Missing date column"),console.log(" Header row:",ve),{lines:X,metadata:J};let dt=0;for(let Ne=ce+1;Ne<s.length;Ne++){const me=s[Ne];if(!me||me.length===0){dt++;continue}const ue=String(me[0]||""),Pe=String(me[1]||""),Re=`${ue} ${Pe}`.toUpperCase();if(Re.includes("SALDO AWAL")){dt++;continue}if(Re.includes("MUTASI DEBET")||Re.includes("MUTASI KREDIT")||Re.includes("SALDO AKHIR")){console.log(` Stopped at footer row ${Ne}: ${ue}`);break}const Qe=me[Ze];if(!Qe){dt++,Ne<ce+5&&console.log(` Row ${Ne}: No date value`);continue}let He="";if(typeof Qe=="number"){const Te=new Date(1900,0,1),Ge=Qe-2,nt=new Date(Te.getTime()+Ge*24*60*60*1e3);He=`${nt.getFullYear()}-${String(nt.getMonth()+1).padStart(2,"0")}-${String(nt.getDate()).padStart(2,"0")}`,Ne<ce+5&&console.log(` Row ${Ne}: Excel serial ${Qe}  ${He}`)}else{const Te=String(Qe).trim(),Ge=Te.match(/^(\d{1,2})\/(\d{1,2})$/),nt={jan:1,feb:2,mar:3,apr:4,may:5,mei:5,jun:6,jul:7,aug:8,agu:8,ags:8,sep:9,oct:10,okt:10,nov:11,dec:12,des:12},ke=Te.match(/^(\d{1,2})[-\s](jan|feb|mar|apr|may|mei|jun|jul|aug|agu|ags|sep|oct|okt|nov|dec|des)/i),Be=Te.match(/^(\d{1,2})[\/-](\d{1,2})[\/-](\d{2,4})$/);let Xe=0,rt=0;if(Be?(Xe=parseInt(Be[1]),rt=parseInt(Be[2])):Ge?(Xe=parseInt(Ge[1]),rt=parseInt(Ge[2])):ke&&(Xe=parseInt(ke[1]),rt=nt[ke[2].toLowerCase()]||0),Xe<1||Xe>31||rt<1||rt>12){dt++,Ne<ce+5&&console.log(` Row ${Ne}: Date doesn't match pattern: "${Te}"`);continue}He=`${ge}-${String(rt).padStart(2,"0")}-${String(Xe).padStart(2,"0")}`}let et=0,Je=0;if($e>=0&&ot>=0){const Te=String(me[$e]||"").trim(),Ge=String(me[ot]||"").trim();et=se(Te),Je=se(Ge)}else if(Ae>=0){const Te=String(me[Ae]||"").trim(),Ge=me[Ae+1]?String(me[Ae+1]).trim().toUpperCase():"",nt=Ge==="CR"||Te.includes(" CR"),ke=Ge==="DB"||Te.includes(" DB"),Be=se(Te);Ne<ce+3&&console.log(` Row ${Ne} amount parsing:`,{amountStr:Te,dbCrIndicator:Ge,isCR:nt,isDB:ke,amount:Be}),nt?Je=Be:(ke||Be>0)&&(et=Be)}let Ce=0;if(de>=0){const Te=String(me[de]||"").trim();Ce=se(Te)}let Me="";if(We>=0){const Te=String(me[We]||"").trim(),Ge=String(me[We+1]||"").trim();Me=Te+(Ge?"; "+Ge:"")}const tt=ze>=0?String(me[ze]||"").trim():"";Ne<ce+3&&console.log(` Row ${Ne} parsed:`,{date:He,debit:et,credit:Je,balance:Ce,description:Me.substring(0,50)}),X.push({id:`temp-${Ne}`,date:He,description:Me,reference:tt,debit:et,credit:Je,balance:Ce,currency:(M==null?void 0:M.currency)||"IDR",status:"unmatched"})}console.log(` Parsing complete: ${X.length} transactions, ${dt} rows skipped`);for(let Ne=0;Ne<s.length;Ne++){const me=s[Ne];if(!me||me.length===0)continue;const ue=String(me[0]||"");if(ue.includes("Saldo Awal")||ue.includes("SALDO AWAL"))for(let Pe=0;Pe<me.length;Pe++){const Re=String(me[Pe]||"");if(Re&&/[\d,\.]+/.test(Re)){J.openingBalance=se(Re);break}}if(ue.includes("Mutasi Debet")||ue.includes("MUTASI DB")||ue.includes("Mutasi DB"))for(let Pe=0;Pe<me.length;Pe++){const Re=String(me[Pe]||"");if(Re&&/[\d,\.]+/.test(Re)){J.totalDebits=se(Re);break}}if(ue.includes("Mutasi Kredit")||ue.includes("MUTASI CR")||ue.includes("Mutasi CR"))for(let Pe=0;Pe<me.length;Pe++){const Re=String(me[Pe]||"");if(Re&&/[\d,\.]+/.test(Re)){J.totalCredits=se(Re);break}}if(ue.includes("Saldo Akhir")||ue.includes("SALDO AKHIR"))for(let Pe=0;Pe<me.length;Pe++){const Re=String(me[Pe]||"");if(Re&&/[\d,\.]+/.test(Re)){J.closingBalance=se(Re);break}}}return{lines:X,metadata:J}},Oe=async()=>{if(G)try{const{data:s,error:E}=await l.rpc("auto_match_smart");if(E)throw E;const X=s==null?void 0:s[0],J=(X==null?void 0:X.matched_count)||0,ge=(X==null?void 0:X.suggested_count)||0,ce=(X==null?void 0:X.skipped_count)||0;await b();let ve=` Auto-match complete!

`;ve+=` Matched (85%+ confidence): ${J}
`,ve+=` Needs Review (70-84%): ${ge}
`,ce>0&&(ve+=` Skipped (already matched): ${ce}
`),ve+=`
 Date tolerance: 7 days maximum`,alert(ve)}catch(s){console.error("Error auto-matching:",s),alert(" Auto-match failed: "+s.message)}},Le=async()=>{if(G)try{const{data:s,error:E}=await l.rpc("preview_bank_statement_delete",{p_bank_account_id:G,p_start_date:a.start,p_end_date:a.end});if(E)throw E;S(s),k(!0)}catch(s){console.error("Error previewing delete:",s),alert(" Failed to preview: "+s.message)}},Ke=async()=>{if(!(!G||!V))try{const{data:s,error:E}=await l.rpc("safe_delete_bank_statement_lines",{p_bank_account_id:G,p_start_date:a.start,p_end_date:a.end});if(E)throw E;s.success?(alert(` Successfully deleted ${s.deleted_count} unmatched transaction(s)`),k(!1),S(null),await b()):alert(` ${s.error}`)}catch(s){console.error("Error clearing data:",s),alert(" Failed to clear data: "+s.message)}},St=async s=>{try{await l.from("bank_statement_lines").update({reconciliation_status:"matched"}).eq("id",s),Z(E=>E.map(X=>X.id===s?{...X,status:"matched"}:X))}catch(E){console.error("Error confirming match:",E)}},ut=async s=>{try{await l.from("bank_statement_lines").update({reconciliation_status:"unmatched",matched_entry_id:null}).eq("id",s),Z(E=>E.map(X=>X.id===s?{...X,status:"unmatched",matchedEntry:void 0,matched_entry_id:void 0}:X))}catch(E){console.error("Error rejecting match:",E)}},bt=s=>{c(s),N(!0)},da=async(s,E,X)=>{try{const{data:{user:J}}=await l.auth.getUser();if(!J)throw new Error("Not authenticated");const{data:ge,error:ce}=await l.from("finance_expenses").insert({expense_category:E,amount:s.debit,expense_date:s.date,description:X||s.description,created_by:J.id}).select().single();if(ce)throw ce;const{error:ve}=await l.from("bank_statement_lines").update({reconciliation_status:"recorded",matched_expense_id:ge.id,matched_at:new Date().toISOString(),matched_by:J.id}).eq("id",s.id).select().single();if(ve)throw ve;N(!1),c(null),await b(),alert(" Expense recorded and linked successfully")}catch(J){console.error("Error recording expense:",J),alert(" "+J.message)}},ma=async(s,E)=>{try{const{data:{user:X}}=await l.auth.getUser();if(!X)throw new Error("Not authenticated");const{error:J}=await l.from("bank_statement_lines").update({reconciliation_status:"matched",matched_expense_id:E,matched_at:new Date().toISOString(),matched_by:X.id}).eq("id",s.id).select().single();if(J)throw J;N(!1),c(null),T(!1),await b(),alert(" Linked to expense successfully")}catch(X){console.error("Error linking to expense:",X),alert(" "+X.message)}},ua=async s=>{le(!0);try{const{data:E}=await l.rpc("get_invoices_with_balance",{customer_uuid:s}),X=(E||[]).filter(J=>J.balance_amount>0);F(X)}catch(E){console.error("Error loading invoices:",E)}finally{le(!1)}},xa=async s=>{try{const{data:E}=await l.from("receipt_vouchers").select("id, voucher_number, voucher_date, amount, customers(company_name)").is("journal_entry_id",null).order("voucher_date",{ascending:!1}).limit(50),{data:X}=await l.from("receipt_vouchers").select("id, voucher_number, voucher_date, amount, customers(company_name)").order("voucher_date",{ascending:!1}).limit(100);ye(X||[])}catch(E){console.error("Error loading receipts:",E)}},pa=async(s,E,X,J)=>{try{const{data:{user:ge}}=await l.auth.getUser();if(!ge)throw new Error("Not authenticated");if(E==="customer_payment"){if(!X)throw new Error("Please select a customer");const{data:ce,error:ve}=await l.rpc("generate_voucher_number",{p_prefix:"RV"});if(ve)throw ve;const{data:Ze,error:We}=await l.from("receipt_vouchers").insert({voucher_number:ce,voucher_date:s.date,customer_id:X,payment_method:"bank_transfer",bank_account_id:G,reference_number:s.reference,amount:s.credit,description:J||s.description,created_by:ge.id}).select().single();if(We)throw We;for(const[de,$e]of Object.entries(ie))$e<=0||await l.from("voucher_allocations").insert({voucher_type:"receipt",receipt_voucher_id:Ze.id,sales_invoice_id:de,allocated_amount:$e});const{error:ze}=await l.from("bank_statement_lines").update({reconciliation_status:"recorded",matched_receipt_id:Ze.id,matched_at:new Date().toISOString(),matched_by:ge.id}).eq("id",s.id);if(ze)throw ze;const Ae=Object.values(ie).filter(de=>de>0).length;alert(`Receipt Voucher ${ce} created${Ae>0?` and allocated to ${Ae} invoice(s)`:""}`)}else{const{error:ce}=await l.from("bank_statement_lines").update({reconciliation_status:"recorded",notes:`${E}: ${J}`,matched_at:new Date().toISOString(),matched_by:ge.id}).eq("id",s.id);if(ce)throw ce;alert("Receipt recorded successfully")}N(!1),c(null),q(""),F([]),_e({}),Ie(!1),b()}catch(ge){console.error("Error recording receipt:",ge),alert("Error: "+ge.message)}},ha=async(s,E)=>{try{const{data:{user:X}}=await l.auth.getUser();if(!X)throw new Error("Not authenticated");const{error:J}=await l.from("bank_statement_lines").update({reconciliation_status:"recorded",matched_receipt_id:E,matched_at:new Date().toISOString(),matched_by:X.id}).eq("id",s.id);if(J)throw J;N(!1),c(null),Ie(!1),ye([]),b(),alert("Linked to existing receipt successfully")}catch(X){console.error("Error linking receipt:",X),alert("Error: "+X.message)}},Kt=K.filter(s=>R==="all"?!0:s.status===R),Ct=s=>{let E="asc";m&&m.key===s&&m.direction==="asc"&&(E="desc"),C({key:s,direction:E})},vt=[...Kt].sort((s,E)=>{if(!m)return 0;const{key:X,direction:J}=m;let ge=s[X],ce=E[X];return X==="date"&&(ge=new Date(ge).getTime(),ce=new Date(ce).getTime()),(X==="debit"||X==="credit")&&(ge=Number(ge)||0,ce=Number(ce)||0),typeof ge=="string"&&(ge=ge.toLowerCase(),ce=ce.toLowerCase()),ge<ce?J==="asc"?-1:1:ge>ce?J==="asc"?1:-1:0}),wt={total:K.length,matched:K.filter(s=>s.status==="matched"||s.status==="recorded").length,suggested:K.filter(s=>s.status==="suggested").length,unmatched:K.filter(s=>s.status==="unmatched").length},jt=s=>s==="USD"?"$":"Rp",ga=s=>{oe(s),be({debit:s.debit,credit:s.credit,description:s.description}),r(!0)},ba=async s=>{if(s.preventDefault(),!!I)try{const{error:E}=await l.from("bank_statement_lines").update({debit_amount:te.debit,credit_amount:te.credit,description:te.description}).eq("id",I.id);if(E)throw E;Z(X=>X.map(J=>J.id===I.id?{...J,debit:te.debit,credit:te.credit,description:te.description}:J)),r(!1),oe(null),alert(" Bank statement line updated successfully")}catch(E){console.error("Error updating line:",E),alert(" "+E.message)}},ya=async()=>{if(!(!I||!window.confirm(`Are you sure you want to unlink this transaction?

This will set its status back to "Unmatched" and remove the link to the expense/receipt.`)))try{const{error:E}=await l.from("bank_statement_lines").update({matched_expense_id:null,matched_receipt_id:null,matched_fund_transfer_id:null,matched_entry_id:null,reconciliation_status:"unmatched",matched_at:null,matched_by:null,notes:null}).eq("id",I.id);if(E)throw E;Z(X=>X.map(J=>J.id===I.id?{...J,status:"unmatched",matchedExpenseId:void 0,matchedReceiptId:void 0,matchedFundTransferId:void 0,matchedExpense:null,matchedReceipt:null,matchedFundTransfer:null,notes:void 0}:J)),r(!1),oe(null),alert(" Transaction unlinked successfully")}catch(E){console.error("Error unlinking transaction:",E),alert(" "+E.message)}};return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-gradient-to-r from-slate-700 to-slate-800 rounded-lg p-2.5 text-white shadow-md",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("h3",{className:"text-sm font-bold",children:"Bank Reconciliation"}),M&&e.jsx("span",{className:"text-slate-300 text-xs",children:M.alias?`${M.alias} (${M.account_number})`:`${M.bank_name} - ${M.account_number}`}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"bg-white/20 rounded px-2.5 py-1",children:[e.jsx("div",{className:"text-slate-200 text-[9px] leading-tight",children:"Matched"}),e.jsx("div",{className:"text-xs font-bold text-green-400",children:wt.matched})]}),e.jsxs("div",{className:"bg-white/20 rounded px-2.5 py-1",children:[e.jsx("div",{className:"text-slate-200 text-[9px] leading-tight",children:"Unmatched"}),e.jsx("div",{className:"text-xs font-bold text-red-400",children:wt.unmatched})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsxs("button",{onClick:()=>{Oe()},disabled:!G,className:"flex items-center gap-1.5 px-2.5 py-1.5 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 font-medium shadow-sm",title:"Auto-match",children:[e.jsx(At,{className:"w-3.5 h-3.5"}),"Match"]}),x&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:Le,disabled:!G,className:"p-1.5 bg-white/20 rounded hover:bg-white/30 disabled:opacity-50",title:"Clear",children:e.jsx(Tt,{className:"w-3.5 h-3.5"})}),e.jsx("input",{ref:_,type:"file",accept:".pdf,.xlsx,.xls,.csv,.png,.jpg,.jpeg",onChange:z,className:"hidden"}),e.jsxs("button",{onClick:()=>{var s;return(s=_.current)==null?void 0:s.click()},disabled:U||!G,className:"flex items-center gap-1.5 px-2.5 py-1.5 text-xs bg-white text-slate-700 rounded hover:bg-slate-50 disabled:opacity-50 font-medium shadow-sm",title:"Upload",children:[e.jsx(Pt,{className:"w-3.5 h-3.5"}),U?"Uploading":"Upload"]})]})]})]})}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-2",children:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsx("select",{value:G,onChange:s=>ee(s.target.value),className:"px-3 py-1.5 border border-gray-300 rounded-md text-xs font-medium",children:W.map(s=>e.jsx("option",{value:s.id,children:s.alias?`${s.alias} (${s.account_number})`:`${s.bank_name} - ${s.account_number} (${s.currency})`},s.id))}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500",children:[e.jsx(sa,{className:"w-3 h-3"}),e.jsxs("span",{children:[new Date(a.start).toLocaleDateString("en-GB"),"  ",new Date(a.end).toLocaleDateString("en-GB")]})]}),e.jsx("div",{className:"h-6 w-px bg-gray-300"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsxs("button",{onClick:()=>B("all"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${R==="all"?"bg-slate-700 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:["All (",wt.total,")"]}),e.jsxs("button",{onClick:()=>B("matched"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${R==="matched"?"bg-green-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[" Matched (",wt.matched,")"]}),e.jsxs("button",{onClick:()=>B("suggested"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${R==="suggested"?"bg-yellow-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[" Review (",wt.suggested,")"]}),e.jsxs("button",{onClick:()=>B("unmatched"),className:`px-3 py-1.5 rounded-md text-xs font-medium transition-all ${R==="unmatched"?"bg-red-600 text-white shadow-sm":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:[" Unmatched (",wt.unmatched,")"]})]})]})}),H?e.jsx("div",{className:"flex items-center justify-center py-12 bg-white rounded-lg",children:e.jsx(At,{className:"w-6 h-6 animate-spin text-blue-600"})}):Kt.length===0?e.jsxs("div",{className:"text-center py-12 bg-white rounded-lg border-2 border-dashed",children:[e.jsx(qa,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-1",children:"No Bank Transactions"}),e.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Upload a BCA PDF statement or Excel/CSV file to start reconciling"}),x&&e.jsxs("button",{onClick:()=>{var s;return(s=_.current)==null?void 0:s.click()},className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[e.jsx(Pt,{className:"w-4 h-4"}),"Upload Statement"]})]}):e.jsx("div",{className:"bg-white border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 border-b",children:e.jsxs("tr",{children:[e.jsx("th",{onClick:()=>Ct("date"),className:"px-3 py-2 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Date",(m==null?void 0:m.key)==="date"&&e.jsx("span",{className:"text-blue-600",children:m.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ct("description"),className:"px-3 py-2 text-left font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center gap-1",children:["Description",(m==null?void 0:m.key)==="description"&&e.jsx("span",{className:"text-blue-600",children:m.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ct("debit"),className:"px-3 py-2 text-right font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["Debit",(m==null?void 0:m.key)==="debit"&&e.jsx("span",{className:"text-blue-600",children:m.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ct("credit"),className:"px-3 py-2 text-right font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:["Credit",(m==null?void 0:m.key)==="credit"&&e.jsx("span",{className:"text-blue-600",children:m.direction==="asc"?"":""})]})}),e.jsx("th",{onClick:()=>Ct("status"),className:"px-3 py-2 text-center font-medium text-gray-600 cursor-pointer hover:bg-gray-100 select-none",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:["Status",(m==null?void 0:m.key)==="status"&&e.jsx("span",{className:"text-blue-600",children:m.direction==="asc"?"":""})]})}),e.jsx("th",{className:"px-3 py-2 text-center font-medium text-gray-600",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[vt.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 text-gray-700 whitespace-nowrap",children:new Date(s.date).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"px-3 py-2 text-gray-700 max-w-md",children:[e.jsx("div",{className:"whitespace-pre-wrap text-sm leading-tight",children:s.description}),s.reference&&e.jsx("div",{className:"text-xs text-gray-500 font-mono mt-1",children:s.reference})]}),e.jsx("td",{className:"px-3 py-2 text-right text-red-600 font-medium whitespace-nowrap",children:s.debit>0?`${jt(s.currency)} ${s.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-green-600 font-medium whitespace-nowrap",children:s.credit>0?`${jt(s.currency)} ${s.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`:"-"}),e.jsx("td",{className:"px-3 py-2",children:e.jsxs("div",{className:"flex flex-col gap-1",children:[(s.status==="matched"||s.status==="recorded")&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700",children:[e.jsx(Ot,{className:"w-3 h-3"})," Recorded"]}),s.matchedExpense&&e.jsxs("span",{className:"text-xs text-gray-600",children:[" Expense: ",s.matchedExpense.expense_category]}),s.matchedReceipt&&e.jsxs("span",{className:"text-xs text-gray-600",children:[" Receipt: ",s.matchedReceipt.customer_name||"Customer"]}),s.matchedFundTransfer&&e.jsxs("span",{className:"text-xs text-gray-600",children:[" Fund Transfer: ",s.matchedFundTransfer.from_account_type,"  ",s.matchedFundTransfer.to_account_type]}),!s.matchedExpense&&!s.matchedReceipt&&!s.matchedFundTransfer&&!s.matchedEntry&&e.jsx("span",{className:"text-xs text-orange-600 font-medium",children:" No link found"})]}),s.status==="suggested"&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-700",children:[e.jsx($t,{className:"w-3 h-3"})," Review"]}),s.status==="unmatched"&&e.jsxs("span",{className:"inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700",children:[e.jsx(Tt,{className:"w-3 h-3"})," Unrecorded"]})]})}),e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[s.status==="suggested"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>St(s.id),className:"p-1 text-green-600 hover:bg-green-50 rounded",title:"Confirm Match",children:e.jsx(Ot,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ut(s.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",title:"Reject Match",children:e.jsx(Tt,{className:"w-4 h-4"})})]}),s.status==="unmatched"&&x&&e.jsxs("button",{onClick:()=>bt(s),className:"inline-flex items-center gap-1 px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700",title:"Record transaction",children:[e.jsx(mt,{className:"w-3 h-3"}),"Record"]}),x&&e.jsx("button",{onClick:()=>ga(s),className:"p-1 text-gray-600 hover:bg-gray-100 rounded",title:"Edit debit/credit",children:e.jsx(Nt,{className:"w-4 h-4"})})]})})]},s.id)),e.jsxs("tr",{className:"bg-blue-50 border-t-2 border-blue-200 font-bold",children:[e.jsxs("td",{colSpan:2,className:"px-3 py-3 text-right text-gray-900",children:["TOTAL (",vt.length," transactions):"]}),e.jsxs("td",{className:"px-3 py-3 text-right text-red-700 font-bold whitespace-nowrap",children:[jt((M==null?void 0:M.currency)||"IDR")," ",vt.reduce((s,E)=>s+E.debit,0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("td",{className:"px-3 py-3 text-right text-green-700 font-bold whitespace-nowrap",children:[jt((M==null?void 0:M.currency)||"IDR")," ",vt.reduce((s,E)=>s+E.credit,0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("td",{colSpan:2,className:"px-3 py-3 text-center text-gray-600 text-sm",children:["Net: ",jt((M==null?void 0:M.currency)||"IDR")," ",(vt.reduce((s,E)=>s+E.credit,0)-vt.reduce((s,E)=>s+E.debit,0)).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]})}),e.jsx(qe,{isOpen:h,onClose:()=>{N(!1),c(null),T(!1)},title:"Record Transaction",children:j&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"font-medium",children:new Date(j.date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{className:"mt-2 text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Description:"}),e.jsx("p",{className:"font-medium mt-1",children:j.description})]}),j.debit>0&&e.jsxs("div",{className:"mt-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"text-lg font-bold text-red-600",children:[jt(j.currency)," ",j.debit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),j.credit>0&&e.jsxs("div",{className:"mt-2 flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"text-lg font-bold text-green-600",children:[jt(j.currency)," ",j.credit.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),j.debit>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{onClick:()=>T(!1),className:`flex-1 py-2 px-3 rounded-lg text-sm font-medium ${p?"bg-gray-100 text-gray-700":"bg-blue-600 text-white"}`,children:"Create New Expense"}),e.jsx("button",{onClick:()=>T(!0),className:`flex-1 py-2 px-3 rounded-lg text-sm font-medium ${p?"bg-blue-600 text-white":"bg-gray-100 text-gray-700"}`,children:"Link to Existing Expense"})]}),p?e.jsxs("form",{onSubmit:s=>{s.preventDefault();const X=new FormData(s.currentTarget).get("expense_id");if(!X){alert("Please select an expense");return}ma(j,X)},className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Select Expense *"}),e.jsxs("select",{name:"expense_id",required:!0,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 text-sm",disabled:o.length===0,children:[e.jsx("option",{value:"",children:o.length===0?"No expenses found":"Choose an expense..."}),o.map(s=>{const E=new Date(s.expense_date),X=String(E.getDate()).padStart(2,"0"),J=String(E.getMonth()+1).padStart(2,"0"),ge=String(E.getFullYear()).slice(-2),ce=`${X}/${J}/${ge}`;return e.jsxs("option",{value:s.id,children:[ce," - ",s.voucher_number?`[${s.voucher_number}] `:"",s.description," - Rp ",s.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]},s.id)})]}),e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Showing ",o.length," unlinked expense",o.length!==1?"s":"",". Match by voucher number or amount."]})]}),e.jsx("button",{type:"submit",className:"w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"Link to Expense"})]}):e.jsxs("form",{onSubmit:s=>{s.preventDefault();const E=new FormData(s.currentTarget),X=E.get("category"),J=E.get("description");da(j,X,J)},className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category *"}),e.jsxs("select",{name:"category",required:!0,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select category..."}),e.jsx("optgroup",{label:" IMPORT COSTS (Capitalized to Inventory) ",children:Fe.filter(s=>s.group==="Import Costs").map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("optgroup",{label:" SALES & DISTRIBUTION (P&L Expense) ",children:Fe.filter(s=>s.group==="Sales & Distribution").map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("optgroup",{label:" STAFF COSTS (P&L Expense) ",children:Fe.filter(s=>s.group==="Staff Costs").map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("optgroup",{label:" OPERATIONS (P&L Expense) ",children:Fe.filter(s=>s.group==="Operations").map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("optgroup",{label:" ADMINISTRATIVE (P&L Expense) ",children:Fe.filter(s=>s.group==="Administrative").map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("input",{type:"text",name:"description",defaultValue:j.description,className:"w-full px-3 py-2 border rounded-lg",placeholder:"Optional: Override description"})]}),e.jsx("button",{type:"submit",className:"w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Create & Link Expense"})]})]}),j.credit>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"font-medium",children:"Record as Receipt"}),e.jsx("button",{type:"button",onClick:()=>{Ie(!De),De||xa()},className:"text-xs text-blue-600 hover:underline",children:De?"Create New Receipt":"Link Existing Receipt"})]}),De?e.jsxs("div",{className:"space-y-3",children:[e.jsx("p",{className:"text-xs text-gray-500",children:"Select an existing receipt voucher to link to this bank statement line."}),e.jsx("div",{className:"max-h-48 overflow-y-auto border rounded-lg divide-y",children:je.length===0?e.jsx("div",{className:"p-3 text-center text-gray-500 text-sm",children:"No receipt vouchers found"}):je.map(s=>{var E,X;return e.jsxs("button",{onClick:()=>ha(j,s.id),className:"w-full p-2 text-left hover:bg-blue-50 text-sm flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-mono font-medium",children:s.voucher_number}),e.jsx("span",{className:"text-gray-500 ml-2",children:(E=s.customers)==null?void 0:E.company_name}),e.jsx("div",{className:"text-xs text-gray-400",children:new Date(s.voucher_date).toLocaleDateString("id-ID")})]}),e.jsxs("span",{className:"font-medium text-green-600",children:["Rp ",(X=s.amount)==null?void 0:X.toLocaleString("id-ID",{minimumFractionDigits:2})]})]},s.id)})})]}):e.jsxs("form",{onSubmit:s=>{s.preventDefault();const E=new FormData(s.currentTarget),X=E.get("type"),J=E.get("description");pa(j,X,y,J)},className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Type *"}),e.jsxs("select",{name:"type",required:!0,className:"w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500",onChange:s=>{s.target.value!=="customer_payment"&&(q(""),F([]),_e({}))},children:[e.jsx("option",{value:"",children:"Select type..."}),e.jsx("option",{value:"customer_payment",children:"Customer Payment"}),e.jsx("option",{value:"capital",children:"Capital Injection"}),e.jsx("option",{value:"other_income",children:"Other Income"}),e.jsx("option",{value:"loan",children:"Loan/Financing"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Customer *"}),e.jsx(Vt,{value:y,onChange:s=>{q(s),_e({}),s?ua(s):F([])},options:ne.map(s=>({value:s.id,label:s.company_name})),placeholder:"Select customer..."})]}),y&&xe.length>0&&e.jsxs("div",{className:"border rounded-lg p-2",children:[e.jsx("p",{className:"text-xs font-medium text-gray-600 mb-2",children:"Allocate to Invoices (optional)"}),e.jsx("div",{className:"max-h-40 overflow-y-auto space-y-1",children:xe.map(s=>{var X;const E=ie[s.id]!==void 0;return e.jsxs("div",{className:"flex items-center gap-2 text-xs p-1 hover:bg-gray-50 rounded",children:[e.jsx("input",{type:"checkbox",checked:E,onChange:J=>{if(J.target.checked){const ge=j.credit-Object.values(ie).reduce((ce,ve)=>ce+ve,0);_e(ce=>({...ce,[s.id]:Math.min(s.balance_amount,ge)}))}else{const ge={...ie};delete ge[s.id],_e(ge)}}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"font-mono",children:s.invoice_number}),e.jsxs("span",{className:"text-red-500 ml-1",children:["Bal: Rp ",(X=s.balance_amount)==null?void 0:X.toLocaleString("id-ID")]})]}),E&&e.jsx("input",{type:"number",value:ie[s.id]||"",onChange:J=>{const ge=parseFloat(J.target.value)||0;_e(ce=>({...ce,[s.id]:Math.min(ge,s.balance_amount)}))},className:"w-24 px-1 py-0.5 border rounded text-right text-xs",min:0,max:s.balance_amount})]},s.id)})}),e.jsxs("div",{className:"mt-2 pt-2 border-t text-xs flex justify-between",children:[e.jsx("span",{children:"Allocated:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["Rp ",Object.values(ie).reduce((s,E)=>s+E,0).toLocaleString("id-ID",{minimumFractionDigits:2})]})]})]}),y&&w&&e.jsx("div",{className:"text-xs text-gray-500 text-center py-2",children:"Loading invoices..."}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("input",{type:"text",name:"description",defaultValue:j.description,className:"w-full px-3 py-2 border rounded-lg",placeholder:"Optional: Override description"})]}),e.jsx("button",{type:"submit",className:"w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"Record Receipt"})]})]})]})}),i&&e.jsx(qe,{isOpen:!0,onClose:()=>{g(null),D(null)},title:"PDF Extraction Failed",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-yellow-800 text-sm font-medium mb-2",children:i.message}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-yellow-700 font-medium",children:"Recommended options:"}),e.jsx("ul",{className:"list-disc list-inside space-y-1 text-sm text-yellow-700",children:i.suggestions.map((s,E)=>e.jsx("li",{children:s},E))})]})]}),i.canUseOCR&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-blue-800 text-sm font-medium mb-2",children:"Advanced Option: OCR Processing"}),e.jsx("p",{className:"text-blue-700 text-xs mb-3",children:"Optical Character Recognition (OCR) can extract text from image-based or encrypted PDFs. This process takes 30-60 seconds and requires Google Vision API configuration. You'll be able to preview the results before saving."}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:ae,disabled:U,className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 text-sm font-medium",children:U?"Processing with OCR...":"Run OCR Anyway"}),e.jsx("button",{onClick:()=>{g(null),D(null)},className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 text-sm font-medium",children:"Cancel"})]})]})]})}),v&&e.jsx(qe,{isOpen:!0,onClose:()=>$(null),title:"OCR Preview - Confirm Before Saving",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("p",{className:"text-green-800 text-sm font-medium mb-2",children:[" OCR extracted ",v.transactionCount," transactions"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Period:"}),e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:v.period})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Opening Balance:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[M==null?void 0:M.currency," ",v.openingBalance.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Closing Balance:"}),e.jsxs("span",{className:"ml-2 font-medium text-gray-900",children:[M==null?void 0:M.currency," ",v.closingBalance.toLocaleString()]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Transactions:"}),e.jsx("span",{className:"ml-2 font-medium text-gray-900",children:v.transactionCount})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-2",children:"Sample Transactions (First 10):"}),e.jsx("div",{className:"border rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-2 py-1 text-left",children:"Date"}),e.jsx("th",{className:"px-2 py-1 text-left",children:"Description"}),e.jsx("th",{className:"px-2 py-1 text-right",children:"Amount"})]})}),e.jsx("tbody",{children:v.transactions.map((s,E)=>e.jsxs("tr",{className:"border-t",children:[e.jsx("td",{className:"px-2 py-1",children:s.date}),e.jsx("td",{className:"px-2 py-1 truncate max-w-xs",children:s.description}),e.jsxs("td",{className:"px-2 py-1 text-right",children:[M==null?void 0:M.currency," ",(s.debitAmount||s.creditAmount).toLocaleString()]})]},E))})]})})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsx("p",{className:"text-yellow-800 text-xs",children:" Please verify the extracted data looks correct before confirming. OCR may have minor errors in dates, amounts, or descriptions."})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:pe,disabled:U,className:"flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50 font-medium",children:U?"Saving...":"Confirm & Save"}),e.jsx("button",{onClick:()=>$(null),className:"px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 font-medium",children:"Cancel"})]})]})}),e.jsx(qe,{isOpen:d,onClose:()=>{k(!1),S(null)},title:"Confirm Clear Data",children:V&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-yellow-900 mb-2",children:"Warning: Data Deletion"}),e.jsx("p",{className:"text-sm text-yellow-800",children:"You are about to clear bank statement data. This action cannot be undone."})]}),e.jsxs("div",{className:"bg-gray-50 border rounded-lg p-4 space-y-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Bank Account"}),e.jsxs("div",{className:"font-medium text-gray-900",children:[(Zt=V.bank_info)==null?void 0:Zt.bank_name," - ",(Jt=V.bank_info)==null?void 0:Jt.account_number,e.jsx("span",{className:"ml-2 px-2 py-0.5 bg-blue-100 text-blue-700 rounded text-xs",children:(Qt=V.bank_info)==null?void 0:Qt.currency})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Date Range"}),e.jsxs("div",{className:"text-sm font-medium text-gray-900",children:[new Date(V.start_date).toLocaleDateString("id-ID")," -"," ",new Date(V.end_date).toLocaleDateString("id-ID")]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Total Transactions"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:V.total_count})]})]}),e.jsxs("div",{className:"border-t pt-3 grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-red-600 font-medium mb-1",children:"Reconciled (Protected)"}),e.jsx("div",{className:"text-lg font-bold text-red-600",children:V.reconciled_count}),e.jsx("div",{className:"text-xs text-gray-500",children:"Cannot be deleted"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium mb-1",children:"Unmatched (Deletable)"}),e.jsx("div",{className:"text-lg font-bold text-gray-900",children:V.unmatched_count}),e.jsx("div",{className:"text-xs text-gray-500",children:"Will be deleted"})]})]})]}),V.warning&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-800 font-medium",children:V.warning})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{k(!1),S(null)},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"button",onClick:Ke,disabled:!V.can_delete,className:"px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed",children:V.can_delete?`Delete ${V.unmatched_count} Transaction(s)`:"Cannot Delete"})]})]})}),e.jsx(qe,{isOpen:he,onClose:()=>{r(!1),oe(null)},title:"Edit Bank Statement Line",children:I&&e.jsxs("form",{onSubmit:ba,className:"space-y-4",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded-lg",children:[e.jsx("div",{className:"text-sm text-gray-600 mb-1",children:"Date:"}),e.jsx("div",{className:"font-medium",children:new Date(I.date).toLocaleDateString("id-ID")}),I.reference&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"text-sm text-gray-600 mt-2 mb-1",children:"Reference:"}),e.jsx("div",{className:"font-medium font-mono text-sm",children:I.reference})]}),e.jsx("div",{className:"text-sm text-gray-600 mt-2 mb-1",children:"Status:"}),e.jsxs("div",{className:"inline-flex items-center gap-1.5",children:[I.status==="matched"&&e.jsxs(e.Fragment,{children:[e.jsx(Ot,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-700 font-medium",children:"Matched"})]}),I.status==="recorded"&&e.jsxs(e.Fragment,{children:[e.jsx(Ot,{className:"w-4 h-4 text-green-600"}),e.jsx("span",{className:"text-green-700 font-medium",children:"Recorded"})]}),I.status==="suggested"&&e.jsxs(e.Fragment,{children:[e.jsx($t,{className:"w-4 h-4 text-yellow-600"}),e.jsx("span",{className:"text-yellow-700 font-medium",children:"Suggested"})]}),I.status==="unmatched"&&e.jsxs(e.Fragment,{children:[e.jsx(Tt,{className:"w-4 h-4 text-gray-400"}),e.jsx("span",{className:"text-gray-600 font-medium",children:"Unmatched"})]})]})]}),(I.matchedExpense||I.matchedReceipt||I.matchedFundTransfer)&&e.jsxs("div",{className:"p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ue,{className:"w-5 h-5 text-blue-600"}),e.jsx("h4",{className:"font-semibold text-blue-900",children:"Linked Transaction"})]}),x&&e.jsx("button",{type:"button",onClick:ya,className:"text-sm text-red-600 hover:text-red-700 font-medium",children:"Unlink"})]}),I.matchedExpense&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Type:"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Expense"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Category:"}),e.jsx("span",{className:"font-medium text-gray-900",children:((ea=Fe.find(s=>{var E;return s.value===((E=I.matchedExpense)==null?void 0:E.expense_category)}))==null?void 0:ea.label)||I.matchedExpense.expense_category})]}),I.matchedExpense.voucher_number&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Voucher:"}),e.jsx("span",{className:"font-medium text-gray-900 font-mono",children:I.matchedExpense.voucher_number})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[I.currency==="USD"?"$":"Rp"," ",I.matchedExpense.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(I.matchedExpense.expense_date).toLocaleDateString("id-ID")})]}),I.matchedExpense.description&&e.jsxs("div",{className:"pt-2 border-t border-blue-200",children:[e.jsx("div",{className:"text-gray-600 mb-1",children:"Description:"}),e.jsx("div",{className:"text-gray-900",children:I.matchedExpense.description})]})]}),I.matchedReceipt&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Type:"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Receipt"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Payment Number:"}),e.jsx("span",{className:"font-medium text-gray-900 font-mono",children:I.matchedReceipt.payment_number})]}),I.matchedReceipt.customer_name&&e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Customer:"}),e.jsx("span",{className:"font-medium text-gray-900",children:I.matchedReceipt.customer_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[I.currency==="USD"?"$":"Rp"," ",I.matchedReceipt.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(I.matchedReceipt.payment_date).toLocaleDateString("id-ID")})]})]}),I.matchedFundTransfer&&e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Type:"}),e.jsx("span",{className:"font-medium text-gray-900",children:"Fund Transfer"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Transfer No:"}),e.jsx("span",{className:"font-medium text-gray-900 font-mono",children:I.matchedFundTransfer.transfer_number})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"From:"}),e.jsx("span",{className:"font-medium text-gray-900",children:I.matchedFundTransfer.from_account_type})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"To:"}),e.jsx("span",{className:"font-medium text-gray-900",children:I.matchedFundTransfer.to_account_type})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Amount:"}),e.jsxs("span",{className:"font-medium text-gray-900",children:[I.currency==="USD"?"$":"Rp"," ",I.matchedFundTransfer.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Date:"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(I.matchedFundTransfer.transfer_date).toLocaleDateString("id-ID")})]}),I.matchedFundTransfer.description&&e.jsxs("div",{className:"pt-2 border-t border-blue-200",children:[e.jsx("div",{className:"text-gray-600 mb-1",children:"Description:"}),e.jsx("div",{className:"text-gray-900",children:I.matchedFundTransfer.description})]})]}),I.notes&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-blue-200",children:[e.jsx("div",{className:"text-xs text-gray-600 mb-1",children:"Match Notes:"}),e.jsx("div",{className:"text-sm text-gray-700 italic",children:I.notes})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:te.description,onChange:s=>be({...te,description:s.target.value}),rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-red-700 mb-1",children:"Debit Amount"}),e.jsx("input",{type:"number",step:"0.01",value:te.debit,onChange:s=>be({...te,debit:parseFloat(s.target.value)||0,credit:0}),className:"w-full px-3 py-2 border border-red-300 rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Money OUT (expenses)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-green-700 mb-1",children:"Credit Amount"}),e.jsx("input",{type:"number",step:"0.01",value:te.credit,onChange:s=>be({...te,credit:parseFloat(s.target.value)||0,debit:0}),className:"w-full px-3 py-2 border border-green-300 rounded-lg"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Money IN (receipts)"})]})]}),e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3",children:e.jsxs("p",{className:"text-xs text-yellow-800",children:[" ",e.jsx("strong",{children:"Note:"})," Each transaction should have either a Debit OR a Credit amount, not both. When you enter one, the other will be cleared."]})}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{r(!1),oe(null)},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Update"})]})]})})]})}const Xt=[{value:"asset",label:"Asset",color:"bg-blue-100 text-blue-800"},{value:"liability",label:"Liability",color:"bg-red-100 text-red-800"},{value:"equity",label:"Equity",color:"bg-purple-100 text-purple-800"},{value:"revenue",label:"Revenue",color:"bg-green-100 text-green-800"},{value:"expense",label:"Expense",color:"bg-orange-100 text-orange-800"},{value:"contra",label:"Contra",color:"bg-gray-100 text-gray-800"}];function ss({canManage:x}){const[W,L]=n.useState([]),[G,ee]=n.useState(!0),[M,O]=n.useState(!1),[K,Z]=n.useState(null),[H,A]=n.useState(new Set(["asset","liability","equity","revenue","expense"])),[U,Q]=n.useState(""),[R,B]=n.useState({code:"",name:"",name_id:"",account_type:"expense",account_group:"",parent_id:"",is_header:!1,normal_balance:"debit",description:""});n.useEffect(()=>{m()},[]);const m=async()=>{try{const{data:o,error:Y}=await l.from("chart_of_accounts").select("*").order("code");if(Y)throw Y;L(o||[])}catch(o){console.error("Error loading accounts:",o)}finally{ee(!1)}},C=async o=>{o.preventDefault();try{const Y={...R,parent_id:R.parent_id||null,name_id:R.name_id||null,description:R.description||null};if(K){const{error:p}=await l.from("chart_of_accounts").update(Y).eq("id",K.id);if(p)throw p}else{const{error:p}=await l.from("chart_of_accounts").insert([Y]);if(p)throw p}O(!1),j(),m()}catch(Y){console.error("Error saving account:",Y),alert("Failed to save account: "+Y.message)}},P=o=>{Z(o),B({code:o.code,name:o.name,name_id:o.name_id||"",account_type:o.account_type,account_group:o.account_group||"",parent_id:o.parent_id||"",is_header:o.is_header,normal_balance:o.normal_balance,description:o.description||""}),O(!0)},a=async o=>{if(confirm("Are you sure you want to delete this account?"))try{const{error:Y}=await l.from("chart_of_accounts").delete().eq("id",o);if(Y)throw Y;m()}catch(Y){console.error("Error deleting account:",Y),alert("Failed to delete account: "+Y.message)}},j=()=>{Z(null),B({code:"",name:"",name_id:"",account_type:"expense",account_group:"",parent_id:"",is_header:!1,normal_balance:"debit",description:""})},c=o=>{const Y=new Set(H);Y.has(o)?Y.delete(o):Y.add(o),A(Y)},h=W.filter(o=>o.code.toLowerCase().includes(U.toLowerCase())||o.name.toLowerCase().includes(U.toLowerCase())||o.name_id&&o.name_id.toLowerCase().includes(U.toLowerCase())),N=Xt.reduce((o,Y)=>(o[Y.value]=h.filter(p=>p.account_type===Y.value),o),{});return G?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search accounts...",value:U,onChange:o=>Q(o.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),x&&e.jsxs("button",{onClick:()=>{j(),O(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:[e.jsx(mt,{className:"w-5 h-5"}),"Add Account"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:Xt.map(o=>{var Y,p;return e.jsxs("div",{className:"border-b last:border-b-0",children:[e.jsx("button",{onClick:()=>c(o.value),className:"w-full flex items-center justify-between px-4 py-3 bg-gray-50 hover:bg-gray-100",children:e.jsxs("div",{className:"flex items-center gap-2",children:[H.has(o.value)?e.jsx(Wt,{className:"w-5 h-5"}):e.jsx(ca,{className:"w-5 h-5"}),e.jsx("span",{className:`px-2 py-1 rounded text-sm font-medium ${o.color}`,children:o.label}),e.jsxs("span",{className:"text-gray-500 text-sm",children:["(",((Y=N[o.value])==null?void 0:Y.length)||0," accounts)"]})]})}),H.has(o.value)&&((p=N[o.value])==null?void 0:p.length)>0&&e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 text-xs text-gray-500 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Code"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Account Name"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Indonesian Name"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Group"}),e.jsx("th",{className:"px-4 py-2 text-center",children:"Normal"}),x&&e.jsx("th",{className:"px-4 py-2 text-right",children:"Actions"})]})}),e.jsx("tbody",{className:"divide-y",children:N[o.value].map(T=>e.jsxs("tr",{className:`hover:bg-gray-50 ${T.is_header?"font-semibold bg-gray-50":""}`,children:[e.jsx("td",{className:"px-4 py-2 font-mono text-sm",children:T.code}),e.jsx("td",{className:"px-4 py-2",children:T.name}),e.jsx("td",{className:"px-4 py-2 text-gray-500",children:T.name_id||"-"}),e.jsx("td",{className:"px-4 py-2 text-sm text-gray-500",children:T.account_group||"-"}),e.jsx("td",{className:"px-4 py-2 text-center",children:e.jsx("span",{className:`text-xs px-2 py-1 rounded ${T.normal_balance==="debit"?"bg-blue-100 text-blue-700":"bg-green-100 text-green-700"}`,children:T.normal_balance})}),x&&e.jsxs("td",{className:"px-4 py-2 text-right",children:[e.jsx("button",{onClick:()=>P(T),className:"text-blue-600 hover:text-blue-800 mr-2",children:e.jsx(Nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>a(T.id),className:"text-red-600 hover:text-red-800",children:e.jsx(pt,{className:"w-4 h-4"})})]})]},T.id))})]})]},o.value)})}),e.jsx(qe,{isOpen:M,onClose:()=>O(!1),title:K?"Edit Account":"Add Account",children:e.jsxs("form",{onSubmit:C,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Code *"}),e.jsx("input",{type:"text",required:!0,value:R.code,onChange:o=>B({...R,code:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"e.g., 1101"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Type *"}),e.jsx("select",{required:!0,value:R.account_type,onChange:o=>B({...R,account_type:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:Xt.map(o=>e.jsx("option",{value:o.value,children:o.label},o.value))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Name (English) *"}),e.jsx("input",{type:"text",required:!0,value:R.name,onChange:o=>B({...R,name:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Name (Indonesian)"}),e.jsx("input",{type:"text",value:R.name_id,onChange:o=>B({...R,name_id:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Group"}),e.jsx("input",{type:"text",value:R.account_group,onChange:o=>B({...R,account_group:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Normal Balance *"}),e.jsxs("select",{required:!0,value:R.normal_balance,onChange:o=>B({...R,normal_balance:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"debit",children:"Debit"}),e.jsx("option",{value:"credit",children:"Credit"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Parent Account"}),e.jsxs("select",{value:R.parent_id,onChange:o=>B({...R,parent_id:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",children:[e.jsx("option",{value:"",children:"None (Top Level)"}),W.filter(o=>o.is_header).map(o=>e.jsxs("option",{value:o.id,children:[o.code," - ",o.name]},o.id))]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"is_header",checked:R.is_header,onChange:o=>B({...R,is_header:o.target.checked}),className:"rounded"}),e.jsx("label",{htmlFor:"is_header",className:"text-sm text-gray-700",children:"This is a header/group account (not for posting)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),e.jsx("textarea",{value:R.description,onChange:o=>B({...R,description:o.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:2})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>O(!1),className:"px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[K?"Update":"Create"," Account"]})]})]})})]})}function ns({canManage:x}){const[W,L]=n.useState([]),[G,ee]=n.useState(!0),[M,O]=n.useState(!1),[K,Z]=n.useState(null),[H,A]=n.useState(""),[U,Q]=n.useState({supplier_code:"",company_name:"",contact_person:"",email:"",phone:"",address:"",city:"",country:"Indonesia",npwp:"",pkp_status:!1,payment_terms_days:30,bank_name:"",bank_account_number:"",bank_account_name:""});n.useEffect(()=>{R()},[]);const R=async()=>{try{const{data:c,error:h}=await l.from("suppliers").select("*").order("company_name");if(h)throw h;L(c||[])}catch(c){console.error("Error loading suppliers:",c)}finally{ee(!1)}},B=async()=>{const c=new Date().getFullYear().toString().slice(-2),{count:h}=await l.from("suppliers").select("*",{count:"exact",head:!0});return`SUP${c}-${String((h||0)+1).padStart(4,"0")}`},m=async c=>{c.preventDefault();try{const{data:{user:h}}=await l.auth.getUser();if(!h)throw new Error("Not authenticated");const N={...U,supplier_code:U.supplier_code||await B(),contact_person:U.contact_person||null,email:U.email||null,phone:U.phone||null,address:U.address||null,city:U.city||null,npwp:U.npwp||null,bank_name:U.bank_name||null,bank_account_number:U.bank_account_number||null,bank_account_name:U.bank_account_name||null};if(K){const{error:o}=await l.from("suppliers").update(N).eq("id",K.id);if(o)throw o}else{const{error:o}=await l.from("suppliers").insert([{...N,created_by:h.id}]);if(o)throw o}O(!1),a(),R()}catch(h){console.error("Error saving supplier:",h),alert("Failed to save supplier: "+h.message)}},C=c=>{Z(c),Q({supplier_code:c.supplier_code||"",company_name:c.company_name,contact_person:c.contact_person||"",email:c.email||"",phone:c.phone||"",address:c.address||"",city:c.city||"",country:c.country,npwp:c.npwp||"",pkp_status:c.pkp_status,payment_terms_days:c.payment_terms_days,bank_name:c.bank_name||"",bank_account_number:c.bank_account_number||"",bank_account_name:c.bank_account_name||""}),O(!0)},P=async c=>{if(confirm("Are you sure you want to delete this supplier?"))try{const{error:h}=await l.from("suppliers").delete().eq("id",c);if(h)throw h;R()}catch(h){console.error("Error deleting supplier:",h),alert("Failed to delete supplier: "+h.message)}},a=()=>{Z(null),Q({supplier_code:"",company_name:"",contact_person:"",email:"",phone:"",address:"",city:"",country:"Indonesia",npwp:"",pkp_status:!1,payment_terms_days:30,bank_name:"",bank_account_number:"",bank_account_name:""})},j=W.filter(c=>c.company_name.toLowerCase().includes(H.toLowerCase())||c.supplier_code&&c.supplier_code.toLowerCase().includes(H.toLowerCase())||c.npwp&&c.npwp.includes(H));return G?e.jsx("div",{className:"flex justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"relative flex-1 max-w-md",children:[e.jsx(_t,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:"Search suppliers...",value:H,onChange:c=>A(c.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg"})]}),x&&e.jsxs("button",{onClick:()=>{a(),O(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:[e.jsx(mt,{className:"w-5 h-5"}),"Add Supplier"]})]}),e.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Code"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Company Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Contact"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"NPWP"}),e.jsx("th",{className:"px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase",children:"PKP"}),e.jsx("th",{className:"px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase",children:"Terms"}),x&&e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase",children:"Actions"})]})}),e.jsxs("tbody",{className:"divide-y",children:[j.map(c=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:c.supplier_code||"-"}),e.jsx("td",{className:"px-4 py-3",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"w-4 h-4 text-gray-400"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:c.company_name}),c.city&&e.jsx("div",{className:"text-sm text-gray-500",children:c.city})]})]})}),e.jsxs("td",{className:"px-4 py-3",children:[e.jsx("div",{className:"text-sm",children:c.contact_person||"-"}),c.phone&&e.jsx("div",{className:"text-sm text-gray-500",children:c.phone})]}),e.jsx("td",{className:"px-4 py-3 font-mono text-sm",children:c.npwp||"-"}),e.jsx("td",{className:"px-4 py-3 text-center",children:c.pkp_status?e.jsx("span",{className:"px-2 py-1 bg-green-100 text-green-700 text-xs rounded",children:"PKP"}):e.jsx("span",{className:"px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded",children:"Non-PKP"})}),e.jsxs("td",{className:"px-4 py-3 text-sm",children:[c.payment_terms_days," days"]}),x&&e.jsxs("td",{className:"px-4 py-3 text-right",children:[e.jsx("button",{onClick:()=>C(c),className:"text-blue-600 hover:text-blue-800 mr-2",children:e.jsx(Nt,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>P(c.id),className:"text-red-600 hover:text-red-800",children:e.jsx(pt,{className:"w-4 h-4"})})]})]},c.id)),j.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-4 py-8 text-center text-gray-500",children:"No suppliers found"})})]})]})}),e.jsx(qe,{isOpen:M,onClose:()=>O(!1),title:K?"Edit Supplier":"Add Supplier",children:e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier Code"}),e.jsx("input",{type:"text",value:U.supplier_code,onChange:c=>Q({...U,supplier_code:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"Auto-generated if empty"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Company Name *"}),e.jsx("input",{type:"text",required:!0,value:U.company_name,onChange:c=>Q({...U,company_name:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Contact Person"}),e.jsx("input",{type:"text",value:U.contact_person,onChange:c=>Q({...U,contact_person:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Phone"}),e.jsx("input",{type:"text",value:U.phone,onChange:c=>Q({...U,phone:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Email"}),e.jsx("input",{type:"email",value:U.email,onChange:c=>Q({...U,email:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Address"}),e.jsx("textarea",{value:U.address,onChange:c=>Q({...U,address:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",rows:2})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"City"}),e.jsx("input",{type:"text",value:U.city,onChange:c=>Q({...U,city:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Country"}),e.jsx("input",{type:"text",value:U.country,onChange:c=>Q({...U,country:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"Tax Information"}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"NPWP"}),e.jsx("input",{type:"text",value:U.npwp,onChange:c=>Q({...U,npwp:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg",placeholder:"00.000.000.0-000.000"})]}),e.jsxs("div",{className:"flex items-center gap-2 pt-6",children:[e.jsx("input",{type:"checkbox",id:"pkp_status",checked:U.pkp_status,onChange:c=>Q({...U,pkp_status:c.target.checked}),className:"rounded"}),e.jsx("label",{htmlFor:"pkp_status",className:"text-sm text-gray-700",children:"PKP (Pengusaha Kena Pajak)"})]})]})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("h4",{className:"font-medium text-gray-700 mb-3",children:"Bank Details"}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Name"}),e.jsx("input",{type:"text",value:U.bank_name,onChange:c=>Q({...U,bank_name:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Number"}),e.jsx("input",{type:"text",value:U.bank_account_number,onChange:c=>Q({...U,bank_account_number:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Name"}),e.jsx("input",{type:"text",value:U.bank_account_name,onChange:c=>Q({...U,bank_account_name:c.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Terms (Days)"}),e.jsx("input",{type:"number",value:U.payment_terms_days,onChange:c=>Q({...U,payment_terms_days:parseInt(c.target.value)||30}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg"})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>O(!1),className:"px-4 py-2 text-gray-700 border rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[K?"Update":"Create"," Supplier"]})]})]})})]})}function rs({canManage:x}){const[W,L]=n.useState([]),[G,ee]=n.useState(!0),[M,O]=n.useState(!1),[K,Z]=n.useState(null),[H,A]=n.useState({account_name:"",bank_name:"",account_number:"",account_type:"current",currency:"IDR",opening_balance:0,opening_balance_date:"2025-01-01",alias:""});n.useEffect(()=>{U()},[]);const U=async()=>{try{const{data:C,error:P}=await l.from("bank_accounts").select("*").order("created_at",{ascending:!1});if(P)throw P;L(C||[])}catch(C){console.error("Error loading bank accounts:",C)}finally{ee(!1)}},Q=async C=>{C.preventDefault();try{const{data:{user:P}}=await l.auth.getUser();if(!P)throw new Error("Not authenticated");if(K){const{error:a}=await l.from("bank_accounts").update(H).eq("id",K.id);if(a)throw a}else{const{error:a}=await l.from("bank_accounts").insert([{...H,current_balance:H.opening_balance,created_by:P.id}]);if(a)throw a}O(!1),B(),U()}catch(P){console.error("Error saving bank account:",P),alert(`Failed to save bank account: ${P.message}`)}},R=C=>{Z(C),A({account_name:C.account_name,bank_name:C.bank_name,account_number:C.account_number,account_type:C.account_type,currency:C.currency,opening_balance:C.opening_balance,opening_balance_date:C.opening_balance_date||"2025-01-01",alias:C.alias||""}),O(!0)},B=()=>{Z(null),A({account_name:"",bank_name:"",account_number:"",account_type:"current",currency:"IDR",opening_balance:0,opening_balance_date:"2025-01-01",alias:""})},m=[{key:"account_name",label:"Account Name"},{key:"bank_name",label:"Bank"},{key:"account_number",label:"Account #"},{key:"type",label:"Type",render:(C,P)=>e.jsx("span",{className:"capitalize",children:P.account_type||"current"})},{key:"balance",label:"Balance",render:(C,P)=>e.jsxs("span",{className:"font-semibold",children:["Rp ",(P.current_balance||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"status",label:"Status",render:(C,P)=>e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${P.is_active?"bg-green-100 text-green-800":"bg-gray-100 text-gray-800"}`,children:P.is_active?"Active":"Inactive"})}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Bank Accounts"}),x&&e.jsxs("button",{onClick:()=>{B(),O(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700",children:[e.jsx(mt,{className:"w-5 h-5"}),"Add Bank Account"]})]}),e.jsx(Ft,{columns:m,data:W,loading:G,actions:x?C=>e.jsx("button",{onClick:()=>R(C),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:e.jsx(Nt,{className:"w-4 h-4"})}):void 0}),e.jsx(qe,{isOpen:M,onClose:()=>{O(!1),B()},title:K?"Edit Bank Account":"Add Bank Account",children:e.jsxs("form",{onSubmit:Q,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Name *"}),e.jsx("input",{type:"text",value:H.account_name,onChange:C=>A({...H,account_name:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Name *"}),e.jsx("input",{type:"text",value:H.bank_name,onChange:C=>A({...H,bank_name:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Display Alias"}),e.jsx("input",{type:"text",value:H.alias,onChange:C=>A({...H,alias:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"e.g., BCA IDR, Mandiri USD"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Short name for easier identification in lists"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Number *"}),e.jsx("input",{type:"text",value:H.account_number,onChange:C=>A({...H,account_number:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Account Type *"}),e.jsxs("select",{value:H.account_type,onChange:C=>A({...H,account_type:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"savings",children:"Savings"}),e.jsx("option",{value:"current",children:"Current"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"other",children:"Other"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Currency *"}),e.jsxs("select",{value:H.currency,onChange:C=>A({...H,currency:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"IDR",children:"IDR (Indonesian Rupiah)"}),e.jsx("option",{value:"USD",children:"USD (US Dollar)"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance"}),e.jsx("input",{type:"number",value:H.opening_balance===0?"":H.opening_balance,onChange:C=>A({...H,opening_balance:C.target.value===""?0:Number(C.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",step:"0.01",placeholder:"0"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Leave blank if opening balance is zero"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance Date *"}),e.jsx("input",{type:"date",value:H.opening_balance_date,onChange:C=>A({...H,opening_balance_date:C.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Date when the opening balance is effective"})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{O(!1),B()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:[K?"Update":"Add"," Account"]})]})]})})]})}function is(){const{t:x}=Ut(),[W,L]=n.useState([]),[G,ee]=n.useState([]),[M,O]=n.useState([]),[K,Z]=n.useState(!0),[H,A]=n.useState("summary"),[U,Q]=n.useState("");n.useEffect(()=>{R()},[]);const R=async()=>{try{Z(!0);const[a,j,c]=await Promise.all([l.from("vw_monthly_tax_summary").select("*").order("month",{ascending:!1}),l.from("vw_input_ppn_report").select("*"),l.from("vw_output_ppn_report").select("*")]);if(a.error)throw a.error;if(j.error)throw j.error;if(c.error)throw c.error;O(a.data||[]),L(j.data||[]),ee(c.data||[])}catch(a){console.error("Error loading tax reports:",a.message),alert("Failed to load tax reports")}finally{Z(!1)}},B=a=>`Rp ${a==null?void 0:a.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,m=a=>a?new Date(a).toLocaleDateString("en-US",{year:"numeric",month:"long"}):"-",C=U?W.filter(a=>a.month===U):W,P=U?G.filter(a=>a.month===U):G;return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between bg-white p-2 rounded-lg shadow-sm",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-900",children:x("finance.taxReports")||"Tax Reports (PPN)"}),e.jsx("p",{className:"text-[10px] text-gray-600",children:x("finance.taxReportsDesc")||"Monthly Input PPN, Output PPN, Net PPN"})]}),e.jsxs("button",{onClick:()=>window.print(),className:"flex items-center gap-1.5 px-2.5 py-1.5 border border-gray-300 rounded-lg hover:bg-gray-50 text-xs",children:[e.jsx(Dt,{className:"w-3.5 h-3.5"}),x("common.print")||"Print"]})]}),e.jsx("div",{className:"flex gap-1.5 border-b border-gray-200 bg-white",children:[{value:"summary",label:x("finance.monthlySummary")||"Monthly Summary",icon:sa},{value:"input",label:x("finance.inputPPN")||"Input PPN",icon:La},{value:"output",label:x("finance.outputPPN")||"Output PPN",icon:qt}].map(a=>{const j=a.icon;return e.jsxs("button",{onClick:()=>A(a.value),className:`flex items-center gap-1.5 px-2.5 py-1.5 text-xs font-medium transition-colors ${H===a.value?"text-blue-600 border-b-2 border-blue-600":"text-gray-500 hover:text-gray-700"}`,children:[e.jsx(j,{className:"w-3.5 h-3.5"}),a.label]},a.value)})}),K?e.jsx("div",{className:"text-center py-8 text-gray-500 text-xs",children:x("common.loading")||"Loading tax reports..."}):e.jsxs(e.Fragment,{children:[H==="summary"&&e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-gray-50 border-b border-gray-200",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-900",children:x("finance.monthlySummary")||"Monthly Tax Summary"}),e.jsx("p",{className:"text-[10px] text-gray-600",children:x("finance.netPPNFormula")||"Net PPN = Output PPN - Input PPN"})]}),e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.month")||"Month"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.inputPPNPaid")||"Input PPN"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.outputPPNCollected")||"Output PPN"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.netPPNPayable")||"Net PPN Payable"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:M.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-3 py-4 text-center text-gray-500 text-xs",children:x("common.noData")||"No tax data available"})}):M.map((a,j)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap",children:e.jsx("div",{className:"text-xs font-medium text-gray-900",children:m(a.month)})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:e.jsx("div",{className:"text-xs text-blue-600 font-medium",children:B(a.input_ppn_paid)})}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:e.jsx("div",{className:"text-xs text-green-600 font-medium",children:B(a.output_ppn_collected)})}),e.jsxs("td",{className:"px-3 py-2 whitespace-nowrap text-right",children:[e.jsx("div",{className:`text-xs font-bold ${a.net_ppn_payable>0?"text-red-600":a.net_ppn_payable<0?"text-blue-600":"text-gray-600"}`,children:B(a.net_ppn_payable)}),e.jsx("div",{className:"text-[10px] text-gray-500",children:a.net_ppn_payable>0?x("finance.payToTax")||"Pay to tax office":a.net_ppn_payable<0?x("finance.carryForward")||"Carry forward":x("finance.balanced")||"Balanced"})]})]},j))})]})]}),H==="input"&&e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-blue-50 border-b border-blue-200",children:[e.jsx("h3",{className:"text-sm font-medium text-blue-900",children:x("finance.inputPPNReport")||"Input PPN Report"}),e.jsx("p",{className:"text-[10px] text-blue-700",children:x("finance.inputPPNDesc")||"PPN paid on imports - can be claimed as tax credit"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.date")||"Date"}),e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.container")||"Container"}),e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.supplier")||"Supplier"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.invoiceValue")||"Invoice Value"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.ppnAmount")||"PPN Amount (11%)"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:C.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-3 py-4 text-center text-gray-500 text-xs",children:x("common.noRecords")||"No input PPN records"})}):C.map((a,j)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-gray-900",children:ct(a.expense_date)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs font-medium text-gray-900",children:a.container_ref}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:a.supplier}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-right text-gray-900",children:B(a.import_invoice_value)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-right font-medium text-blue-600",children:B(a.ppn_amount)})]},j))})]})})]}),H==="output"&&e.jsxs("div",{className:"bg-white rounded-lg shadow overflow-hidden",children:[e.jsxs("div",{className:"px-3 py-2 bg-green-50 border-b border-green-200",children:[e.jsx("h3",{className:"text-sm font-medium text-green-900",children:x("finance.outputPPNReport")||"Output PPN Report"}),e.jsx("p",{className:"text-[10px] text-green-700",children:x("finance.outputPPNDesc")||"PPN collected from customers - must be paid to tax office"}),e.jsx("p",{className:"text-[10px] font-semibold text-red-700 mt-1",children:x("finance.taxPayableWarning")||" Tax is payable based on INVOICE DATE, not payment status!"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.date")||"Date"}),e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.invoiceNo")||"Invoice #"}),e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:x("common.customer")||"Customer"}),e.jsx("th",{className:"px-3 py-1.5 text-left text-[10px] font-medium text-gray-500 uppercase",children:"NPWP"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.subtotal")||"Subtotal"}),e.jsx("th",{className:"px-3 py-1.5 text-right text-[10px] font-medium text-gray-500 uppercase",children:x("finance.ppnAmount")||"PPN Amount (11%)"}),e.jsxs("th",{className:"px-3 py-1.5 text-center text-[10px] font-medium text-gray-500 uppercase",children:[x("common.paymentStatus")||"Payment Status",e.jsx("div",{className:"text-[10px] font-normal text-gray-500 normal-case",children:x("finance.forInfoOnly")||"(For info only - tax due regardless)"})]})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:P.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"px-3 py-4 text-center text-gray-500 text-xs",children:x("common.noRecords")||"No output PPN records"})}):P.map((a,j)=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-gray-900",children:ct(a.invoice_date)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs font-medium text-gray-900",children:a.invoice_number}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:a.customer}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-600",children:a.customer_npwp||"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-right text-gray-900",children:B(a.subtotal)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-xs text-right font-medium text-green-600",children:B(a.ppn_amount)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-center",children:e.jsx("span",{className:`inline-flex px-1.5 py-0.5 text-[10px] font-medium rounded ${a.payment_status==="paid"?"bg-green-100 text-green-800":a.payment_status==="partial"?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"}`,children:a.payment_status})})]},j))})]})})]})]}),e.jsxs("div",{className:"bg-red-50 border border-red-300 rounded-lg p-2",children:[e.jsx("h4",{className:"text-xs font-semibold text-red-900 mb-1",children:x("finance.taxRuleWarning")||" CRITICAL: Indonesian PPN Tax Rule"}),e.jsxs("div",{className:"text-[10px] text-red-800 space-y-1",children:[e.jsx("p",{className:"font-semibold",children:x("finance.ppnPayableRule")||"PPN is payable based on INVOICE DATE, NOT payment date!"}),e.jsxs("ul",{className:"list-disc list-inside space-y-0.5 ml-1",children:[e.jsx("li",{children:x("finance.taxRule1")||"When you issue an invoice  PPN is immediately owed to tax office"}),e.jsx("li",{children:x("finance.taxRule2")||"Payment status does NOT matter for tax"}),e.jsx("li",{children:x("finance.taxRule3")||"You must pay PPN to government even if customer hasn't paid you yet"}),e.jsx("li",{children:x("finance.taxRule4")||"All invoices in a month = PPN payable for that month"})]})]})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-2",children:[e.jsx("h4",{className:"text-xs font-semibold text-blue-900 mb-1",children:x("finance.taxFilingGuide")||" Tax Filing Guide"}),e.jsxs("ul",{className:"text-[10px] text-blue-800 space-y-0.5",children:[e.jsxs("li",{children:[" ",e.jsx("strong",{children:x("finance.inputPPN")||"Input PPN"}),": ",x("finance.inputPPNDesc2")||"PPN paid on imports (can be claimed back)"]}),e.jsxs("li",{children:[" ",e.jsx("strong",{children:x("finance.outputPPN")||"Output PPN"}),": ",x("finance.outputPPNDesc2")||"PPN collected from customers (must pay to tax office)"]}),e.jsxs("li",{children:[" ",e.jsx("strong",{children:x("finance.netPPNPayable")||"Net PPN Payable"}),": ",x("finance.netPPNFormula2")||"Output PPN - Input PPN"]}),e.jsxs("li",{children:[" ",x("finance.taxRule5")||"If positive: Pay to tax office by month-end"]}),e.jsxs("li",{children:[" ",x("finance.taxRule6")||"If negative: Carry forward to next month or claim refund"]}),e.jsxs("li",{children:[" ",e.jsx("strong",{children:x("finance.ppnRate")||"PPN Rate"}),": 11% ",x("finance.asPerLaw")||"(as per Indonesian tax law)"]})]})]})]})}function ls(){var Y;const{profile:x}=Rt(),{dateRange:W}=xt(),[L,G]=n.useState("inventory_movement"),[ee,M]=n.useState(!1),[O,K]=n.useState(null),[Z,H]=n.useState(null),A={from:W.startDate,to:W.endDate},U=[{id:"coa",name:"Chart of Accounts",icon:Ue,description:"Complete COA list"},{id:"cash_ledger",name:"Cash Ledger",icon:Ue,description:"Cash on Hand & Petty Cash"},{id:"bank_ledger",name:"Bank Ledger",icon:Ve,description:"All bank accounts"},{id:"sales_register",name:"Sales Register",icon:qt,description:"All sales invoices"},{id:"purchase_register",name:"Purchase Register",icon:Ue,description:"All purchase invoices"},{id:"inventory_movement",name:"Inventory Movement",icon:lt,description:"Stock Opening + In + Out + Closing",highlight:!0},{id:"journal_register",name:"Journal Register",icon:Ue,description:"All journal entries"},{id:"general_ledger",name:"General Ledger",icon:Ue,description:"All account ledgers combined"},{id:"trial_balance",name:"Trial Balance",icon:Ue,description:"Debit/Credit summary"},{id:"fixed_assets",name:"Fixed Asset Register",icon:Ve,description:"Assets with depreciation"}];n.useEffect(()=>{L&&Q()},[L,W.startDate,W.endDate]);const Q=async()=>{M(!0),H(null);try{let p=null;switch(L){case"coa":p=await R();break;case"cash_ledger":p=await B();break;case"bank_ledger":p=await m();break;case"sales_register":p=await C();break;case"purchase_register":p=await P();break;case"inventory_movement":p=await a();break;case"journal_register":p=await j();break;case"general_ledger":p=await c();break;case"trial_balance":p=await h();break;case"fixed_assets":p=await N();break}K(p)}catch(p){console.error("Error loading report:",p),H(p.message||"Failed to load report")}finally{M(!1)}},R=async()=>{const{data:p,error:T}=await l.from("chart_of_accounts").select("code, name, account_type").order("code");if(T)throw T;return p||[]},B=async()=>{const{data:p}=await l.from("chart_of_accounts").select("id, code, name").in("code",["1101","1102"]);if(!p||p.length===0)return[];const T=p.map(u=>u.id),{data:_}=await l.from("journal_entries").select("id, entry_date, entry_number, source_module").gte("entry_date",A.from).lte("entry_date",A.to).order("entry_date",{ascending:!0});if(!_||_.length===0)return[];const i=_.map(u=>u.id),{data:g,error:v}=await l.from("journal_entry_lines").select("journal_entry_id, account_id, debit, credit, description").in("journal_entry_id",i).in("account_id",T);if(v)throw v;return(g==null?void 0:g.map(u=>{const D=_.find(oe=>oe.id===u.journal_entry_id),I=p.find(oe=>oe.id===u.account_id);return{date:D==null?void 0:D.entry_date,voucher_no:D==null?void 0:D.entry_number,account_name:I==null?void 0:I.name,debit:u.debit,credit:u.credit,narration:u.description}}))||[]},m=async()=>{const{data:p}=await l.from("chart_of_accounts").select("id, code, name").like("code","1111%");if(!p||p.length===0)return[];const T=p.map(u=>u.id),{data:_}=await l.from("journal_entries").select("id, entry_date, entry_number, source_module").gte("entry_date",A.from).lte("entry_date",A.to).order("entry_date",{ascending:!0});if(!_||_.length===0)return[];const i=_.map(u=>u.id),{data:g,error:v}=await l.from("journal_entry_lines").select("journal_entry_id, account_id, debit, credit, description").in("journal_entry_id",i).in("account_id",T);if(v)throw v;return(g==null?void 0:g.map(u=>{const D=_.find(oe=>oe.id===u.journal_entry_id),I=p.find(oe=>oe.id===u.account_id);return{date:D==null?void 0:D.entry_date,voucher_no:D==null?void 0:D.entry_number,account_name:I==null?void 0:I.name,debit:u.debit,credit:u.credit,narration:u.description}}))||[]},C=async()=>{const{data:p,error:T}=await l.from("sales_invoices").select(`
        invoice_number,
        invoice_date,
        customer_id,
        subtotal,
        tax_amount,
        total_amount,
        faktur_pajak_number,
        customers(company_name)
      `).gte("invoice_date",A.from).lte("invoice_date",A.to).order("invoice_date",{ascending:!0});if(T)throw T;return(p==null?void 0:p.map(_=>{var i;return{invoice_date:_.invoice_date,invoice_number:_.invoice_number,customer_name:(i=_.customers)==null?void 0:i.company_name,tax_invoice_no:_.faktur_pajak_number,net_amount:_.subtotal,ppn:_.tax_amount,total_amount:_.total_amount}}))||[]},P=async()=>{const{data:p,error:T}=await l.from("purchase_orders").select(`
        po_number,
        po_date,
        supplier_id,
        subtotal,
        tax_amount,
        total_amount,
        currency,
        suppliers(company_name)
      `).gte("po_date",A.from).lte("po_date",A.to).order("po_date",{ascending:!0});if(T)throw T;return(p==null?void 0:p.map(_=>{var i;return{po_date:_.po_date,po_number:_.po_number,supplier_name:(i=_.suppliers)==null?void 0:i.company_name,net_amount:_.subtotal,ppn:_.tax_amount,total_amount:_.total_amount,currency:_.currency}}))||[]},a=async()=>{const{data:p}=await l.from("inventory_transactions").select(`
        product_id,
        quantity,
        transaction_type
      `).lt("transaction_date",A.from),{data:T}=await l.from("inventory_transactions").select(`
        product_id,
        transaction_date,
        quantity,
        transaction_type,
        reference_type,
        reference_number
      `).gte("transaction_date",A.from).lte("transaction_date",A.to),{data:_}=await l.from("products").select("id, product_code, product_name, unit");if(!_)return[];const i=new Map;return _.forEach(g=>{i.set(g.id,{product_code:g.product_code,product_name:g.product_name,unit:g.unit||"PCS",opening:0,in_qty:0,out_qty:0,closing:0})}),p==null||p.forEach(g=>{if(i.has(g.product_id)){const v=i.get(g.product_id);g.quantity>0,v.opening+=parseFloat(g.quantity)}}),T==null||T.forEach(g=>{if(i.has(g.product_id)){const v=i.get(g.product_id);parseFloat(g.quantity)>0?v.in_qty+=parseFloat(g.quantity):v.out_qty+=Math.abs(parseFloat(g.quantity))}}),Array.from(i.values()).forEach(g=>{g.closing=g.opening+g.in_qty-g.out_qty}),Array.from(i.values())},j=async()=>{const{data:p}=await l.from("journal_entries").select("id, entry_date, entry_number, source_module, description").gte("entry_date",A.from).lte("entry_date",A.to).order("entry_date",{ascending:!0}).order("entry_number",{ascending:!0});if(!p||p.length===0)return[];const T=p.map($=>$.id),{data:_}=await l.from("journal_entry_lines").select("journal_entry_id, line_number, account_id, debit, credit, description").in("journal_entry_id",T).order("line_number",{ascending:!0}),{data:i}=await l.from("chart_of_accounts").select("id, code, name"),g=new Map((i==null?void 0:i.map($=>[$.id,$]))||[]);return(_==null?void 0:_.map($=>{const u=p.find(I=>I.id===$.journal_entry_id),D=g.get($.account_id);return{entry_date:u==null?void 0:u.entry_date,entry_number:u==null?void 0:u.entry_number,voucher_type:u==null?void 0:u.source_module,account_code:D==null?void 0:D.code,account_name:D==null?void 0:D.name,debit:$.debit,credit:$.credit,narration:$.description||(u==null?void 0:u.description)}}))||[]},c=async()=>{const{data:p}=await l.from("journal_entries").select("id, entry_date, entry_number, source_module").gte("entry_date",A.from).lte("entry_date",A.to);if(!p||p.length===0)return[];const T=p.map($=>$.id),{data:_}=await l.from("journal_entry_lines").select("journal_entry_id, account_id, debit, credit, description").in("journal_entry_id",T),{data:i}=await l.from("chart_of_accounts").select("id, code, name, account_type"),g=new Map((i==null?void 0:i.map($=>[$.id,$]))||[]);return((_==null?void 0:_.map($=>{const u=p.find(I=>I.id===$.journal_entry_id),D=g.get($.account_id);return{account_code:D==null?void 0:D.code,account_name:D==null?void 0:D.name,entry_date:u==null?void 0:u.entry_date,voucher_number:u==null?void 0:u.entry_number,debit:$.debit,credit:$.credit,description:$.description}}))||[]).sort(($,u)=>$.account_code!==u.account_code?($.account_code||"").localeCompare(u.account_code||""):($.entry_date||"").localeCompare(u.entry_date||""))},h=async()=>{const{data:p}=await l.from("journal_entries").select("id").gte("entry_date",A.from).lte("entry_date",A.to);if(!p||p.length===0)return[];const T=p.map(v=>v.id),{data:_}=await l.from("journal_entry_lines").select("account_id, debit, credit").in("journal_entry_id",T),{data:i}=await l.from("chart_of_accounts").select("id, code, name, account_type"),g=new Map;return i==null||i.forEach(v=>{g.set(v.id,{code:v.code,name:v.name,account_type:v.account_type,debit:0,credit:0})}),_==null||_.forEach(v=>{if(g.has(v.account_id)){const $=g.get(v.account_id);$.debit+=parseFloat(v.debit||0),$.credit+=parseFloat(v.credit||0)}}),Array.from(g.values()).filter(v=>v.debit!==0||v.credit!==0).sort((v,$)=>v.code.localeCompare($.code))},N=async()=>{const{data:p,error:T}=await l.from("chart_of_accounts").select("code, name").gte("code","1500").lt("code","2000").order("code");if(T)throw T;return(p==null?void 0:p.map(_=>({asset_code:_.code,asset_name:_.name,acquisition_date:"",cost:"",accumulated_depreciation:"",net_book_value:""})))||[]},o=async()=>{if(!O||O.length===0){alert("No data to export");return}const{data:p}=await l.from("app_settings").select("company_name").limit(1).maybeSingle(),T=(p==null?void 0:p.company_name)||"Your Company Name";let _=[],i="",g="",v=!1;switch(L){case"coa":g="CHART OF ACCOUNTS",_=O.map(r=>({"Account Code":r.code,"Account Name":r.name,"Account Type":r.account_type})),i="Chart_of_Accounts.xlsx";break;case"inventory_movement":g="INVENTORY MOVEMENT REPORT",v=!0,_=O.map(r=>({"Product Code":r.product_code,"Product Name":r.product_name,Unit:r.unit,"Opening Qty":r.opening,"Qty In":r.in_qty,"Qty Out":r.out_qty,"Closing Qty":r.closing})),i=`Inventory_Movement_${A.from}_to_${A.to}.xlsx`;break;case"sales_register":g="SALES REGISTER",v=!0,_=O.map(r=>({Date:r.invoice_date,"Invoice No":r.invoice_number,Customer:r.customer_name,"Tax Invoice No":r.tax_invoice_no,"Net Amount":r.net_amount,PPN:r.ppn,Total:r.total_amount})),i=`Sales_Register_${A.from}_to_${A.to}.xlsx`;break;case"purchase_register":g="PURCHASE REGISTER",v=!0,_=O.map(r=>({Date:r.po_date,"PO Number":r.po_number,Supplier:r.supplier_name,"Net Amount":r.net_amount,PPN:r.ppn,Total:r.total_amount,Currency:r.currency})),i=`Purchase_Register_${A.from}_to_${A.to}.xlsx`;break;case"journal_register":g="JOURNAL REGISTER",v=!0,_=O.map(r=>({Date:r.entry_date,"Entry No":r.entry_number,"Voucher Type":r.voucher_type,"Account Code":r.account_code,"Account Name":r.account_name,Debit:r.debit,Credit:r.credit,Narration:r.narration})),i=`Journal_Register_${A.from}_to_${A.to}.xlsx`;break;case"general_ledger":g="GENERAL LEDGER",v=!0,_=O.map(r=>({"Account Code":r.account_code,"Account Name":r.account_name,Date:r.entry_date,"Voucher No":r.voucher_number,Debit:r.debit,Credit:r.credit,Description:r.description})),i=`General_Ledger_${A.from}_to_${A.to}.xlsx`;break;case"trial_balance":g="TRIAL BALANCE",v=!0,_=O.map(r=>({"Account Code":r.code,"Account Name":r.name,Debit:r.debit,Credit:r.credit})),i=`Trial_Balance_${A.from}_to_${A.to}.xlsx`;break;case"cash_ledger":g="CASH LEDGER",v=!0,_=O.map(r=>({Date:r.date,"Voucher No":r.voucher_no,Account:r.account_name,Debit:r.debit,Credit:r.credit,Narration:r.narration})),i=`Cash_Ledger_${A.from}_to_${A.to}.xlsx`;break;case"bank_ledger":g="BANK LEDGER",v=!0,_=O.map(r=>({Date:r.date,"Voucher No":r.voucher_no,"Bank Account":r.account_name,Debit:r.debit,Credit:r.credit,Narration:r.narration})),i=`Bank_Ledger_${A.from}_to_${A.to}.xlsx`;break;case"fixed_assets":g="FIXED ASSET REGISTER",_=O.map(r=>({"Asset Code":r.asset_code,"Asset Name":r.asset_name,"Acquisition Date":r.acquisition_date,Cost:r.cost,"Accumulated Depreciation":r.accumulated_depreciation,"Net Book Value":r.net_book_value})),i="Fixed_Asset_Register.xlsx";break}const $=[[T],[g]];if(v){const r=new Date(A.from).toLocaleDateString("en-GB"),te=new Date(A.to).toLocaleDateString("en-GB");$.push([`Period: ${r} to ${te}`])}$.push([]);const u=Object.keys(_[0]||{}),D=_.map(r=>u.map(te=>r[te])),I=[...$,u,...D],oe=Bt.aoa_to_sheet(I);oe["!cols"]=u.map(()=>({wch:15}));const he=Bt.book_new();Bt.book_append_sheet(he,oe,"Report"),Pa(he,i)};return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsx("h2",{className:"text-2xl font-bold text-slate-900",children:"CA Reports - Tax Consultant Excel Exports"})}),e.jsx("div",{className:"grid grid-cols-5 gap-4",children:U.map(p=>{const T=p.icon;return e.jsxs("button",{onClick:()=>G(p.id),className:`p-4 rounded-lg border-2 text-left transition-all ${L===p.id?"border-emerald-500 bg-emerald-50":p.highlight?"border-amber-500 bg-amber-50 hover:border-amber-600":"border-slate-200 bg-white hover:border-slate-300"}`,children:[e.jsx(T,{className:`w-6 h-6 mb-2 ${L===p.id?"text-emerald-600":p.highlight?"text-amber-600":"text-slate-600"}`}),e.jsx("h3",{className:"font-semibold text-sm text-slate-900",children:p.name}),e.jsx("p",{className:"text-xs text-slate-500 mt-1",children:p.description})]},p.id)})}),e.jsxs("div",{className:"bg-white rounded-lg border border-slate-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-slate-900",children:(Y=U.find(p=>p.id===L))==null?void 0:Y.name}),e.jsxs("button",{onClick:o,disabled:ee||!O||O.length===0,className:"px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(Dt,{className:"w-4 h-4"}),"Export to Excel"]})]}),ee?e.jsx("div",{className:"text-center py-12 text-slate-500",children:"Loading report..."}):Z?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"text-red-600 font-semibold mb-2",children:"Error Loading Report"}),e.jsx("div",{className:"text-slate-600",children:Z}),e.jsx("button",{onClick:Q,className:"mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Retry"})]}):!O||O.length===0?e.jsx("div",{className:"text-center py-12 text-slate-500",children:"No data available for selected period"}):e.jsxs("div",{className:"overflow-x-auto max-h-[600px] overflow-y-auto",children:[e.jsxs("div",{className:"text-sm text-slate-600 mb-2",children:[O.length," record(s) found"]}),e.jsxs("table",{className:"min-w-full divide-y divide-slate-200 text-sm",children:[e.jsx("thead",{className:"bg-slate-50 sticky top-0",children:e.jsxs("tr",{children:[L==="inventory_movement"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Product Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Product Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Unit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Opening"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700 bg-green-50",children:"In"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700 bg-red-50",children:"Out"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700 bg-blue-50",children:"Closing"})]}),L==="coa"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Type"})]}),L==="sales_register"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Invoice No"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Customer"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Tax Invoice"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Net"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"PPN"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Total"})]}),L==="purchase_register"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"PO No"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Supplier"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Net"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"PPN"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Total"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Currency"})]}),L==="cash_ledger"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Credit"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Narration"})]}),L==="bank_ledger"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Bank Account"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Credit"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Narration"})]}),L==="journal_register"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Entry No"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Voucher Type"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Name"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Credit"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Narration"})]}),L==="general_ledger"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Date"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Voucher No"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Credit"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Description"})]}),L==="trial_balance"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Account Name"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Debit"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Credit"})]}),L==="fixed_assets"&&e.jsxs(e.Fragment,{children:[e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Asset Code"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Asset Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-medium text-slate-700",children:"Acquisition Date"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Cost"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Acc. Depreciation"}),e.jsx("th",{className:"px-4 py-3 text-right font-medium text-slate-700",children:"Net Book Value"})]})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-slate-200",children:[L==="inventory_movement"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.product_code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.product_name}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.unit}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:p.opening}),e.jsx("td",{className:"px-4 py-3 text-right text-green-600 bg-green-50",children:p.in_qty}),e.jsx("td",{className:"px-4 py-3 text-right text-red-600 bg-red-50",children:p.out_qty}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-blue-600 bg-blue-50",children:p.closing})]},T)),L==="coa"&&O.map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900 font-mono",children:p.code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.name}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.account_type})]},T)),L==="sales_register"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.invoice_date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.invoice_number}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.customer_name}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.tax_invoice_no}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.net_amount||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.ppn||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-slate-900",children:parseFloat(p.total_amount||0).toFixed(2)})]},T)),L==="purchase_register"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.po_date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.po_number}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.supplier_name}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.net_amount||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.ppn||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-slate-900",children:parseFloat(p.total_amount||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.currency})]},T)),L==="cash_ledger"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.voucher_no}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.account_name}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.debit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.credit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.narration})]},T)),L==="bank_ledger"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.voucher_no}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.account_name}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.debit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.credit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.narration})]},T)),L==="journal_register"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.entry_date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.entry_number}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.voucher_type}),e.jsx("td",{className:"px-4 py-3 text-slate-900 font-mono",children:p.account_code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.account_name}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.debit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.credit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.narration})]},T)),L==="general_ledger"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900 font-mono",children:p.account_code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.account_name}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.entry_date}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.voucher_number}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.debit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.credit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-slate-600",children:p.description})]},T)),L==="trial_balance"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900 font-mono",children:p.code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.name}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.debit||0).toFixed(2)}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:parseFloat(p.credit||0).toFixed(2)})]},T)),L==="fixed_assets"&&O.slice(0,100).map((p,T)=>e.jsxs("tr",{className:"hover:bg-slate-50",children:[e.jsx("td",{className:"px-4 py-3 text-slate-900 font-mono",children:p.asset_code}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.asset_name}),e.jsx("td",{className:"px-4 py-3 text-slate-900",children:p.acquisition_date}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:p.cost}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:p.accumulated_depreciation}),e.jsx("td",{className:"px-4 py-3 text-right text-slate-900",children:p.net_book_value})]},T))]})]}),O.length>100&&e.jsxs("div",{className:"text-center py-4 text-slate-500 text-sm",children:["Showing first 100 records. Export to Excel to see all ",O.length," records."]})]})]})]})}const cs=[{name:"Loan Received",description:"Bank loan received into account",lines:[{accountCode:"111101",side:"debit",label:"Bank BCA - IDR"},{accountCode:"2210",side:"credit",label:"Bank Loans"}]},{name:"Loan Repayment",description:"Repay bank loan from account",lines:[{accountCode:"2210",side:"debit",label:"Bank Loans"},{accountCode:"111101",side:"credit",label:"Bank BCA - IDR"}]},{name:"Loan Given",description:"Loan given to external party",lines:[{accountCode:"1310",side:"debit",label:"Loan Receivable"},{accountCode:"111101",side:"credit",label:"Bank BCA - IDR"}]},{name:"Director Loan",description:"Loan from director/owner",lines:[{accountCode:"111101",side:"debit",label:"Bank BCA - IDR"},{accountCode:"2220",side:"credit",label:"Loan from Vijay Lunkad"}]},{name:"Staff Advance",description:"Advance given to staff",lines:[{accountCode:"1160",side:"debit",label:"Staff Advances & Loans"},{accountCode:"1102",side:"credit",label:"Petty Cash"}]},{name:"Advance Recovery",description:"Recover advance from staff salary",lines:[{accountCode:"6100",side:"debit",label:"Salaries & Wages"},{accountCode:"1160",side:"credit",label:"Staff Advances & Loans"}]},{name:"Salary Adjustment",description:"Adjust salary or bonus entries",lines:[{accountCode:"6100",side:"debit",label:"Salaries & Wages"},{accountCode:"111101",side:"credit",label:"Bank BCA - IDR"}]},{name:"Interest Payment",description:"Pay interest on loan",lines:[{accountCode:"7200",side:"debit",label:"Interest Expense"},{accountCode:"111101",side:"credit",label:"Bank BCA - IDR"}]}];function It(){return{key:crypto.randomUUID(),account_id:"",account_code:"",account_name:"",description:"",debit:0,credit:0}}function os({canManage:x,onNavigateToLedger:W}){const{dateRange:L,triggerRefresh:G,refreshTrigger:ee}=xt(),{profile:M}=Rt(),[O,K]=n.useState([]),[Z,H]=n.useState([]),[A,U]=n.useState(!0),[Q,R]=n.useState(!1),[B,m]=n.useState(new Date().toISOString().split("T")[0]),[C,P]=n.useState(""),[a,j]=n.useState([It(),It()]),[c,h]=n.useState(null),[N,o]=n.useState(""),Y=n.useRef(null),p=n.useRef(null),[T,_]=n.useState(null),[i,g]=n.useState(!1),[v,$]=n.useState(!1),u=n.useRef(null),D=a.reduce((F,ie)=>F+(ie.debit||0),0),I=a.reduce((F,ie)=>F+(ie.credit||0),0),oe=D>0&&Math.abs(D-I)<.01,he=a.filter(F=>F.account_id).length>=2,r=n.useCallback(async()=>{const{data:F}=await l.from("chart_of_accounts").select("id, code, name, account_type, normal_balance").eq("is_header",!1).eq("is_active",!0).order("code");F&&K(F)},[]),te=n.useCallback(async()=>{U(!0);const{data:F}=await l.from("journal_entries").select("id, entry_number, entry_date, description, source_module, total_debit, total_credit, is_posted, created_at").eq("source_module","manual").gte("entry_date",L.startDate).lte("entry_date",L.endDate).order("created_at",{ascending:!1});F&&H(F),U(!1)},[L]);n.useEffect(()=>{r()},[r]),n.useEffect(()=>{te()},[te,ee]),n.useEffect(()=>{function F(ie){Y.current&&!Y.current.contains(ie.target)&&h(null),u.current&&!u.current.contains(ie.target)&&$(!1)}return document.addEventListener("mousedown",F),()=>document.removeEventListener("mousedown",F)},[]),n.useEffect(()=>{c!==null&&p.current&&p.current.focus()},[c]);const be=O.filter(F=>{if(!N)return!0;const ie=N.toLowerCase();return F.code.toLowerCase().includes(ie)||F.name.toLowerCase().includes(ie)}),V=(F,ie,_e)=>{j(w=>{const le=[...w];return le[F]={...le[F],[ie]:_e},ie==="debit"&&_e>0?le[F].credit=0:ie==="credit"&&_e>0&&(le[F].debit=0),le})},S=(F,ie)=>{j(_e=>{const w=[..._e];return w[F]={...w[F],account_id:ie.id,account_code:ie.code,account_name:ie.name},w}),h(null),o("")},d=F=>{a.length<=2||j(ie=>ie.filter((_e,w)=>w!==F))},k=()=>{j(F=>[...F,It()])},ne=()=>{m(new Date().toISOString().split("T")[0]),P(""),j([It(),It()])},Se=F=>{const ie=F.lines.map(_e=>{const w=O.find(le=>le.code===_e.accountCode);return{key:crypto.randomUUID(),account_id:(w==null?void 0:w.id)||"",account_code:(w==null?void 0:w.code)||_e.accountCode,account_name:(w==null?void 0:w.name)||_e.label,description:"",debit:(_e.side==="debit",0),credit:(_e.side==="credit",0)}});P(F.description),j(ie),$(!1)},y=async()=>{if(!(!oe||!he)){R(!0);try{const{data:F,error:ie}=await l.rpc("generate_journal_entry_number");if(ie)throw ie;const{data:_e,error:w}=await l.from("journal_entries").insert({entry_number:F,entry_date:B,description:C||null,source_module:"manual",total_debit:D,total_credit:I,is_posted:!0,posted_by:M==null?void 0:M.id,created_by:M==null?void 0:M.id}).select("id").single();if(w)throw w;const le=a.filter(ye=>ye.account_id&&(ye.debit>0||ye.credit>0)).map((ye,De)=>({journal_entry_id:_e.id,line_number:De+1,account_id:ye.account_id,description:ye.description||null,debit:ye.debit||0,credit:ye.credit||0})),{error:je}=await l.from("journal_entry_lines").insert(le);if(je)throw je;fe("success","Journal Posted",`Entry ${F} posted successfully`),ne(),G()}catch(F){fe("error","Posting Failed",F.message||"Could not post journal entry")}finally{R(!1)}}},q=async F=>{const{data:ie}=await l.from("journal_entry_lines").select("line_number, account_id, description, debit, credit, chart_of_accounts(code, name)").eq("journal_entry_id",F.id).order("line_number");_({...F,lines:ie||[]}),g(!0)},xe=F=>F?new Intl.NumberFormat("id-ID",{minimumFractionDigits:0,maximumFractionDigits:2}).format(F):"-";return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-900",children:"Journal Voucher"}),e.jsx("p",{className:"text-sm text-gray-500 mt-0.5",children:"Manual double-entry journal posting"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsxs("div",{className:"relative",ref:u,children:[e.jsxs("button",{onClick:()=>$(!v),className:"flex items-center gap-1.5 px-3 py-2 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg border border-gray-300 transition-colors",children:[e.jsx(Ue,{className:"w-4 h-4"}),"Templates",e.jsx(Wt,{className:"w-3.5 h-3.5"})]}),v&&e.jsx("div",{className:"absolute right-0 top-full mt-1 w-72 bg-white rounded-lg shadow-xl border border-gray-200 z-50 py-1 max-h-80 overflow-y-auto",children:cs.map(F=>e.jsxs("button",{onClick:()=>Se(F),className:"w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:F.name}),e.jsx("div",{className:"text-xs text-gray-500",children:F.description})]},F.name))})]})})]}),x&&e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"p-4 border-b border-gray-100",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Date"}),e.jsx("input",{type:"date",value:B,onChange:F=>m(F.target.value),className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"sm:col-span-2",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-600 mb-1",children:"Narration / Description"}),e.jsx("input",{type:"text",value:C,onChange:F=>P(F.target.value),placeholder:"e.g. Loan received from Bank BCA",className:"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]})]})}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-gray-600",children:[e.jsx("th",{className:"text-left px-4 py-2.5 font-medium w-10",children:"#"}),e.jsx("th",{className:"text-left px-4 py-2.5 font-medium min-w-[280px]",children:"Account"}),e.jsx("th",{className:"text-left px-4 py-2.5 font-medium min-w-[160px]",children:"Line Narration"}),e.jsx("th",{className:"text-right px-4 py-2.5 font-medium w-36",children:"Debit"}),e.jsx("th",{className:"text-right px-4 py-2.5 font-medium w-36",children:"Credit"}),e.jsx("th",{className:"text-center px-2 py-2.5 font-medium w-20",children:"Actions"})]})}),e.jsx("tbody",{children:a.map((F,ie)=>e.jsxs("tr",{className:"border-t border-gray-100 hover:bg-gray-50/50",children:[e.jsx("td",{className:"px-4 py-2 text-gray-400 text-xs",children:ie+1}),e.jsx("td",{className:"px-4 py-2 relative",children:c===ie?e.jsxs("div",{ref:Y,className:"relative",children:[e.jsxs("div",{className:"flex items-center border border-blue-400 rounded-lg bg-white shadow-sm",children:[e.jsx(_t,{className:"w-4 h-4 text-gray-400 ml-2 shrink-0"}),e.jsx("input",{ref:p,type:"text",value:N,onChange:_e=>o(_e.target.value),placeholder:"Search account...",className:"w-full px-2 py-1.5 text-sm border-0 focus:ring-0 focus:outline-none"}),e.jsx("button",{onClick:()=>{h(null),o("")},className:"p-1 mr-1",children:e.jsx(yt,{className:"w-4 h-4 text-gray-400"})})]}),e.jsx("div",{className:"absolute left-0 top-full mt-1 w-full bg-white rounded-lg shadow-xl border border-gray-200 z-50 max-h-48 overflow-y-auto",children:be.length===0?e.jsx("div",{className:"px-4 py-3 text-sm text-gray-400",children:"No accounts found"}):be.map(_e=>e.jsxs("button",{onClick:()=>S(ie,_e),className:"w-full text-left px-3 py-2 hover:bg-blue-50 flex items-center gap-2 transition-colors",children:[e.jsx("span",{className:"text-xs font-mono text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded",children:_e.code}),e.jsx("span",{className:"text-sm text-gray-800 truncate",children:_e.name}),e.jsx("span",{className:"text-xs text-gray-400 ml-auto shrink-0",children:_e.account_type})]},_e.id))})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>{h(ie),o("")},className:`flex-1 text-left px-3 py-1.5 rounded-lg border transition-colors text-sm ${F.account_id?"border-gray-200 bg-white hover:border-gray-300":"border-dashed border-gray-300 text-gray-400 hover:border-blue-400 hover:text-blue-500"}`,children:F.account_id?e.jsxs("span",{children:[e.jsx("span",{className:"font-mono text-blue-600 mr-1.5",children:F.account_code}),F.account_name]}):"Select account..."}),F.account_id&&e.jsx("button",{onClick:W,title:"View Ledger",className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",children:e.jsx(oa,{className:"w-4 h-4"})})]})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"text",value:F.description,onChange:_e=>V(ie,"description",_e.target.value),placeholder:"Optional",className:"w-full px-2.5 py-1.5 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"number",min:"0",step:"any",value:F.debit||"",onChange:_e=>V(ie,"debit",parseFloat(_e.target.value)||0),placeholder:"0",className:"w-full px-2.5 py-1.5 text-sm text-right border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 tabular-nums"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"number",min:"0",step:"any",value:F.credit||"",onChange:_e=>V(ie,"credit",parseFloat(_e.target.value)||0),placeholder:"0",className:"w-full px-2.5 py-1.5 text-sm text-right border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 tabular-nums"})}),e.jsx("td",{className:"px-2 py-2 text-center",children:e.jsx("button",{onClick:()=>d(ie),disabled:a.length<=2,className:"p-1 text-gray-400 hover:text-red-500 disabled:opacity-30 disabled:cursor-not-allowed transition-colors",children:e.jsx(pt,{className:"w-4 h-4"})})})]},F.key))}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t-2 border-gray-300 bg-gray-50 font-semibold",children:[e.jsx("td",{className:"px-4 py-3",colSpan:3,children:e.jsxs("button",{onClick:k,className:"flex items-center gap-1.5 text-sm text-blue-600 hover:text-blue-800 transition-colors",children:[e.jsx(mt,{className:"w-4 h-4"})," Add Row"]})}),e.jsx("td",{className:`px-4 py-3 text-right tabular-nums ${D!==I?"text-red-600":"text-gray-900"}`,children:xe(D)}),e.jsx("td",{className:`px-4 py-3 text-right tabular-nums ${D!==I?"text-red-600":"text-gray-900"}`,children:xe(I)}),e.jsx("td",{})]})})]})}),e.jsxs("div",{className:"p-4 border-t border-gray-100 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3",children:[e.jsxs("div",{children:[D>0&&!oe&&e.jsxs("span",{className:"text-sm text-red-600 font-medium",children:["Difference: ",xe(Math.abs(D-I))," ",D>I?"(Debit excess)":"(Credit excess)"]}),oe&&he&&e.jsx("span",{className:"text-sm text-green-600 font-medium",children:"Balanced - ready to post"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:ne,className:"flex items-center gap-1.5 px-4 py-2 text-sm text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(Ta,{className:"w-4 h-4"})," Clear"]}),e.jsxs("button",{onClick:y,disabled:!oe||!he||Q,className:"flex items-center gap-1.5 px-5 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:[Q?e.jsx(aa,{className:"w-4 h-4 animate-spin"}):e.jsx(Oa,{className:"w-4 h-4"}),Q?"Posting...":"Post Journal"]})]})]})]}),e.jsxs("div",{className:"bg-white rounded-xl border border-gray-200 shadow-sm",children:[e.jsx("div",{className:"px-4 py-3 border-b border-gray-100",children:e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Manual Journal Entries"})}),A?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(aa,{className:"w-6 h-6 animate-spin text-blue-500"})}):Z.length===0?e.jsx("div",{className:"text-center py-12 text-gray-400 text-sm",children:"No manual journal entries in selected date range"}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-gray-600 text-xs uppercase",children:[e.jsx("th",{className:"text-left px-4 py-2.5 font-medium",children:"Entry #"}),e.jsx("th",{className:"text-left px-4 py-2.5 font-medium",children:"Date"}),e.jsx("th",{className:"text-left px-4 py-2.5 font-medium",children:"Description"}),e.jsx("th",{className:"text-right px-4 py-2.5 font-medium",children:"Debit"}),e.jsx("th",{className:"text-right px-4 py-2.5 font-medium",children:"Credit"}),e.jsx("th",{className:"text-center px-4 py-2.5 font-medium",children:"View"})]})}),e.jsx("tbody",{children:Z.map(F=>e.jsxs("tr",{className:"border-t border-gray-100 hover:bg-gray-50/80 transition-colors",children:[e.jsx("td",{className:"px-4 py-2.5 font-mono text-blue-700 font-medium",children:F.entry_number}),e.jsx("td",{className:"px-4 py-2.5 text-gray-600",children:new Date(F.entry_date).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})}),e.jsx("td",{className:"px-4 py-2.5 text-gray-800 max-w-xs truncate",children:F.description||"-"}),e.jsx("td",{className:"px-4 py-2.5 text-right tabular-nums",children:xe(F.total_debit)}),e.jsx("td",{className:"px-4 py-2.5 text-right tabular-nums",children:xe(F.total_credit)}),e.jsx("td",{className:"px-4 py-2.5 text-center",children:e.jsx("button",{onClick:()=>q(F),className:"p-1 text-gray-400 hover:text-blue-600 transition-colors",children:e.jsx(Lt,{className:"w-4 h-4"})})})]},F.id))})]})})]}),i&&T&&e.jsx(qe,{title:`Journal Entry: ${T.entry_number}`,onClose:()=>g(!1),size:"lg",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Date:"})," ",e.jsx("span",{className:"font-medium",children:new Date(T.entry_date).toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-500",children:"Status:"})," ",e.jsx("span",{className:`inline-flex px-2 py-0.5 text-xs rounded-full font-medium ${T.is_posted?"bg-green-100 text-green-700":"bg-yellow-100 text-yellow-700"}`,children:T.is_posted?"Posted":"Draft"})]})]}),T.description&&e.jsxs("div",{className:"text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Description:"})," ",e.jsx("span",{className:"text-gray-800",children:T.description})]}),e.jsxs("table",{className:"w-full text-sm border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-50 text-gray-600",children:[e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"#"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Account"}),e.jsx("th",{className:"text-left px-4 py-2 font-medium",children:"Description"}),e.jsx("th",{className:"text-right px-4 py-2 font-medium",children:"Debit"}),e.jsx("th",{className:"text-right px-4 py-2 font-medium",children:"Credit"})]})}),e.jsx("tbody",{children:T.lines.map(F=>{var ie,_e;return e.jsxs("tr",{className:"border-t border-gray-100",children:[e.jsx("td",{className:"px-4 py-2 text-gray-400",children:F.line_number}),e.jsxs("td",{className:"px-4 py-2",children:[e.jsx("span",{className:"font-mono text-blue-600 mr-1",children:(ie=F.chart_of_accounts)==null?void 0:ie.code}),(_e=F.chart_of_accounts)==null?void 0:_e.name]}),e.jsx("td",{className:"px-4 py-2 text-gray-600",children:F.description||"-"}),e.jsx("td",{className:"px-4 py-2 text-right tabular-nums",children:F.debit>0?xe(F.debit):"-"}),e.jsx("td",{className:"px-4 py-2 text-right tabular-nums",children:F.credit>0?xe(F.credit):"-"})]},F.line_number)})}),e.jsx("tfoot",{children:e.jsxs("tr",{className:"border-t-2 border-gray-300 bg-gray-50 font-semibold",children:[e.jsx("td",{colSpan:3,className:"px-4 py-2 text-right",children:"Total"}),e.jsx("td",{className:"px-4 py-2 text-right tabular-nums",children:xe(T.total_debit)}),e.jsx("td",{className:"px-4 py-2 text-right tabular-nums",children:xe(T.total_credit)})]})})]})]})})]})}const ds=x=>[{label:x.finance.vouchers,items:[{id:"purchase",label:x.finance.purchase,shortcut:"F9"},{id:"receipt",label:x.finance.receipt,shortcut:"F6"},{id:"payment",label:x.finance.payment,shortcut:"F5"},{id:"journal",label:x.finance.journal,shortcut:"F7"},{id:"contra",label:x.finance.contra,shortcut:"F4"},{id:"expenses",label:x.finance.expenses,shortcut:"F8"},{id:"petty_cash",label:x.finance.pettyCash}]},{label:x.finance.books,items:[{id:"ledger",label:x.finance.ledger,shortcut:"Ctrl+L"},{id:"journal_register",label:x.finance.journalRegister,shortcut:"Ctrl+J"},{id:"bank_ledger",label:x.finance.bankLedger},{id:"party_ledger",label:x.finance.partyLedger},{id:"bank_recon",label:x.finance.bankReconciliation}]},{label:x.finance.reports,collapsible:!0,items:[{id:"ca_reports",label:" "+x.finance.caReports,shortcut:"Ctrl+R"},{id:"trial_balance",label:x.finance.trialBalance},{id:"pnl",label:x.finance.profitLoss},{id:"balance_sheet",label:x.finance.balanceSheet},{id:"receivables",label:x.finance.receivables},{id:"payables",label:x.finance.payables},{id:"ageing",label:x.finance.ageing},{id:"tax",label:x.finance.taxReports}]},{label:x.finance.masters,collapsible:!0,items:[{id:"coa",label:x.finance.chartOfAccounts},{id:"suppliers",label:x.finance.suppliers},{id:"banks",label:x.finance.banks}]}];function ms(){const{profile:x}=Rt(),{t:W}=Ut(),{dateRange:L}=xt(),[G,ee]=n.useState("purchase"),[M,O]=n.useState(new Set),[K,Z]=n.useState(!1),H=(x==null?void 0:x.role)==="admin"||(x==null?void 0:x.role)==="accounts",A=n.useMemo(()=>!W||!W.finance?[]:ds(W),[W]),U=R=>{O(B=>{const m=new Set(B);return m.has(R)?m.delete(R):m.add(R),m})};n.useEffect(()=>{const R=B=>{if(!["INPUT","TEXTAREA","SELECT"].includes(B.target.tagName))if(B.key==="F2"){B.preventDefault();const m=document.querySelector('input[type="date"]');m&&m.focus()}else B.key==="F4"?(B.preventDefault(),ee("contra")):B.key==="F5"?(B.preventDefault(),ee("payment")):B.key==="F6"?(B.preventDefault(),ee("receipt")):B.key==="F7"?(B.preventDefault(),ee("journal")):B.key==="F8"?(B.preventDefault(),ee("expenses")):B.key==="F9"?(B.preventDefault(),ee("purchase")):B.key==="F10"?(B.preventDefault(),window.location.hash="sales"):B.ctrlKey&&B.key==="l"?(B.preventDefault(),ee("ledger")):B.ctrlKey&&B.key==="j"&&(B.preventDefault(),ee("journal_register"))};return window.addEventListener("keydown",R),()=>window.removeEventListener("keydown",R)},[]);const Q=()=>{var R;switch(G){case"purchase":return e.jsx(Ma,{canManage:H});case"receipt":return e.jsx(Ua,{canManage:H});case"payment":return e.jsx(Va,{canManage:H});case"journal":return e.jsx(os,{canManage:H,onNavigateToLedger:()=>ee("ledger")});case"contra":return e.jsx(Ga,{canManage:H});case"expenses":return e.jsx(Wa,{canManage:H});case"petty_cash":return e.jsx(za,{canManage:H,onNavigateToFundTransfer:()=>ee("contra")});case"ledger":return e.jsx(Ya,{});case"journal_register":return e.jsx(Ha,{canManage:H});case"bank_ledger":return e.jsx(Ja,{});case"party_ledger":return e.jsx(Za,{});case"bank_recon":return e.jsx(as,{canManage:H});case"trial_balance":return e.jsx(Gt,{initialReport:"trial_balance"});case"pnl":return e.jsx(Gt,{initialReport:"pnl"});case"balance_sheet":return e.jsx(Gt,{initialReport:"balance_sheet"});case"receivables":return e.jsx(Qa,{canManage:H});case"payables":return e.jsx(es,{canManage:H});case"ageing":return e.jsx(ts,{});case"tax":return e.jsx(is,{});case"ca_reports":return e.jsx(ls,{});case"coa":return e.jsx(ss,{canManage:H});case"suppliers":return e.jsx(ns,{canManage:H});case"banks":return e.jsx(rs,{canManage:H});default:return e.jsx("div",{className:"text-center p-8 text-gray-500",children:((R=W==null?void 0:W.common)==null?void 0:R.noData)||"No data available"})}};return e.jsx(Da,{children:e.jsxs("div",{className:"flex h-screen bg-gray-50",children:[!K&&e.jsx("div",{className:"fixed inset-0 z-40 bg-black/30 md:hidden",onClick:()=>Z(!0)}),!K&&e.jsx("div",{className:"fixed inset-y-0 left-0 z-50 w-48 bg-white border-r border-gray-200 flex flex-col md:relative md:z-auto",children:e.jsx("div",{className:"flex-1 overflow-y-auto",children:A.map((R,B)=>{const m=M.has(R.label),C=R.collapsible;return e.jsxs("div",{className:B>0?"border-t border-gray-200":"",children:[C?e.jsxs("button",{onClick:()=>U(R.label),className:"w-full px-2 py-1.5 text-[10px] font-semibold text-gray-500 uppercase tracking-wider flex items-center justify-between hover:bg-gray-50",children:[e.jsx("span",{children:R.label}),m?e.jsx(ca,{className:"w-3 h-3"}):e.jsx(Wt,{className:"w-3 h-3"})]}):e.jsx("div",{className:"px-2 py-1.5 text-[10px] font-semibold text-gray-500 uppercase tracking-wider",children:R.label}),!m&&e.jsx("div",{children:R.items.map(P=>e.jsx("button",{onClick:()=>ee(P.id),className:`w-full text-left px-3 py-1.5 text-xs transition-colors ${G===P.id?"bg-blue-50 text-blue-700 font-medium border-l-2 border-blue-600":"text-gray-700 hover:bg-gray-50 border-l-2 border-transparent"}`,children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{children:P.label}),P.shortcut&&e.jsx("span",{className:"text-[10px] text-gray-400",children:P.shortcut})]})},P.id))})]},R.label)})})}),e.jsxs("div",{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"bg-white border-b border-gray-200 px-3 md:px-6 py-3 flex items-center gap-3",children:[e.jsx("button",{onClick:()=>Z(!K),className:"p-1.5 hover:bg-gray-100 rounded transition-colors",title:K?"Show Menu":"Hide Menu",children:K?e.jsx(Sa,{className:"w-5 h-5 text-gray-600"}):e.jsx(yt,{className:"w-5 h-5 text-gray-600"})}),e.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:W.finance.title}),e.jsxs("span",{className:"text-xs text-gray-400 ml-2",children:[L.startDate," to ",L.endDate]})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-white",children:e.jsx("div",{className:"p-3 md:p-6",children:Q()})})]})]})})}function Bs(){return e.jsx(ms,{})}export{Bs as Finance};
