import{m as te,r as l,s as b,j as e}from"./index-05MON0zc.js";import{M as ae}from"./Modal-DojL8f5j.js";import{B as se}from"./book-open-DxKJGqJh.js";import{R as ne}from"./refresh-cw-COiX6GIZ.js";import{D as re}from"./download-DgYIVgez.js";function xe({selectedBank:v}){var F;const{dateRange:i}=te(),[f,q]=l.useState([]),[c,L]=l.useState(""),[g,z]=l.useState([]),[k,I]=l.useState(!1),[a,G]=l.useState(null),[S,w]=l.useState(!1),[C,B]=l.useState([]),[H,R]=l.useState(!1),[_,J]=l.useState(0),[K,D]=l.useState(!1),[h,E]=l.useState({balance:0,date:"2025-01-01"});l.useEffect(()=>{$()},[]),l.useEffect(()=>{v&&L(v)},[v]),l.useEffect(()=>{c&&O()},[c,i.startDate,i.endDate]),l.useEffect(()=>{S&&a&&a.type==="expense"&&Q()},[S,a]);const Q=async()=>{if(!(!a||a.type!=="expense")){R(!0);try{const{data:t}=await b.storage.from("expense-documents").list(`${a.id}/`);if(t&&t.length>0){const r=t.map(x=>{const{data:m}=b.storage.from("expense-documents").getPublicUrl(`${a.id}/${x.name}`);return m.publicUrl});B(r)}else B([])}catch(t){console.error("Error loading expense documents:",t),B([])}finally{R(!1)}}},$=async()=>{const{data:t}=await b.from("bank_accounts").select("*").order("bank_name");t&&q(t)},O=async()=>{if(c){I(!0);try{const t=f.find(s=>s.id===c),r=(t==null?void 0:t.opening_balance)||0,x=(t==null?void 0:t.opening_balance_date)||"2025-01-01";console.log("ðŸ“Š Loading ledger for bank:",t==null?void 0:t.bank_name,t==null?void 0:t.account_number,"ID:",c),console.log("ðŸ’° Opening Balance:",r,"as of",x),console.log("ðŸ“… Date Range:",i.startDate,"to",i.endDate);let m=r;if(i.startDate>x){console.log("ðŸ”„ Calculating opening balance from",x,"to",i.startDate);const{data:s}=await b.rpc("calculate_balance_between_dates",{p_bank_account_id:c,p_start_date:x,p_end_date:i.startDate});if(s&&s.length>0){const p=s[0].net_change||0;m=r+p,console.log("âœ… Net change:",p,"â†’ Effective opening balance:",m)}}J(m);const y=[],u=new Date(i.endDate);u.setDate(u.getDate()+1);const o=u.toISOString().split("T")[0],{data:j}=await b.from("bank_statement_lines").select("id, transaction_date, description, reference, debit_amount, credit_amount, matched_expense_id, matched_receipt_id, matched_entry_id, notes").eq("bank_account_id",c).gte("transaction_date",i.startDate).lt("transaction_date",o).order("transaction_date");console.log("âœ… Bank statement lines found:",(j==null?void 0:j.length)||0),j&&j.forEach(s=>{y.push({id:s.id,entry_date:s.transaction_date,particulars:s.description||"Bank Transaction",reference:s.reference||"-",debit:Number(s.debit_amount||0),credit:Number(s.credit_amount||0),type:"bank",linkedId:s.matched_expense_id||s.matched_receipt_id||s.matched_entry_id,notes:s.notes})}),y.sort((s,p)=>{const N=new Date(s.entry_date).getTime()-new Date(p.entry_date).getTime();if(N!==0)return N;const A=s.credit>0,M=p.credit>0;return A&&!M?-1:!A&&M?1:0});let P=m;const ee=y.map(s=>{const p=s.debit||0,N=s.credit||0;return P+=N-p,{id:s.id,entry_date:s.entry_date,particulars:s.particulars,reference:s.reference,debit:p,credit:N,running_balance:P}});z(ee)}catch(t){console.error("Error loading ledger:",t)}finally{I(!1)}}},V=async()=>{if(c)try{const{error:t}=await b.from("bank_accounts").update({opening_balance:h.balance,opening_balance_date:h.date}).eq("id",c);if(t)throw t;D(!1),await $(),await O()}catch(t){alert("Failed to update opening balance: "+t.message)}},W=()=>{const t=f.find(r=>r.id===c);t&&(E({balance:t.opening_balance,date:t.opening_balance_date||"2025-01-01"}),D(!0))},X=t=>({IDR:"Rp",USD:"$",EUR:"â‚¬"})[t]||t,d=(t,r)=>t===0?"-":`${X(r)} ${t.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,Y=()=>{const t=f.find(o=>o.id===c);if(!t)return;const r=["Date","Particulars","Reference","Debit (Dr)","Credit (Cr)","Balance"],x=g.map(o=>[new Date(o.entry_date).toLocaleDateString("id-ID"),o.particulars,o.reference,o.debit>0?d(o.debit,t.currency):"",o.credit>0?d(o.credit,t.currency):"",d(o.running_balance,t.currency)]),m=[`Bank Ledger - ${t.bank_name} (${t.account_number})`,`Period: ${new Date(i.startDate).toLocaleDateString("id-ID")} to ${new Date(i.endDate).toLocaleDateString("id-ID")}`,`Opening Balance: ${d(_,t.currency)}`,"",r.join(","),...x.map(o=>o.join(","))].join(`
`),y=new Blob([m],{type:"text/csv;charset=utf-8;"}),u=document.createElement("a");u.href=URL.createObjectURL(y),u.download=`bank_ledger_${t.bank_name}_${new Date().toISOString().split("T")[0]}.csv`,u.click()},n=f.find(t=>t.id===c),U=g.reduce((t,r)=>t+r.debit,0),T=g.reduce((t,r)=>t+r.credit,0),Z=_+T-U;return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-blue-600"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800",children:"Bank Ledger (Bank Book)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{onClick:O,disabled:!c||k,className:"flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ne,{className:`w-4 h-4 ${k?"animate-spin":""}`}),"Refresh"]}),e.jsxs("button",{onClick:Y,disabled:!c||g.length===0,className:"flex items-center gap-2 px-3 py-1.5 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(re,{className:"w-4 h-4"}),"Export"]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:c,onChange:t=>L(t.target.value),className:"w-full px-3 py-2 border rounded-lg max-w-md",children:[e.jsx("option",{value:"",children:"Select Bank Account"}),f.map(t=>e.jsxs("option",{value:t.id,children:[t.bank_name," - ",t.account_number," (",t.currency,")"]},t.id))]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Period is controlled by global date range at top"})]}),n&&e.jsx("div",{className:"mb-4 p-3 bg-blue-50 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-medium text-gray-700",children:["Opening Balance (as of ",new Date(i.startDate).toLocaleDateString("id-ID"),")"]}),e.jsx("p",{className:"text-lg font-bold text-blue-600",children:d(_,n.currency)}),i.startDate>n.opening_balance_date&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Adjusted for filtered date range"})]}),e.jsx("button",{onClick:W,className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700",children:"Update"})]})})]}),c&&e.jsx("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Date"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Particulars"}),e.jsx("th",{className:"px-3 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Ref No"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Debit (Dr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Credit (Cr)"}),e.jsx("th",{className:"px-3 py-3 text-right text-xs font-medium text-gray-700 uppercase tracking-wider",children:"Balance"})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[e.jsxs("tr",{className:"bg-blue-50 font-semibold",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",children:new Date(i.startDate).toLocaleDateString("id-ID")}),e.jsxs("td",{className:"px-3 py-2 text-sm text-gray-900",colSpan:2,children:["Opening Balance",i.startDate>((n==null?void 0:n.opening_balance_date)||"")&&e.jsx("span",{className:"ml-2 text-xs font-normal text-gray-600",children:"(adjusted for date filter)"})]}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right",children:"-"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:n&&d(_,n.currency)})]}),k?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"Loading entries..."})}):g.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"px-3 py-8 text-center text-gray-500",children:"No recorded transactions found for this period"})}):g.map(t=>e.jsxs("tr",{className:"hover:bg-blue-50 cursor-pointer transition-colors",onClick:()=>{G(t),w(!0)},children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",children:new Date(t.entry_date).toLocaleDateString("id-ID")}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-900",children:t.particulars}),e.jsx("td",{className:"px-3 py-2 text-sm text-gray-600 font-mono",children:t.reference}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-medium",children:n&&(t.debit>0?d(t.debit,n.currency):"-")}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-medium",children:n&&(t.credit>0?d(t.credit,n.currency):"-")}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-semibold",children:n&&d(t.running_balance,n.currency)})]},t.id)),g.length>0&&e.jsxs("tr",{className:"bg-gray-100 font-semibold border-t-2 border-gray-300",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900",colSpan:3,children:"Closing Balance"}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-red-600 text-right font-bold",children:n&&d(U,n.currency)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-green-600 text-right font-bold",children:n&&d(T,n.currency)}),e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-sm text-gray-900 text-right font-bold",children:n&&d(Z,n.currency)})]})]})]})})}),S&&a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",onClick:()=>w(!1),children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto",onClick:t=>t.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Transaction Details"}),e.jsx("button",{onClick:()=>w(!1),className:"text-gray-400 hover:text-gray-600",children:e.jsx("span",{className:"text-2xl",children:"Ã—"})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Date"}),e.jsx("p",{className:"font-medium",children:new Date(a.entry_date).toLocaleDateString("id-ID")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Reference"}),e.jsx("p",{className:"font-medium font-mono",children:a.reference})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Particulars"}),e.jsx("p",{className:"font-medium",children:a.particulars})]}),a.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Description"}),e.jsx("p",{className:"font-medium",children:a.description})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Debit"}),e.jsx("p",{className:"font-medium text-red-600",children:n&&(a.debit>0?d(a.debit,n.currency):"-")})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Credit"}),e.jsx("p",{className:"font-medium text-green-600",children:n&&(a.credit>0?d(a.credit,n.currency):"-")})]})]}),a.type==="expense"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Expense Category"}),e.jsx("p",{className:"font-medium capitalize",children:(F=a.expenseCategory)==null?void 0:F.replace("_"," ")})]}),H?e.jsx("div",{className:"text-center py-4",children:e.jsx("p",{className:"text-sm text-gray-500",children:"Loading documents..."})}):C.length>0?e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-gray-600 mb-2",children:["Attached Documents (",C.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:C.map((t,r)=>e.jsxs("a",{href:t,target:"_blank",rel:"noopener noreferrer",className:"block p-2 border rounded hover:bg-gray-50 text-sm text-blue-600 hover:text-blue-800 truncate",children:["Document ",r+1]},r))})]}):e.jsx("div",{className:"text-center py-2",children:e.jsx("p",{className:"text-sm text-gray-400",children:"No documents attached"})})]}),a.type==="receipt"&&a.customerName&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Customer"}),e.jsx("p",{className:"font-medium",children:a.customerName})]}),a.type==="payment"&&a.supplierName&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Supplier"}),e.jsx("p",{className:"font-medium",children:a.supplierName})]}),a.type==="bank"&&a.notes&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Notes"}),e.jsx("p",{className:"font-medium",children:a.notes})]}),a.type==="bank"&&a.linkedId&&e.jsx("div",{className:"bg-blue-50 p-3 rounded-lg",children:e.jsx("p",{className:"text-sm text-blue-900 font-medium",children:"This transaction is matched to a system entry"})})]}),e.jsx("div",{className:"mt-6 flex justify-end",children:e.jsx("button",{onClick:()=>w(!1),className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700",children:"Close"})})]})}),e.jsx(ae,{isOpen:K,onClose:()=>D(!1),title:"Update Opening Balance",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance Amount *"}),e.jsx("input",{type:"number",value:h.balance,onChange:t=>E({...h,balance:parseFloat(t.target.value)||0}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Opening Balance Date *"}),e.jsx("input",{type:"date",value:h.date,onChange:t=>E({...h,date:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Set the date when this opening balance is effective. All transactions from this date onwards will be included in the ledger."})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:()=>D(!1),className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Cancel"}),e.jsx("button",{onClick:V,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700",children:"Update"})]})]})})]})}export{xe as default};
