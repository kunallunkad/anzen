import{u as ie,r as i,s as o,j as t,A as B,F as A,T as F}from"./index-05MON0zc.js";import{D as E}from"./DataTable-DghMVdqP.js";import{M as $}from"./Modal-DojL8f5j.js";import{f as j}from"./dateFormat-E6B5rKFz.js";import{D as q}from"./Layout-9pjiZa2A.js";import{P as O}from"./plus-C8ciBmA_.js";import{S as I}from"./square-pen-pND7Nsfd.js";import"./search-CGgsAlNq.js";import"./chevron-up-TszMf-vQ.js";import"./chevron-down-C44n7mhs.js";function fe({canManage:f}){const{profile:de}=ie(),[m,N]=i.useState("bills"),[u,T]=i.useState([]),[R,L]=i.useState([]),[M,V]=i.useState([]),[w,k]=i.useState(!0),[U,b]=i.useState(!1),[Y,x]=i.useState(!1),[y,D]=i.useState(null),[g,C]=i.useState(null),[n,d]=i.useState({bill_number:"",vendor_name:"",vendor_id:"",bill_date:new Date().toISOString().split("T")[0],due_date:"",amount:0,tax_amount:0,category:"expense",description:""}),[r,c]=i.useState({bill_id:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""});i.useEffect(()=>{z()},[]);const z=async()=>{k(!0),await Promise.all([p(),v(),G()]),k(!1)},p=async()=>{try{const{data:e,error:a}=await o.from("vendor_bills").select("*").order("bill_date",{ascending:!1});if(a)throw a;T(e||[])}catch(e){console.error("Error loading bills:",e)}},v=async()=>{try{const{data:e,error:a}=await o.from("vendor_payments").select(`
          *,
          vendor_bills (
            bill_number,
            vendor_name
          ),
          bank_accounts (
            account_name,
            bank_name
          )
        `).order("payment_date",{ascending:!1});if(a)throw a;L(e||[])}catch(e){console.error("Error loading payments:",e)}},G=async()=>{try{const{data:e,error:a}=await o.from("bank_accounts").select("id, account_name, bank_name").eq("is_active",!0).order("account_name");if(a)throw a;V(e||[])}catch(e){console.error("Error loading bank accounts:",e)}},H=async()=>{const e="BILL",a=new Date().getFullYear(),{data:s}=await o.from("vendor_bills").select("bill_number").like("bill_number",`${e}-${a}%`).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s!=null&&s.bill_number){const l=parseInt(s.bill_number.split("-")[2]);return`${e}-${a}-${String(l+1).padStart(5,"0")}`}return`${e}-${a}-00001`},J=async()=>{const e="VPAY",a=new Date().getFullYear(),{data:s}=await o.from("vendor_payments").select("payment_number").like("payment_number",`${e}-${a}%`).order("created_at",{ascending:!1}).limit(1).maybeSingle();if(s!=null&&s.payment_number){const l=parseInt(s.payment_number.split("-")[2]);return`${e}-${a}-${String(l+1).padStart(5,"0")}`}return`${e}-${a}-00001`},K=async e=>{e.preventDefault();try{const{data:{user:a}}=await o.auth.getUser();if(!a)throw new Error("Not authenticated");const s=n.amount+n.tax_amount;if(y){const{error:l}=await o.from("vendor_bills").update({vendor_name:n.vendor_name,vendor_id:n.vendor_id||null,bill_date:n.bill_date,due_date:n.due_date||null,amount:n.amount,tax_amount:n.tax_amount,total_amount:s,category:n.category,description:n.description||null}).eq("id",y.id);if(l)throw l}else{const l=await H(),{error:P}=await o.from("vendor_bills").insert([{bill_number:l,vendor_name:n.vendor_name,vendor_id:n.vendor_id||null,bill_date:n.bill_date,due_date:n.due_date||null,amount:n.amount,tax_amount:n.tax_amount,total_amount:s,category:n.category,description:n.description||null,created_by:a.id}]);if(P)throw P}b(!1),h(),p()}catch(a){console.error("Error saving bill:",a),alert("Failed to save bill. Please try again.")}},Q=async e=>{e.preventDefault();try{const{data:{user:a}}=await o.auth.getUser();if(!a)throw new Error("Not authenticated");if(g){const{error:s}=await o.from("vendor_payments").update({payment_date:r.payment_date,amount:r.amount,payment_method:r.payment_method,bank_account_id:r.bank_account_id||null,reference_number:r.reference_number||null,notes:r.notes||null}).eq("id",g.id);if(s)throw s}else{const s=await J(),{error:l}=await o.from("vendor_payments").insert([{payment_number:s,bill_id:r.bill_id,payment_date:r.payment_date,amount:r.amount,payment_method:r.payment_method,bank_account_id:r.bank_account_id||null,reference_number:r.reference_number||null,notes:r.notes||null,created_by:a.id}]);if(l)throw l}x(!1),_(),v(),p()}catch(a){console.error("Error saving payment:",a),alert("Failed to save payment. Please try again.")}},W=e=>{D(e),d({bill_number:e.bill_number,vendor_name:e.vendor_name,vendor_id:e.vendor_id||"",bill_date:e.bill_date,due_date:e.due_date||"",amount:e.amount,tax_amount:e.tax_amount,category:e.category,description:e.description||""}),b(!0)},X=e=>{C(e),c({bill_id:e.bill_id,payment_date:e.payment_date,amount:e.amount,payment_method:e.payment_method,bank_account_id:e.bank_account_id||"",reference_number:e.reference_number||"",notes:e.notes||""}),x(!0)},Z=async e=>{if(confirm("Are you sure you want to delete this bill?"))try{const{error:a}=await o.from("vendor_bills").delete().eq("id",e);if(a)throw a;p()}catch(a){console.error("Error deleting bill:",a),alert("Failed to delete bill. Please try again.")}},ee=async e=>{if(confirm("Are you sure you want to delete this payment?"))try{const{error:a}=await o.from("vendor_payments").delete().eq("id",e);if(a)throw a;v(),p()}catch(a){console.error("Error deleting payment:",a),alert("Failed to delete payment. Please try again.")}},h=()=>{D(null),d({bill_number:"",vendor_name:"",vendor_id:"",bill_date:new Date().toISOString().split("T")[0],due_date:"",amount:0,tax_amount:0,category:"expense",description:""})},_=()=>{C(null),c({bill_id:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""})},te=e=>{switch(e){case"paid":return"bg-green-100 text-green-800";case"partial":return"bg-yellow-100 text-yellow-800";case"pending":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},ae=e=>e?{inventory:"Inventory",expense:"Expense",asset:"Asset",other:"Other"}[e]||e:"N/A",ne=e=>({cash:"Cash",bank_transfer:"Bank Transfer",cheque:"Cheque",credit_card:"Credit Card",other:"Other"})[e]||e,re=u.filter(e=>e.payment_status!=="paid").reduce((e,a)=>e+a.total_amount,0),se=u.filter(e=>!e.due_date||e.payment_status==="paid"?!1:new Date(e.due_date)<new Date),le=[{key:"bill_number",label:"Bill Number",render:e=>t.jsx("span",{className:"font-medium text-gray-900",children:e.bill_number})},{key:"vendor_name",label:"Vendor",render:e=>e.vendor_name},{key:"bill_date",label:"Bill Date",render:e=>j(e.bill_date)},{key:"due_date",label:"Due Date",render:e=>{if(!e.due_date)return"N/A";const s=new Date(e.due_date)<new Date&&e.payment_status!=="paid";return t.jsxs("span",{className:s?"text-red-600 font-medium":"",children:[j(e.due_date),s&&t.jsx(B,{className:"w-3 h-3 inline ml-1"})]})}},{key:"category",label:"Category",render:e=>ae(e.category)},{key:"total_amount",label:"Total Amount",render:e=>t.jsxs("span",{className:"font-semibold text-red-600",children:["Rp ",e.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"payment_status",label:"Status",render:e=>t.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${te(e.payment_status)}`,children:e.payment_status.toUpperCase()})}],oe=[{key:"payment_number",label:"Payment Number",render:e=>t.jsx("span",{className:"font-medium text-gray-900",children:e.payment_number})},{key:"bill",label:"Bill Number",render:e=>{var a;return((a=e.vendor_bills)==null?void 0:a.bill_number)||"N/A"}},{key:"vendor",label:"Vendor",render:e=>{var a;return((a=e.vendor_bills)==null?void 0:a.vendor_name)||"N/A"}},{key:"payment_date",label:"Payment Date",render:e=>j(e.payment_date)},{key:"amount",label:"Amount",render:e=>t.jsxs("span",{className:"font-semibold text-green-600",children:["Rp ",e.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"payment_method",label:"Method",render:e=>ne(e.payment_method)},{key:"bank_account",label:"Bank Account",render:e=>e.bank_accounts?`${e.bank_accounts.account_name} - ${e.bank_accounts.bank_name}`:"N/A"}],S=u.filter(e=>e.payment_status!=="paid");return t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx("div",{className:"bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow p-6 text-white",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-red-100",children:"Total Payable"}),t.jsxs("p",{className:"text-2xl font-bold mt-1",children:["Rp ",re.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),t.jsx(q,{className:"w-8 h-8 text-red-200"})]})}),t.jsx("div",{className:"bg-orange-50 rounded-lg shadow p-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-orange-600",children:"Overdue Bills"}),t.jsx("p",{className:"text-2xl font-bold text-orange-600 mt-1",children:se.length})]}),t.jsx(B,{className:"w-8 h-8 text-orange-400"})]})}),t.jsx("div",{className:"bg-blue-50 rounded-lg shadow p-6",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm text-blue-600",children:"Total Bills"}),t.jsx("p",{className:"text-2xl font-bold text-blue-600 mt-1",children:u.length})]}),t.jsx(A,{className:"w-8 h-8 text-blue-400"})]})})]}),t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex gap-2",children:[t.jsxs("button",{onClick:()=>N("bills"),className:`px-4 py-2 rounded-lg transition ${m==="bills"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[t.jsx(A,{className:"w-4 h-4 inline mr-2"}),"Bills"]}),t.jsxs("button",{onClick:()=>N("payments"),className:`px-4 py-2 rounded-lg transition ${m==="payments"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[t.jsx(q,{className:"w-4 h-4 inline mr-2"}),"Payments"]})]}),f&&t.jsxs("div",{className:"flex gap-2",children:[m==="bills"&&t.jsxs("button",{onClick:()=>{h(),b(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition",children:[t.jsx(O,{className:"w-5 h-5"}),"Add Bill"]}),m==="payments"&&t.jsxs("button",{onClick:()=>{_(),x(!0)},className:"flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition",children:[t.jsx(O,{className:"w-5 h-5"}),"Record Payment"]})]})]}),m==="bills"?t.jsx(E,{columns:le,data:u,loading:w,actions:f?e=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>W(e),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:t.jsx(I,{className:"w-4 h-4"})}),t.jsx("button",{onClick:()=>Z(e.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:t.jsx(F,{className:"w-4 h-4"})})]}):void 0}):t.jsx(E,{columns:oe,data:R,loading:w,actions:f?e=>t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>X(e),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:t.jsx(I,{className:"w-4 h-4"})}),t.jsx("button",{onClick:()=>ee(e.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:t.jsx(F,{className:"w-4 h-4"})})]}):void 0}),t.jsx($,{isOpen:U,onClose:()=>{b(!1),h()},title:y?"Edit Vendor Bill":"Add Vendor Bill",children:t.jsxs("form",{onSubmit:K,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor Name *"}),t.jsx("input",{type:"text",value:n.vendor_name,onChange:e=>d({...n,vendor_name:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Vendor ID (Optional)"}),t.jsx("input",{type:"text",value:n.vendor_id,onChange:e=>d({...n,vendor_id:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Category *"}),t.jsxs("select",{value:n.category||"",onChange:e=>d({...n,category:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[t.jsx("option",{value:"expense",children:"Expense"}),t.jsx("option",{value:"inventory",children:"Inventory"}),t.jsx("option",{value:"asset",children:"Asset"}),t.jsx("option",{value:"other",children:"Other"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bill Date *"}),t.jsx("input",{type:"date",value:n.bill_date,onChange:e=>d({...n,bill_date:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Due Date"}),t.jsx("input",{type:"date",value:n.due_date,onChange:e=>d({...n,due_date:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),t.jsx("input",{type:"number",value:n.amount===0?"":n.amount,onChange:e=>d({...n,amount:e.target.value===""?0:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tax Amount (Rp)"}),t.jsx("input",{type:"number",value:n.tax_amount===0?"":n.tax_amount,onChange:e=>d({...n,tax_amount:e.target.value===""?0:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",min:"0",step:"0.01"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Total Amount"}),t.jsxs("div",{className:"text-2xl font-bold text-gray-900",children:["Rp ",(n.amount+n.tax_amount).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Description"}),t.jsx("textarea",{value:n.description,onChange:e=>d({...n,description:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:3})]})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[t.jsx("button",{type:"button",onClick:()=>{b(!1),h()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),t.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:y?"Update Bill":"Add Bill"})]})]})}),t.jsx($,{isOpen:Y,onClose:()=>{x(!1),_()},title:g?"Edit Payment":"Record Payment",children:t.jsxs("form",{onSubmit:Q,className:"space-y-4",children:[t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bill *"}),t.jsxs("select",{value:r.bill_id,onChange:e=>{const a=e.target.value,s=S.find(l=>l.id===a);c({...r,bill_id:a,amount:s?s.total_amount:0})},className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,disabled:!!g,children:[t.jsx("option",{value:"",children:"Select a bill"}),S.map(e=>t.jsxs("option",{value:e.id,children:[e.bill_number," - ",e.vendor_name," (Rp ",e.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2}),")"]},e.id))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Date *"}),t.jsx("input",{type:"date",value:r.payment_date,onChange:e=>c({...r,payment_date:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),t.jsx("input",{type:"number",value:r.amount===0?"":r.amount,onChange:e=>c({...r,amount:e.target.value===""?0:Number(e.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),t.jsxs("select",{value:r.payment_method,onChange:e=>c({...r,payment_method:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[t.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),t.jsx("option",{value:"cash",children:"Cash"}),t.jsx("option",{value:"cheque",children:"Cheque"}),t.jsx("option",{value:"credit_card",children:"Credit Card"}),t.jsx("option",{value:"other",children:"Other"})]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),t.jsxs("select",{value:r.bank_account_id,onChange:e=>c({...r,bank_account_id:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[t.jsx("option",{value:"",children:"Select bank account"}),M.map(e=>t.jsxs("option",{value:e.id,children:[e.account_name," - ",e.bank_name]},e.id))]})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),t.jsx("input",{type:"text",value:r.reference_number,onChange:e=>c({...r,reference_number:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"Transaction/Check number"})]}),t.jsxs("div",{className:"col-span-2",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),t.jsx("textarea",{value:r.notes,onChange:e=>c({...r,notes:e.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:3})]})]}),t.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[t.jsx("button",{type:"button",onClick:()=>{x(!1),_()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),t.jsx("button",{type:"submit",className:"px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition",children:g?"Update Payment":"Record Payment"})]})]})})]})}export{fe as PayablesManager};
