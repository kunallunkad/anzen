import{c as F,r as S,s as b,j as e,F as I,C as Q,u as B}from"./index-05MON0zc.js";import{D as T,P as z,M as W,C as Z,L as J,Z as G}from"./Layout-9pjiZa2A.js";import{M as A}from"./mail-cPtJJUOl.js";import{R as V}from"./refresh-cw-COiX6GIZ.js";import{S as E}from"./sparkles-A007ZmUx.js";import{E as H,L as K,C as X}from"./CompactInquiryForm-BFm_etZd.js";import{C as P}from"./check-circle-2-B8I5xse-.js";import{C as R}from"./chevron-up-TszMf-vQ.js";import{C as L}from"./chevron-down-C44n7mhs.js";import{M as Y}from"./Modal-DojL8f5j.js";import{S as M}from"./send-CLMEfVND.js";import{P as U}from"./phone-ji2YOq_r.js";import"./dateFormat-E6B5rKFz.js";import"./purify.es-B9ZVCkUG.js";import"./search-CGgsAlNq.js";import"./plus-C8ciBmA_.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const O=F("TestTube",[["path",{d:"M14.5 2v17.5c0 1.4-1.1 2.5-2.5 2.5h0c-1.4 0-2.5-1.1-2.5-2.5V2",key:"187lwq"}],["path",{d:"M8.5 2h7",key:"csnxdl"}],["path",{d:"M14.5 16h-5",key:"1ox875"}]]);function D({onEmailSelect:c,selectedEmailId:t}){const[w,x]=S.useState([]),[n,N]=S.useState(!0),[l,y]=S.useState(!1),[_,v]=S.useState(null),g=S.useCallback(async()=>{try{const{data:i,error:o}=await b.from("crm_email_inbox").select("*").eq("is_processed",!1).order("received_date",{ascending:!1}).limit(50);if(o)throw o;x(i||[])}catch(i){console.error("Error loading emails:",i)}finally{N(!1),y(!1)}},[]),q=S.useCallback(async()=>{y(!0);try{const{data:{session:i}}=await b.auth.getSession();if(!i){console.error("Not authenticated"),y(!1);return}const o="https://dkrtsqienlhpouohmfki.supabase.co/functions/v1/sync-gmail-emails",m=new AbortController,h=setTimeout(()=>m.abort(),12e4),u=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${i.access_token}`,"Content-Type":"application/json"},signal:m.signal});if(clearTimeout(h),!u.ok)throw new Error(`Sync failed: ${u.status}`);await u.json(),await g()}catch(i){console.error("Error syncing emails:",i),await g()}finally{y(!1)}},[g]);S.useEffect(()=>{g();const i=b.channel("email_inbox_changes").on("postgres_changes",{event:"*",schema:"public",table:"crm_email_inbox"},()=>{g()}).subscribe(),o=setInterval(()=>{q()},6e5);return()=>{i.unsubscribe(),clearInterval(o)}},[g,q]),S.useEffect(()=>{(async()=>{const o=sessionStorage.getItem("pendingEmailForInquiry");if(o){console.log("[EmailListPanel] Found pending email in sessionStorage"),sessionStorage.removeItem("pendingEmailForInquiry"),document.body.style.cursor="wait";try{const m=JSON.parse(o);console.log("[EmailListPanel] Parsed email data:",m);const{data:{session:h}}=await b.auth.getSession();if(!h)throw console.error("[EmailListPanel] No session found"),new Error("Not authenticated");try{const{data:p}=await b.from("crm_inquiries").select("id, inquiry_number, product_name").eq("mail_subject",m.subject).maybeSingle();if(p){if(!confirm(`This email has already been processed as Inquiry #${p.inquiry_number} (${p.product_name}).

Do you want to reprocess it?`)){console.log("[EmailListPanel] User declined to reprocess existing inquiry"),sessionStorage.removeItem("pendingEmailForCommandCenter");return}console.log("[EmailListPanel] User confirmed reprocessing existing inquiry")}}catch(p){console.warn("[EmailListPanel] Could not check for duplicates (continuing anyway):",p)}console.log("[EmailListPanel] Calling parse-pharma-email edge function");const u="https://dkrtsqienlhpouohmfki.supabase.co/functions/v1/parse-pharma-email";console.log("[EmailListPanel] API URL:",u),console.log("[EmailListPanel] Request body:",{emailSubject:m.subject,emailBody:m.body.substring(0,100)+"...",fromEmail:m.fromEmail,fromName:m.fromName});const j=await fetch(u,{method:"POST",headers:{Authorization:`Bearer ${h.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({emailSubject:m.subject,emailBody:m.body,fromEmail:m.fromEmail,fromName:m.fromName})});if(console.log("[EmailListPanel] Response status:",j.status),!j.ok){const p=await j.text();throw console.error("[EmailListPanel] Response error:",p),new Error(`Edge function returned ${j.status}: ${p}`)}const a=await j.json();if(console.log("[EmailListPanel] Parse result:",a),a.success||a.fallbackData){const p={id:"gmail-"+Date.now(),from_email:m.fromEmail,from_name:m.fromName,subject:m.subject,body:m.body,received_date:m.date,is_processed:!1,is_inquiry:!1,parsed_data:null,converted_to_inquiry:null};console.log("[EmailListPanel] Calling onEmailSelect with mock email"),c(p,a.data||a.fallbackData)}else console.error("[EmailListPanel] Parse failed:",a.error),alert("Failed to parse email from Gmail: "+a.error)}catch(m){console.error("[EmailListPanel] Error processing pending email:",m),alert(`Failed to process email: ${m instanceof Error?m.message:String(m)}`)}finally{document.body.style.cursor="default"}}else console.log("[EmailListPanel] No pending email found in sessionStorage")})()},[c]);const s=async i=>{v(i.id),document.body.style.cursor="wait";try{const{data:{session:o}}=await b.auth.getSession();if(!o)throw new Error("Not authenticated");const u=await(await fetch("https://dkrtsqienlhpouohmfki.supabase.co/functions/v1/parse-pharma-email",{method:"POST",headers:{Authorization:`Bearer ${o.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({emailSubject:i.subject,emailBody:i.body,fromEmail:i.from_email,fromName:i.from_name})})).json();u.success?c(i,u.data):u.fallbackData?c(i,u.fallbackData):(alert("Failed to parse email: "+u.error),c(i,null))}catch(o){console.error("Error parsing email:",o),alert("Failed to parse email. Please try again.")}finally{v(null),document.body.style.cursor="default"}},r=i=>{var j,a;const o=((j=i.body)==null?void 0:j.toLowerCase())||"",m=((a=i.subject)==null?void 0:a.toLowerCase())||"",h=o+" "+m,u=[];return(h.includes("price")||h.includes("harga")||h.includes("quotation")||h.includes("quote"))&&u.push({icon:T,color:"text-green-600",label:"Price"}),(h.includes("coa")||h.includes("certificate")||h.includes("analysis"))&&u.push({icon:I,color:"text-blue-600",label:"COA"}),(h.includes("msds")||h.includes("safety")||h.includes("data sheet"))&&u.push({icon:I,color:"text-orange-600",label:"MSDS"}),(h.includes("sample")||h.includes("sampel"))&&u.push({icon:O,color:"text-purple-600",label:"Sample"}),u},d=i=>{const m=(i.body||"").split(`
`).filter(a=>a.trim().length>0);let h="",u="",j="";for(const a of m.slice(0,20)){const p=a.toLowerCase();if(!h&&(p.includes("product")||p.includes("material")||p.includes("item"))&&(h=a.replace(/^[^:]+:/,"").trim().substring(0,50)),!u&&(p.includes("qty")||p.includes("quantity")||p.includes("kg")||p.includes("mt"))){const k=a.match(/\d+\s*(kg|mt|ton|units?|pcs)/i);k&&(u=k[0])}!j&&(p.includes("supplier")||p.includes("manufacturer")||p.includes("origin"))&&(j=a.replace(/^[^:]+:/,"").trim().substring(0,30))}return{product:h,quantity:u,supplier:j}},f=i=>{const o=(i.subject+" "+i.body).toLowerCase();return o.includes("urgent")||o.includes("asap")||o.includes("segera")||o.includes("mendesak")};return n?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading emails..."})]})}):e.jsxs("div",{className:"flex flex-col h-full bg-white border-r border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(A,{className:"w-5 h-5 text-blue-600"}),e.jsx("h2",{className:"font-semibold text-gray-900",children:"New Emails"}),e.jsx("span",{className:"px-2 py-0.5 text-xs font-medium bg-blue-100 text-blue-700 rounded-full",children:w.length})]}),e.jsx("button",{onClick:q,disabled:l,className:"p-1.5 hover:bg-gray-200 rounded-lg transition",title:"Refresh emails",children:e.jsx(V,{className:`w-4 h-4 text-gray-600 ${l?"animate-spin":""}`})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:w.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center px-4",children:[e.jsx(A,{className:"w-16 h-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium",children:"No unprocessed emails"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"New emails will appear here automatically"})]}):e.jsx("div",{className:"divide-y divide-gray-100",children:w.map(i=>{const o=d(i),m=r(i),h=f(i),u=t===i.id,j=_===i.id;return e.jsxs("div",{onClick:()=>!j&&s(i),className:`p-4 cursor-pointer transition ${u?"bg-blue-50 border-l-4 border-blue-600":"hover:bg-gray-50 border-l-4 border-transparent"} ${j?"opacity-50 cursor-wait":""}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-semibold text-gray-900 truncate",children:i.from_name||i.from_email}),h&&e.jsx("span",{className:"flex-shrink-0 px-1.5 py-0.5 text-xs font-bold bg-red-100 text-red-700 rounded",children:"URGENT"})]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:i.from_email})]}),j&&e.jsx(E,{className:"w-5 h-5 text-blue-600 animate-pulse flex-shrink-0 ml-2"})]}),e.jsx("p",{className:"text-sm font-medium text-gray-800 mb-2 line-clamp-1",children:i.subject}),(o.product||o.quantity)&&e.jsxs("div",{className:"space-y-1 mb-2",children:[o.product&&e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(z,{className:"w-3.5 h-3.5 text-gray-400 mt-0.5 flex-shrink-0"}),e.jsx("span",{className:"text-xs text-gray-600 line-clamp-1",children:o.product})]}),o.quantity&&e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"text-xs font-medium text-blue-600",children:o.quantity})})]}),m.length>0&&e.jsx("div",{className:"flex items-center gap-2 mb-2",children:m.map((a,p)=>e.jsxs("div",{className:"flex items-center gap-1 px-2 py-0.5 bg-gray-100 rounded",title:a.label,children:[e.jsx(a.icon,{className:`w-3 h-3 ${a.color}`}),e.jsx("span",{className:"text-xs text-gray-600",children:a.label})]},p))}),e.jsxs("div",{className:"flex items-center justify-between mt-2",children:[e.jsx("span",{className:"text-xs text-gray-500",children:new Date(i.received_date).toLocaleString("en-US",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}),!j&&e.jsxs("span",{className:"text-xs text-blue-600 font-medium flex items-center gap-1",children:[e.jsx(E,{className:"w-3 h-3"}),"AI Parse"]})]})]},i.id)})})})]})}function ee({email:c,parsedData:t,onSave:w,saving:x}){const[n,N]=S.useState(!1),[l,y]=S.useState(null),[_,v]=S.useState(!1),g=(t==null?void 0:t.products)&&t.products.length>1;S.useEffect(()=>{var r,d;if(console.log("[InquiryFormPanel] useEffect triggered",{email:c,parsedData:t}),t){let f=t.contactPerson||"",i=t.contactEmail||"";if(typeof f=="object"&&!Array.isArray(f)?f=f.name||"":Array.isArray(f)&&(f=((r=f[0])==null?void 0:r.name)||f[0]||""),typeof i=="object"&&!Array.isArray(i)?i=i.email||"":Array.isArray(i)&&(i=((d=i[0])==null?void 0:d.email)||i[0]||""),typeof i=="string"){i=i.replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim();const h=/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/g,u=[];let j;for(;(j=h.exec(i))!==null;)u.includes(j[1])||u.push(j[1]);u.length>0&&(i=u.join(", "))}typeof f=="string"&&(f=f.replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim());let o=t.companyName||"";typeof o=="string"&&(o=o.replace(/<[^>]+>/g,"").replace(/\s+/g," ").trim());const m={product_name:t.productName||"",specification:t.specification||"",quantity:t.quantity||"",supplier_name:t.supplierName||"",supplier_country:t.supplierCountry||"",company_name:o,contact_person:f,contact_email:i,contact_phone:t.contactPhone||"",priority:t.urgency||"medium",delivery_date:t.deliveryDateExpected||"",remarks:t.remarks||"",coa_required:g?!0:t.coaRequested||!1,sample_required:t.sampleRequested||!1,price_required:g?!0:t.priceRequested||!0,agency_letter_required:t.agencyLetterRequested||!1,aceerp_no:"",purchase_price:"",purchase_price_currency:"USD",offered_price:"",offered_price_currency:"USD",delivery_terms:"",inquiry_source:"email",mail_subject:(c==null?void 0:c.subject)||"",is_multi_product:g,products:t.products||[]};console.log("[InquiryFormPanel] Setting initialData:",m),y(m),g&&v(!0)}},[t,c,g]);const q=async r=>{const d={inquiryNumber:"",productName:r.product_name,specification:r.specification||"",quantity:r.quantity,supplierName:r.supplier_name||"",supplierCountry:r.supplier_country||"",companyName:r.company_name,contactPerson:r.contact_person||"",contactEmail:r.contact_email||"",contactPhone:r.contact_phone||"",priority:r.priority,purposeIcons:[],deliveryDateExpected:r.delivery_date||"",remarks:r.remarks||"",coaRequested:r.coa_required||!1,msdsRequested:!1,sampleRequested:r.sample_required||!1,priceRequested:r.price_required||!1,agencyLetterRequested:r.agency_letter_required||!1,aceerp_no:r.aceerp_no||"",purchasePrice:r.purchase_price||"",purchasePriceCurrency:r.purchase_price_currency||"USD",offeredPrice:r.offered_price||"",offeredPriceCurrency:r.offered_price_currency||"USD",deliveryDate:r.delivery_date||"",deliveryTerms:r.delivery_terms||"",isMultiProduct:r.is_multi_product||!1,products:r.products||[]};await w(d)},s={high:"text-green-600 bg-green-50 border-green-200",medium:"text-yellow-600 bg-yellow-50 border-yellow-200",low:"text-red-600 bg-red-50 border-red-200"};return!c||!t?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center px-8 bg-gray-50",children:[e.jsx(I,{className:"w-20 h-20 text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No Email Selected"}),e.jsx("p",{className:"text-gray-600 max-w-md",children:"Click on an email from the left panel to automatically parse and fill this inquiry form with AI"}),e.jsxs("div",{className:"mt-6 text-sm text-gray-500 space-y-1",children:[e.jsxs("p",{className:"flex items-center gap-2 justify-center",children:[e.jsx(E,{className:"w-4 h-4 text-blue-500"}),e.jsx("span",{children:"AI extracts product, quantity, company, contact"})]}),e.jsxs("p",{className:"flex items-center gap-2 justify-center",children:[e.jsx(P,{className:"w-4 h-4 text-green-500"}),e.jsx("span",{children:"Only inquiry number needs manual input"})]})]})]}):e.jsxs("div",{className:"flex flex-col h-full bg-white",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-transparent",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Create Inquiry"}),t&&e.jsx("div",{className:`px-3 py-1 rounded-lg text-sm font-medium border ${s[t.confidence]}`,children:e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(E,{className:"w-3.5 h-3.5"}),e.jsxs("span",{children:["AI Confidence: ",t.confidence.toUpperCase()]}),e.jsxs("span",{className:"text-xs",children:["(",Math.round(t.confidenceScore*100),"%)"]})]})})]}),c&&e.jsxs("div",{className:"mt-3 bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden",children:[e.jsxs("button",{type:"button",onClick:()=>N(!n),className:"w-full flex items-center justify-between px-5 py-3 hover:bg-gray-50 transition border-b border-gray-200",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:e.jsx("span",{className:"text-sm font-bold text-blue-700",children:(c.from_name||c.from_email).charAt(0).toUpperCase()})}),e.jsxs("div",{className:"text-left flex-1 min-w-0",children:[e.jsx("p",{className:"text-base font-semibold text-gray-900 truncate",children:c.subject}),e.jsxs("div",{className:"flex items-center gap-2 mt-0.5",children:[e.jsx("p",{className:"text-sm text-gray-900 font-medium",children:c.from_name||"Unknown"}),e.jsx("span",{className:"text-gray-400 text-xs",children:"•"}),e.jsxs("p",{className:"text-xs text-gray-500 truncate",children:["<",c.from_email,">"]})]})]})]}),n?e.jsx(R,{className:"w-5 h-5 text-gray-500 flex-shrink-0 ml-2"}):e.jsx(L,{className:"w-5 h-5 text-gray-500 flex-shrink-0 ml-2"})]}),n&&e.jsxs("div",{className:"bg-white",children:[e.jsx("div",{className:"px-5 py-3 border-b border-gray-100 bg-gray-50",children:e.jsx("p",{className:"text-xs text-gray-500 uppercase tracking-wide font-semibold",children:new Date(c.received_date).toLocaleString("en-US",{weekday:"short",year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})})}),e.jsx("div",{className:"px-5 py-4",children:e.jsx(H,{htmlContent:c.body,className:"max-h-[600px]"})}),e.jsx("div",{className:"px-5 py-3 bg-blue-50 border-t border-blue-100",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-blue-700",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{className:"font-medium",children:"AI has extracted data from this email. Review the form fields below."})]})})]})]}),(t==null?void 0:t.autoDetectedCompany)&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-green-700 bg-green-50 px-3 py-1.5 rounded-lg mt-3",children:[e.jsx(P,{className:"w-4 h-4"}),e.jsx("span",{children:"Company auto-detected from email domain"})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto px-6 py-4",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(P,{className:"w-5 h-5 text-green-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-900 mb-1",children:"Auto-Generated Inquiry Number"}),e.jsx("p",{className:"text-xs text-green-700",children:"Inquiry number will be automatically generated when you save (format: INQ-2025-NNNN)"})]})]})}),g&&(t==null?void 0:t.products)&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-5 h-5 text-blue-600"}),e.jsxs("h3",{className:"text-sm font-semibold text-blue-900",children:["Multi-Product Inquiry Detected (",t.products.length," Products)"]})]}),e.jsx("button",{type:"button",onClick:()=>v(!_),className:"text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1",children:_?e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"w-4 h-4"}),"Hide Products"]}):e.jsxs(e.Fragment,{children:[e.jsx(L,{className:"w-4 h-4"}),"Show Products"]})})]}),e.jsxs("p",{className:"text-xs text-blue-700 mb-3",children:["This will create a parent inquiry and ",t.products.length," child inquiries with numbers like INQ-2025-001.1, INQ-2025-001.2, etc."]}),_&&e.jsx("div",{className:"bg-white rounded-lg border border-blue-200 overflow-hidden overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-blue-100",children:[e.jsx("thead",{className:"bg-blue-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"#"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Product Name"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Specification"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Quantity"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Supplier / Origin"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Delivery Date"}),e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold text-blue-900",children:"Delivery Terms"})]})}),e.jsx("tbody",{className:"divide-y divide-blue-100",children:t.products.map((r,d)=>e.jsxs("tr",{className:"hover:bg-blue-50",children:[e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:d+1}),e.jsx("td",{className:"px-3 py-2 text-xs font-medium text-gray-900",children:r.productName||r.product_name}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:r.specification||r.spec||"-"}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:r.quantity||"-"}),e.jsxs("td",{className:"px-3 py-2 text-xs text-gray-700",children:[r.supplierName||r.supplier_name||r.origin||"-",(r.supplierCountry||r.supplier_country)&&` (${r.supplierCountry||r.supplier_country})`]}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:r.deliveryDate||r.delivery_date||r.tglDatang||r.tgl_datang||"-"}),e.jsx("td",{className:"px-3 py-2 text-xs text-gray-700",children:r.deliveryTerms||r.delivery_terms||"-"})]},d))})]})})]}),l&&e.jsx(X,{onSubmit:q,onCancel:()=>{},initialData:l,isEditing:!1})]})})]})}async function se(c,t,w,x,n){var N;try{const{data:l,error:y}=await b.from("crm_inquiries").select("*").eq("id",c).single();if(y)throw y;let _=l.status,v=!1;const g={};switch(t){case"send_price":g.price_quoted=!0,g.price_quoted_date=new Date().toISOString().split("T")[0],_="price_quoted",v=!0;break;case"send_coa":g.coa_sent=!0,g.coa_sent_date=new Date().toISOString().split("T")[0],l.price_quoted&&l.coa_sent&&(_="negotiation",v=!0);break;case"send_msds":g.msds_sent=!0,g.msds_sent_date=new Date().toISOString().split("T")[0];break;case"send_sample":g.sample_sent=!0,g.sample_sent_date=new Date().toISOString().split("T")[0],_="sample_sent",v=!0;break}if(v&&(g.status=_),Object.keys(g).length>0){const{error:d}=await b.from("crm_inquiries").update(g).eq("id",c);if(d)throw d}let q;const{data:s}=await b.rpc("auto_create_followup",{p_inquiry_id:c,p_action_type:t,p_user_id:x});s&&(q=s);const{error:r}=await b.from("crm_quick_actions_log").insert({inquiry_id:c,action_type:t,action_label:w,email_sent:!!(n!=null&&n.emailTo),email_to:(n==null?void 0:n.emailTo)||null,email_subject:(n==null?void 0:n.emailSubject)||null,email_body:(n==null?void 0:n.emailBody)||null,template_used:(n==null?void 0:n.templateId)||null,old_status:l.status,new_status:_,status_updated:v,follow_up_created:!!q,follow_up_reminder_id:q||null,notes:(n==null?void 0:n.notes)||null,performed_by:x});if(r)throw r;if(n!=null&&n.emailTo&&(n!=null&&n.emailSubject)&&(n!=null&&n.emailBody)){const{error:d}=await b.from("crm_email_activities").insert({inquiry_id:c,email_type:"sent",from_email:(N=(await b.auth.getUser()).data.user)==null?void 0:N.email,to_email:[n.emailTo],subject:n.emailSubject,body:n.emailBody,template_id:n.templateId||null,sent_date:new Date().toISOString(),created_by:x});d&&console.error("Error logging email:",d)}return{success:!0,reminderId:q}}catch(l){return console.error("Error performing quick action:",l),{success:!1,error:l instanceof Error?l.message:"Unknown error"}}}async function te(c,t,w,x,n,N){try{let l=null,y="";switch(x){case"customer_will_revert":l=new Date,l.setDate(l.getDate()+2),y="Customer will revert";break;case"could_not_reach":l=new Date,l.setDate(l.getDate()+1),y="Try calling again";break;case"discussed_price":case"discussed_coa":case"discussed_sample":l=new Date,l.setDate(l.getDate()+3),y="Follow up on discussion";break;case"positive":l=new Date,l.setDate(l.getDate()+2),y="Positive response - follow up";break;case"negative":l=new Date,l.setDate(l.getDate()+7),y="Negative response - check back later";break}const{error:_}=await b.from("crm_activity_logs").insert({inquiry_id:c,activity_type:t,activity_title:w,activity_description:N||null,outcome:x,next_follow_up_date:l?l.toISOString():null,follow_up_reason:y,created_by:n});if(_)throw _;l&&await b.from("crm_inquiries").update({next_follow_up:l.toISOString(),last_contact_date:new Date().toISOString()}).eq("id",c);let v;if(l){const{data:g,error:q}=await b.from("crm_reminders").insert({inquiry_id:c,reminder_type:"follow_up",title:y,due_date:l.toISOString(),assigned_to:n,created_by:n}).select("id").single();!q&&g&&(v=g.id)}return{success:!0,reminderId:v}}catch(l){return console.error("Error logging activity:",l),{success:!1,error:l instanceof Error?l.message:"Unknown error"}}}function re({inquiry:c,onActionComplete:t}){const[w,x]=S.useState(!1),[n,N]=S.useState("phone_call"),[l,y]=S.useState(!1),_=[{id:"send_price",label:"Send Price",icon:T,color:"bg-green-50 hover:bg-green-100 text-green-700 border-green-200",description:"Auto-updates status & creates 2-day follow-up"},{id:"send_coa",label:"Send COA",icon:I,color:"bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-200",description:"Auto-updates status & creates 1-day follow-up"},{id:"send_msds",label:"Send MSDS",icon:I,color:"bg-orange-50 hover:bg-orange-100 text-orange-700 border-orange-200",description:"Sends MSDS document"},{id:"send_sample",label:"Send Sample",icon:O,color:"bg-purple-50 hover:bg-purple-100 text-purple-700 border-purple-200",description:"Auto-updates status & creates 3-day follow-up"}],v=[{value:"customer_will_revert",label:"Customer Will Revert",followUpDays:2},{value:"could_not_reach",label:"Could Not Reach",followUpDays:1},{value:"discussed_price",label:"Discussed Price/COA",followUpDays:3},{value:"positive",label:"Positive Response",followUpDays:2},{value:"negative",label:"Negative Response",followUpDays:7},{value:"other",label:"Other",followUpDays:3}],g=async(s,r)=>{if(!(!c||!confirm(`Send ${r}?

This will:
- Update inquiry status
- Create automatic follow-up
- Log the action

Continue?`))){y(!0);try{const{data:{user:f}}=await b.auth.getUser();if(!f)throw new Error("Not authenticated");const i=await se(c.id,s,r,f.id,{emailTo:c.contact_email||void 0,emailSubject:`Re: ${c.email_subject||c.product_name}`,emailBody:`Dear ${c.contact_person||"Sir/Madam"},

Thank you for your inquiry regarding ${c.product_name}.

Please find the ${r.toLowerCase()} attached.

Best regards`});i.success?(alert(`${r} sent successfully!

Status updated & follow-up created automatically.`),t()):alert(`Failed to send ${r}: ${i.error}`)}catch(f){console.error("Error performing quick action:",f),alert("Failed to perform action. Please try again.")}finally{y(!1)}}},q=async s=>{if(c){y(!0);try{const{data:{user:r}}=await b.auth.getUser();if(!r)throw new Error("Not authenticated");const d=n==="phone_call"?"Phone Call":n==="meeting"?"Meeting":"WhatsApp Message",f=await te(c.id,n,d,s,r.id);if(f.success){const i=v.find(o=>o.value===s);alert(`${d} logged!

Follow-up automatically created for ${i==null?void 0:i.followUpDays} days from now.`),x(!1),t()}else alert(`Failed to log activity: ${f.error}`)}catch(r){console.error("Error logging activity:",r),alert("Failed to log activity. Please try again.")}finally{y(!1)}}};return c?e.jsxs("div",{className:"flex flex-col h-full bg-white border-l border-gray-200",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 bg-gradient-to-r from-green-50 to-transparent",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-1",children:"Quick Actions"}),e.jsxs("p",{className:"text-xs text-gray-600",children:["Inquiry #",c.inquiry_number]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(M,{className:"w-4 h-4"}),"Send Documents (1-Click)"]}),e.jsx("div",{className:"space-y-2",children:_.map(s=>e.jsx("button",{onClick:()=>g(s.id,s.label),disabled:l,className:`w-full p-3 rounded-lg border-2 transition ${s.color} disabled:opacity-50 disabled:cursor-not-allowed text-left`,children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(s.icon,{className:"w-5 h-5 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-sm",children:s.label}),e.jsx("p",{className:"text-xs opacity-75 truncate",children:s.description})]})]})},s.id))})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(U,{className:"w-4 h-4"}),"Log Activity (1-Click)"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("button",{onClick:()=>{N("phone_call"),x(!0)},disabled:l,className:"w-full p-3 rounded-lg border-2 border-gray-200 hover:bg-gray-50 transition text-left disabled:opacity-50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(U,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm text-gray-900",children:"Log Call"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Quick outcome selection"})]})]})}),e.jsx("button",{onClick:()=>{N("meeting"),x(!0)},disabled:l,className:"w-full p-3 rounded-lg border-2 border-gray-200 hover:bg-gray-50 transition text-left disabled:opacity-50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Q,{className:"w-5 h-5 text-purple-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm text-gray-900",children:"Log Meeting"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Record meeting outcome"})]})]})}),e.jsx("button",{onClick:()=>{N("whatsapp"),x(!0)},disabled:l,className:"w-full p-3 rounded-lg border-2 border-gray-200 hover:bg-gray-50 transition text-left disabled:opacity-50",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(W,{className:"w-5 h-5 text-green-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-semibold text-sm text-gray-900",children:"Log WhatsApp"}),e.jsx("p",{className:"text-xs text-gray-600",children:"Log WhatsApp conversation"})]})]})})]})]}),e.jsx("div",{className:"border-t border-gray-200 pt-4",children:e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(Z,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-xs text-blue-800",children:[e.jsx("p",{className:"font-medium mb-1",children:"Auto-Automation Active"}),e.jsxs("ul",{className:"space-y-0.5 text-blue-700",children:[e.jsx("li",{children:"• Status updates automatically"}),e.jsx("li",{children:"• Follow-ups created automatically"}),e.jsx("li",{children:"• All actions logged in timeline"})]})]})]})})})]}),e.jsx(Y,{isOpen:w,onClose:()=>x(!1),title:`Log ${n==="phone_call"?"Phone Call":n==="meeting"?"Meeting":"WhatsApp"}`,children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Select the outcome to automatically update follow-up date:"}),e.jsx("div",{className:"space-y-2",children:v.map(s=>e.jsx("button",{onClick:()=>q(s.value),disabled:l,className:"w-full p-4 text-left border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition disabled:opacity-50 disabled:cursor-not-allowed",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(P,{className:"w-5 h-5 text-gray-400"}),e.jsx("span",{className:"font-medium text-gray-900",children:s.label})]}),e.jsxs("span",{className:"text-xs text-gray-500",children:["+",s.followUpDays,"d follow-up"]})]})},s.value))}),e.jsx("div",{className:"pt-4 border-t border-gray-200",children:e.jsx("p",{className:"text-xs text-gray-500 text-center",children:"Click an outcome to log and auto-create follow-up"})})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center px-8 bg-gray-50",children:[e.jsx(M,{className:"w-20 h-20 text-gray-300 mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Quick Actions"}),e.jsx("p",{className:"text-gray-600 max-w-md",children:"Save an inquiry to see quick action buttons here"}),e.jsxs("div",{className:"mt-6 text-sm text-gray-500 space-y-1",children:[e.jsx("p",{children:"One-click actions include:"}),e.jsxs("ul",{className:"list-disc list-inside text-left",children:[e.jsx("li",{children:"Send Price Quote"}),e.jsx("li",{children:"Send COA/MSDS"}),e.jsx("li",{children:"Log Phone Calls"}),e.jsx("li",{children:"Schedule Follow-ups"})]})]})]})}function ie(c){if(!c)return null;const t=c.trim();if(!t)return null;if(/^\d{4}-\d{2}-\d{2}$/.test(t))return t;const w=t.match(/^(\d{1,2})\.(\d{1,2})\.(\d{2})$/);if(w){const l=w[1].padStart(2,"0"),y=w[2].padStart(2,"0");return`${parseInt(w[3])<50?`20${w[3]}`:`19${w[3]}`}-${y}-${l}`}const x=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2})$/);if(x){const l=x[1].padStart(2,"0"),y=x[2].padStart(2,"0");return`${parseInt(x[3])<50?`20${x[3]}`:`19${x[3]}`}-${y}-${l}`}const n=t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);if(n){const l=n[1].padStart(2,"0"),y=n[2].padStart(2,"0");return`${n[3]}-${y}-${l}`}const N=t.match(/^(\d{1,2})-(\d{1,2})-(\d{4})$/);if(N){const l=N[1].padStart(2,"0"),y=N[2].padStart(2,"0");return`${N[3]}-${y}-${l}`}try{const l=new Date(t);if(!isNaN(l.getTime()))return l.toISOString().split("T")[0]}catch{console.warn("Could not parse date:",t)}return null}function je(){console.log("[CRMCommandCenter] Component loaded - Dec 7 2025 v1.2");const{profile:c}=B(),[t,w]=S.useState(null),[x,n]=S.useState(null),[N,l]=S.useState(null),[y,_]=S.useState(!1),v=(s,r)=>{console.log("[CRMCommandCenter] handleEmailSelect called",{email:s,data:r}),w(s),n(r),l(null)},g=async s=>{var r;if(!(!t||!c)){_(!0);try{const{data:{user:d}}=await b.auth.getUser();if(!d)throw new Error("Not authenticated");let f=null;const i=s.contactEmail.split(/[,;]/)[0].trim();console.log("[CRMCommandCenter] Looking up customer with primaryEmail:",i);const{data:o,error:m}=await b.from("crm_contacts").select("id, company_name, email, contact_person, phone, address").or(`email.eq.${i},company_name.ilike.${s.companyName}`).limit(1).maybeSingle();if(m)throw console.error("[CRMCommandCenter] Customer lookup error:",m),m;if(o){f=o.id;const a={};s.contactPerson&&!o.contact_person&&(a.contact_person=s.contactPerson),s.contactPhone&&!o.phone&&(a.phone=s.contactPhone),s.contactEmail&&s.contactEmail!==o.email&&(a.email=s.contactEmail),Object.keys(a).length>0&&await b.from("crm_contacts").update({...a,updated_at:new Date().toISOString()}).eq("id",f)}else{const{data:a,error:p}=await b.from("crm_contacts").insert({company_name:s.companyName,contact_person:s.contactPerson||null,email:s.contactEmail,phone:s.contactPhone||null,is_active:!0,created_by:d.id}).select().single();if(p)throw console.error("[CRMCommandCenter] Customer creation error:",p),new Error(`Failed to create customer: ${p.message}`);a&&(f=a.id)}if(!f)throw new Error("Failed to get or create customer ID");const h={customer_id:f,inquiry_date:new Date().toISOString().split("T")[0],product_name:s.productName,specification:s.specification||null,quantity:s.quantity,supplier_name:s.supplierName||null,supplier_country:s.supplierCountry||null,company_name:s.companyName,contact_person:s.contactPerson||null,contact_email:s.contactEmail,contact_phone:s.contactPhone||null,mail_subject:t.subject,email_body:t.body,inquiry_source:"email",status:"new",pipeline_status:"new",priority:s.priority,purpose_icons:s.purposeIcons,delivery_date_expected:ie(s.deliveryDateExpected),ai_confidence_score:(x==null?void 0:x.confidenceScore)||0,auto_detected_company:(x==null?void 0:x.autoDetectedCompany)||!1,auto_detected_contact:(x==null?void 0:x.autoDetectedContact)||!1,coa_sent:!1,msds_sent:!1,sample_sent:!1,price_quoted:!1,price_required:s.priceRequested,coa_required:s.coaRequested,sample_required:s.sampleRequested,agency_letter_required:s.agencyLetterRequested||!1,aceerp_no:s.aceerp_no||null,purchase_price:s.purchasePrice?parseFloat(s.purchasePrice):null,purchase_price_currency:s.purchasePriceCurrency||"USD",offered_price:s.offeredPrice?parseFloat(s.offeredPrice):null,offered_price_currency:s.offeredPriceCurrency||"USD",delivery_date:s.deliveryDate||null,delivery_terms:s.deliveryTerms||null,remarks:s.remarks||null,assigned_to:d.id,created_by:d.id,source:"email",source_email_id:t.id.startsWith("gmail-")?null:t.id};let u;if(s.isMultiProduct&&s.products&&s.products.length>0){const a=s.products.map(C=>({...h,product_name:C.productName,specification:C.specification||null,quantity:C.quantity,supplier_name:C.supplierName||h.supplier_name||null,supplier_country:C.supplierCountry||h.supplier_country||null,delivery_date:C.deliveryDate||h.delivery_date||null,delivery_terms:C.deliveryTerms||h.delivery_terms||null,is_multi_product:!1,has_items:!1}));console.log("[CRMCommandCenter] Inserting multi-product inquiries:",a.length,"items");const{data:p,error:k}=await b.from("crm_inquiries").insert(a).select();if(k)throw console.error("[CRMCommandCenter] Multi-product insert error:",k),k;if(p&&p.length>0){const C=p[0].inquiry_number;for(let $=0;$<p.length;$++)await b.from("crm_inquiries").update({inquiry_number:`${C}.${$+1}`}).eq("id",p[$].id);u=p[0]}}else{console.log("[CRMCommandCenter] Inserting single product inquiry");const{data:a,error:p}=await b.from("crm_inquiries").insert([{...h,is_multi_product:!1,has_items:!1}]).select().single();if(p)throw console.error("[CRMCommandCenter] Single product insert error:",p),p;u=a}if(await b.from("crm_email_inbox").update({is_processed:!0,is_inquiry:!0,converted_to_inquiry:u.id}).eq("id",t.id),s.coaRequested||s.msdsRequested||s.sampleRequested||s.priceRequested||s.agencyLetterRequested){const a=[];s.priceRequested&&a.push({inquiry_id:u.id,reminder_type:"send_price",title:"Send price quote to customer",due_date:new Date(Date.now()+1*24*60*60*1e3).toISOString(),assigned_to:d.id,created_by:d.id}),s.coaRequested&&a.push({inquiry_id:u.id,reminder_type:"send_coa",title:"Send COA to customer",due_date:new Date(Date.now()+2*24*60*60*1e3).toISOString(),assigned_to:d.id,created_by:d.id}),s.msdsRequested&&a.push({inquiry_id:u.id,reminder_type:"send_msds",title:"Send MSDS to customer",due_date:new Date(Date.now()+2*24*60*60*1e3).toISOString(),assigned_to:d.id,created_by:d.id}),s.sampleRequested&&a.push({inquiry_id:u.id,reminder_type:"send_sample",title:"Send sample to customer",due_date:new Date(Date.now()+3*24*60*60*1e3).toISOString(),assigned_to:d.id,created_by:d.id}),s.agencyLetterRequested&&a.push({inquiry_id:u.id,reminder_type:"send_agency_letter",title:"Send agency letter to customer",due_date:new Date(Date.now()+1*24*60*60*1e3).toISOString(),assigned_to:d.id,created_by:d.id}),a.length>0&&await b.from("crm_reminders").insert(a)}l(u),n(null);const j=s.isMultiProduct&&s.products?`Inquiry #${u.inquiry_number} created successfully with ${s.products.length} product line items!

Use Quick Actions to send documents for each product.`:`Inquiry #${u.inquiry_number} created successfully!

Use Quick Actions to send documents.`;alert(j)}catch(d){if(console.error("[CRMCommandCenter] Error creating inquiry:",d),console.error("[CRMCommandCenter] Error details:",JSON.stringify(d,null,2)),(r=d.message)!=null&&r.includes("duplicate key"))alert("This inquiry number already exists. Please use a different number.");else{const f=d.message||d.details||d.hint||"Unknown error";alert(`Failed to create inquiry: ${f}

Check console for details.`)}}finally{_(!1)}}},q=()=>{l(null),w(null),n(null)};return e.jsx(J,{children:e.jsxs("div",{className:"h-screen flex flex-col",children:[e.jsx("div",{className:"flex-shrink-0 bg-gradient-to-r from-blue-600 to-blue-700 px-4 py-2 border-b border-blue-800",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(G,{className:"w-5 h-5 text-white"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold text-white",children:"CRM Command Center"}),e.jsx("p",{className:"text-blue-100 text-xs",children:"AI-powered inquiry processing"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-blue-200",children:"Quick Actions"}),e.jsx("p",{className:"text-xl font-bold text-white",children:"2 Clicks"})]})]})}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[e.jsx("div",{className:"w-1/4 min-w-[300px] max-w-[400px]",children:e.jsx(D,{onEmailSelect:v,selectedEmailId:(t==null?void 0:t.id)||null})}),e.jsx("div",{className:"flex-1",children:e.jsx(ee,{email:t,parsedData:x,onSave:g,saving:y})}),e.jsx("div",{className:"w-1/4 min-w-[300px] max-w-[400px]",children:e.jsx(re,{inquiry:N,onActionComplete:q})})]}),N&&e.jsx("div",{className:"flex-shrink-0 bg-green-50 border-t border-green-200 px-6 py-3",children:e.jsxs("div",{className:"flex items-center justify-center gap-2 text-green-800",children:[e.jsx(P,{className:"w-5 h-5"}),e.jsxs("span",{className:"font-medium",children:["Inquiry #",N.inquiry_number," created successfully! Use Quick Actions on the right →"]})]})})]})})}export{je as CRMCommandCenter};
