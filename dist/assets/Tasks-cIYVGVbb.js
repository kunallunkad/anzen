import{c as se,u as ce,r as x,s as f,j as e,C as de,X as ue,F as ge,d as he,A as pe,T as ye}from"./index-Bqpro8KL.js";import{M as me,L as te,C as fe,Z as be}from"./Layout-BToEj-kL.js";import{M as ae,P as re}from"./Modal-BJLUH_oV.js";import{L as le}from"./loader-DedE0Rkj.js";import{U as A}from"./user-C20dTtR4.js";import{a as ee,P as B,C as ne,T as je,M as we,A as Ne,F as _e}from"./TaskFormModal-D7kWACKU.js";import{D as ve}from"./download-Pvi4C3Ra.js";import{S as ke}from"./send-D9f3kKKL.js";import{I as Te,F as Se}from"./image-D92nbYP-.js";import{f as Ce}from"./dateFormat-E6B5rKFz.js";import{C as K}from"./check-circle-2-PUIHFEpm.js";import{S as qe}from"./search-DVwgCoyq.js";import{E as De}from"./external-link-BEW8qUPb.js";import{E as Me}from"./eye-BAIwIpS3.js";import{S as Ee}from"./square-pen-C7r27JVi.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=se("Bot",[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=se("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=se("MoreVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);function Ue({isOpen:i,onClose:a,taskId:r,onUpdate:p}){const{user:u}=ce(),[m,V]=x.useState(null),[L,P]=x.useState([]),[_,Q]=x.useState([]),[F,$]=x.useState(!0),[v,S]=x.useState(""),[I,C]=x.useState(!1),[R,M]=x.useState(""),[k,T]=x.useState([]),[o,w]=x.useState(!1),[E,O]=x.useState(!1),q=x.useRef(null),z=x.useRef(null);x.useEffect(()=>{i&&r&&(W(),Y(),H())},[i,r]);const W=async()=>{var t,n,c,g;try{$(!0);const{data:h,error:U}=await f.from("tasks").select(`
          *,
          creator:created_by(full_name),
          inquiry:crm_inquiries(inquiry_number),
          customer:customers(company_name),
          product:products(name)
        `).eq("id",r).single();if(U)throw U;const G=h.assigned_users||[],{data:J}=await f.from("user_profiles").select("id, full_name").in("id",G);V({...h,creator_name:(t=h.creator)==null?void 0:t.full_name,assignee_names:(J==null?void 0:J.map(xe=>xe.full_name))||[],inquiry_number:(n=h.inquiry)==null?void 0:n.inquiry_number,customer_name:(c=h.customer)==null?void 0:c.company_name,product_name:(g=h.product)==null?void 0:g.name})}catch(h){console.error("Error loading task:",h)}finally{$(!1)}},Y=async()=>{try{const{data:t,error:n}=await f.from("task_comments").select(`
          *,
          user:user_id(full_name)
        `).eq("task_id",r).eq("is_deleted",!1).order("created_at",{ascending:!0});if(n)throw n;P((t||[]).map(c=>{var g;return{...c,user_name:((g=c.user)==null?void 0:g.full_name)||"Unknown User"}}))}catch(t){console.error("Error loading comments:",t)}},H=async()=>{try{const{data:t,error:n}=await f.from("user_profiles").select("id, full_name, email").eq("is_active",!0).order("full_name");if(n)throw n;Q(t||[])}catch(t){console.error("Error loading users:",t)}},Z=t=>{const n=t.target.value;S(n);const c=n.split(" ").pop()||"";c.startsWith("@")?(M(c.slice(1)),C(!0)):C(!1)},X=(t,n)=>{var g;const c=v.split(" ");c[c.length-1]=`@${t} `,S(c.join(" ")),C(!1),(g=z.current)==null||g.focus()},s=t=>{const n=/@(\w+)/g,c=[];let g;for(;(g=n.exec(t))!==null;){const h=g[1],U=_.find(G=>G.full_name.replace(/\s+/g,"")===h);U&&c.push(U.id)}return c},l=async()=>{const t=[];for(const n of k){const c=`${Date.now()}_${n.name}`,g=`tasks/${r}/comments/${c}`,{error:h}=await f.storage.from("task-attachments").upload(g,n);h?console.error("Error uploading file:",h):t.push(g)}return t},d=async()=>{if(!(!v.trim()&&k.length===0))try{w(!0);const t=await l(),n=s(v),{error:c}=await f.from("task_comments").insert([{task_id:r,comment_text:v,user_id:u==null?void 0:u.id,mentions:n,attachment_urls:t}]);if(c)throw c;S(""),T([]),Y()}catch(t){console.error("Error adding comment:",t),alert("Failed to add comment")}finally{w(!1)}},y=async t=>{try{O(!0);const{error:n}=await f.from("tasks").update({status:t}).eq("id",r);if(n)throw n;W(),p()}catch(n){console.error("Error updating status:",n),alert("Failed to update status")}finally{O(!1)}},b=t=>{var c;const n=(c=t.split(".").pop())==null?void 0:c.toLowerCase();return["jpg","jpeg","png","gif","webp"].includes(n||"")?e.jsx(Te,{className:"w-4 h-4"}):["pdf"].includes(n||"")?e.jsx(ge,{className:"w-4 h-4"}):e.jsx(Se,{className:"w-4 h-4"})},N=async t=>{try{const{data:n,error:c}=await f.storage.from("task-attachments").download(t);if(c)throw c;const g=URL.createObjectURL(n),h=document.createElement("a");h.href=g,h.download=t.split("/").pop()||"download",document.body.appendChild(h),h.click(),document.body.removeChild(h),URL.revokeObjectURL(g)}catch(n){console.error("Error downloading file:",n)}},D=t=>{const n={to_do:"bg-gray-100 text-gray-700 border-gray-300",in_progress:"bg-blue-100 text-blue-700 border-blue-300",waiting:"bg-orange-100 text-orange-700 border-orange-300",completed:"bg-green-100 text-green-700 border-green-300"};return n[t]||n.to_do},j=t=>{const n={low:"bg-gray-100 text-gray-700",medium:"bg-yellow-100 text-yellow-700",high:"bg-orange-100 text-orange-700",urgent:"bg-red-100 text-red-700"};return n[t]||n.medium};return F||!m?e.jsx(ae,{isOpen:i,onClose:a,title:"Loading...",children:e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(le,{className:"w-8 h-8 animate-spin text-blue-600"})})}):e.jsx(ae,{isOpen:i,onClose:a,title:m.title,size:"xl",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-sm font-medium ${j(m.priority)}`,children:m.priority.toUpperCase()}),e.jsxs("select",{value:m.status,onChange:t=>y(t.target.value),disabled:E,className:`px-3 py-1 rounded-full text-sm font-medium border-2 ${D(m.status)} cursor-pointer disabled:opacity-50`,children:[e.jsx("option",{value:"to_do",children:"To Do"}),e.jsx("option",{value:"in_progress",children:"In Progress"}),e.jsx("option",{value:"waiting",children:"Waiting"}),e.jsx("option",{value:"completed",children:"Completed"})]})]}),m.description&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-700 mb-2",children:"Description"}),e.jsx("p",{className:"text-gray-900 whitespace-pre-wrap",children:m.description})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(de,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Deadline:"}),e.jsx("span",{className:"font-medium text-gray-900",children:new Date(m.deadline).toLocaleString()})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Created by:"}),e.jsx("span",{className:"font-medium text-gray-900",children:m.creator_name})]}),m.assignee_names.length>0&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Assigned to:"}),e.jsx("span",{className:"font-medium text-gray-900",children:m.assignee_names.join(", ")})]}),m.inquiry_number&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Inquiry:"}),e.jsx("span",{className:"font-medium text-blue-600",children:m.inquiry_number})]}),m.customer_name&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(A,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Customer:"}),e.jsx("span",{className:"font-medium text-gray-900",children:m.customer_name})]}),m.product_name&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(ee,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:"Product:"}),e.jsx("span",{className:"font-medium text-gray-900",children:m.product_name})]})]}),m.attachment_urls.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-700 mb-2 flex items-center gap-2",children:[e.jsx(B,{className:"w-4 h-4"}),"Attachments (",m.attachment_urls.length,")"]}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:m.attachment_urls.map((t,n)=>e.jsxs("button",{onClick:()=>N(t),className:"flex items-center gap-2 p-2 border border-gray-200 rounded-lg hover:bg-gray-50 text-left",children:[b(t),e.jsx("span",{className:"text-sm text-gray-700 truncate",children:t.split("/").pop()}),e.jsx(ve,{className:"w-4 h-4 ml-auto text-gray-400"})]},n))})]}),e.jsxs("div",{className:"border-t pt-6",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(me,{className:"w-5 h-5"}),"Discussion (",L.length,")"]}),e.jsx("div",{className:"space-y-4 mb-4 max-h-96 overflow-y-auto",children:L.length===0?e.jsx("p",{className:"text-sm text-gray-500 text-center py-8",children:"No comments yet. Start the discussion!"}):L.map(t=>e.jsxs("div",{className:"flex gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center text-white font-medium text-sm",children:t.user_name.charAt(0).toUpperCase()})}),e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"font-medium text-sm text-gray-900",children:t.user_name}),e.jsx("span",{className:"text-xs text-gray-500",children:new Date(t.created_at).toLocaleString()})]}),e.jsx("p",{className:"text-sm text-gray-900 whitespace-pre-wrap",children:t.comment_text}),t.attachment_urls.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:t.attachment_urls.map((n,c)=>e.jsxs("button",{onClick:()=>N(n),className:"flex items-center gap-2 text-xs text-blue-600 hover:text-blue-700",children:[b(n),n.split("/").pop()]},c))})]})})]},t.id))}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{ref:z,value:v,onChange:Z,placeholder:"Add a comment... Use @ to mention someone",className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none",rows:3}),I&&e.jsx("div",{className:"absolute bottom-full left-0 mb-1 w-64 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto z-10",children:_.filter(t=>t.full_name.toLowerCase().includes(R.toLowerCase())).slice(0,5).map(t=>e.jsxs("button",{onClick:()=>X(t.full_name.replace(/\s+/g,""),t.id),className:"w-full px-3 py-2 text-left hover:bg-gray-50 flex items-center gap-2",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-white text-xs",children:t.full_name.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-900",children:t.full_name}),e.jsx("p",{className:"text-xs text-gray-500",children:t.email})]})]},t.id))})]}),k.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2",children:k.map((t,n)=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-1 bg-gray-100 rounded-lg text-sm",children:[e.jsx(B,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-gray-700",children:t.name}),e.jsx("button",{onClick:()=>T(c=>c.filter((g,h)=>h!==n)),className:"text-gray-500 hover:text-red-600",children:e.jsx(ue,{className:"w-4 h-4"})})]},n))}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("input",{ref:q,type:"file",multiple:!0,onChange:t=>{t.target.files&&T(Array.from(t.target.files))},className:"hidden"}),e.jsxs("button",{onClick:()=>{var t;return(t=q.current)==null?void 0:t.click()},className:"flex items-center gap-2 px-3 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition",children:[e.jsx(B,{className:"w-4 h-4"}),"Attach Files"]}),e.jsx("button",{onClick:d,disabled:o||!v.trim()&&k.length===0,className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition",children:o?e.jsxs(e.Fragment,{children:[e.jsx(le,{className:"w-4 h-4 animate-spin"}),"Posting..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ke,{className:"w-4 h-4"}),"Post Comment"]})})]})]})]})]})})}class oe{static async getSystemTasks(a){let r=f.from("tasks").select(`
        *,
        customers (company_name),
        products (product_name),
        created_by_user:user_profiles!tasks_created_by_fkey (full_name, role)
      `).eq("is_deleted",!1).order("deadline",{ascending:!0});if((a==null?void 0:a.taskType)==="system"?r=r.eq("task_type","system"):(a==null?void 0:a.taskType)==="manual"&&(r=r.eq("task_type","manual")),a!=null&&a.status&&a.status!=="all"&&(r=r.eq("status",a.status)),a!=null&&a.priority&&a.priority!=="all"&&(r=r.eq("priority",a.priority)),a!=null&&a.assignedToMe){const{data:{user:m}}=await f.auth.getUser();m&&(r=r.contains("assigned_users",[m.id]))}const{data:p,error:u}=await r;if(u)throw console.error("Error fetching system tasks:",u),u;return p||[]}static async getSystemTasksSummary(a){const{data:r,error:p}=await f.rpc("get_system_tasks_summary",{user_role:a||null});if(p)throw console.error("Error fetching system tasks summary:",p),p;return(r==null?void 0:r[0])||{total_tasks:0,urgent_tasks:0,overdue_tasks:0,today_tasks:0,by_origin:{}}}static async dismissSystemTask(a,r){const{data:p,error:u}=await f.rpc("dismiss_system_task",{p_task_id:a,p_reason:r||null});if(u)throw console.error("Error dismissing system task:",u),u;return p===!0}static async getSystemTaskEvents(a){let r=f.from("system_task_events").select("*").order("created_at",{ascending:!1});a!=null&&a.eventType&&(r=r.eq("event_type",a.eventType)),a!=null&&a.entityType&&(r=r.eq("entity_type",a.entityType)),a!=null&&a.entityId&&(r=r.eq("entity_id",a.entityId)),a!=null&&a.limit&&(r=r.limit(a.limit));const{data:p,error:u}=await r;if(u)throw console.error("Error fetching system task events:",u),u;return p||[]}static isOverdue(a){return new Date(a)<new Date}static isDueToday(a){const r=new Date,p=new Date(a);return p.getDate()===r.getDate()&&p.getMonth()===r.getMonth()&&p.getFullYear()===r.getFullYear()}static getPriorityColor(a){switch(a){case"urgent":return"bg-red-100 text-red-700 border-red-300";case"high":return"bg-orange-100 text-orange-700 border-orange-300";case"medium":return"bg-yellow-100 text-yellow-700 border-yellow-300";case"low":return"bg-blue-100 text-blue-700 border-blue-300";default:return"bg-gray-100 text-gray-700 border-gray-300"}}static getOriginLabel(a){return a?{sales_order_approved:"Sales Order Approved",sales_order_shortage:"Stock Shortage",delivery_challan_created:"Delivery Created",stock_low_alert:"Low Stock Alert",import_requirement_created:"Import Required",purchase_order_created:"Purchase Order",manual:"Manual"}[a]||a:"Manual"}static getTaskTypeBadge(a,r){return a==="system"?{label:r==="enforced"?"SYSTEM - REQUIRED":"SYSTEM",className:r==="enforced"?"bg-red-600 text-white":"bg-blue-600 text-white"}:{label:"MANUAL",className:"bg-gray-500 text-white"}}static subscribeToSystemTasks(a){return f.channel("system-tasks-changes").on("postgres_changes",{event:"*",schema:"public",table:"tasks",filter:"task_type=eq.system"},a).subscribe()}static async createManualTask(a){const{data:{user:r}}=await f.auth.getUser();if(!r)throw new Error("Not authenticated");const{data:p,error:u}=await f.from("tasks").insert({...a,task_type:"manual",created_by:r.id,status:"to_do"}).select().single();if(u)throw console.error("Error creating manual task:",u),u;return p}}function Ge(){const{user:i,profile:a}=ce(),{t:r}=he(),[p,u]=x.useState([]),[m,V]=x.useState([]),[L,P]=x.useState(!0),[_,Q]=x.useState(""),[F,$]=x.useState(!1),[v,S]=x.useState(null),[I,C]=x.useState(!1),[R,M]=x.useState(!1),[k,T]=x.useState(null),[o,w]=x.useState({status:[],priority:[],assignedTo:[],view:"my-tasks",taskType:"all"}),[E,O]=x.useState({total:0,pending:0,completed:0,overdue:0});x.useEffect(()=>{q()},[i]),x.useEffect(()=>{W()},[p,o,_]);const q=async()=>{try{P(!0);let s=f.from("tasks").select(`
          *,
          creator:created_by(full_name),
          inquiry:crm_inquiries(inquiry_number),
          customer:customers(company_name),
          product:products(product_name)
        `).eq("is_deleted",!1).order("deadline",{ascending:!0});const{data:l,error:d}=await s;if(d)throw d;const y=(l==null?void 0:l.map(j=>j.id))||[],{data:b}=await f.from("task_comments").select("task_id").in("task_id",y).eq("is_deleted",!1),N={};b==null||b.forEach(j=>{N[j.task_id]=(N[j.task_id]||0)+1});const D=(l||[]).map(j=>{var t,n,c,g;return{...j,creator_name:(t=j.creator)==null?void 0:t.full_name,inquiry_number:(n=j.inquiry)==null?void 0:n.inquiry_number,customer_name:(c=j.customer)==null?void 0:c.company_name,product_name:(g=j.product)==null?void 0:g.product_name,comment_count:N[j.id]||0}});u(D),z(D)}catch(s){console.error("Error loading tasks:",s)}finally{P(!1)}},z=s=>{const l=new Date,d=s.filter(y=>y.assigned_users.includes((i==null?void 0:i.id)||"")||y.created_by===(i==null?void 0:i.id));O({total:d.length,pending:d.filter(y=>y.status!=="completed").length,completed:d.filter(y=>y.status==="completed").length,overdue:d.filter(y=>y.status!=="completed"&&new Date(y.deadline)<l).length})},W=()=>{let s=[...p];if(o.taskType==="system"?s=s.filter(l=>l.task_type==="system"):o.taskType==="manual"&&(s=s.filter(l=>l.task_type!=="system")),o.view==="my-tasks")s=s.filter(l=>l.assigned_users.includes((i==null?void 0:i.id)||"")||l.created_by===(i==null?void 0:i.id));else if(o.view==="pending")s=s.filter(l=>l.status!=="completed"&&(l.assigned_users.includes((i==null?void 0:i.id)||"")||l.created_by===(i==null?void 0:i.id)));else if(o.view==="completed")s=s.filter(l=>l.status==="completed"&&(l.assigned_users.includes((i==null?void 0:i.id)||"")||l.created_by===(i==null?void 0:i.id)));else if(o.view==="overdue"){const l=new Date;s=s.filter(d=>d.status!=="completed"&&new Date(d.deadline)<l&&(d.assigned_users.includes((i==null?void 0:i.id)||"")||d.created_by===(i==null?void 0:i.id)))}if(o.status.length>0&&(s=s.filter(l=>o.status.includes(l.status))),o.priority.length>0&&(s=s.filter(l=>o.priority.includes(l.priority))),_){const l=_.toLowerCase();s=s.filter(d=>{var y,b,N,D;return d.title.toLowerCase().includes(l)||((y=d.description)==null?void 0:y.toLowerCase().includes(l))||((b=d.customer_name)==null?void 0:b.toLowerCase().includes(l))||((N=d.product_name)==null?void 0:N.toLowerCase().includes(l))||((D=d.inquiry_number)==null?void 0:D.toLowerCase().includes(l))||oe.getOriginLabel(d.task_origin||"").toLowerCase().includes(l)})}V(s)},Y=s=>{switch(s){case"urgent":return e.jsx(_e,{className:"w-4 h-4 text-red-600"});case"high":return e.jsx(Ne,{className:"w-4 h-4 text-orange-600"});case"medium":return e.jsx(we,{className:"w-4 h-4 text-yellow-600"});default:return e.jsx(ne,{className:"w-4 h-4 text-gray-400"})}},H=s=>{const l={to_do:"bg-gray-100 text-gray-700",in_progress:"bg-blue-100 text-blue-700",waiting:"bg-orange-100 text-orange-700",completed:"bg-green-100 text-green-700"},d={to_do:"To Do",in_progress:"In Progress",waiting:"Waiting",completed:"Completed"};return e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${l[s]}`,children:d[s]})},Z=s=>{const l=new Date(s),d=new Date,y=l.getTime()-d.getTime(),b=Math.floor(y/(1e3*60*60)),N=Math.floor(b/24);return y<0?e.jsx("span",{className:"text-red-600 font-medium",children:"Overdue"}):b<24?e.jsxs("span",{className:"text-orange-600 font-medium",children:["Due in ",b,"h"]}):N<7?e.jsxs("span",{className:"text-yellow-600 font-medium",children:["Due in ",N,"d"]}):e.jsx("span",{className:"text-gray-600",children:Ce(l)})},X=async s=>{if(confirm("Are you sure you want to delete this task?"))try{const{error:l}=await f.from("tasks").update({is_deleted:!0,deleted_at:new Date().toISOString(),deleted_by:i==null?void 0:i.id}).eq("id",s);if(l)throw l;q()}catch(l){console.error("Error deleting task:",l),alert("Failed to delete task")}};return L?e.jsx(te,{children:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"})})}):e.jsxs(te,{children:[e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:r("tasks.title")}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage and track team assignments"})]}),e.jsxs("button",{onClick:()=>M(!0),className:"flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:[e.jsx(re,{className:"w-5 h-5"}),r("tasks.addTask")]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-blue-100 rounded-lg",children:e.jsx(K,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Tasks"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:E.total})]})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-yellow-100 rounded-lg",children:e.jsx(fe,{className:"w-6 h-6 text-yellow-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:r("common.pending")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:E.pending})]})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-green-100 rounded-lg",children:e.jsx(K,{className:"w-6 h-6 text-green-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:r("common.completed")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:E.completed})]})]})}),e.jsx("div",{className:"bg-white p-4 rounded-lg border border-gray-200",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-red-100 rounded-lg",children:e.jsx(pe,{className:"w-6 h-6 text-red-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:r("common.overdue")}),e.jsx("p",{className:"text-2xl font-bold text-gray-900",children:E.overdue})]})]})})]}),e.jsxs("div",{className:"bg-white rounded-lg border border-gray-200",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200",children:[e.jsxs("div",{className:"flex gap-2 mb-4 pb-4 border-b border-gray-200",children:[e.jsxs("button",{onClick:()=>w({...o,taskType:"all"}),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${o.taskType==="all"?"bg-gray-700 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(ne,{className:"w-4 h-4"}),r("tasks.allTasks")]}),e.jsxs("button",{onClick:()=>w({...o,taskType:"system"}),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${o.taskType==="system"?"bg-blue-600 text-white":"bg-blue-50 text-blue-700 hover:bg-blue-100"}`,children:[e.jsx(ie,{className:"w-4 h-4"}),"System Tasks"]}),e.jsxs("button",{onClick:()=>w({...o,taskType:"manual"}),className:`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition ${o.taskType==="manual"?"bg-green-600 text-white":"bg-green-50 text-green-700 hover:bg-green-100"}`,children:[e.jsx(A,{className:"w-4 h-4"}),"Manual Tasks"]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4 justify-between",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:[{value:"my-tasks",label:r("tasks.myTasks")},{value:"pending",label:r("common.pending")},{value:"completed",label:r("common.completed")},{value:"overdue",label:r("common.overdue")},{value:"all",label:r("tasks.allTasks")}].map(s=>e.jsx("button",{onClick:()=>w({...o,view:s.value}),className:`px-4 py-2 rounded-lg text-sm font-medium transition ${o.view===s.value?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:s.label},s.value))}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1 sm:flex-none sm:w-64",children:[e.jsx(qe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",placeholder:`${r("common.search")}...`,value:_,onChange:s=>Q(s.target.value),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsx("button",{onClick:()=>$(!F),className:`px-4 py-2 border rounded-lg transition ${F?"bg-blue-50 border-blue-300 text-blue-700":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx(Le,{className:"w-5 h-5"})})]})]}),F&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-gray-200 grid grid-cols-1 sm:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r("common.status")}),e.jsx("div",{className:"space-y-2",children:["to_do","in_progress","waiting","completed"].map(s=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:o.status.includes(s),onChange:l=>{l.target.checked?w({...o,status:[...o.status,s]}):w({...o,status:o.status.filter(d=>d!==s)})},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 capitalize",children:s.replace("_"," ")})]},s))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:r("tasks.priority")}),e.jsx("div",{className:"space-y-2",children:["urgent","high","medium","low"].map(s=>e.jsxs("label",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:o.priority.includes(s),onChange:l=>{l.target.checked?w({...o,priority:[...o.priority,s]}):w({...o,priority:o.priority.filter(d=>d!==s)})},className:"rounded border-gray-300 text-blue-600 focus:ring-blue-500"}),e.jsx("span",{className:"text-sm text-gray-700 capitalize",children:s})]},s))})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:()=>w({...o,status:[],priority:[],assignedTo:[]}),className:"text-sm text-blue-600 hover:text-blue-700 font-medium",children:"Clear All Filters"})})]})]}),e.jsx("div",{className:"divide-y divide-gray-200",children:m.length===0?e.jsxs("div",{className:"p-12 text-center",children:[e.jsx(K,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:r("common.noData")}),e.jsx("p",{className:"text-gray-600 mb-6",children:_||o.status.length>0||o.priority.length>0?"Try adjusting your filters or search query":"Create your first task to get started"}),!_&&o.status.length===0&&e.jsxs("button",{onClick:()=>M(!0),className:"inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",children:[e.jsx(re,{className:"w-5 h-5"}),r("tasks.addTask")]})]}):m.map(s=>e.jsx("div",{className:"p-4 hover:bg-gray-50 transition cursor-pointer",onClick:()=>{S(s),C(!0)},children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"mt-1",children:Y(s.priority)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start gap-2 flex-wrap",children:[e.jsx("h3",{className:"font-medium text-gray-900 truncate",children:s.title}),s.attachment_urls.length>0&&e.jsx(B,{className:"w-4 h-4 text-gray-400 flex-shrink-0"}),s.task_type==="system"&&e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 text-xs font-bold rounded ${s.task_mode==="enforced"?"bg-red-600 text-white":"bg-blue-600 text-white"}`,children:[e.jsx(ie,{className:"w-3 h-3"}),"SYSTEM"]})]}),s.description&&e.jsx("p",{className:"text-sm text-gray-600 mt-1 line-clamp-2",children:s.description}),s.task_origin&&s.task_type==="system"&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1 flex items-center gap-1",children:[e.jsx(be,{className:"w-3 h-3"}),oe.getOriginLabel(s.task_origin)]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 mt-2",children:[H(s.status),e.jsxs("div",{className:"flex items-center gap-1 text-sm text-gray-600",children:[e.jsx(de,{className:"w-4 h-4"}),Z(s.deadline)]}),s.comment_count>0&&e.jsxs("div",{className:"flex items-center gap-1 text-sm text-gray-600",children:[e.jsx(me,{className:"w-4 h-4"}),s.comment_count]}),s.inquiry_number&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded",children:[e.jsx(De,{className:"w-3 h-3"}),s.inquiry_number]}),s.customer_name&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded",children:[e.jsx(A,{className:"w-3 h-3"}),s.customer_name]}),s.tags.length>0&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-gray-600",children:[e.jsx(ee,{className:"w-3 h-3"}),s.tags[0],s.tags.length>1&&` +${s.tags.length-1}`]})]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("button",{onClick:l=>{l.stopPropagation(),T(k===s.id?null:s.id)},className:"p-1 hover:bg-gray-100 rounded transition",children:e.jsx(Fe,{className:"w-5 h-5 text-gray-600"})}),k===s.id&&e.jsxs("div",{className:"absolute right-0 mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 py-1 z-10",children:[e.jsxs("button",{onClick:l=>{l.stopPropagation(),S(s),C(!0),T(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4"}),"View Details"]}),(s.created_by===(i==null?void 0:i.id)||(a==null?void 0:a.role)==="admin")&&e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:l=>{l.stopPropagation(),T(null)},className:"w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Edit Task"]}),e.jsxs("button",{onClick:l=>{l.stopPropagation(),X(s.id),T(null)},className:"w-full px-4 py-2 text-left text-sm text-red-600 hover:bg-red-50 flex items-center gap-2",children:[e.jsx(ye,{className:"w-4 h-4"}),"Delete Task"]})]})]})]})]})},s.id))})]})]}),R&&e.jsx(je,{isOpen:R,onClose:()=>M(!1),onSuccess:()=>{M(!1),q()}}),I&&v&&e.jsx(Ue,{isOpen:I,onClose:()=>{C(!1),S(null)},taskId:v.id,onUpdate:q})]})}export{Ge as Tasks};
