import{a as J,r as c,s as d,j as e}from"./index-D377iWu2.js";import{D as P}from"./DataTable-BXltp17L.js";import{M as K}from"./Modal-XL444I2e.js";import{f as N}from"./dateFormat-E6B5rKFz.js";import{R as Q}from"./refresh-cw-BlA-hMpC.js";import{T as E}from"./Layout-B5e6WOHT.js";import"./search-C8aJjCFC.js";import"./chevron-up-CjxuCjv5.js";import"./chevron-down-D_LZ1jaB.js";function le({canManage:q}){var F;const{setCurrentPage:O}=J(),[b,S]=c.useState("invoices"),[y,L]=c.useState([]),[$,T]=c.useState([]),[B,M]=c.useState([]),[k,U]=c.useState(!0),[R,A]=c.useState(!1),[V,_]=c.useState(!1),[f,v]=c.useState(null),[I,j]=c.useState([]),[u,x]=c.useState({}),[s,p]=c.useState({payment_number:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""}),g=c.useCallback(async()=>{try{const[t,a,n]=await Promise.all([d.from("sales_invoices").select("*, customers(company_name)").in("payment_status",["pending","partial"]).order("due_date",{ascending:!0}),d.from("receipt_vouchers").select(`
            *,
            customers(company_name),
            bank_accounts(account_name, alias)
          `).order("voucher_date",{ascending:!1}).limit(50),d.from("bank_accounts").select("id, account_name, bank_name, alias").eq("is_active",!0).order("account_name")]);if(t.error)throw console.error("Error loading invoices:",t.error),t.error;if(a.error)throw console.error("Error loading payments:",a.error),a.error;if(n.error)throw console.error("Error loading banks:",n.error),n.error;const l=await Promise.all((t.data||[]).map(async r=>{try{const{data:o,error:m}=await d.from("voucher_allocations").select("allocated_amount").eq("sales_invoice_id",r.id).eq("voucher_type","receipt");m&&console.error("Error loading allocations for invoice:",r.id,m);const h=(o==null?void 0:o.reduce((D,C)=>D+(Number(C.allocated_amount)||0),0))||0;return{...r,paid_amount:h,customers:r.customers||null}}catch(o){return console.error("Error processing invoice:",r.id,o),{...r,paid_amount:0,customers:r.customers||null}}})),i=await Promise.all((a.data||[]).map(async r=>{try{const{data:o,error:m}=await d.from("voucher_allocations").select("allocated_amount, sales_invoices(invoice_number)").eq("receipt_voucher_id",r.id).eq("voucher_type","receipt");return m&&console.error("Error loading allocations for voucher:",r.id,m),{...r,allocations:o||[],customers:r.customers||null,bank_accounts:r.bank_accounts||null}}catch(o){return console.error("Error processing voucher:",r.id,o),{...r,allocations:[],customers:r.customers||null,bank_accounts:r.bank_accounts||null}}}));L(l),T(i),M(n.data||[])}catch(t){console.error("Error loading data:",t)}finally{U(!1),A(!1)}},[]);c.useEffect(()=>{g();const t=setInterval(g,3e4);return()=>clearInterval(t)},[g]);const W=()=>{A(!0),g()},z=async t=>{v(t);const a=t.total_amount-(t.paid_amount||0);p({...s,payment_number:`PAY-${Date.now()}`,amount:a});try{const{data:n,error:l}=await d.from("sales_invoices").select("*").eq("customer_id",t.customer_id).in("payment_status",["pending","partial"]).order("invoice_date",{ascending:!0});if(l)throw console.error("Error loading customer invoices:",l),l;const i=await Promise.all((n||[]).map(async r=>{try{const{data:o,error:m}=await d.from("voucher_allocations").select("allocated_amount").eq("sales_invoice_id",r.id).eq("voucher_type","receipt");m&&console.error("Error loading allocations for invoice:",r.id,m);const h=(o==null?void 0:o.reduce((D,C)=>D+(Number(C.allocated_amount)||0),0))||0;return{...r,paid_amount:h,customers:r.customers||null}}catch(o){return console.error("Error processing invoice:",r.id,o),{...r,paid_amount:0,customers:r.customers||null}}}));j(i),x({[t.id]:a})}catch(n){console.error("Error loading customer invoices:",n)}_(!0)},H=async t=>{if(t.preventDefault(),!f)return;const a=Object.values(u).reduce((n,l)=>n+l,0);if(a>s.amount){alert("Total allocated amount cannot exceed payment amount");return}if(a===0){alert("Please allocate the payment to at least one invoice");return}try{const{data:{user:n}}=await d.auth.getUser();if(!n)throw new Error("Not authenticated");const{data:l,error:i}=await d.rpc("generate_voucher_number",{p_prefix:"RV"});if(i)throw i;const{data:r,error:o}=await d.from("receipt_vouchers").insert([{voucher_number:l,voucher_date:s.payment_date,customer_id:f.customer_id,payment_method:s.payment_method,bank_account_id:s.bank_account_id||null,reference_number:s.reference_number||null,amount:s.amount,description:s.notes||null,created_by:n.id}]).select().single();if(o)throw o;for(const[m,h]of Object.entries(u))h<=0||await d.from("voucher_allocations").insert({voucher_type:"receipt",receipt_voucher_id:r.id,sales_invoice_id:m,allocated_amount:h});_(!1),v(null),j([]),x({}),w(),g(),alert(`Receipt voucher ${l} created and allocated successfully!`)}catch(n){console.error("Error recording payment:",n),alert(`Failed to record payment: ${n.message}`)}},w=()=>{p({payment_number:"",payment_date:new Date().toISOString().split("T")[0],amount:0,payment_method:"bank_transfer",bank_account_id:"",reference_number:"",notes:""})},Y=[{key:"invoice_number",label:"Invoice #",render:(t,a)=>e.jsx("button",{onClick:()=>O("sales"),className:"text-blue-600 hover:underline font-medium",children:a.invoice_number})},{key:"customer",label:"Customer",render:(t,a)=>{var n;return((n=a.customers)==null?void 0:n.company_name)||"N/A"}},{key:"invoice_date",label:"Date",render:(t,a)=>N(a.invoice_date)},{key:"due_date",label:"Due Date",render:(t,a)=>{const i=new Date(a.due_date)<new Date&&a.payment_status!=="paid";return e.jsx("span",{className:i?"text-red-600 font-semibold":"",children:N(a.due_date)})}},{key:"total_amount",label:"Amount",render:(t,a)=>`Rp ${a.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`},{key:"paid",label:"Paid",render:(t,a)=>e.jsxs("span",{className:"text-green-600",children:["Rp ",(a.paid_amount||0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"balance",label:"Balance",render:(t,a)=>e.jsxs("span",{className:"font-semibold text-red-600",children:["Rp ",(a.total_amount-(a.paid_amount||0)).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"status",label:"Status",render:(t,a)=>e.jsx("span",{className:`inline-block px-2 py-1 rounded-full text-xs font-medium ${a.payment_status==="partial"?"bg-yellow-100 text-yellow-800":"bg-red-100 text-red-800"}`,children:a.payment_status})}],G=[{key:"voucher_number",label:"Voucher #",render:(t,a)=>a.voucher_number},{key:"voucher_date",label:"Date",render:(t,a)=>N(a.voucher_date)},{key:"customer",label:"Customer",render:(t,a)=>{var n;return((n=a.customers)==null?void 0:n.company_name)||"N/A"}},{key:"invoices",label:"Invoices",render:(t,a)=>!a.allocations||a.allocations.length===0?"Unallocated":a.allocations.map(n=>{var l;return((l=n.sales_invoices)==null?void 0:l.invoice_number)||"N/A"}).join(", ")},{key:"amount",label:"Amount",render:(t,a)=>e.jsxs("span",{className:"font-semibold text-green-600",children:["Rp ",a.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})},{key:"method",label:"Method",render:(t,a)=>e.jsx("span",{className:"capitalize",children:a.payment_method.replace("_"," ")})},{key:"bank",label:"Bank Account",render:(t,a)=>a.bank_accounts?a.bank_accounts.alias||a.bank_accounts.account_name:"Cash"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>S("invoices"),className:`px-4 py-2 rounded-lg font-medium transition ${b==="invoices"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:["Outstanding Invoices (",y.length,")"]}),e.jsx("button",{onClick:()=>S("payments"),className:`px-4 py-2 rounded-lg font-medium transition ${b==="payments"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Payment History"})]}),e.jsxs("button",{onClick:W,disabled:R,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition",title:"Refresh data",children:[e.jsx(Q,{className:`w-4 h-4 ${R?"animate-spin":""}`}),e.jsx("span",{className:"text-sm",children:"Refresh"})]})]}),b==="invoices"&&y.length>0&&e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 flex items-start gap-3",children:[e.jsx("div",{className:"bg-blue-100 rounded-full p-2",children:e.jsx(E,{className:"w-5 h-5 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-blue-900",children:"Recording Customer Payments"}),e.jsxs("p",{className:"text-sm text-blue-700 mt-1",children:["Click the green ",e.jsx("span",{className:"font-semibold",children:'"Record Payment"'}),' button next to any invoice to record payment received from customers. The invoice status will automatically change from "pending" to "paid" once full payment is allocated.']})]})]}),b==="invoices"?e.jsx(e.Fragment,{children:y.length===0&&!k?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(E,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-lg font-medium",children:"All Caught Up!"}),e.jsx("p",{className:"text-sm mt-2",children:"No outstanding invoices - all payments received!"})]}):e.jsx(P,{columns:Y,data:y,loading:k,actions:q?t=>e.jsxs("button",{onClick:()=>z(t),className:"flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition shadow-sm",children:[e.jsx("span",{className:"text-lg",children:"+"}),"Record Payment"]}):void 0})}):e.jsx(P,{columns:G,data:$,loading:k}),e.jsx(K,{isOpen:V,onClose:()=>{_(!1),v(null),j([]),x({}),w()},title:"Record Customer Payment",size:"lg",children:e.jsxs("form",{onSubmit:H,className:"space-y-4",children:[f&&e.jsx("div",{className:"bg-blue-50 p-4 rounded-lg",children:e.jsxs("div",{className:"text-sm",children:[e.jsx("div",{className:"font-medium text-lg mb-2",children:(F=f.customers)==null?void 0:F.company_name}),e.jsx("div",{className:"text-gray-600",children:"Recording payment for customer invoices"})]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Number *"}),e.jsx("input",{type:"text",value:s.payment_number,onChange:t=>p({...s,payment_number:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Date *"}),e.jsx("input",{type:"date",value:s.payment_date,onChange:t=>p({...s,payment_date:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Amount (Rp) *"}),e.jsx("input",{type:"number",value:s.amount===0?"":s.amount,onChange:t=>p({...s,amount:t.target.value===""?0:Number(t.target.value)}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,min:"0",step:"0.01"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method *"}),e.jsxs("select",{value:s.payment_method,onChange:t=>p({...s,payment_method:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",required:!0,children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank_transfer",children:"Bank Transfer"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"credit_card",children:"Credit Card"}),e.jsx("option",{value:"other",children:"Other"})]})]}),s.payment_method!=="cash"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Bank Account"}),e.jsxs("select",{value:s.bank_account_id,onChange:t=>p({...s,bank_account_id:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Select Bank Account"}),B.map(t=>e.jsx("option",{value:t.id,children:t.alias||`${t.account_name} - ${t.bank_name}`},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Reference Number"}),e.jsx("input",{type:"text",value:s.reference_number,onChange:t=>p({...s,reference_number:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",placeholder:"Bank reference or cheque number"})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Notes"}),e.jsx("textarea",{value:s.notes,onChange:t=>p({...s,notes:t.target.value}),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500",rows:2})]})]}),I.length>0&&e.jsxs("div",{className:"border rounded-lg p-4 space-y-3 max-h-96 overflow-y-auto",children:[e.jsx("h3",{className:"font-medium text-gray-900",children:"Allocate Payment to Invoices"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Select invoices and enter amount to allocate to each"}),I.map(t=>{const a=t.total_amount-(t.paid_amount||0),n=u[t.id]!==void 0,l=u[t.id]||0;return e.jsx("div",{className:"border rounded p-3 space-y-2",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3 flex-1",children:[e.jsx("input",{type:"checkbox",checked:n,onChange:i=>{if(i.target.checked)x(r=>({...r,[t.id]:Math.min(a,s.amount-Object.values(u).reduce((o,m)=>o+m,0))}));else{const r={...u};delete r[t.id],x(r)}},className:"mt-1"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium text-sm",children:t.invoice_number}),e.jsxs("div",{className:"text-xs text-gray-600",children:["Date: ",N(t.invoice_date)]}),e.jsxs("div",{className:"text-xs mt-1",children:["Total: Rp ",t.total_amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]}),e.jsxs("div",{className:"text-xs text-orange-600 font-medium",children:["Balance: Rp ",a.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]}),n&&e.jsx("div",{className:"ml-3 w-32",children:e.jsx("input",{type:"number",value:l||"",onChange:i=>{const r=parseFloat(i.target.value)||0;if(r>a){alert("Cannot allocate more than balance");return}x(o=>({...o,[t.id]:r}))},className:"w-full px-2 py-1 border rounded text-sm",placeholder:"Amount",min:"0",max:a,step:"0.01"})})]})},t.id)}),e.jsxs("div",{className:"border-t pt-3 space-y-1",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"font-medium",children:"Payment Amount:"}),e.jsxs("span",{className:"font-bold",children:["Rp ",s.amount.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Allocated:"}),e.jsxs("span",{className:Object.values(u).reduce((t,a)=>t+a,0)>s.amount?"text-red-600 font-bold":"text-green-600",children:["Rp ",Object.values(u).reduce((t,a)=>t+a,0).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{children:"Unallocated:"}),e.jsxs("span",{className:"text-gray-600",children:["Rp ",(s.amount-Object.values(u).reduce((t,a)=>t+a,0)).toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})]})]})]})]}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx("button",{type:"button",onClick:()=>{_(!1),v(null),j([]),x({}),w()},className:"px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition",disabled:Object.values(u).reduce((t,a)=>t+a,0)===0,children:"Record Payment"})]})]})})]})}export{le as ReceivablesManager};
