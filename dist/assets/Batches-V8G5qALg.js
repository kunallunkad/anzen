import{d as fe,u as be,r as p,s as o,j as e,e as P,T as je,F as D,f,h as Ne}from"./index-D377iWu2.js";import{L as ve,P as $,D as Y}from"./Layout-B5e6WOHT.js";import{D as we}from"./DataTable-BXltp17L.js";import{M as U}from"./Modal-XL444I2e.js";import{F as ke}from"./FileUpload-n_Ilzo_i.js";import{S as G}from"./SearchableSelect-B1o4KxTG.js";import{f as q}from"./dateFormat-E6B5rKFz.js";import{P as De}from"./plus-BUV76DvH.js";import{S as qe}from"./square-pen-Bq2ioL1R.js";import{E as Se}from"./external-link-CbTQ6Fgm.js";import"./search-C8aJjCFC.js";import"./chevron-up-CjxuCjv5.js";import"./chevron-down-D_LZ1jaB.js";import"./upload-B0u4dWaP.js";import"./clipboard-4R3bkPrW.js";import"./file-BzewGIPn.js";import"./image-D11Hy8GW.js";function Ke(){const{t:Ce}=fe(),{profile:h}=be(),[g,J]=p.useState([]),[S,X]=p.useState([]),[Z,ee]=p.useState([]),[te,re]=p.useState(!0),[se,v]=p.useState(!1),[ae,T]=p.useState(!1),[ie,B]=p.useState(!1),[L,A]=p.useState([]),[Ee,R]=p.useState(null),[N,O]=p.useState(null),[M,z]=p.useState([]),[m,H]=p.useState(null),[Q,C]=p.useState([]),[r,u]=p.useState({batch_number:"",product_id:"",import_container_id:"",import_date:"",import_quantity:0,packaging_details:"",import_price_usd:0,exchange_rate_usd_to_idr:0,duty_charges:0,duty_percent:0,duty_charge_type:"fixed",freight_charges:0,freight_charge_type:"fixed",other_charges:0,other_charge_type:"fixed",expiry_date:"",per_pack_weight:"",pack_type:"bag"});p.useEffect(()=>{E(),ne(),ce()},[]);const E=async()=>{try{const{data:t,error:s}=await o.from("batches").select(`
          *,
          products(product_name, product_code, unit),
          import_containers(container_ref)
        `).order("import_date",{ascending:!1});if(s)throw s;const a=await Promise.all((t||[]).map(async i=>{const{count:c}=await o.from("batch_documents").select("*",{count:"exact",head:!0}).eq("batch_id",i.id);return{...i,document_count:c||0}}));J(a)}catch(t){console.error("Error loading batches:",t)}finally{re(!1)}},ne=async()=>{try{const{data:t,error:s}=await o.from("products").select("id, product_name, product_code, unit, duty_percent").eq("is_active",!0).order("product_name");if(s)throw s;X(t||[])}catch(t){console.error("Error loading products:",t)}},ce=async()=>{try{const{data:t,error:s}=await o.from("import_containers").select("id, container_ref, status").order("container_ref",{ascending:!1});if(s)throw s;ee(t||[])}catch(t){console.error("Error loading import containers:",t)}},oe=async t=>{try{const{data:s,error:a}=await o.from("batch_documents").select("*").eq("batch_id",t).order("uploaded_at",{ascending:!1});if(a)throw a;A(s||[]),R(t),T(!0)}catch(s){console.error("Error loading documents:",s),f({type:"error",title:"Error",message:"Failed to load documents"})}},le=async t=>{if(t.preventDefault(),r.import_price_usd>0&&r.exchange_rate_usd_to_idr<=0){f({type:"error",title:"Error",message:"Please enter a valid exchange rate"});return}try{let s=0;if(m){const{data:x,error:_}=await o.from("sales_invoice_items").select("quantity").eq("batch_id",m.id);if(_)throw _;if(s=(x==null?void 0:x.reduce((b,j)=>b+parseFloat(j.quantity||0),0))||0,r.import_quantity<s){f({type:"error",title:"Error",message:`Cannot reduce import quantity to ${r.import_quantity}. You have already sold ${s} units from this batch.`});return}}const a=r.import_price_usd*r.exchange_rate_usd_to_idr,i=(x,_,b)=>_==="percentage"?b*x/100:x,c=a*r.duty_percent/100,l=i(r.freight_charges,r.freight_charge_type,a),d=i(r.other_charges,r.other_charge_type,a);let y;if(m){const x=r.import_quantity-m.import_quantity,_={batch_number:r.batch_number,product_id:r.product_id,import_container_id:r.import_container_id&&r.import_container_id.trim()!==""?r.import_container_id:null,import_date:r.import_date,import_quantity:r.import_quantity,packaging_details:r.packaging_details,import_price:a,import_price_usd:r.import_price_usd||null,exchange_rate_usd_to_idr:r.exchange_rate_usd_to_idr||null,duty_percent:r.duty_percent||0,duty_charges:c,duty_charge_type:"percentage",freight_charges:l,freight_charge_type:r.freight_charge_type,other_charges:d,other_charge_type:r.other_charge_type,expiry_date:r.expiry_date||null},{error:b}=await o.from("batches").update(_).eq("id",m.id);if(b)throw b;if(y=m.id,x!==0){const{error:j}=await o.from("inventory_transactions").update({quantity:r.import_quantity,notes:`Updated import quantity from ${m.import_quantity} to ${r.import_quantity} (Delta: ${x>0?"+":""}${x})`}).eq("batch_id",m.id).eq("transaction_type","purchase");j&&console.error("Error updating purchase transaction:",j);const{data:I}=await o.from("inventory_transactions").select("quantity").eq("batch_id",m.id),he=(I==null?void 0:I.reduce((ge,ye)=>ge+parseFloat(ye.quantity||"0"),0))||0;await o.from("batches").update({current_stock:he}).eq("id",m.id)}}else{const x={batch_number:r.batch_number,product_id:r.product_id,import_container_id:r.import_container_id&&r.import_container_id.trim()!==""?r.import_container_id:null,import_date:r.import_date,import_quantity:r.import_quantity,current_stock:r.import_quantity,packaging_details:r.packaging_details,import_price:a,import_price_usd:r.import_price_usd||null,exchange_rate_usd_to_idr:r.exchange_rate_usd_to_idr||null,duty_percent:r.duty_percent||0,duty_charges:c,duty_charge_type:"percentage",freight_charges:l,freight_charge_type:r.freight_charge_type,other_charges:d,other_charge_type:r.other_charge_type,expiry_date:r.expiry_date||null},{data:{user:_}}=await o.auth.getUser();if(!_)throw new Error("Not authenticated");const{data:b,error:j}=await o.from("batches").insert([{...x,is_active:!0,created_by:_.id}]).select().single();if(j)throw j;y=b.id}await de(y),v(!1),w(),E()}catch(s){console.error("Error saving batch:",s),f({type:"error",title:"Error",message:"Failed to save batch. Please try again."})}},de=async t=>{const s=Q.filter(a=>a.file&&!a.id);for(const a of s)try{const i=`${Date.now()}_${a.file.name}`,c=`${t}/${i}`,{error:l}=await o.storage.from("batch-documents").upload(c,a.file);if(l)throw l;const{data:{publicUrl:d}}=o.storage.from("batch-documents").getPublicUrl(c),{error:y}=await o.from("batch_documents").insert([{batch_id:t,file_url:d,file_name:a.file.name,file_type:a.file_type,file_size:a.file_size}]);if(y)throw y}catch(i){console.error("Error uploading file:",i)}},me=async t=>{H(t);let s="",a="bag";if(t.packaging_details){const d=t.packaging_details.match(/(\d+)\s+(\w+)s?\s+x\s+(\d+(?:\.\d+)?)kg/);d&&(s=d[3],a=d[2].toLowerCase())}const i=S.find(d=>d.id===t.product_id),c=(i==null?void 0:i.duty_percent)||0;u({batch_number:t.batch_number,product_id:t.product_id,import_container_id:t.import_container_id||"",import_date:t.import_date,import_quantity:t.import_quantity,packaging_details:t.packaging_details,import_price_usd:t.import_price_usd||0,exchange_rate_usd_to_idr:t.exchange_rate_usd_to_idr||0,duty_percent:c,duty_charges:t.duty_charges,duty_charge_type:"fixed",freight_charges:t.freight_charges,freight_charge_type:"fixed",other_charges:t.other_charges,other_charge_type:"fixed",expiry_date:t.expiry_date,per_pack_weight:s,pack_type:a});const{data:l}=await o.from("batch_documents").select("*").eq("batch_id",t.id);C(l||[]),v(!0)},ue=async t=>{try{const{data:s}=await o.from("sales_invoice_items").select("id, sales_invoices(invoice_number)").eq("batch_id",t).limit(1);if(s&&s.length>0){f({type:"error",title:"Error",message:"Cannot delete this batch. It has been used in sales invoices. Please delete the related invoices first or contact your administrator."});return}const{data:a}=await o.from("delivery_challan_items").select("id").eq("batch_id",t).limit(1);if(a&&a.length>0){f({type:"error",title:"Error",message:"Cannot delete this batch. It has been used in delivery challans. Please delete the related delivery challans first."});return}if(!await Ne({title:"Confirm",message:"Are you sure you want to delete this batch? This will permanently remove all related data.",variant:"danger",confirmLabel:"Delete"}))return;const{error:i}=await o.from("batch_documents").delete().eq("batch_id",t);if(i)throw i;const{error:c}=await o.from("inventory_transactions").delete().eq("batch_id",t);if(c)throw c;const{error:l}=await o.from("finance_expenses").delete().eq("batch_id",t);if(l)throw l;const{error:d}=await o.from("batches").delete().eq("id",t);if(d)throw d;f({type:"success",title:"Success",message:"Batch deleted successfully"}),await E()}catch(s){console.error("Error deleting batch:",s);const a=(s==null?void 0:s.message)||"Unknown error occurred";f({type:"error",title:"Error",message:`Failed to delete batch: ${a}`})}},w=()=>{H(null),C([]),u({batch_number:"",product_id:"",import_container_id:"",import_date:"",import_quantity:0,packaging_details:"",import_price_usd:0,exchange_rate_usd_to_idr:0,duty_percent:0,duty_charges:0,duty_charge_type:"fixed",freight_charges:0,freight_charge_type:"fixed",other_charges:0,other_charge_type:"fixed",expiry_date:"",per_pack_weight:"",pack_type:"bag"})},xe=async(t,s,a)=>{O({id:t,name:s,code:a}),B(!0);const{data:i,error:c}=await o.from("inventory_transactions").select("*").eq("product_id",t).order("transaction_date",{ascending:!1}).order("created_at",{ascending:!1});if(c){console.error("Error loading transaction history:",c),f({type:"error",title:"Error",message:"Error loading transaction history: "+c.message});return}const l=await Promise.all((i||[]).map(async d=>{let y=null,x=null;if(d.reference_number&&d.reference_number.startsWith("DO-")){const{data:_}=await o.from("delivery_challans").select("challan_number, customer_id, customers(customer_name)").eq("challan_number",d.reference_number).single();y=_}if(d.sales_order_id){const{data:_}=await o.from("sales_orders").select("so_number, customer_id, customers(customer_name)").eq("id",d.sales_order_id).single();x=_}return{...d,delivery_challans:y,sales_orders:x}}));z(l)},F=t=>t.current_stock<t.import_quantity*.2,W=t=>t.expiry_date?new Date(t.expiry_date)<new Date:!1,V=t=>{if(!t.expiry_date)return!1;const s=new Date;return s.setDate(s.getDate()+30),new Date(t.expiry_date)<=s&&!W(t)},pe=()=>{const t=r.import_price_usd*r.exchange_rate_usd_to_idr,s=(l,d)=>d==="percentage"?t*l/100:l,a=t*r.duty_percent/100,i=s(r.freight_charges,r.freight_charge_type),c=s(r.other_charges,r.other_charge_type);return t+a+i+c},k=(t,s)=>{const a=r.import_price_usd*r.exchange_rate_usd_to_idr;return s==="percentage"?a*t/100:t},n=(t,s="IDR")=>s==="USD"?`$ ${t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`:`Rp ${t.toLocaleString("id-ID",{minimumFractionDigits:2,maximumFractionDigits:2})}`,_e=[{key:"batch_number",label:"Batch Number"},{key:"product",label:"Product",render:(t,s)=>{var a,i;return e.jsxs("div",{children:[e.jsx("button",{onClick:()=>{var c,l;return xe(s.product_id,((c=s.products)==null?void 0:c.product_name)||"",((l=s.products)==null?void 0:l.product_code)||"")},className:"font-medium text-blue-600 hover:text-blue-800 hover:underline text-left",children:(a=s.products)==null?void 0:a.product_name}),((i=s.products)==null?void 0:i.product_code)&&e.jsx("div",{className:"text-xs text-gray-500",children:s.products.product_code})]})}},{key:"import_date",label:"Import Date",render:(t,s)=>q(s.import_date)},{key:"stock",label:"Stock",render:(t,s)=>{var i,c,l;const a=s.current_stock-(s.reserved_stock||0);return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:F(s)?"text-orange-600 font-semibold":"font-medium",children:[s.current_stock," ",(i=s.products)==null?void 0:i.unit]}),F(s)&&e.jsx(P,{className:"w-4 h-4 text-orange-600"})]}),s.reserved_stock>0&&e.jsxs("div",{className:"text-xs space-y-0.5",children:[e.jsxs("div",{className:"text-amber-600",children:["Reserved: ",s.reserved_stock," ",(c=s.products)==null?void 0:c.unit]}),e.jsxs("div",{className:"text-green-600",children:["Free: ",a," ",(l=s.products)==null?void 0:l.unit]})]})]})}},{key:"pricing",label:"Import Price",render:(t,s)=>e.jsx("div",{className:"text-sm",children:s.import_price_usd&&s.exchange_rate_usd_to_idr?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium text-green-700",children:n(s.import_price_usd,"USD")}),e.jsx("div",{className:"text-xs text-gray-500",children:n(s.import_price)}),e.jsxs("div",{className:"text-xs text-gray-400",children:["@ ",s.exchange_rate_usd_to_idr.toLocaleString()]})]}):e.jsx("div",{className:"text-gray-500",children:n(s.import_price)})})},{key:"landed_cost",label:"Landed Cost",render:(t,s)=>{var l;const a=s.import_cost_allocated&&s.import_cost_allocated>0,i=s.landed_cost_per_unit||s.import_price,c=a?s.import_cost_allocated/s.import_quantity:0;return e.jsxs("div",{className:"text-sm",children:[s.import_price_usd&&s.exchange_rate_usd_to_idr?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium text-blue-700",children:n(i/s.exchange_rate_usd_to_idr,"USD")}),e.jsx("div",{className:"text-xs text-gray-500",children:n(i)}),a&&e.jsxs("div",{className:"text-xs text-green-600",children:["+Container: ",n(c)]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["@ ",s.exchange_rate_usd_to_idr.toLocaleString("id-ID")]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-medium text-blue-700",children:n(i)}),a&&e.jsxs("div",{className:"text-xs text-green-600",children:["+Container: ",n(c)]})]}),((l=s.import_containers)==null?void 0:l.container_ref)&&e.jsx("div",{className:"text-xs text-gray-400",children:s.import_containers.container_ref}),s.cost_locked&&e.jsx("div",{className:"text-xs text-amber-600 font-medium",children:"ðŸ”’ Locked"})]})}},{key:"expiry_date",label:"Expiry Date",render:(t,s)=>e.jsx("span",{className:W(s)?"text-red-700 font-semibold":V(s)?"text-orange-600 font-semibold":"",children:s.expiry_date?q(s.expiry_date):"N/A"})},{key:"documents",label:"Docs",render:(t,s)=>e.jsxs("button",{onClick:()=>oe(s.id),className:"flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition",children:[e.jsx(D,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:s.document_count||0})]})},{key:"total_cost",label:"Total Cost",render:(t,s)=>{const a=s.import_price*s.import_quantity,i=s.import_price_usd?s.import_price_usd*s.import_quantity:null;return e.jsx("div",{className:"text-sm",children:i&&s.exchange_rate_usd_to_idr?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"font-semibold text-green-700",children:n(i,"USD")}),e.jsx("div",{className:"text-xs text-gray-500",children:n(a)})]}):e.jsx("div",{className:"font-semibold",children:n(a)})})}}],K=(h==null?void 0:h.role)==="admin"||(h==null?void 0:h.role)==="warehouse"||(h==null?void 0:h.role)==="accounts";return e.jsx(ve,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Import Batches"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Manage import batches with USD pricing and document tracking"})]}),K&&e.jsxs("button",{onClick:()=>{w(),v(!0)},className:"flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition",children:[e.jsx(De,{className:"w-5 h-5"}),"Add Batch"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx("div",{className:"bg-white rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Total Batches"}),e.jsx("p",{className:"text-2xl font-bold text-gray-900 mt-1",children:g.length})]}),e.jsx($,{className:"w-8 h-8 text-blue-600"})]})}),e.jsx("div",{className:"bg-orange-50 rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-orange-600",children:"Low Stock"}),e.jsx("p",{className:"text-2xl font-bold text-orange-600 mt-1",children:g.filter(F).length})]}),e.jsx(P,{className:"w-8 h-8 text-orange-600"})]})}),e.jsx("div",{className:"bg-red-50 rounded-lg shadow p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-red-600",children:"Near Expiry"}),e.jsx("p",{className:"text-2xl font-bold text-red-600 mt-1",children:g.filter(V).length})]}),e.jsx(P,{className:"w-8 h-8 text-red-600"})]})})]}),e.jsx(we,{columns:_e,data:g,loading:te,actions:K?t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>me(t),className:"p-1 text-blue-600 hover:bg-blue-50 rounded",children:e.jsx(qe,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ue(t.id),className:"p-1 text-red-600 hover:bg-red-50 rounded",children:e.jsx(je,{className:"w-4 h-4"})})]}):void 0}),g.length>0&&e.jsxs("div",{className:"bg-gradient-to-r from-blue-50 to-green-50 rounded-lg shadow-lg p-6 border-2 border-blue-200",children:[e.jsxs("h3",{className:"text-lg font-bold text-gray-900 mb-4 flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5 text-blue-600"}),"Total Import Value Summary"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Total Value (USD)"}),e.jsx("p",{className:"text-3xl font-bold text-green-700",children:n(g.reduce((t,s)=>{const a=s.import_price_usd?s.import_price_usd*s.import_quantity:0;return t+a},0),"USD")})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-gray-600 font-medium",children:"Total Value (IDR)"}),e.jsx("p",{className:"text-3xl font-bold text-blue-700",children:n(g.reduce((t,s)=>{const a=s.import_price*s.import_quantity;return t+a},0))})]})]}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-blue-200",children:[e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Total Batches:"}),e.jsx("span",{className:"font-semibold text-gray-900",children:g.length})]}),e.jsxs("div",{className:"flex justify-between items-center text-sm mt-1",children:[e.jsx("span",{className:"text-gray-600",children:"Total Quantity:"}),e.jsxs("span",{className:"font-semibold text-gray-900",children:[g.reduce((t,s)=>t+s.import_quantity,0).toLocaleString()," units"]})]})]})]}),e.jsx(U,{isOpen:se,onClose:()=>{v(!1),w()},title:m?"Edit Batch":"Add New Batch",size:"xl",children:e.jsxs("form",{onSubmit:le,className:"space-y-2",children:[e.jsxs("div",{className:"border-b pb-1.5",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-900 mb-1.5",children:"Basic Information"}),e.jsxs("div",{className:"grid grid-cols-[2fr_1fr_1fr] gap-2 mb-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Batch Number *"}),e.jsx("input",{type:"text",value:r.batch_number,onChange:t=>u({...r,batch_number:t.target.value}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Import Date *"}),e.jsx("input",{type:"date",value:r.import_date,onChange:t=>u({...r,import_date:t.target.value}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Expiry Date"}),e.jsx("input",{type:"date",value:r.expiry_date,onChange:t=>u({...r,expiry_date:t.target.value}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Product *"}),e.jsx(G,{value:r.product_id,onChange:t=>{const s=S.find(a=>a.id===t);u({...r,product_id:t,duty_percent:(s==null?void 0:s.duty_percent)||0})},options:S.map(t=>({value:t.id,label:`${t.product_name}${t.product_code?` (${t.product_code})`:""}`})),placeholder:"Select Product",className:"text-sm",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Import Container (Optional)"}),e.jsx(G,{value:r.import_container_id,onChange:t=>u({...r,import_container_id:t}),options:[{value:"",label:"Select Container (Optional)"},...Z.map(t=>({value:t.id,label:`${t.container_ref} (${t.status})`}))],placeholder:"Select Container",className:"text-sm"}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Link batch to import container for cost allocation"})]})]})]}),e.jsxs("div",{className:"border-b pb-1.5",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-900 mb-1.5",children:"Quantity"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Import Quantity *"}),e.jsx("input",{type:"number",value:r.import_quantity===0?"":r.import_quantity,onChange:t=>u({...r,import_quantity:t.target.value===""?0:Number(t.target.value)}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",required:!0,min:"0",step:"0.001",placeholder:"0"}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Total quantity being imported"})]}),m&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Current Stock"}),e.jsx("div",{className:"w-full px-2 py-1 text-sm border border-gray-200 rounded bg-gray-50",children:e.jsx("span",{className:"text-gray-700 font-medium",children:m.current_stock.toLocaleString()})}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:["Available: ",m.current_stock.toLocaleString()," | Sold: ",(m.import_quantity-m.current_stock).toLocaleString()]})]})]})]}),e.jsxs("div",{className:"border-b pb-1.5",children:[e.jsxs("h3",{className:"text-xs font-semibold text-gray-900 mb-1 flex items-center gap-1.5",children:[e.jsx($,{className:"w-3.5 h-3.5"}),"Packaging Details (Optional)"]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Per Pack Weight"}),e.jsx("input",{type:"number",step:"0.001",value:r.per_pack_weight,onChange:t=>{const s={...r,per_pack_weight:t.target.value};if(r.import_quantity&&t.target.value){const a=parseFloat(t.target.value);if(a){const i=(r.import_quantity/a).toFixed(0);s.packaging_details=`${i} ${r.pack_type}${parseInt(i)!==1?"s":""} x ${a}kg`}}u(s)},placeholder:"e.g., 25",className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"kg per pack"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Pack Type"}),e.jsxs("select",{value:r.pack_type,onChange:t=>{const s={...r,pack_type:t.target.value};if(r.import_quantity&&r.per_pack_weight){const a=parseFloat(r.per_pack_weight);if(a){const i=(r.import_quantity/a).toFixed(0);s.packaging_details=`${i} ${t.target.value}${parseInt(i)!==1?"s":""} x ${a}kg`}}u(s)},className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",children:[e.jsx("option",{value:"bag",children:"Bag"}),e.jsx("option",{value:"drum",children:"Drum"}),e.jsx("option",{value:"tin",children:"Tin"}),e.jsx("option",{value:"box",children:"Box"}),e.jsx("option",{value:"carton",children:"Carton"}),e.jsx("option",{value:"pallet",children:"Pallet"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Calculated Packs"}),e.jsx("div",{className:"px-2 py-1 text-sm bg-gray-50 border border-gray-200 rounded",children:e.jsx("span",{className:"text-gray-700 font-medium",children:r.import_quantity&&r.per_pack_weight?Math.ceil(r.import_quantity/parseFloat(r.per_pack_weight)):"-"})}),e.jsx("p",{className:"text-xs text-gray-500 mt-0.5",children:"Total packs"})]})]}),r.packaging_details&&e.jsx("div",{className:"mt-1 p-1.5 bg-blue-50 border border-blue-200 rounded",children:e.jsxs("p",{className:"text-xs text-blue-900",children:[e.jsx("span",{className:"font-semibold",children:"Packaging: "}),r.packaging_details]})})]}),e.jsxs("div",{className:"border-b pb-1.5",children:[e.jsxs("h3",{className:"text-xs font-semibold text-gray-900 mb-1 flex items-center gap-1.5",children:[e.jsx(Y,{className:"w-3.5 h-3.5 text-green-600"}),"Import Pricing (USD)"]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Import Price (USD)"}),e.jsx("input",{type:"number",value:r.import_price_usd===0?"":r.import_price_usd,onChange:t=>u({...r,import_price_usd:t.target.value===""?0:Number(t.target.value)}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",min:"0",step:"0.01",placeholder:"0.00"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-0.5",children:"Exchange Rate (USD to IDR)"}),e.jsx("input",{type:"number",value:r.exchange_rate_usd_to_idr===0?"":r.exchange_rate_usd_to_idr,onChange:t=>u({...r,exchange_rate_usd_to_idr:t.target.value===""?0:Number(t.target.value)}),className:"w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",min:"0",step:"0.0001",placeholder:"15000"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-0.5",children:["1 USD = ",r.exchange_rate_usd_to_idr.toLocaleString()," IDR"]})]})]}),r.import_price_usd>0&&r.exchange_rate_usd_to_idr>0&&e.jsxs("div",{className:"mt-1 p-1.5 bg-green-50 border border-green-200 rounded",children:[e.jsxs("p",{className:"text-xs text-green-800",children:[e.jsx("span",{className:"font-semibold",children:"Calculated Import Price (IDR):"})," ",n(r.import_price_usd*r.exchange_rate_usd_to_idr)]}),e.jsxs("p",{className:"text-xs text-green-600 mt-0.5",children:[n(r.import_price_usd,"USD")," Ã— ",r.exchange_rate_usd_to_idr.toLocaleString()," = ",n(r.import_price_usd*r.exchange_rate_usd_to_idr)]})]})]}),e.jsxs("div",{className:"border-b pb-1.5",children:[e.jsx("h3",{className:"text-xs font-semibold text-gray-900 mb-1",children:"Additional Charges"}),e.jsx("div",{className:"space-y-3",children:e.jsxs("div",{className:"grid grid-cols-[1fr_1fr_1fr] gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Duty (Form A1 %)"}),e.jsxs("div",{className:"flex gap-0.5",children:[e.jsx("input",{type:"number",value:r.duty_percent===0?"":r.duty_percent,onChange:t=>u({...r,duty_percent:t.target.value===""?0:Number(t.target.value)}),className:"flex-1 px-1.5 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",min:"0",max:"100",step:"0.01",placeholder:"Auto from product"}),e.jsx("div",{className:"w-12 px-0.5 py-1 text-xs border border-gray-300 rounded bg-gray-50 flex items-center justify-center",children:"%"})]}),r.duty_percent>0&&r.import_price_usd>0&&r.exchange_rate_usd_to_idr>0&&e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:["= ",n(r.import_price_usd*r.exchange_rate_usd_to_idr*r.duty_percent/100)]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Freight"}),e.jsxs("div",{className:"flex gap-0.5",children:[e.jsx("input",{type:"number",value:r.freight_charges===0?"":r.freight_charges,onChange:t=>u({...r,freight_charges:t.target.value===""?0:Number(t.target.value)}),className:"flex-1 px-1.5 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",min:"0",step:"0.01",placeholder:"0"}),e.jsxs("select",{value:r.freight_charge_type,onChange:t=>u({...r,freight_charge_type:t.target.value}),className:"w-12 px-0.5 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"percentage",children:"%"}),e.jsx("option",{value:"fixed",children:"Rp"})]})]}),r.freight_charges>0&&e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:["= ",n(k(r.freight_charges,r.freight_charge_type))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Other"}),e.jsxs("div",{className:"flex gap-0.5",children:[e.jsx("input",{type:"number",value:r.other_charges===0?"":r.other_charges,onChange:t=>u({...r,other_charges:t.target.value===""?0:Number(t.target.value)}),className:"flex-1 px-1.5 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500",min:"0",step:"0.01",placeholder:"0"}),e.jsxs("select",{value:r.other_charge_type,onChange:t=>u({...r,other_charge_type:t.target.value}),className:"w-12 px-0.5 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 bg-white",children:[e.jsx("option",{value:"percentage",children:"%"}),e.jsx("option",{value:"fixed",children:"Rp"})]})]}),r.other_charges>0&&e.jsxs("p",{className:"text-xs text-gray-600 mt-0.5",children:["= ",n(k(r.other_charges,r.other_charge_type))]})]})]})})]}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded p-2",children:[e.jsx("h3",{className:"text-xs font-semibold text-blue-900 mb-1.5",children:"Total Cost Summary"}),e.jsxs("div",{className:"space-y-0.5 text-xs text-blue-800",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Import Price (per unit):"}),e.jsx("span",{className:"font-medium",children:n(r.import_price_usd*r.exchange_rate_usd_to_idr)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Duty (Form A1):"}),e.jsxs("span",{className:"font-medium",children:[n(r.import_price_usd*r.exchange_rate_usd_to_idr*r.duty_percent/100),r.duty_percent>0&&e.jsxs("span",{className:"text-xs ml-1",children:["(",r.duty_percent,"%)"]})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Freight Charges:"}),e.jsxs("span",{className:"font-medium",children:[n(k(r.freight_charges,r.freight_charge_type)),r.freight_charge_type==="percentage"&&r.freight_charges>0&&e.jsxs("span",{className:"text-xs ml-1",children:["(",r.freight_charges,"%)"]})]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Other Charges:"}),e.jsxs("span",{className:"font-medium",children:[n(k(r.other_charges,r.other_charge_type)),r.other_charge_type==="percentage"&&r.other_charges>0&&e.jsxs("span",{className:"text-xs ml-1",children:["(",r.other_charges,"%)"]})]})]}),e.jsxs("div",{className:"border-t border-blue-300 pt-1.5 mt-1.5 space-y-1",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"font-bold",children:"Total Cost (IDR):"}),e.jsx("span",{className:"font-bold text-sm",children:n(pe())})]}),r.import_quantity>0&&e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded px-2 py-1.5 mt-2",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"font-bold text-green-900",children:"Total Batch Cost:"}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"font-bold text-green-700",children:n(r.import_price_usd*r.import_quantity,"USD")}),e.jsx("div",{className:"text-xs text-green-600",children:n(r.import_price_usd*r.exchange_rate_usd_to_idr*r.import_quantity)})]})]}),e.jsxs("div",{className:"text-xs text-green-700 mt-0.5",children:[n(r.import_price_usd,"USD")," Ã— ",r.import_quantity," = ",n(r.import_price_usd*r.import_quantity,"USD")]})]})]})]})]}),e.jsxs("div",{className:"border-t pt-1.5",children:[e.jsxs("h3",{className:"text-xs font-semibold text-gray-900 mb-1 flex items-center gap-1.5",children:[e.jsx(D,{className:"w-3.5 h-3.5"}),"Import Documents"]}),e.jsx(ke,{batchId:m==null?void 0:m.id,existingFiles:Q,onFilesChange:C})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-2 border-t",children:[e.jsx("button",{type:"button",onClick:()=>{v(!1),w()},className:"px-3 py-1 text-sm border border-gray-300 rounded hover:bg-gray-50 transition",children:"Cancel"}),e.jsx("button",{type:"submit",className:"px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 transition",children:m?"Update Batch":"Add Batch"})]})]})}),e.jsx(U,{isOpen:ae,onClose:()=>{T(!1),A([]),R(null)},title:"Batch Documents",children:e.jsx("div",{className:"space-y-3",children:L.length>0?L.map(t=>e.jsxs("a",{href:t.file_url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-200 hover:bg-blue-50 hover:border-blue-300 transition",children:[e.jsx(D,{className:"w-5 h-5 text-blue-600 flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:t.file_name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-gray-500 mt-1",children:[e.jsx("span",{className:"capitalize",children:t.file_type.replace("_"," ")}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[(t.file_size/1024).toFixed(1)," KB"]}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:q(t.uploaded_at)})]})]}),e.jsx(Se,{className:"w-4 h-4 text-gray-400 flex-shrink-0"})]},t.id)):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(D,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"No documents uploaded for this batch"})]})})}),e.jsx(U,{isOpen:ie,onClose:()=>{B(!1),O(null),z([])},title:`Transaction History - ${(N==null?void 0:N.name)||""} (${(N==null?void 0:N.code)||""})`,children:e.jsx("div",{className:"space-y-3 max-h-[600px] overflow-y-auto",children:M.length>0?e.jsx("div",{className:"space-y-2",children:M.map((t,s)=>e.jsx("div",{className:`p-3 rounded-lg border-l-4 ${parseFloat(t.quantity)>0?"bg-green-50 border-green-500":"bg-red-50 border-red-500"}`,children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:`font-semibold ${parseFloat(t.quantity)>0?"text-green-700":"text-red-700"}`,children:[parseFloat(t.quantity)>0?"+":"",parseFloat(t.quantity).toFixed(3)]}),e.jsx("span",{className:"text-xs px-2 py-0.5 rounded bg-gray-200 text-gray-700 uppercase",children:t.transaction_type.replace("_"," ")})]}),e.jsxs("div",{className:"text-sm text-gray-600 space-y-0.5",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Date:"})," ",q(t.transaction_date)]}),t.reference_number&&e.jsxs("div",{children:[e.jsx("strong",{children:"Reference:"})," ",t.reference_number]}),t.reference_type==="delivery_challan"&&t.delivery_challans&&e.jsxs("div",{className:"text-xs text-blue-600",children:["DC: ",t.delivery_challans.challan_number,t.delivery_challans.customers&&e.jsxs("span",{className:"ml-1",children:["â†’ ",t.delivery_challans.customers.customer_name]})]}),t.sales_order_id&&t.sales_orders&&e.jsxs("div",{className:"text-xs text-blue-600",children:["SO: ",t.sales_orders.so_number,t.sales_orders.customers&&e.jsxs("span",{className:"ml-1",children:["â†’ ",t.sales_orders.customers.customer_name]})]}),t.notes&&e.jsx("div",{className:"text-xs text-gray-500 italic",children:t.notes})]})]}),e.jsx("div",{className:"text-right text-xs text-gray-400",children:new Date(t.created_at).toLocaleString()})]})},t.id))}):e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx($,{className:"w-12 h-12 mx-auto mb-3 text-gray-300"}),e.jsx("p",{children:"No transactions found for this product"})]})})})]})})}export{Ke as Batches};
